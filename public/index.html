<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="codelover's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="一直走在吃软饭路上的软狗">
<meta property="og:type" content="website">
<meta property="og:title" content="codelover's blog">
<meta property="og:url" content="http://codelover.link/index.html">
<meta property="og:site_name" content="codelover's blog">
<meta property="og:description" content="一直走在吃软饭路上的软狗">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="codelover's blog">
<meta name="twitter:description" content="一直走在吃软饭路上的软狗">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6254113771573216000,
      author: 'codelover'
    }
  };
</script>




  <link rel="canonical" href="http://codelover.link/"/>

  <title> codelover's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">codelover's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/25/linux_shell_backup/" itemprop="url">
                  ubuntu相关软件配置备忘录
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-03-25T00:00:00+08:00" content="2017-03-25">
              2017-03-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/ubuntu/" itemprop="url" rel="index">
                    <span itemprop="name">ubuntu</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/03/25/linux_shell_backup/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/25/linux_shell_backup/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="端口占用相关"><a href="#端口占用相关" class="headerlink" title="端口占用相关"></a>端口占用相关</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//查找端口占用情况</span></div><div class="line"><span class="symbol">$</span> netstat -anp | grep <span class="string">"5000"</span></div><div class="line"> </div><div class="line"><span class="comment">//干掉某个进程</span></div><div class="line"><span class="symbol">$</span> kill <span class="number">-9</span> <span class="number">2553</span></div><div class="line"> </div><div class="line"><span class="comment">//后台运行 </span></div><div class="line"><span class="symbol">$</span> nohup command &amp;</div></pre></td></tr></table></figure>
<h4 id="安装SS"><a href="#安装SS" class="headerlink" title="安装SS"></a>安装SS</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">$</span> apt-get update</div><div class="line"><span class="comment">//安装ss</span></div><div class="line"><span class="symbol">$</span> apt-get install python-pip </div><div class="line"><span class="symbol">$</span> pip install shadowsocks</div><div class="line"><span class="comment">//运行ss服务端</span></div><div class="line"><span class="symbol">$</span> nohup ssserver -s ip地址 -k 密码 &amp;</div></pre></td></tr></table></figure>
<h4 id="安装MySQL5-7"><a href="#安装MySQL5-7" class="headerlink" title="安装MySQL5.7"></a>安装MySQL5.7</h4><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">http://tecadmin.net/install-mysql-5-on-ubuntu/</div><div class="line"></div><div class="line">$ sudo apt-get install software-properties-common</div><div class="line">$ sudo<span class="built_in"> add-apt-repository </span>-y ppa:ondrej/mysql-5.7</div><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install mysql-server</div><div class="line"></div><div class="line">//编辑此处，允许远程登录</div><div class="line">/etc/mysql/my.cnf</div><div class="line"></div><div class="line">bind-address		= 0.0.0.0</div><div class="line"></div><div class="line">//重启MySQL</div><div class="line">$ /etc/init.d/mysql restart</div></pre></td></tr></table></figure>
<h4 id="MySQL添加用户"><a href="#MySQL添加用户" class="headerlink" title="MySQL添加用户"></a>MySQL添加用户</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//新增用户</div><div class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span>  <span class="keyword">on</span> *.* <span class="keyword">to</span> root@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">"root"</span>;</div><div class="line">//立即生效</div><div class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">grant</span> <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">delete</span>,<span class="keyword">create</span>,<span class="keyword">drop</span> <span class="keyword">on</span>  <span class="keyword">to</span> joe@<span class="number">10.163</span><span class="number">.225</span><span class="number">.87</span> <span class="keyword">identified</span> <span class="keyword">by</span> ‘<span class="number">123</span>′;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">grant</span> all  <span class="keyword">on</span> xxxDB.* <span class="keyword">to</span> xxx@<span class="string">'%'</span>;</div></pre></td></tr></table></figure>
<h4 id="MySQL提示“Checking-for-tables-which-need-an-upgrade-are-corrupt-or-were-not-closed-cleanly”"><a href="#MySQL提示“Checking-for-tables-which-need-an-upgrade-are-corrupt-or-were-not-closed-cleanly”" class="headerlink" title="MySQL提示“Checking for tables which need an upgrade, are corrupt or were not closed cleanly”"></a>MySQL提示“Checking for tables which need an upgrade, are corrupt or were not closed cleanly”</h4><p>操作步骤：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$ sudo service mysql <span class="built_in">stop</span> </div><div class="line">$ sudo /etc/init.d/apparmor reload</div><div class="line">$ sudo service mysql <span class="built_in">start</span></div><div class="line"></div><div class="line"></div><div class="line">或者：</div><div class="line"></div><div class="line">down vote</div><div class="line">This error occurs due <span class="built_in">to</span> multiple installations <span class="keyword">of</span> mysql. Run <span class="keyword">the</span> <span class="keyword">command</span>:</div><div class="line"></div><div class="line">$ ps -A|grep mysql</div><div class="line">Kill <span class="keyword">the</span> <span class="built_in">process</span> <span class="keyword">by</span> <span class="keyword">using</span>:</div><div class="line"></div><div class="line">$ sudo pkill mysql</div><div class="line"><span class="keyword">and</span> <span class="keyword">then</span> run <span class="keyword">command</span>:</div><div class="line"></div><div class="line">$ ps -A|grep mysqld</div><div class="line">Also Kill this <span class="built_in">process</span> <span class="keyword">by</span> running:</div><div class="line"></div><div class="line">$ sudo pkill mysqld</div><div class="line">Now you are fully <span class="built_in">set</span> just run <span class="keyword">the</span> following commands:</div><div class="line"></div><div class="line">$ service mysql restart</div><div class="line">mysql -u root -p</div></pre></td></tr></table></figure>
<h4 id="7z相关操作"><a href="#7z相关操作" class="headerlink" title="7z相关操作"></a>7z相关操作</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//压缩</span></div><div class="line">$ <span class="number">7</span>z a -t7z -r manager<span class="number">.7</span>z /home/manager<span class="comment">/*</span></div><div class="line">//解压</div><div class="line">$ 7z X xx.zip</div></pre></td></tr></table></figure>
<h4 id="腾讯云修改密码-允许root登录"><a href="#腾讯云修改密码-允许root登录" class="headerlink" title="腾讯云修改密码,允许root登录"></a>腾讯云修改密码,允许root登录</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>sudo passwd root</div><div class="line"></div><div class="line"><span class="variable">$ </span>sudo vi /etc/ssh/sshd_config</div><div class="line"></div><div class="line"><span class="variable">$ </span>sudo service ssh  restart</div></pre></td></tr></table></figure>
<h4 id="开机启动相关"><a href="#开机启动相关" class="headerlink" title="开机启动相关"></a>开机启动相关</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//查看开机启动相关程序</span></div><div class="line"><span class="symbol">$</span> ls /etc/rc*</div><div class="line"><span class="comment">//安装sysv-rc-conf</span></div><div class="line"><span class="symbol">$</span> sudo apt-get install sysv-rc-conf</div><div class="line"><span class="symbol">$</span> sudo sysv-rc-conf</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/17/visualstudiocode_for_php_debug/" itemprop="url">
                  用Visual Studio Code Debug世界上最好的语言
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-03-17T00:00:00+08:00" content="2017-03-17">
              2017-03-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Visual-Studio/" itemprop="url" rel="index">
                    <span itemprop="name">Visual Studio</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/03/17/visualstudiocode_for_php_debug/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/17/visualstudiocode_for_php_debug/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>这阵子因缘巧合接手了一个辣鸡项目，是用世界上最好的拍黄片写的，项目基本是另一个小伙伴在撸码，我就兼职打杂和发布做点运维的工作。</p>
<p>然后昨天项目上了测试版之后，一用起来Error满天飞了。让小伙伴查了很久都没有头绪，实在尴尬，只好自己动手了…</p>
<p>作为一个后端狗，虽然知道PHP大体原理和框架，看着项目的业务逻辑也大体知道个所以然，在此之前还是没撸过代码的。</p>
<p>看代码基本是Visual Studio Code或者HBuilder工具，本地跑代码很白痴的在用phpStudy。</p>
<p>Error出来了，第一反应就是debug咯…然后问了下小伙伴他以前怎么玩的，答曰：echo。</p>
<p>一口老血都…</p>
<p>查了下谷歌发现，Visual Studio Code + 插件是完全可以用来调试PHP的，所以就撸起了。</p>
<h4 id="Visual-Studio-Code-php-debug插件-phpStudy-xdebug"><a href="#Visual-Studio-Code-php-debug插件-phpStudy-xdebug" class="headerlink" title="Visual Studio Code + php-debug插件 + phpStudy + xdebug"></a>Visual Studio Code + php-debug插件 + phpStudy + xdebug</h4><h4 id="安装Visual-Studio-Code"><a href="#安装Visual-Studio-Code" class="headerlink" title="安装Visual Studio Code"></a>安装Visual Studio Code</h4><p>首先肯定是先下载<a href="http://code.visualstudio.com/" target="_blank" rel="external">Visual Studio Code</a> 咯。</p>
<p>安装好之后，随便在一个文件夹内鼠标“右键”，都能看到Open with code，打开之后如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/b1cee12e-6215-4f04-9dea-3721400e238b" alt="Open with code"></p>
<h4 id="安装Visual-Studio-Code-php-debug插件"><a href="#安装Visual-Studio-Code-php-debug插件" class="headerlink" title="安装Visual Studio Code php-debug插件"></a>安装Visual Studio Code php-debug插件</h4><p>装好VS Code之后，接下来是安装一下PHP-Debug插件了。我们在插件商城搜索一下php，排名第二的PHP Debug就是我们要的插件了。<br>如下图：<br><img src="http://7xread.com1.z0.glb.clouddn.com/3f798ea9-bba9-4768-9f58-14257ddc1999" alt="PHP-Debug"></p>
<p>装好了之后重启一下vs code即可。</p>
<h4 id="phpStudy"><a href="#phpStudy" class="headerlink" title="phpStudy"></a>phpStudy</h4><p>对于我这种懒人来说，去配置什么PHP运行环境肯定是不愿意的，那么类似的集成环境有么？</p>
<p>小伙伴和我说，你下个<a href="http://www.phpstudy.net/" target="_blank" rel="external">phpStudy</a>撸就算了，别去倒腾什么版本了。</p>
<p>然后…</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/6c8ea274-9da5-4168-ba80-f6a0f6e173c3" alt="phpStudy"></p>
<p>下载好了安装完了，打开程序如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/7d2d12e2-783f-4402-8900-0315905c6948" alt="phpStudy"></p>
<p>看了下功能，其实这个软件就是集成了各种版本的PHP，可以方便切换PHP版本；同时自带一个Apache和MySQL，各种配置管理起来也挺方便的。<br>（感觉dalao们应该不怎么会用这么白痴的东西，233…</p>
<p>装好之后，启动一下服务，点击一下phpMyAdmin，看看它打开的网站是否能登录到本地的MySQL数据库。</p>
<p>如果可以，说明PHP环境应该是正常的了；如果有问题，请自行谷歌了…</p>
<p>接着切换PHP版本到意向版本，点击一下运行模式旁边的“切换版本”就可以选择版本了。</p>
<h4 id="xdebug设置"><a href="#xdebug设置" class="headerlink" title="xdebug设置"></a>xdebug设置</h4><p><a href="https://xdebug.org/" target="_blank" rel="external">xdebug</a>是什么呢？<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Xdebug作为PHP调试工具，提供了丰富的调试函数，</div><div class="line">也可将Xdebug安装配置为zend studio、editplus调试PHP的第三方插件，</div><div class="line"></div><div class="line">通过开启自动跟踪(auto_trace)和分析器功能，可以直观的看到PHP源代码的性能数据，</div><div class="line">以便优化PHP代码。</div><div class="line"></div><div class="line">引用自：[PHP调试工具Xdebug安装配置教程]</div><div class="line">(http:<span class="regexp">//</span>www.cnblogs.com<span class="regexp">/qiantuwuliang/</span>archive<span class="regexp">/2011/</span><span class="number">01</span><span class="regexp">/23/</span><span class="number">1942382</span>.html)</div></pre></td></tr></table></figure></p>
<p>我们可以在<a href="https://xdebug.org/" target="_blank" rel="external">xdebug.org</a>（自备梯子）上面下载到PHP各个版本的xdebug dll使用。</p>
<p>不过当我打开phpStudy的php-ini打算手动开启debug的时候，非常高兴得发现已经phpStudy已自带了对应版本的xdebug，而且路径都配好了。</p>
<p>phpStudy的php.ini在“其他选项-打开配置文件-php-ini”，如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/76b103cd-399c-4bce-a716-098adbd4d212" alt="php.ini"></p>
<p>把文档拉到最后，看得到xdebug的配置如下：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/00285d82-f76f-4fd8-8ba6-f429de194809" alt="xdebug"></p>
<p>phpStudy已经帮我们配置好xdebug dll的路径了，我们只需要手动在zend_extension上面添加远程调试和自动启动配置即可，代码如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">xdebug.remote_enable = <span class="number">1</span></div><div class="line">xdebug.remote_autostart= <span class="number">1</span></div></pre></td></tr></table></figure>
<p>完整配置如下：<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[XDebug]</div><div class="line">;xdebug.profiler_output_dir="C:<span class="symbol">\p</span>hpStudy<span class="symbol">\t</span>mp<span class="symbol">\x</span>debug"</div><div class="line">;xdebug.trace_output_dir="C:<span class="symbol">\p</span>hpStudy<span class="symbol">\t</span>mp<span class="symbol">\x</span>debug"</div><div class="line">xdebug.remote_enable = 1</div><div class="line">xdebug.remote_autostart= 1</div><div class="line">;你的PHP版本的php_xdebug.dll，phpStudy自动设置的</div><div class="line">zend_extension="C:<span class="symbol">\p</span>hpStudy<span class="symbol">\p</span>hp<span class="symbol">\p</span>hp-5.5.38<span class="symbol">\e</span>xt<span class="symbol">\p</span>hp_xdebug.dll"</div></pre></td></tr></table></figure></p>
<p>保存文件，重启一下phpStudy服务。</p>
<h4 id="Visual-Studio-Code-设置用户配置和调试配置"><a href="#Visual-Studio-Code-设置用户配置和调试配置" class="headerlink" title="Visual Studio Code 设置用户配置和调试配置"></a>Visual Studio Code 设置用户配置和调试配置</h4><p>这个时候，我们随便在PHP文件夹中打开vs code，vs code会自动提示我们：Cannot validate since no PHP executable is set. Use the setting ‘php.validate.executablePath’ to configure the PHP executable.</p>
<p>嗯，没有设置PHP执行文件，可以通过设置php.validate.executablePath属性来配置它。</p>
<p>这个在哪配置呢？在“文件-首选项-设置”，打开之后如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/df4428e9-9ef2-435a-a5f5-ae8bade00a39" alt="php.validate.executablePath"></p>
<p>这个php.validate.executablePath对应就是当前phpStudy中运行的php.exe的路径，可以在phpStudy-其他选项菜单-打开文件位置-PHP中找到此路径。</p>
<p>保存好了之后，回到Visual Studio Code界面，转到Debug，选择添加配置，之后选择PHP，生成如下图的launch.json：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/e1b74467-9142-4a2f-bf5e-89aa2c2e0127" alt="Listen for XDebug"></p>
<p>不用改任何东西，直接开撸…</p>
<h4 id="开启Debug"><a href="#开启Debug" class="headerlink" title="开启Debug"></a>开启Debug</h4><p>确保phpStudy启动了，网站也正常运行起来了,然后在Visual Studio Code中启动调试，打上要的断点，接着启动调试。</p>
<p>如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/7ac86cce-edc6-49a6-abb6-44f74c55a027" alt="图片描述"></p>
<p>接着访问你要调试的页面对应的PHP代码，打上你的断点，华丽丽的Debug出来了…</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/7f7739df-02d4-47e5-8e42-67b9bd9f75ee" alt="异常"></p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/41913030-362c-45cb-a187-08eed7728e8c" alt="命中断点"></p>
<p>F10单步调试，F11跳入函数，F5直接运行之类的快捷键自己玩吧。</p>
<h4 id="其他运行环境下的配置"><a href="#其他运行环境下的配置" class="headerlink" title="其他运行环境下的配置"></a>其他运行环境下的配置</h4><p>基本没什么区别，配置php.ini，下载到对应版本的xdebug.dll，php.validate.executablePath配置正确就完事。</p>
<p>其他参考链接：</p>
<ol>
<li><p><a href="http://blog.csdn.net/ruihanchen/article/details/7705842" target="_blank" rel="external"> 如何使用XDebug调试php</a></p>
</li>
<li><p><a href="http://www.chenxuanyi.cn/xampp-phpstorm-xdebug.html" target="_blank" rel="external">XAMPP环境下用phpStorm+XDebug进行断点调试的配置</a></p>
</li>
<li><p><a href="http://blog.csdn.net/dc_726/article/details/9905517" target="_blank" rel="external">PHPStorm下XDebug配置</a></p>
</li>
</ol>
<h4 id="PS-果然是世界上最好的语言…-逃"><a href="#PS-果然是世界上最好的语言…-逃" class="headerlink" title="PS:果然是世界上最好的语言…(逃"></a>PS:果然是世界上最好的语言…(逃</h4>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/04/how_to_make_crawler_base_netcore/" itemprop="url">
                  手把手教你用.NET Core写爬虫
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-04T00:00:00+08:00" content="2016-12-04">
              2016-12-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/asp-net-core/" itemprop="url" rel="index">
                    <span itemprop="name">asp.net core</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/04/how_to_make_crawler_base_netcore/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/04/how_to_make_crawler_base_netcore/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>自从上一个项目<a href="https://github.com/liguobao/58HouseSearch" target="_blank" rel="external">58HouseSearch</a>从.NET迁移到.NET core之后，磕磕碰碰磨蹭了一个月才正式上线到新版本。<br>然后最近又开了个新坑，搞了个<a href="http://codelover.win/" target="_blank" rel="external">Dy2018Crawler</a>用来爬dy2018电影天堂上面的电影资源。这里也借机简单介绍一下如何基于.NET Core写一个爬虫。<br>PS：如有偏错，敬请指明…<br>PPS:该去电影院还是多去电影院，毕竟美人良时可无价。</p>
<h3 id="准备工作（-NET-Core准备）"><a href="#准备工作（-NET-Core准备）" class="headerlink" title="准备工作（.NET Core准备）"></a>准备工作（.NET Core准备）</h3><p>首先，肯定是先安装.NET Core咯。下载及安装教程在这里：<a href="https://www.microsoft.com/net/core" target="_blank" rel="external">.NET - Powerful Open Source Development</a>。无论你是Windows、linux还是mac，统统可以玩。</p>
<p>我这里的环境是：Windows10 + VS2015 community updata3 + .NET Core 1.1.0 SDK + .NET Core 1.0.1 tools Preview 2.</p>
<p>理论上，只需要安装一下 .NET Core 1.1.0 SDK 即可开发.NET Core程序，至于用什么工具写代码都无关紧要了。</p>
<p>安装好以上工具之后，在VS2015的新建项目就可以看到.NET Core的模板了。如下图：</p>
<p><img src="https://www.microsoft.com/net/images/screenshots/FileNewProject.png" alt=""></p>
<p>为了简单起见，我们创建的时候，直接选择VS .NET Core tools自带的模板。</p>
<h3 id="一个爬虫的自我修养"><a href="#一个爬虫的自我修养" class="headerlink" title="一个爬虫的自我修养"></a>一个爬虫的自我修养</h3><h4 id="分析网页"><a href="#分析网页" class="headerlink" title="分析网页"></a>分析网页</h4><p>写爬虫之前，我们首先要先去了解一下即将要爬取的网页数据组成。</p>
<p>具体到网页的话，便是分析我们要抓取的数据在HTML里面是用什么标签抑或有什么样的标记，然后使用这个标记把数据从HTML中提取出来。在我这里的话，用的更多的是HTML标签的ID和CSS属性。</p>
<p>以本文章想要爬取的dy2018.com为例,简单描述一下这个过程。dy2018.com主页如下图：</p>
<p><img src="http://7xrayk.com1.z0.glb.clouddn.com/123.png" alt=""></p>
<p>在chrome里面，按F12进入开发者模式，接着如下图使用鼠标选择对应页面数据，然后去分析页面HTML组成。</p>
<p><img src="http://7xrayk.com1.z0.glb.clouddn.com/chromeF12_Select_HTML.png" alt=""></p>
<p>接着我们开始分析页面数据:</p>
<p><img src="http://7xrayk.com1.z0.glb.clouddn.com/chrome_dy2018_lstmovie_divclass.png" alt=""></p>
<p><img src="http://7xrayk.com1.z0.glb.clouddn.com/chrome_dy2018_a.png" alt=""></p>
<p>经过简单分析HTML，我们得到以下结论：</p>
<ol>
<li><p>www.dy2018.com首页的电影数据存储在一个class为co_content222的div标签里面</p>
</li>
<li><p>电影详情链接为a标签，标签显示文本就是电影名称，URL即详情URL</p>
</li>
</ol>
<p>那么总结下来，我们的工作就是：找到class=’co_content222’ 的div标签，从里面提取所有的a标签数据。</p>
<h4 id="开始写代码…"><a href="#开始写代码…" class="headerlink" title="开始写代码…"></a>开始写代码…</h4><p>之前在写<a href="https://zhuanlan.zhihu.com/p/22764927" target="_blank" rel="external">58HouseSearch项目迁移到asp.net core</a>简单提过AngleSharp库，一个基于.NET（C#）开发的专门为解析xHTML源码的DLL组件。</p>
<ol>
<li><p>AngleSharp主页在这里：<a href="https://anglesharp.github.io/" target="_blank" rel="external">https://anglesharp.github.io/</a>，</p>
</li>
<li><p>博客园文章：<a href="http://www.cnblogs.com/pandait/p/AngleSharp.html" target="_blank" rel="external">解析HTML利器AngleSharp介绍</a>，</p>
</li>
<li><p>Nuget地址:<a href="https://www.nuget.org/packages/AngleSharp" target="_blank" rel="external">Nuget AngleSharp</a> 安装命令：Install-Package AngleSharp</p>
</li>
</ol>
<h5 id="获取电影列表数据"><a href="#获取电影列表数据" class="headerlink" title="获取电影列表数据"></a>获取电影列表数据</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> HtmlParser htmlParser = <span class="keyword">new</span> HtmlParser();</div><div class="line"></div><div class="line"><span class="keyword">private</span>  ConcurrentDictionary&lt;<span class="keyword">string</span>, MovieInfo&gt; _cdMovieInfo = <span class="keyword">new</span> ConcurrentDictionary&lt;<span class="keyword">string</span>, MovieInfo&gt;();</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddToHotMovieList</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//此操作不阻塞当前其他操作，所以使用Task</span></div><div class="line">	<span class="comment">// _cdMovieInfo 为线程安全字典，存储了当期所有的电影数据</span></div><div class="line">	Task.Factory.StartNew(()=&gt; </div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">try</span></div><div class="line">	    &#123;</div><div class="line">	        <span class="comment">//通过URL获取HTML</span></div><div class="line">	        <span class="keyword">var</span> htmlDoc = HTTPHelper.GetHTMLByURL(<span class="string">"http://www.dy2018.com/"</span>);</div><div class="line">	        <span class="comment">//HTML 解析成 IDocument</span></div><div class="line">	        <span class="keyword">var</span> dom = htmlParser.Parse(htmlDoc);</div><div class="line">	        <span class="comment">//从dom中提取所有class='co_content222'的div标签</span></div><div class="line">	        <span class="comment">//QuerySelectorAll方法接受 选择器语法 </span></div><div class="line">	        <span class="keyword">var</span> lstDivInfo = dom.QuerySelectorAll(<span class="string">"div.co_content222"</span>);</div><div class="line">	        <span class="keyword">if</span> (lstDivInfo != <span class="literal">null</span>)</div><div class="line">	        &#123;</div><div class="line">	            <span class="comment">//前三个DIV为新电影</span></div><div class="line">	            <span class="keyword">foreach</span> (<span class="keyword">var</span> divInfo <span class="keyword">in</span> lstDivInfo.Take(<span class="number">3</span>))</div><div class="line">	            &#123;</div><div class="line">	                <span class="comment">//获取div中所有的a标签且a标签中含有"/i/"的</span></div><div class="line">	                <span class="comment">//Contains("/i/") 条件的过滤是因为在测试中发现这一块div中的a标签有可能是广告链接</span></div><div class="line">	                divInfo.QuerySelectorAll(<span class="string">"a"</span>).Where(a =&gt; </div><div class="line">	                a.GetAttribute(<span class="string">"href"</span>).Contains(<span class="string">"/i/"</span>))</div><div class="line">	                .ToList().ForEach(</div><div class="line">	                a =&gt;</div><div class="line">	                &#123;</div><div class="line">	                    <span class="comment">//拼接成完整链接</span></div><div class="line">	                    <span class="keyword">var</span> onlineURL = <span class="string">"http://www.dy2018.com"</span> + a.GetAttribute(<span class="string">"href"</span>);</div><div class="line">	                    <span class="comment">//看一下是否已经存在于现有数据中</span></div><div class="line">	                    <span class="keyword">if</span> (!_cdMovieInfo.ContainsKey(onlineURL))</div><div class="line">	                    &#123;</div><div class="line">	                        <span class="comment">//获取电影的详细信息</span></div><div class="line">	                        MovieInfo movieInfo = FillMovieInfoFormWeb(a, onlineURL);</div><div class="line">	                        <span class="comment">//下载链接不为空才添加到现有数据</span></div><div class="line">	                        <span class="keyword">if</span> (movieInfo.XunLeiDownLoadURLList != <span class="literal">null</span> </div><div class="line">	                        &amp;&amp; movieInfo.XunLeiDownLoadURLList.Count != <span class="number">0</span>)</div><div class="line">	                        &#123;</div><div class="line">	                             _cdMovieInfo.TryAdd</div><div class="line">	                             (movieInfo.Dy2018OnlineUrl,movieInfo);</div><div class="line">	                        &#125;</div><div class="line">	                    &#125;</div><div class="line">	                &#125;);</div><div class="line">	            &#125;</div><div class="line">	        &#125;</div><div class="line">	</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">catch</span>(Exception ex)</div><div class="line">	    &#123;</div><div class="line">	</div><div class="line">	    &#125;</div><div class="line">	&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="获取电影详细信息"><a href="#获取电影详细信息" class="headerlink" title="获取电影详细信息"></a>获取电影详细信息</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">private</span> MovieInfo <span class="title">FillMovieInfoFormWeb</span>(<span class="params">AngleSharp.Dom.IElement a, </span></span></div><div class="line"> <span class="keyword">string</span> onlineURL)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> movieHTML = HTTPHelper.GetHTMLByURL(onlineURL);</div><div class="line">    <span class="keyword">var</span> movieDoc = htmlParser.Parse(movieHTML);</div><div class="line">    <span class="comment">//http://www.dy2018.com/i/97462.html 分析过程见上，不再赘述</span></div><div class="line">    <span class="comment">//电影的详细介绍 在id为Zoom的标签中</span></div><div class="line">    <span class="keyword">var</span> zoom = movieDoc.GetElementById(<span class="string">"Zoom"</span>);</div><div class="line">    <span class="comment">//下载链接在 bgcolor='#fdfddf'的td中，有可能有多个链接</span></div><div class="line">    <span class="keyword">var</span> lstDownLoadURL = movieDoc.QuerySelectorAll(<span class="string">"[bgcolor='#fdfddf']"</span>);</div><div class="line">    <span class="comment">//发布时间 在class='updatetime'的span标签中</span></div><div class="line">    <span class="keyword">var</span> updatetime = movieDoc.QuerySelector(<span class="string">"span.updatetime"</span>); </div><div class="line">    <span class="keyword">var</span> pubDate = DateTime.Now;</div><div class="line">    <span class="keyword">if</span>(updatetime!=<span class="literal">null</span> &amp;&amp; !<span class="keyword">string</span>.IsNullOrEmpty(updatetime.InnerHtml))</div><div class="line">    &#123;</div><div class="line">        <span class="comment">//内容带有“发布时间：”字样，</span></div><div class="line">        <span class="comment">//replace成""之后再去转换，转换失败不影响流程</span></div><div class="line">        DateTime.TryParse(updatetime.InnerHtml.Replace(<span class="string">"发布时间："</span>, </div><div class="line">        <span class="string">""</span>), <span class="keyword">out</span> pubDate);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"></div><div class="line">    <span class="keyword">var</span> movieInfo = <span class="keyword">new</span> MovieInfo()</div><div class="line">    &#123;</div><div class="line">        <span class="comment">//InnerHtml中可能还包含font标签，做多一个Replace</span></div><div class="line">        MovieName = a.InnerHtml.Replace(<span class="string">"&lt;font color=\"#0c9000\"&gt;"</span>,<span class="string">""</span>)</div><div class="line">        .Replace(<span class="string">"&lt;font color=\"	#0c9000\"&gt;"</span>,<span class="string">""</span>)</div><div class="line">        .Replace(<span class="string">"&lt;/font&gt;"</span>, <span class="string">""</span>),</div><div class="line">        Dy2018OnlineUrl = onlineURL,</div><div class="line">        MovieIntro = zoom != <span class="literal">null</span> ? WebUtility.HtmlEncode(zoom.InnerHtml) : <span class="string">"暂无介绍..."</span>,</div><div class="line">        <span class="comment">//可能没有简介，虽然好像不怎么可能</span></div><div class="line">        XunLeiDownLoadURLList = lstDownLoadURL != <span class="literal">null</span> ?</div><div class="line">        lstDownLoadURL.Select(d =&gt; d.FirstElementChild.InnerHtml).ToList() : <span class="literal">null</span>,</div><div class="line">        <span class="comment">//可能没有下载链接</span></div><div class="line">        PubDate = pubDate,</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> movieInfo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="HTTPHelper"><a href="#HTTPHelper" class="headerlink" title="HTTPHelper"></a>HTTPHelper</h4><p>这边有个小坑，dy2018网页编码格式是GB2312,.NET Core默认不支持GB2312，使用Encoding.GetEncoding(“GB2312”)的时候会抛出异常。</p>
<p>解决方案是手动安装System.Text.Encoding.CodePages包(Install-Package System.Text.Encoding.CodePages),</p>
<p>然后在Starup.cs的Configure方法中加入Encoding.RegisterProvider(CodePagesEncodingProvider.Instance),接着就可以正常使用Encoding.GetEncoding(“GB2312”)了。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Net.Http;</div><div class="line"><span class="keyword">using</span> System.Net.Http.Headers;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Dy2018Crawler</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HTTPHelper</span></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> HttpClient Client &#123; <span class="keyword">get</span>; &#125; = <span class="keyword">new</span> HttpClient();</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetHTMLByURL</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                System.Net.WebRequest wRequest = System.Net.WebRequest.Create(url);</div><div class="line">                wRequest.ContentType = <span class="string">"text/html; charset=gb2312"</span>;</div><div class="line"></div><div class="line">                wRequest.Method = <span class="string">"get"</span>;</div><div class="line">                wRequest.UseDefaultCredentials = <span class="literal">true</span>;</div><div class="line">                <span class="comment">// Get the response instance.</span></div><div class="line">                <span class="keyword">var</span> task = wRequest.GetResponseAsync();</div><div class="line">                System.Net.WebResponse wResp = task.Result;</div><div class="line">                System.IO.Stream respStream = wResp.GetResponseStream();</div><div class="line">                <span class="comment">//dy2018这个网站编码方式是GB2312,</span></div><div class="line">                <span class="keyword">using</span> (System.IO.StreamReader reader =</div><div class="line">                <span class="keyword">new</span> System.IO.StreamReader(respStream,</div><div class="line">                Encoding.GetEncoding(<span class="string">"GB2312"</span>)))</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">return</span> reader.ReadToEnd();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception ex)</div><div class="line">            &#123;</div><div class="line">                Console.WriteLine(ex.ToString());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">string</span>.Empty;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">       </div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="定时任务的实现"><a href="#定时任务的实现" class="headerlink" title="定时任务的实现"></a>定时任务的实现</h3><p>定时任务我这里使用的是<a href="https://www.nuget.org/packages/Pomelo.AspNetCore.TimedJob/1.1.0-rtm-10026" target="_blank" rel="external">Pomelo.AspNetCore.TimedJob</a>。</p>
<p>Pomelo.AspNetCore.TimedJob是一个.NET Core实现的定时任务job库，支持毫秒级定时任务、从数据库读取定时配置、同步异步定时任务等功能。</p>
<p>由.NET Core社区大神兼前微软MVP<a href="https://www.nuget.org/profiles/AmamiyaYuuko" target="_blank" rel="external">AmamiyaYuuko</a>(入职微软之后就卸任MVP…)开发维护，不过好像没有开源，回头问下看看能不能开源掉。</p>
<p>nuget上有各种版本，按需自取。地址：<a href="https://www.nuget.org/packages/Pomelo.AspNetCore.TimedJob/1.1.0-rtm-10026" target="_blank" rel="external">https://www.nuget.org/packages/Pomelo.AspNetCore.TimedJob/1.1.0-rtm-10026</a></p>
<p>作者自己的介绍文章：<a href="http://www.1234.sh/post/pomelo-extensions-timed-jobs" target="_blank" rel="external">Timed Job - Pomelo扩展包系列</a></p>
<h4 id="Startup-cs相关代码"><a href="#Startup-cs相关代码" class="headerlink" title="Startup.cs相关代码"></a>Startup.cs相关代码</h4><p>我这边使用的话，首先肯定是先安装对应的包：Install-Package Pomelo.AspNetCore.TimedJob -Pre</p>
<p>然后在Startup.cs的ConfigureServices函数里面添加Service,在Configure函数里面Use一下。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Add framework services.</span></div><div class="line">    services.AddMvc();</div><div class="line">    <span class="comment">//Add TimedJob services</span></div><div class="line">    services.AddTimedJob();</div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, </span></span></div><div class="line"> IHostingEnvironment env, ILoggerFactory loggerFactory)</div><div class="line">&#123;</div><div class="line">    <span class="comment">//使用TimedJob</span></div><div class="line">    app.UseTimedJob();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (env.IsDevelopment())</div><div class="line">    &#123;</div><div class="line">        app.UseDeveloperExceptionPage();</div><div class="line">        app.UseBrowserLink();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        app.UseExceptionHandler(<span class="string">"/Home/Error"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    app.UseStaticFiles();</div><div class="line"></div><div class="line">    app.UseMvc(routes =&gt;</div><div class="line">    &#123;</div><div class="line">        routes.MapRoute(</div><div class="line">            name: <span class="string">"default"</span>,</div><div class="line">            template: <span class="string">"&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;"</span>);</div><div class="line">    &#125;);</div><div class="line">    Encoding.RegisterProvider(CodePagesEncodingProvider.Instance);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Job相关代码"><a href="#Job相关代码" class="headerlink" title="Job相关代码"></a>Job相关代码</h4><p>接着新建一个类，明明为XXXJob.cs,引用命名空间using Pomelo.AspNetCore.TimedJob，XXXJob继承于Job，添加以下代码。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutoGetMovieListJob</span>:<span class="title">Job</span></div><div class="line"> &#123;</div><div class="line">     </div><div class="line">     <span class="comment">// Begin 起始时间；Interval执行时间间隔，单位是毫秒，建议使用以下格式，此处为3小时；</span></div><div class="line">     <span class="comment">//SkipWhileExecuting是否等待上一个执行完成，true为等待；</span></div><div class="line">     [Invoke(Begin = <span class="string">"2016-11-29 22:10"</span>, Interval = <span class="number">1000</span> * <span class="number">3600</span>*<span class="number">3</span>, SkipWhileExecuting =<span class="literal">true</span>)]</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Run</span>(<span class="params"></span>)</span></div><div class="line">     &#123;</div><div class="line">          <span class="comment">//Job要执行的逻辑代码</span></div><div class="line">          </div><div class="line">         <span class="comment">//LogHelper.Info("Start crawling");</span></div><div class="line">         <span class="comment">//AddToLatestMovieList(100);</span></div><div class="line">         <span class="comment">//AddToHotMovieList();</span></div><div class="line">         <span class="comment">//LogHelper.Info("Finish crawling");</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="项目发布相关"><a href="#项目发布相关" class="headerlink" title="项目发布相关"></a>项目发布相关</h3><h4 id="新增runtimes节点"><a href="#新增runtimes节点" class="headerlink" title="新增runtimes节点"></a>新增runtimes节点</h4><p>使用VS2015新建的模板工程，project.json配置默认是没有runtimes节点的.</p>
<p>我们想要发布到非Windows平台的时候，需要手动配置一下此节点以便生成。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  <span class="string">"runtimes"</span>: &#123;</div><div class="line">  <span class="string">"win7-x64"</span>: &#123;&#125;,</div><div class="line">  <span class="string">"win7-x86"</span>: &#123;&#125;,</div><div class="line">  <span class="string">"osx.10.10-x64"</span>: &#123;&#125;,</div><div class="line">  <span class="string">"osx.10.11-x64"</span>: &#123;&#125;,</div><div class="line">  <span class="string">"ubuntu.14.04-x64"</span>: &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="删除-注释scripts节点"><a href="#删除-注释scripts节点" class="headerlink" title="删除/注释scripts节点"></a>删除/注释scripts节点</h4><p>生成时会调用node.js脚本构建前端代码，这个不能确保每个环境都有bower存在…注释完事。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//"scripts": &#123;</span></div><div class="line"><span class="comment">//  "prepublish": [ "bower install", "dotnet bundle" ],</span></div><div class="line"><span class="comment">//  "postpublish": [ "dotnet publish-iis --publish-folder %publish:OutputPath% --framework %publish:FullTargetFramework%" ]</span></div><div class="line"><span class="comment">//&#125;,</span></div></pre></td></tr></table></figure></p>
<h4 id="删除-注释dependencies节点里面的type"><a href="#删除-注释dependencies节点里面的type" class="headerlink" title="删除/注释dependencies节点里面的type"></a>删除/注释dependencies节点里面的type</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">"dependencies"</span>: &#123;</div><div class="line">    <span class="string">"Microsoft.NETCore.App"</span>: &#123;</div><div class="line">      <span class="string">"version"</span>: <span class="string">"1.1.0"</span></div><div class="line">      <span class="comment">//"type": "platform"</span></div><div class="line">    &#125;,</div></pre></td></tr></table></figure>
<p>project.json的相关配置说明可以看下这个官方文档：<a href="https://github.com/aspnet/Home/wiki/Project.json-file" target="_blank" rel="external">Project.json-file</a>,<br>或者张善友老师的文章<a href="http://www.cnblogs.com/shanyou/p/5693453.html" target="_blank" rel="external">.NET Core系列 ： 2 、project.json 这葫芦里卖的什么药</a></p>
<h4 id="开发编译发布"><a href="#开发编译发布" class="headerlink" title="开发编译发布"></a>开发编译发布</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//还原各种包文件</div><div class="line">dotnet restore;</div><div class="line"></div><div class="line">//发布到C:\code\website\Dy2018Crawler文件夹</div><div class="line">dotnet publish -r ubuntu.14.04-x64 -c Release -o &quot;C:\code\website\Dy2018Crawler&quot;;</div></pre></td></tr></table></figure>
<p>最后，照旧开源……以上代码都在下面找到：</p>
<p>Gayhub地址：<a href="https://github.com/liguobao/Dy2018Crawler" target="_blank" rel="external">https://github.com/liguobao/Dy2018Crawler</a></p>
<p>在线地址：<a href="http://codelover.win/" target="_blank" rel="external">http://codelover.win/</a></p>
<p>PS:回头写个爬片大家滋持不啊…</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/01/webchat_JS_SDK/" itemprop="url">
                  ASP.NET MVC 微信JS-SDK认证
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-11-01T00:00:00+08:00" content="2016-11-01">
              2016-11-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/net/" itemprop="url" rel="index">
                    <span itemprop="name">.net</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/11/01/webchat_JS_SDK/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/01/webchat_JS_SDK/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>前阵子因为有个项目需要做微信自定义分享功能，因而去研究了下微信JS-SDK相关知识。</p>
<p>此文做个简单的记(tu)录(cao)…</p>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><p>所有的东西都从文档开始:<a href="http://mp.weixin.qq.com/wiki/11/74ad127cc054f6b80759c40f77ec03db.html" target="_blank" rel="external">微信JSSDK说明文档</a></p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/44b1232e-9311-4abb-9200-6dd4936d7c47" alt="分享接口"></p>
<p>项目需要用到的是<a href="http://mp.weixin.qq.com/wiki/11/74ad127cc054f6b80759c40f77ec03db.html#.E5.88.86.E4.BA.AB.E6.8E.A5.E5.8F.A3" target="_blank" rel="external">分享接口</a> 不过使用微信JS-SDK之前，需要做JS接口认证。</p>
<p>认证如下：</p>
<p>步骤一：绑定域名</p>
<p>步骤二：引入JS文件</p>
<p>步骤三：通过config接口注入权限验证配置</p>
<p>步骤四：通过ready接口处理成功验证</p>
<p>步骤五：通过error接口处理失败验证</p>
<p>步骤一中允许使用域名/子域名，只要xx.com/xxx.txt或者xx.com/mp/xxx.txt能访问就好。域名认证通过之后，此域名下的所有端口的网站都可以使用JS-SDK。</p>
<p>步骤二没什么问题，略过。</p>
<p>步骤三最磨人，下面单独讲解。</p>
<h3 id="config接口注入权限验证配置"><a href="#config接口注入权限验证配置" class="headerlink" title="config接口注入权限验证配置"></a>config接口注入权限验证配置</h3><p>先来一段说明：<br><figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用</div><div class="line">（同一个<span class="built_in">url</span>仅需调用一次，对于变化<span class="built_in">url</span>的SPA的web app可在每次<span class="built_in">url</span>变化时进行调用,</div><div class="line">目前Android微信客户端不支持pushState的H5新特性，</div><div class="line">所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6<span class="number">.2</span>中修复）。</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">wx.config(&#123;</div><div class="line">    debug: <span class="literal">true</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，</span></div><div class="line">    <span class="comment">//若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></div><div class="line">    appId: <span class="string">''</span>, <span class="comment">// 必填，公众号的唯一标识</span></div><div class="line">    timestamp: , <span class="comment">// 必填，生成签名的时间戳</span></div><div class="line">    nonceStr: <span class="string">''</span>, <span class="comment">// 必填，生成签名的随机串</span></div><div class="line">    signature: <span class="string">''</span>,<span class="comment">// 必填，签名，见附录1</span></div><div class="line">    jsApiList: [] <span class="comment">// 必填，需要使用的JS接口列表，所有JS接口列表见附录2</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>看到这里肯定懵逼了，这是都什么鬼…怎么玩啊。</p>
<p>提示我们去看附录1…看完之后总结如下：</p>
<ol>
<li>使用config接口注入权限验证配置，重点是生成合法的signatrue</li>
<li>生成signature需要通过appid和secret获取token</li>
<li>时间戳和调用接口URL必不可少</li>
<li>此操作需要服务端完成，不能使用客户端实现</li>
</ol>
<p>整个过程变成：</p>
<ol>
<li><p>通过appid和secret获取access_token，接着使用token获取jsapi_ticket；</p>
</li>
<li><p>拿到jsapi_ticket之后，把jsapi_ticket、时间戳、随机字符串、接口调用页面URL 拼接成完整字符串，使用sha1算法加密得到signature。</p>
</li>
<li><p>最后返回至页面，在wx.config里面填入appid，上一步的时间戳timestamp，上一部的随机字符串、sha1拿到的signature，想要使用的JS接口。</p>
</li>
</ol>
<p>废话少说，直接上代码吧。</p>
<h3 id="代码时间"><a href="#代码时间" class="headerlink" title="代码时间"></a>代码时间</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WeiXinController</span> : <span class="title">Controller</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> appid =</div><div class="line">    System.Web.Configuration.WebConfigurationManager.AppSettings[<span class="string">"wxappid"</span>];</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> secret =</div><div class="line">    System.Web.Configuration.WebConfigurationManager.AppSettings[<span class="string">"wxsecret"</span>];</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">bool</span> isDedug =</div><div class="line">    System.Web.Configuration.WebConfigurationManager.AppSettings[<span class="string">"IsDebug"</span>] ==<span class="string">"true"</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> _ticket = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DateTime _lastTimestamp;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Info</span>(<span class="params"><span class="keyword">string</span> url,<span class="keyword">string</span> noncestr</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(_ticket) || </div><div class="line">        _lastTimestamp == <span class="literal">null</span> || (_lastTimestamp - DateTime.Now).Milliseconds &gt; <span class="number">7200</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> resultString = HTTPHelper.GetHTMLByURL</div><div class="line">            (<span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid="</span></div><div class="line">                + appid + <span class="string">"&amp;secret="</span> + secret);</div><div class="line">            <span class="keyword">dynamic</span> resultValue = JsonConvert.DeserializeObject&lt;<span class="keyword">dynamic</span>&gt;(resultString);</div><div class="line">            <span class="keyword">if</span> (resultValue == <span class="literal">null</span> || resultValue.access_token == <span class="literal">null</span> </div><div class="line">            || resultValue.access_token.Value == <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; issuccess = <span class="literal">false</span>, </div><div class="line">                error = <span class="string">"获取token失败"</span> &#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">var</span> token = resultValue.access_token.Value;</div><div class="line"></div><div class="line">            resultString = HTTPHelper.GetHTMLByURL</div><div class="line">            (<span class="string">"https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token="</span> + </div><div class="line">            token + <span class="string">"&amp;type=jsapi"</span>);</div><div class="line">            <span class="keyword">dynamic</span> ticketValue = JsonConvert.DeserializeObject&lt;<span class="keyword">dynamic</span>&gt;(resultString);</div><div class="line">            <span class="keyword">if</span> (ticketValue == <span class="literal">null</span> || ticketValue.errcode == <span class="literal">null</span></div><div class="line">            || ticketValue.errcode.Value != <span class="number">0</span> || ticketValue.ticket == <span class="literal">null</span>)</div><div class="line">                <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; issuccess = <span class="literal">false</span>,</div><div class="line">                error = <span class="string">"获取ticketValue失败"</span> &#125;);</div><div class="line">            _ticket = ticketValue.ticket.Value;</div><div class="line">            _lastTimestamp = DateTime.Now;</div><div class="line">            <span class="keyword">var</span> timestamp = GetTimeStamp();</div><div class="line">            <span class="keyword">var</span> hexString = <span class="keyword">string</span>.Format(<span class="string">"jsapi_ticket=&#123;0&#125;&amp;noncestr=&#123;3&#125;&amp;timestamp=&#123;1&#125;&amp;url=&#123;2&#125;"</span>,</div><div class="line">            _ticket, timestamp, url,noncestr);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123;</div><div class="line">                issuccess = <span class="literal">true</span>, </div><div class="line">                sha1value = GetSHA1Value(hexString), </div><div class="line">                timestamp = timestamp, </div><div class="line">                url = url, </div><div class="line">                appid = appid, </div><div class="line">                debug=isDedug,</div><div class="line">                tiket=_ticket</div><div class="line">            &#125;);</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> timestamp = GetTimeStamp();</div><div class="line">            <span class="keyword">var</span> hexString = <span class="keyword">string</span>.Format(<span class="string">"jsapi_ticket=&#123;0&#125;&amp;noncestr=1234567890123456&amp;timestamp=&#123;1&#125;&amp;url=&#123;2&#125;"</span>,</div><div class="line">               _ticket, timestamp, url);</div><div class="line">            <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; </div><div class="line">                issuccess = <span class="literal">true</span>, sha1value = GetSHA1Value(hexString),</div><div class="line">                timestamp = timestamp, url = url,</div><div class="line">                appid = appid, debug = isDedug,tiket = _ticket</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetSHA1Value</span>(<span class="params"><span class="keyword">string</span> sourceString</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> hash = SHA1.Create().ComputeHash(Encoding.UTF8.GetBytes(sourceString));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">string</span>.Join(<span class="string">""</span>, </div><div class="line">        hash.Select(b =&gt; b.ToString(<span class="string">"x2"</span>)).ToArray());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetTimeStamp</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        TimeSpan ts = DateTime.Now - <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> Convert.ToInt64(ts.TotalSeconds).ToString();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HTTPHelper</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetHTMLByURL</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">string</span> htmlCode = <span class="keyword">string</span>.Empty;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            HttpWebRequest webRequest = (System.Net.HttpWebRequest)System.Net.WebRequest.Create(url);</div><div class="line">            webRequest.Timeout = <span class="number">30000</span>;</div><div class="line">            webRequest.Method = <span class="string">"GET"</span>;</div><div class="line">            webRequest.UserAgent = <span class="string">"Mozilla/4.0"</span>;</div><div class="line">            webRequest.Headers.Add(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip, deflate"</span>);</div><div class="line">            HttpWebResponse webResponse = (System.Net.HttpWebResponse)webRequest.GetResponse();</div><div class="line">            <span class="comment">//获取目标网站的编码格式</span></div><div class="line">            <span class="keyword">string</span> contentype = webResponse.Headers[<span class="string">"Content-Type"</span>];</div><div class="line">            Regex regex = <span class="keyword">new</span> Regex(<span class="string">"charset\\s*=\\s*[\\W]?\\s*([\\w-]+)"</span>, RegexOptions.IgnoreCase);</div><div class="line">            <span class="keyword">if</span> (webResponse.ContentEncoding.ToLower() == <span class="string">"gzip"</span>)<span class="comment">//如果使用了GZip则先解压</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">using</span> (System.IO.Stream streamReceive = webResponse.GetResponseStream())</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">using</span> (<span class="keyword">var</span> zipStream = <span class="keyword">new</span> System.IO.Compression.GZipStream(streamReceive, </div><div class="line">                    System.IO.Compression.CompressionMode.Decompress))</div><div class="line">                    &#123;</div><div class="line">                        <span class="comment">//匹配编码格式</span></div><div class="line">                        <span class="keyword">if</span> (regex.IsMatch(contentype))</div><div class="line">                        &#123;</div><div class="line">                            Encoding ending = Encoding.GetEncoding</div><div class="line">                            (regex.Match(contentype).Groups[<span class="number">1</span>].Value.Trim());</div><div class="line">                            <span class="keyword">using</span> (StreamReader sr = <span class="keyword">new</span> System.IO.StreamReader(zipStream, ending))</div><div class="line">                            &#123;</div><div class="line">                                htmlCode = sr.ReadToEnd();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">else</span></div><div class="line">                        &#123;</div><div class="line">                            <span class="keyword">using</span> (StreamReader sr = <span class="keyword">new</span> System.IO.StreamReader(zipStream, Encoding.UTF8))</div><div class="line">                            &#123;</div><div class="line">                                htmlCode = sr.ReadToEnd();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">using</span> (System.IO.Stream streamReceive = webResponse.GetResponseStream())</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">var</span> encoding = Encoding.Default;</div><div class="line">                    <span class="keyword">if</span> (contentype.Contains(<span class="string">"utf"</span>))</div><div class="line">                        encoding = Encoding.UTF8;</div><div class="line">                    <span class="keyword">using</span> (System.IO.StreamReader sr = <span class="keyword">new</span> System.IO.StreamReader(streamReceive, encoding))</div><div class="line">                    &#123;</div><div class="line">                        htmlCode = sr.ReadToEnd();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> htmlCode;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (Exception ex)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>PS：这里要注意缓存一下_ticket（即access_token），照微信文档说的，access_token两个小时内有效，不需要频繁调用。而且获取access_token的接口有调用次数的限制，如果超过了次数，就不允许调用了。</p>
<p>PPS:建议noncestr和URL由前台传入比较适合，使用 var theWebUrl = window.location.href.split(‘#’)[0] 获取URL，noncestr就随意了。</p>
<p>PPPS:遇到诡异的invalid signature的时候，首先检查url参数，然后检查noncestr，再不行重启一下程序获取一个新的token回来继续玩。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/22/javascript_requirejs_rf_code/" itemprop="url">
                  使用requirejs编写模块化代码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-22T00:00:00+08:00" content="2016-10-22">
              2016-10-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/22/javascript_requirejs_rf_code/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/22/javascript_requirejs_rf_code/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>最早接触javascript的时候，javascript代码直接扔在script标签里面就完事了。</p>
<p>反正代码不多，交互简单，逻辑不难，和HTML混在一起也未尝不可。</p>
<p>后来交互越来越复杂，代码越多越多了，我们就开始把JS代码独立到了单独的JS文件中。</p>
<p>公共的库引用在前，自己的逻辑代码引用在后，全局变量定义在HTML内部，在独立JS文件中直接使用变量就好。</p>
<p>我们会经常看到下面这种代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">　　<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"1.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">　　<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">　　<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"3.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">　　<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"4.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">　　<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"5.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">　　<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"6.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>通过script标签顺序去js管理依赖关系。</p>
<p>阮一峰老师在<a href="http://www.ruanyifeng.com/blog/2012/11/require_js.html" target="_blank" rel="external">Javascript模块化编程（三）：require.js的用法</a><br>一文中总结了这样写法的缺点：</p>
<p>首先，加载的时候，浏览器会停止网页渲染，加载文件越多，网页失去响应的时间就会越长；</p>
<p>其次，由于js文件之间存在依赖关系，因此必须严格保证加载顺序（比如上例的1.js要在2.js的前面），依赖性最大的模块一定要放到最后加载.</p>
<p>当依赖关系很复杂的时候，代码的编写和维护都会变得困难。</p>
<p>而requirejs的诞生便是为了解决这个问题。</p>
<h3 id="requirejs"><a href="#requirejs" class="headerlink" title="requirejs"></a><a href="http://requirejs.org/docs/download.html" target="_blank" rel="external">requirejs</a></h3><p>在<a href="http://requirejs.org/docs/download.html" target="_blank" rel="external">官网</a>把requirejs 下载回来之后。使用一般的方法引入：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/require.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>但是这样的方法，还是可能在加载require.js的时候导致网页失去响应。解决方案一般有两种：</p>
<ol>
<li><p>把上面的代码放到网页底部</p>
</li>
<li><p>使用异步的方法加载，如下：</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/require.js"</span> <span class="attr">defer</span> <span class="attr">async</span>=<span class="string">"true"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p><a href="http://www.w3school.com.cn/html5/att_script_async.asp" target="_blank" rel="external">async属性</a> 表明这个文件需要异步加载，避免网页失去响应。</p>
<p>不过IE下不支持这个属性，只支持defer，所以可以把defer也写上。</p>
<h3 id="加载主模块"><a href="#加载主模块" class="headerlink" title="加载主模块"></a>加载主模块</h3><p>在上一步，我们已经引入了require了，那么require怎么知道我们究竟要加载什么东西呢？答案是使用data-main属性。<br>假设我们的主模块为js/home.js,引入代码应该如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">　<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/require.js"</span> <span class="attr">data-main</span>=<span class="string">"js/home"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">//require.js默认文件后缀为js，所以home.js可以写成home。</div></pre></td></tr></table></figure></p>
<p>接下来我使用<a href="https://github.com/liguobao/58HouseSearch" target="_blank" rel="external">58HouseSearch</a> 的代码来讲解一下require的使用。</p>
<p>在此项目里面，重构前大概就是JS变量漫天飞，js文件里面各种函数到处乱放。一开始用起来还没什么，后来加入了更多功能的时候，JS代码维护起来就疼不欲生了。因此托了个小伙伴帮忙使用模块化思想重构了一下JS代码。</p>
<p>上面说了，我们首先需要创建我们的模块，在这个项目里面，主模块叫home.js。</p>
<p>home.js中我们需要配置一下require.config.<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">require.config(&#123;</div><div class="line">    baseUrl: <span class="string">'/DomainJS/'</span>,</div><div class="line">    paths: &#123;</div><div class="line">        jquery: <span class="string">"lib/jquery-1.11.3.min"</span>,</div><div class="line">        <span class="string">"AMUI"</span>: <span class="string">"lib/amazeui.2.7.1.min"</span>,</div><div class="line">        <span class="string">"jquery.range"</span>: <span class="string">"lib/jquery.range"</span>,</div><div class="line">        <span class="string">"es5"</span>: <span class="string">"lib/es5"</span>,</div><div class="line">        <span class="string">"mapController"</span>: <span class="string">"mapController"</span>,</div><div class="line">        <span class="string">"addToolbar"</span>: <span class="string">"addToolbar"</span>,</div><div class="line">    &#125;,</div><div class="line">    shim: &#123;</div><div class="line">        <span class="string">"addToolbar"</span>: &#123;</div><div class="line">            deps: [<span class="string">"jquery"</span>]</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"jquery.range"</span>: &#123;</div><div class="line">            deps: [<span class="string">"jquery"</span>]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>在这里我主要配置了一下baseURL(所有模块的查找根路径)，paths(名称映射)，shim(<br>为那些没有使用define()来声明依赖关系、设置模块的”浏览器全局变量注入”型脚本做依赖和导出配置。)</p>
<p>关于require.config的详细内容可以看下下面这些文章：</p>
<ol>
<li><a href="https://segmentfault.com/a/1190000002401665" target="_blank" rel="external">RequireJS进阶:配置文件的学习</a> </li>
<li><a href="https://segmentfault.com/a/1190000002403806" target="_blank" rel="external">RequireJS进阶:模块的优化及配置的详解</a></li>
</ol>
<p>配置做完了，我们也可以开始真正写我们的逻辑代码了,我们使用require来加载我们需要的库。<br>代码如下：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">require(['domready!', 'jquery', 'AMUI', 'mapController', 'city', 'commuteGo'], </div><div class="line"></div><div class="line">function (<span class="name">doc</span>, $, AMUI, mapController, city, commuteGo) &#123;</div><div class="line">    city.initAllCityInfo()<span class="comment">;</span></div><div class="line">    mapController.init()<span class="comment">;</span></div><div class="line"></div><div class="line">    $(<span class="string">"input[name='locationType']"</span>).bind('click', </div><div class="line">    mapController.locationMethodOnChange)</div><div class="line"></div><div class="line">    $(<span class="string">"input[name='vehicle']"</span>).bind('click', commuteGo.go)</div><div class="line"></div><div class="line">    $('#Get58Data').bind('click', function(<span class="name">e</span>) &#123;</div><div class="line">        e.preventDefault()<span class="comment">;</span></div><div class="line">     </div><div class="line">        mapController.Get58DataClick()<span class="comment">;</span></div><div class="line">        e.stopPropagation()<span class="comment">;</span></div><div class="line">    &#125;)<span class="comment">;</span></div><div class="line"></div><div class="line"> </div><div class="line">    $.ajax(&#123;</div><div class="line">        type: <span class="string">"post"</span>,</div><div class="line">        url: <span class="string">"../Commom/GetPVCount"</span>,</div><div class="line">        data: &#123; &#125;,</div><div class="line">        success: function (<span class="name">result</span>)</div><div class="line">        &#123;</div><div class="line">            if (<span class="name">result</span>.IsSuccess)&#123;</div><div class="line">                $(<span class="string">"#lblPVCount"</span>).text(<span class="name">result</span>.PVCount)<span class="comment">;</span></div><div class="line">            &#125;else &#123;</div><div class="line">                $(<span class="string">"#lblPVCount"</span>).text(<span class="number">0</span>)<span class="comment">;</span></div><div class="line">                console.log(<span class="name">result</span>.Error)<span class="comment">;</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;)<span class="comment">;</span></div><div class="line"></div><div class="line">    $('#search-offcanvas').offCanvas(&#123; effect: 'overlay' &#125;)<span class="comment">;</span></div><div class="line"></div><div class="line">    $(<span class="string">".amap-sug-result"</span>).css(<span class="string">"z-index"</span>, <span class="number">9999</span>)<span class="comment">;</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>忽略function里面的具体逻辑，加载如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>([<span class="string">'domready!'</span>, <span class="string">'jquery'</span>, <span class="string">'AMUI'</span>, <span class="string">'mapController'</span>, <span class="string">'city'</span>, <span class="string">'commuteGo'</span>], </div><div class="line"><span class="function"><span class="keyword">function</span> (<span class="params">doc, $, AMUI, mapController, city, commuteGo</span>)</span>&#123;</div><div class="line"></div><div class="line"><span class="comment">//todo</span></div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>第一个参数为一个数组，表示所依赖的模块，此处为[‘domready!’, ‘jquery’, ‘AMUI’, ‘mapController’, ‘city’, ‘commuteGo’]；</p>
<p>第二个参数为回调函数，当前面指定的模块都全部加载成功之后，便调用此函数。加载的模块会以参数形式传入此函数，从而在回调函数内部就可以使用这些模块啦。</p>
<p>require()异步加载所需模块的时候，此时浏览器并不会失去响应；当前面的模块加载成功之后，执行回调函数才会运行我们的逻辑代码，因此解决了依赖性问题。</p>
<p>讲完了模块加载，我们下面讲一下模块编写。</p>
<h3 id="AMD模块编写"><a href="#AMD模块编写" class="headerlink" title="AMD模块编写"></a>AMD模块编写</h3><p>require.js加载的模块的采用的AMD规范。所以我们的模块必须按照AMD的规定来写。</p>
<p>关于AMD规范详情可以看这个文章：<a href="http://www.ruanyifeng.com/blog/2012/10/asynchronous_module_definition.html" target="_blank" rel="external">Javascript模块化编程（二）：AMD规范</a></p>
<p>模块有两个情况，不依赖其他模块和依赖其他模块。</p>
<h4 id="不依赖其他模块"><a href="#不依赖其他模块" class="headerlink" title="不依赖其他模块"></a>不依赖其他模块</h4><p>直接define定义，使用function回调。</p>
<p><a href="https://github.com/liguobao/58HouseSearch/blob/master/58HouseSearch/DomainJS/helper.js" target="_blank" rel="external">58HouseSearch/DomainJS/helper.js</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">define(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//获取URL中的参数</span></div><div class="line">    <span class="keyword">var</span> getQueryString=  <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(^|&amp;)"</span> + name + <span class="string">"=([^&amp;]*)(&amp;|$)"</span>);</div><div class="line">        <span class="keyword">var</span> r = <span class="built_in">window</span>.location.search.substr(<span class="number">1</span>).match(reg);</div><div class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) <span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]); <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        getQueryString: getQueryString,</div><div class="line">    &#125;;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<h4 id="依赖其他模块"><a href="#依赖其他模块" class="headerlink" title="依赖其他模块"></a>依赖其他模块</h4><p>define中如同require一样，用数组表明需要加载的模块，function回调。</p>
<p><a href="https://github.com/liguobao/58HouseSearch/blob/master/58HouseSearch/DomainJS/marker.js" target="_blank" rel="external">58HouseSearch/DomainJS/marker.js</a><br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">define(['mapSignleton', 'city', 'transfer'], </div><div class="line">function(<span class="name">mapSignleton</span>, city, transfer) &#123;</div><div class="line">    var _map = mapSignleton.map<span class="comment">;</span></div><div class="line">    var _workMarker = null<span class="comment">;</span></div><div class="line">    var _markerArray = []<span class="comment">;</span></div><div class="line">    var load = function(<span class="name">x</span>, y, locationName) &#123;</div><div class="line">        _workMarker = new AMap.Marker(&#123;</div><div class="line">            map: _map,</div><div class="line">            title: locationName,</div><div class="line">            icon: 'http<span class="symbol">://webapi</span>.amap.com/theme/v1.<span class="number">3</span>/markers/n/mark_r.png',</div><div class="line">            position: [x, y]</div><div class="line">        &#125;)<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    var add = function(<span class="name">address</span>, rent, href, markBG) &#123;</div><div class="line">        new AMap.Geocoder(&#123;</div><div class="line">            city: city.name,</div><div class="line">            radius: <span class="number">1000</span></div><div class="line">        &#125;).getLocation(<span class="name">address</span>, function(<span class="name">status</span>, result) &#123;</div><div class="line"></div><div class="line">            if (<span class="name">status</span> === <span class="string">"complete"</span> <span class="symbol">&amp;&amp;</span> result.info === 'OK') &#123;</div><div class="line">                var geocode = result.geocodes[<span class="number">0</span>]<span class="comment">;</span></div><div class="line">                var rentMarker = new AMap.Marker(&#123;</div><div class="line">                    map: _map,</div><div class="line">                    title: address,</div><div class="line">                    icon: markBG ? 'IMG/Little/' +</div><div class="line">                    markBG : 'http<span class="symbol">://webapi</span>.amap.com/theme/v1.<span class="number">3</span>/markers/n/mark_b.png',</div><div class="line">                    position: [geocode.location.getLng(), geocode.location.getLat()]</div><div class="line">                &#125;)<span class="comment">;</span></div><div class="line">                _markerArray.push(<span class="name">rentMarker</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">                rentMarker.content = <span class="string">"&lt;div&gt;&lt;a target = '_blank' href='"</span> </div><div class="line">                + href + <span class="string">"'&gt;房源："</span> + address + <span class="string">"  租金："</span> + rent + <span class="string">"&lt;/a&gt;&lt;div&gt;"</span></div><div class="line">                rentMarker.on('click', function(<span class="name">e</span>) &#123;</div><div class="line">                    transfer.add(<span class="name">e</span>, address)<span class="comment">;</span></div><div class="line">                &#125;)<span class="comment">;</span></div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;<span class="comment">;</span></div><div class="line"></div><div class="line">    var clearArray = function() &#123;</div><div class="line">        if (<span class="name">_markerArray</span> <span class="symbol">&amp;&amp;</span> _markerArray.length &gt; <span class="number">0</span>) </div><div class="line">        _map.remove(<span class="name">_markerArray</span>)<span class="comment">;</span></div><div class="line">        _markerArray = []<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    var clear = function() &#123;</div><div class="line">        if (<span class="name">_workMarker</span>) &#123;</div><div class="line">            _map.remove(<span class="name">_workMarker</span>)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return &#123;</div><div class="line">        load: load,</div><div class="line">        add: add,</div><div class="line">        clearArray: clearArray,</div><div class="line">        clear: clear</div><div class="line">    &#125;<span class="comment">;</span></div><div class="line">&#125;)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>这样的话，一个供require调用的模块也就写好了。</p>
<p>最后感谢小伙伴<a href="https://www.zhihu.com/people/piratf" target="_blank" rel="external">Larry Sean</a> 帮忙重构代码。</p>
<p>全文完。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/15/install_Preview2_on_fresh_VS2015_Update3_Installation/" itemprop="url">
                  Microsoft .NET Core 1.0.0 VS 2015 Tooling Preview 2 0x80070003
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-15T13:53:38+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/net-core/" itemprop="url" rel="index">
                    <span itemprop="name">.net core</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/15/install_Preview2_on_fresh_VS2015_Update3_Installation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/15/install_Preview2_on_fresh_VS2015_Update3_Installation/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近安装Microsoft .NET Core 1.0.0 VS 2015 Tooling Preview 2实在有点曲折，忍不住写个文章来讲这货的坑爹之旅了。</p>
<p>一般我们在<a href="https://www.microsoft.com/net/download" target="_blank" rel="external">.NET Downloads</a> 下载回来的Microsoft .NET Core 1.0.0 VS 2015 Tooling Preview 2是一个简易安装包。</p>
<p>它在安装过程中会不断去网络请求需要的msi文件，美名曰：在线安装。</p>
<p>然而在我国的国情以及我国网络运营商的衬托下，在线安装这种东西实在不可恭维。</p>
<p>本来网络稳定，在线安装 这种鬼也还算能用，不过最近微软爸爸不知道为嘛了，.net core相关安装包的下载地址全线失效。<br>如<a href="https://download.microsoft.com/download/0/A/3/0A372822-205D-4A86-BFA7-084D2CBE9EDF/DotNetCore.1.0.1-SDK.1.0.0.Preview2-003133-x64.exe" target="_blank" rel="external">DotNetCore.1.0.1-SDK.1.0.0.Preview2-003133-x64.exe</a>，直接出502 Bad Gateway。</p>
<p>这个还能用迅雷或者命令行下载回来，但是DotNetCore.1.0.1-SDK.1.0.0.Preview2这货安装过程中需要的一下msi安装包，就死活下不回来了。</p>
<h4 id="安装过程报错：0x80070003-系统找不到需要的文件。"><a href="#安装过程报错：0x80070003-系统找不到需要的文件。" class="headerlink" title="安装过程报错：0x80070003 系统找不到需要的文件。"></a>安装过程报错：0x80070003 系统找不到需要的文件。</h4><p>此处已确认是微软爸爸的bug了。<a href="https://github.com/aspnet/Tooling/issues/655" target="_blank" rel="external">issue在这里</a></p>
<p>我们去看安装失败的log，能看到类似下面的log：</p>
<p>Error 0x80072efd: Failed attempt to download URL: ‘<a href="https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/ancm_iis_express_x64_en_rc2_39.msi" target="_blank" rel="external">https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/ancm_iis_express_x64_en_rc2_39.msi</a>‘ to: ‘C:\Users\cneuss\AppData\Local\Temp{C307771D-8D9A-45B5-B514-B6CA69C0C6E2}\ANCM_IISExpress_x64’</p>
<p>很明显这个操作从<a href="https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/ancm_iis_express_x64_en_rc2_39.msi" target="_blank" rel="external">https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/ancm_iis_express_x64_en_rc2_39.msi</a>上面下载ancm_iis_express_x64_en_rc2_39.msi文件。<br>然而我们点击进去，看到这个同样的问题：502 Bad Gateway。</p>
<p>安装到这里，已经GG了。</p>
<p>不过既然知道是因为下载文件的问题了，那么解决办法也应运而生了。</p>
<p>我们完全手动下载文件（用迅雷或者别的下载工具），发布在本地，改hosts地址让下载请求直接从本地下载文件。</p>
<p>这个方案听起来是没有任何的问题的，我也成功使用迅雷把无法下载的文件下载到本地了。然而在改host地址这里卡住了。</p>
<p>不知道为嘛，无论我把<a href="download.microsoft.com">download.microsoft.com</a>指向怎么改，也无法把请求重定向到本地。</p>
<p>后来认真看了下安装log，发现所以的下载操作都是把文件下载到 C:\Users\cneuss\AppData\Local\Temp 目录（具体目录看log文件内容）下的临时路径，报错是系统找不到需要的文件。</p>
<p>那么，我们手动把需要的文件放到对应的位置，问题也就解决了。</p>
<p>所以，为了清晰找到临时路径，安装之前先把“C:\Users\cneuss\AppData\Local\Temp”的文件清空，然后点击安装包。</p>
<p>很快可以在temp路径下看到冒出来的{xxxxxxxxxxxxx}文件夹，然后迅速把我们通过迅雷下载回来的文件仍到这个目录底下。</p>
<p>迅速操作的原因是，在线安装包正在下载所需要的文件，如：ancm_iis_express_x64_en_rc2_39.msi，我们要在下载超时之前把文件应该在的位置，这样的话即使下载没拿到文件，安装程序还是可以拿我们的文件去执行安装。</p>
<p>别的就是不断尝试，看缺少那个msi手动下哪个msi的事情了。</p>
<h4 id="最终方案"><a href="#最终方案" class="headerlink" title="最终方案"></a>最终方案</h4><p>最后，根据log文件，还发现了一个更简单的方法：</p>
<p>在DotNetCore.1.0.1-SDK.1.0.0.Preview2-003133-x64.exe的同级目录下新建packages文件夹，把上面无法在线下载到的msi仍进去，然后就一路绿灯了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/14/visualstudio_shortcut_key/" itemprop="url">
                  VS快捷键（转载）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-14T00:00:00+08:00" content="2016-10-14">
              2016-10-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/memorandum/" itemprop="url" rel="index">
                    <span itemprop="name">memorandum</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/14/visualstudio_shortcut_key/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/14/visualstudio_shortcut_key/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文：<a href="http://www.cnblogs.com/xiaofeixiang/p/3785167.html" target="_blank" rel="external">http://www.cnblogs.com/xiaofeixiang/p/3785167.html</a></p>
<p>ctrl+s         保存（这个确实很简单，要说常用，这玩意绝对排名第一）</p>
<p>ctrl+Shift+S   保存所有VS中打开的所有文件</p>
<p>ctrl+O         打开新文件</p>
<p>ctrl+Shift+O   打开项目</p>
<p>ctrl+Shift+A   当前项目中添加新建项</p>
<p>ctrl+F4        关闭当前打开页</p>
<p>ctrl+F6        跳到下一个窗口</p>
<p>ctrl+Shift+F6  跳到前一个打开的窗口</p>
<p>F12            转到函数定义实现处，或者转到变量定义处（一堆代码中使用这个键确实逻辑会更清晰一点）</p>
<p>ctrl+-         这个相对来说跟F12是配套使用的，F12到函数定义，然后返回原代码中继续查看</p>
<p>shift+ctrl+-   相对于上一个步骤，这个可以再次转到函数定义的地方</p>
<p>ctrl+tab       页面切换，打开页面过多的话，切换用的还是比较多的</p>
<p>ctrl+F         搜索，查找，功能简单粗暴有的时候比很高效</p>
<p>ctrl+F3        在选中区域搜索</p>
<p>ctrl+K，ctrl+D 整个文档格式化</p>
<p>ctrl+K,ctrl+F  格式化选中部分代码</p>
<p>ctrl+K，ctrl+C  代码注释</p>
<p>ctrl+K，ctrl+U  取消代码注释</p>
<p>ctrl+L          删除，删除当前行或者删除选中行</p>
<p>Shift+Alt+Enter 当前代码区域全屏，再按一次取消全屏</p>
<p>ctrl+M，ctrl+M  写代码都喜欢折叠，折叠之后还是还要打开的，可以试试这个快捷键</p>
<p>ctrl+space      代码补全</p>
<p>ctrl+Enter      假如现在当前行上面添加代码光标跳到当前行的上一行</p>
<p>ctrl+Shift+Enter假如现在当前行下面添加代码光标跳到当前行的下一行</p>
<p>Shift+F12       查找函数或者变量的所有引用</p>
<p>ctrl+g          查找行，跳转到你想要跳转的行数</p>
<p>ctrl+Shift+↑    向上查找引用</p>
<p>ctrl+Shift+↓    向下查找引用</p>
<p>Shift+Alt+↑    向上画一条直线，通常如果拷贝代码的时候有行号可以这样去除</p>
<p>Shift+Alt+↓    向下画一条直线，同上</p>
<p>Shift+↑         向上选中代码区域</p>
<p>Shift+↓         向下选中代码区域</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/04/58CityHouseSearch_move_to_aspnetcore/" itemprop="url">
                  58HouseSearch项目迁移到asp.net core
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-04T00:00:00+08:00" content="2016-10-04">
              2016-10-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/asp-net-core/" itemprop="url" rel="index">
                    <span itemprop="name">asp.net core</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/04/58CityHouseSearch_move_to_aspnetcore/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/04/58CityHouseSearch_move_to_aspnetcore/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><a href="https://github.com/liguobao/58HouseSearch" target="_blank" rel="external">58HouseSearch</a>这个项目原本是基于ASP.NET MVC 4写的，开发环境是Windows+VS2015，发布平台是linux+mono+jexus，这样看来整个项目基本已经满足跨平台的需求。</p>
<p>这样一来，本来我是没什么动力去做迁移的，好好的东西闲着没事干才迁移呢。</p>
<p>不过，这不国庆了么？穷人不是在家穷游天下么？所以…真的有点闲着没事干了。</p>
<h3 id="迁移可行性探讨"><a href="#迁移可行性探讨" class="headerlink" title="迁移可行性探讨"></a>迁移可行性探讨</h3><p>项目迁移前，我们还是先来讨论一下迁移可行性。为嘛要进行可行性探讨呢？原因是.NET CORE是一个跨平台的框架，和上一代的.NET存在不兼容。</p>
<p>个人总结一下，迁移的主要的问题在于：代码不兼容、类库不兼容、严重依赖Windows API或者COM组件等。</p>
<h4 id="代码不兼容"><a href="#代码不兼容" class="headerlink" title="代码不兼容"></a>代码不兼容</h4><p>代码不兼容其实不算麻烦。毕竟代码是活的，你我也是活的，不就是一个改字罢了。花点时间慢慢改，总是能搞掂的。</p>
<h4 id="类库不兼容"><a href="#类库不兼容" class="headerlink" title="类库不兼容"></a>类库不兼容</h4><p>要不就弃用，要不就找替代品。</p>
<h4 id="严重依赖Windows-API或者COM组件"><a href="#严重依赖Windows-API或者COM组件" class="headerlink" title="严重依赖Windows API或者COM组件"></a>严重依赖Windows API或者COM组件</h4><p>额？找替代品，找不到可用替代品的话。放弃吧，这个项目别考虑迁移了。</p>
<p>这个故事告诉我们，做跨平台项目的时候，少点用系统API或者组建。</p>
<p>回到58HouseSearch项目上面。</p>
<p>这个项目的代码基本都是我写的，所以重写代码没什么问题。<br>依赖的类库有下面几个:</p>
<ul>
<li><p><a href="https://github.com/FlorianRappl/AngleSharp" target="_blank" rel="external">AngleSharp</a></p>
</li>
<li><p><a href="http://www.newtonsoft.com/json" target="_blank" rel="external">Newtonsoft.Json</a></p>
</li>
<li><p><a href="http://logging.apache.org/log4net/" target="_blank" rel="external">log4net</a></p>
</li>
</ul>
<p>AngleSharp是用来解析HTML的类库，用linq的方式来操作HTML，用起来实在爽快。</p>
<p>如果这货在.net core上不能跑，我应该立马放弃了。<br>不过，这个实在给力…</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/1a950803-3d38-4b16-9761-6c9cd806b0b9" alt="AngleSharp支持平台"></p>
<p>Newtonsoft.Json</p>
<p>在这个项目里面主要是用来记录PV数据的，非核心功能，可有可无。不过看了下nuget上的介绍，也是支持.net core的。</p>
<p>剩下log4net…嗯，并不支持log4net。不过这个就更加是非核心内容了，直接丢了。<br>PS:考虑后期加入Nlog替代log4net。</p>
<p>至于依赖Windows API之类的，在这个项目里面基本没有，所以略过…</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li><a href="https://www.visualstudio.com/downloads/" target="_blank" rel="external">Visual Studio Community 2015 with Update 3 – Free</a></li>
<li><a href="https://www.microsoft.com/net/download" target="_blank" rel="external">.NET Core SDK</a></li>
<li><a href="https://www.microsoft.com/net/download" target="_blank" rel="external">.NET Core</a></li>
<li><a href="https://go.microsoft.com/fwlink/?LinkId=827546" target="_blank" rel="external">.NET Core 1.0.1 - VS 2015 Tooling Preview 2</a></li>
</ul>
<p>友情提示：</p>
<ol>
<li>Visual Studio Community 2015 with Update 3 下载镜像来安装。</li>
</ol>
<p>错误操作如下：<br><img src="http://7xread.com1.z0.glb.clouddn.com/1e723e08-b3d5-4dab-b4a6-1de70799c4c8" alt="错误操作"></p>
<p>正确打开方式：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/706771d8-d3f2-4122-a61d-5e961887121a" alt="正确的打开方式-1"></p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/455ec5cc-b429-4563-a4fb-3a0c18608969" alt="正确的打开方式-2"></p>
<ol>
<li><p>安装.NET Core SDK和.NET Core之后再安装.NET Core 1.0.1 - VS 2015 Tooling Preview 2</p>
</li>
<li><p>安装.NET Core 1.0.1 - VS 2015 Tooling Preview 2 这货的可能会报错0x80072f8a未指定的错误</p>
</li>
</ol>
<p>解决方案见下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/47c517d1-4b48-4088-be4a-a0768413e768" alt="图片描述"></p>
<p>详细见链接：<a href="http://www.cnblogs.com/JiaoWoWeiZai/p/5892255.html" target="_blank" rel="external">安装DotNetCore.1.0.1-VS2015Tools.Preview2.0.2出现0x80072f8a未指定的错误</a></p>
<p>上面都弄好之后，理论上在VS2O15-新建项目里面可以看到ASP.NET CORE的模板了。如下图：<br><img src="http://7xread.com1.z0.glb.clouddn.com/3364e7c9-a41e-47f2-8d08-60345e4efa35" alt="ASP.NET CORE的模板"></p>
<h3 id="项目迁移"><a href="#项目迁移" class="headerlink" title="项目迁移"></a>项目迁移</h3><h4 id="新建空白ASP-NET-CORE项目"><a href="#新建空白ASP-NET-CORE项目" class="headerlink" title="新建空白ASP.NET CORE项目"></a>新建空白ASP.NET CORE项目</h4><p>新建好了之后如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/e047d81d-56f1-4e51-9d72-7989e1fc6225" alt="空白ASP.NET CORE项目"></p>
<h4 id="Nuget获取引用"><a href="#Nuget获取引用" class="headerlink" title="Nuget获取引用"></a>Nuget获取引用</h4><p><a href="https://www.nuget.org/packages/AngleSharp/" target="_blank" rel="external">https://www.nuget.org/packages/AngleSharp/</a></p>
<p><a href="https://www.nuget.org/packages/Newtonsoft.Json" target="_blank" rel="external">https://www.nuget.org/packages/Newtonsoft.Json</a></p>
<h4 id="添加Controllers文件夹"><a href="#添加Controllers文件夹" class="headerlink" title="添加Controllers文件夹"></a>添加Controllers文件夹</h4><p>然后把之前项目的Controllers拷贝过来，改掉命名空间，去掉无用代码，添加相应引用。</p>
<h4 id="添加Views文件夹"><a href="#添加Views文件夹" class="headerlink" title="添加Views文件夹"></a>添加Views文件夹</h4><p>本项目直接把之前项目的Views拷贝过来是完全没有问题的。</p>
<h4 id="静态文件处理"><a href="#静态文件处理" class="headerlink" title="静态文件处理"></a>静态文件处理</h4><p>asp.net core MVC中的文件结构和asp.net mvc的文件结构略有不同。</p>
<p>asp.net core MVC在view中“IMG/Little/PaleGreen.png”对应的文件对应于“项目路径/webroot/IMG/Little/PaleGreen.png”；</p>
<p>而asp.net mvc中，对应路径为“项目/IMG/Little/PaleGreen.png”。</p>
<p>因而，我们的所有静态文件都应该放到：webroot文件夹下。</p>
<p>上面的都做完了之后，项目结构如下：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/2fee156b-2505-4953-bfe9-1d2521f13565" alt="项目结构"></p>
<p>接下来就是改代码了。</p>
<h3 id="代码迁移"><a href="#代码迁移" class="headerlink" title="代码迁移"></a>代码迁移</h3><h4 id="Startup-cs添加MVC"><a href="#Startup-cs添加MVC" class="headerlink" title="Startup.cs添加MVC"></a>Startup.cs添加MVC</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">public</span> <span class="selector-tag">class</span> <span class="selector-tag">Startup</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></div><div class="line">    <span class="comment">// For more information on how to configure your application, visit http://go.microsoft.com/fwlink/?LinkID=398940</span></div><div class="line">    <span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">ConfigureServices</span>(IServiceCollection services)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">//添加MVC框架</span></div><div class="line">        services<span class="selector-class">.AddMvc</span>();</div><div class="line">        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></div><div class="line">    <span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">Configure</span>(IApplicationBuilder app, IHostingEnvironment env,</div><div class="line">    ILoggerFactory loggerFactory)</div><div class="line">    &#123;</div><div class="line">        loggerFactory<span class="selector-class">.AddConsole</span>();</div><div class="line"></div><div class="line">        <span class="selector-tag">if</span> (env.IsDevelopment())</div><div class="line">        &#123;</div><div class="line">            app<span class="selector-class">.UseDeveloperExceptionPage</span>();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//启用静态文件中间件</span></div><div class="line">        app<span class="selector-class">.UseStaticFiles</span>();</div><div class="line">        <span class="comment">//启动MVC路由</span></div><div class="line">        app<span class="selector-class">.UseMvcWithDefaultRoute</span>();</div><div class="line">        <span class="comment">//设置默认页面</span></div><div class="line">        <span class="selector-tag">app</span><span class="selector-class">.UseMvc</span>(routes =&gt;</div><div class="line">        &#123;</div><div class="line">            <span class="selector-tag">routes</span><span class="selector-class">.MapRoute</span>(</div><div class="line">                <span class="attribute">name</span>: <span class="string">"default"</span>,</div><div class="line">                <span class="attribute">template</span>: <span class="string">"&#123;controller=House&#125;/&#123;action=Index&#125;/&#123;id?&#125;"</span>); </div><div class="line">        &#125;);</div><div class="line"></div><div class="line">      </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="改写GetHTMLByURL方法"><a href="#改写GetHTMLByURL方法" class="headerlink" title="改写GetHTMLByURL方法"></a>改写GetHTMLByURL方法</h4><p>之前的方法：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/d005a100-e3e6-423b-b34c-3eae11b2ab63" alt="old GetHTMLByURL"></p>
<p>.net core重写了HttpWebRequest，变成了WebRequest,所以上面的代码废了。</p>
<p>重写如下：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public static <span class="keyword">string</span> GetHTMLByURL(<span class="keyword">string</span> Url, <span class="keyword">string</span> <span class="built_in">type</span> = <span class="string">"UTF-8"</span>)</div><div class="line">&#123;</div><div class="line">    try</div><div class="line">    &#123;</div><div class="line">        Url = Url.ToLower();</div><div class="line"></div><div class="line">        <span class="keyword">System</span>.Net.WebRequest wReq = <span class="keyword">System</span>.Net.WebRequest.<span class="keyword">Create</span>(Url);</div><div class="line">        <span class="comment">// Get the response instance.</span></div><div class="line">        <span class="keyword">System</span>.Net.WebResponse wResp = wReq.GetResponseAsync().Result;</div><div class="line">        <span class="keyword">System</span>.IO.Stream respStream = wResp.GetResponseStream();</div><div class="line">        using (<span class="keyword">System</span>.IO.StreamReader reader = <span class="keyword">new</span> <span class="keyword">System</span>.IO.</div><div class="line">        StreamReader(respStream, Encoding.GetEncoding(<span class="built_in">type</span>)))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> reader.ReadToEnd();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    catch (<span class="keyword">System</span>.Exception ex)</div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">string</span>.Empty;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="改写Controller代码"><a href="#改写Controller代码" class="headerlink" title="改写Controller代码"></a>改写Controller代码</h4><p>嗯，换了命名空间，别的一句都没改直接拉过来了…略过。</p>
<h3 id="发布到ubuntu"><a href="#发布到ubuntu" class="headerlink" title="发布到ubuntu"></a>发布到ubuntu</h3><p><a href="https://www.microsoft.com/net/core#ubuntu" target="_blank" rel="external">Install for Ubuntu 14.04, 16.04 &amp; Linux Mint 17</a></p>
<p>第一步<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Ubuntu 14.04 / Linux Mint 17</span></div><div class="line">sudo <span class="keyword">sh</span> -c 'echo <span class="string">"deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ trusty main"</span> &gt; /etc/apt/sources.<span class="keyword">list</span>.<span class="keyword">d</span>/dotnetdev.<span class="keyword">list</span>'</div><div class="line">sudo apt-key adv --keyserver apt-mo.trafficmanager.<span class="keyword">net</span> --recv-keys 417A0893</div><div class="line">sudo apt-get <span class="keyword">update</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//Ubuntu 16.04</span></div><div class="line">sudo <span class="keyword">sh</span> -c 'echo <span class="string">"deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ xenial main"</span> &gt; /etc/apt/sources.<span class="keyword">list</span>.<span class="keyword">d</span>/dotnetdev.<span class="keyword">list</span>'</div><div class="line">sudo apt-key adv --keyserver apt-mo.trafficmanager.<span class="keyword">net</span> --recv-keys 417A0893</div><div class="line">sudo apt-get <span class="keyword">update</span></div></pre></td></tr></table></figure></p>
<p>第二步<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install dotnet-dev<span class="number">-1.0</span><span class="number">.0</span>-preview2<span class="number">-003131</span></div></pre></td></tr></table></figure></p>
<p>安装好了之后，输入 dotnet -v 应该能看到版本信息，如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/6ebca12e-2be9-487e-b230-d22562a5aabe" alt="dotnet -v "></p>
<p>这样的下，一句完成了ubuntu 运行asp.net core的环境搭建了。</p>
<h3 id="project-json里面隐藏的坑"><a href="#project-json里面隐藏的坑" class="headerlink" title="project.json里面隐藏的坑"></a>project.json里面隐藏的坑</h3><h4 id="dependencies"><a href="#dependencies" class="headerlink" title="dependencies"></a>dependencies</h4><p>NET Core 1.0.1 - VS 2015 Tooling Preview 2模板的asp.net core 版本和ubuntu 的asp.net core 版本不一致。</p>
<p>根据微软爸给的教程，我们在ubuntu上安装的.NET Core 1.0.0，见上图。</p>
<p>然而我们创建项目的模板是.NET Core 1.0.1，见下图:</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/a3192bdf-f548-4fad-868a-4865632acd29" alt=".NET Core 1.0.1"></p>
<p>怎么办？要不升级ubuntu的asp.net core，要不降级。</p>
<p>由于没找到.NET Core 1.0.1 ubuntu的安装包，所以我选择了降级到.NET Core 1.0.0.</p>
<p>其中需要把Microsoft.NETCore.App version 、Microsoft.AspNetCore.Server.Kestrel、Microsoft.AspNetCore.Mvc 这三个节点都改成“1.0.0”。如下：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="string">"dependencies"</span>: &#123;</div><div class="line">  <span class="string">"Microsoft.NETCore.App"</span>: &#123;</div><div class="line">    <span class="string">"version"</span>: <span class="string">"1.0.1"</span>,</div><div class="line">    <span class="string">"type"</span>: <span class="string">"platform"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"Microsoft.AspNetCore.Diagnostics"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="string">"Microsoft.AspNetCore.Server.IISIntegration"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="string">"Microsoft.AspNetCore.Server.Kestrel"</span>: <span class="string">"1.0.1"</span>,</div><div class="line">  <span class="string">"Microsoft.Extensions.Logging.Console"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="string">"Microsoft.AspNetCore.Mvc"</span>: <span class="string">"1.0.1"</span>,</div><div class="line">  <span class="string">"Microsoft.AspNetCore.StaticFiles"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="string">"Newtonsoft.Json"</span>: <span class="string">"9.0.1"</span>,</div><div class="line">  <span class="string">"AngleSharp"</span>: <span class="string">"0.9.8.1"</span></div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h4 id="publishOptions"><a href="#publishOptions" class="headerlink" title="publishOptions"></a>publishOptions</h4><p>发布输出包括Views文件夹<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="string">"publishOptions"</span>: &#123;</div><div class="line">  <span class="string">"include"</span>: [</div><div class="line">    <span class="string">"wwwroot"</span>,</div><div class="line">    <span class="string">"web.config"</span>,</div><div class="line">    <span class="string">"Views"</span></div><div class="line">  ]</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<h4 id="runtimes"><a href="#runtimes" class="headerlink" title="runtimes"></a>runtimes</h4><p>runtimes 配置为模板运行平台。<br>详细见链接：<a href="https://docs.nuget.org/ndocs/schema/project.json" target="_blank" rel="external">https://docs.nuget.org/ndocs/schema/project.json</a></p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"runtimes"</span>: &#123; <span class="string">"ubuntu.14.04-x64"</span>: &#123;&#125; &#125;</div></pre></td></tr></table></figure>
<p>上面都弄好之后，跑一下看,如下图：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dotnet <span class="keyword">restore</span></div><div class="line"></div><div class="line"><span class="keyword">dotnet</span> run</div></pre></td></tr></table></figure>
<p>来个请求看看：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/b1191226-c33b-45c7-98cc-f62bb3ea73b4" alt="请求log"></p>
<h3 id="jexus转发-反向代理"><a href="#jexus转发-反向代理" class="headerlink" title="jexus转发/反向代理"></a>jexus转发/反向代理</h3><p><a href="http://www.cnblogs.com/gaobing/p/5663012.html" target="_blank" rel="external">ASP.NET Core “完整发布,自带运行时” 到jexus</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/13/58City-House-Crawler-JS/" itemprop="url">
                  58同城高德搜房项目JS相关知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-13T00:00:00+08:00" content="2016-08-13">
              2016-08-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/13/58City-House-Crawler-JS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/13/58City-House-Crawler-JS/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在线地址：<a href="http://codelover.link:8080/">58同城品牌公寓高德搜房</a></p>
<p>Github地址：<a href="https://github.com/liguobao/58HouseSearch" target="_blank" rel="external">https://github.com/liguobao/58HouseSearch</a></p>
<p>知乎专栏(点赞用的)：<a href="https://zhuanlan.zhihu.com/p/21960329" target="_blank" rel="external">高德API+Python解决租房问题(.NET版)</a></p>
<p>经过了一个星期的修补补，以及小伙伴奉献的代码，整个项目基本处于基本稳定运行的状态。</p>
<p>同时加入了一下新功能：</p>
<ol>
<li>IP定位：调用高德地图IP定位功能实现</li>
<li>移动地图中心定位：调用高德地图移动地图定位实现</li>
<li>定位城市名转58同城城市名以获得准确58同城城市域名：抓取58同城城市分类信息</li>
<li>优化数据源、去除广告数据：小伙伴奉献代码</li>
</ol>
<p>今天主要简单讲解一下其中使用的一些高德地图API接口。</p>
<p>高德地图JavaScript API 主体为map对象，基本所有的操作都是通过map对象来实现的。<br>map对象实例化是通过 Amap类来做的。如以下代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">map = <span class="keyword">new</span> AMap.Map(<span class="string">"container"</span>, &#123;</div><div class="line">        resizeEnable: <span class="literal">true</span>,</div><div class="line">        zoomEnable: <span class="literal">true</span>,</div><div class="line">        center: [<span class="number">121.297428</span>, <span class="number">31.1345</span>],<span class="comment">//经纬度，此处为上海</span></div><div class="line">        zoom: <span class="number">11</span></div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<h4 id="IP定位"><a href="#IP定位" class="headerlink" title="IP定位"></a>IP定位</h4><p>调用Map.CitySearch()获得当前IP所在城市，直接将地图显示成当前城市。代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">showCityInfo</span>(<span class="params">map</span>) </span>&#123;</div><div class="line">    <span class="comment">//实例化城市查询类</span></div><div class="line">    <span class="keyword">var</span> citysearch = <span class="keyword">new</span> AMap.CitySearch();</div><div class="line">    <span class="comment">//自动获取用户IP，返回当前城市</span></div><div class="line">    citysearch.getLocalCity(<span class="function"><span class="keyword">function</span> (<span class="params">status, result</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (status === <span class="string">'complete'</span> &amp;&amp; result.info === <span class="string">'OK'</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (result &amp;&amp; result.city &amp;&amp; result.bounds) &#123;</div><div class="line">                <span class="keyword">var</span> cityinfo = result.city;<span class="comment">//获得XX市</span></div><div class="line">                <span class="keyword">var</span> citybounds = result.bounds;<span class="comment">//用于设置地图显示位置的实例</span></div><div class="line">                cityName = cityinfo.substring(<span class="number">0</span>, cityinfo.length - <span class="number">1</span>);<span class="comment">//去掉市这个字</span></div><div class="line">                ConvertCityCNNameToShortCut();<span class="comment">//城市名转换成58同城城市域名字母，如上海-&gt;sh,苏州-&gt;su,</span></div><div class="line">                                              <span class="comment">//下面会有实现代码</span></div><div class="line"></div><div class="line">                <span class="built_in">document</span>.getElementById(<span class="string">'IPLocation'</span>).innerHTML = <span class="string">'您当前所在城市：'</span> + cityName;</div><div class="line">                <span class="comment">//地图显示当前城市</span></div><div class="line">                map.setBounds(citybounds);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">document</span>.getElementById(<span class="string">'IPLocation'</span>).innerHTML = result.info;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="移动地图自动中心定位"><a href="#移动地图自动中心定位" class="headerlink" title="移动地图自动中心定位"></a>移动地图自动中心定位</h4><p>之前有一版是让用户输入城市名，然后直接定位到输入的城市的。<br>这个功能卡在了设置地图显示位置上，如果是使用高德地图提供的搜索控件的话，又存在输入结果之后搜索结果可能是多个的问题。而且这点我只是要取到用户想要定位的城市而已，感觉没必要做得太复杂。<br>昨晚在看高德地图API的时候发现，有一个移动地图获得地图中心所在位置的样例，马上眼前一亮了。这个功能比我想要的还要好…果断上。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">MapMoveToLocationCity</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    map.on(<span class="string">'moveend'</span>, getCity);</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getCity</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        map.getCity(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (data[<span class="string">'province'</span>] &amp;&amp; <span class="keyword">typeof</span> data[<span class="string">'province'</span>] === <span class="string">'string'</span>) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">var</span> cityinfo = (data[<span class="string">'city'</span>] || data[<span class="string">'province'</span>]);</div><div class="line">                cityName = cityinfo.substring(<span class="number">0</span>, cityinfo.length - <span class="number">1</span>);</div><div class="line">                ConvertCityCNNameToShortCut();<span class="comment">//城市名转58同城地区域名</span></div><div class="line"></div><div class="line">                <span class="built_in">document</span>.getElementById(<span class="string">'IPLocation'</span>).innerHTML = <span class="string">'地图中心所在城市：'</span> + cityName;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>整个代码的意思是，给map绑定一下移动时间，移动完了之后，调用getCity的方法获取当前地图中心所在城市信息。</p>
<p>这个时候要注意，城市名可能在city对象里面，也可能在province里面。</p>
<p>原因很简单：普通城市等级就是城市，我国还存在一个和省份一个等级的城市：直辖市。因此直辖市的城市名是在province里面的。</p>
<h4 id="城市名匹配58同城地区域名"><a href="#城市名匹配58同城地区域名" class="headerlink" title="城市名匹配58同城地区域名"></a>城市名匹配58同城地区域名</h4><p>这个是上个版本(两三天前)的一个bug引出来的新功能。</p>
<p>上个版本是让用户输入城市名，然后提取城市名的中文拼音首字母作为58同城地区域名。如上海 =sh，广州=gz，北京=bj，成都=cd。</p>
<p>这个功能使用的是网上别人写的一个JS库，通过汉字匹配实现的。转换出来的数据没什么问题，不过我国汉字实在奥妙。</p>
<p>广州=gz，赣州=gz；<br>遂宁=sn；绥宁=sn；<br>惠州=hz，杭州=hz。</p>
<p>这样一来，上面这个做法就没法玩了。</p>
<p>想了下怎么解决这个问题，灵机一动。反正是在爬58的数据，这个城市名和城市域名数据58同城肯定有啊，然后找到了这个。<br><a href="http://www.58.com/changecity.aspx?PGTID=0d100000-0007-a77b-4c4b-a28f725b8f5a&amp;ClickID=1" target="_blank" rel="external">58同城城市分类导航</a></p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/c01c293a-d5cc-4f58-80dc-13aa05d47b01" alt=""></p>
<p>很明显，我要的所有城市名和城市域名都是里面了。</p>
<p>晚上和衣衣说了下，衣衣一大早就把处理好的json数据给我了。</p>
<p>于是来了下面一段代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//加载json文件</span></div><div class="line">$.getJSON(<span class="string">"DomainJS/city.json"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span></div><div class="line">&#123;</div><div class="line">      allCityInfo = data;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ConvertCityCNNameToShortCut</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> filterarray = $.grep(allCityInfo, <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> obj.cityName == cityName;</div><div class="line">    &#125;);<span class="comment">//找到当前城市名对应的json对象</span></div><div class="line">    <span class="comment">//获取json对象的地区域名</span></div><div class="line">    cityNameCNPY = filterarray <span class="keyword">instanceof</span> <span class="built_in">Array</span> ? </div><div class="line">    filterarray[<span class="number">0</span>].shortCut : filterarray != <span class="literal">null</span> ? filterarray.shortCut : <span class="string">""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="高德地图自动补全功能"><a href="#高德地图自动补全功能" class="headerlink" title="高德地图自动补全功能"></a>高德地图自动补全功能</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-input"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"work-location"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">style</span>=<span class="string">"width:60%"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> auto = <span class="keyword">new</span> AMap.Autocomplete(&#123;</div><div class="line">       input: <span class="string">"work-location"</span></div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   AMap.event.addListener(auto, <span class="string">"select"</span>, workLocationSelected);</div></pre></td></tr></table></figure>
<p>看方法前面也知道，其实这就是把ID为work-location的input初始化为地图插件，然后给Amap增加了一个监听事件。<br>当其中选中某一个数据的时候，触发workLocationSelected函数。效果如下：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/fe425992-e7c4-4cae-800e-319eff3b17e8" alt=""></p>
<p>在这里locationSelected是定位到所选位置，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLocationSelected</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    workAddress = e.poi.name;</div><div class="line">    loadWorkLocation();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadWorkLocation</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    delWorkLocation();</div><div class="line">    <span class="keyword">var</span> geocoder = <span class="keyword">new</span> AMap.Geocoder(&#123;</div><div class="line">        city: cityName,</div><div class="line">        radius: <span class="number">1000</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    geocoder.getLocation(workAddress, <span class="function"><span class="keyword">function</span> (<span class="params">status, result</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (status === <span class="string">"complete"</span> &amp;&amp; result.info === <span class="string">'OK'</span>) &#123;</div><div class="line">            <span class="keyword">var</span> geocode = result.geocodes[<span class="number">0</span>];</div><div class="line">            x = geocode.location.getLng();</div><div class="line">            y = geocode.location.getLat();</div><div class="line">            loadWorkMarker(x, y);</div><div class="line">            loadWorkRange(x, y, <span class="number">60</span>, <span class="string">"#3f67a5"</span>, vehicle);</div><div class="line">            map.setZoomAndCenter(<span class="number">12</span>, [x, y]);</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>至于导航功能代码我没怎么动，没去研究就不献丑了…</p>
<p>最后来个效果图。</p>
<h4 id="北京"><a href="#北京" class="headerlink" title="北京"></a>北京</h4><p><img src="http://7xread.com1.z0.glb.clouddn.com/e7900aba-5a56-417c-9dd9-63527583e84b" alt=""></p>
<h4 id="成都"><a href="#成都" class="headerlink" title="成都"></a>成都</h4><p><img src="http://7xread.com1.z0.glb.clouddn.com/c9947d97-1b76-42bf-82b3-aca817e84e13" alt=""></p>
<h4 id="苏州"><a href="#苏州" class="headerlink" title="苏州"></a>苏州</h4><p><img src="http://7xread.com1.z0.glb.clouddn.com/941809ae-aa37-4a3b-89c7-10646cc7e3e7" alt=""></p>
<h4 id="深圳"><a href="#深圳" class="headerlink" title="深圳"></a>深圳</h4><p><img src="http://7xread.com1.z0.glb.clouddn.com/86712397-27ec-4b37-bbf8-81191e530ef6" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/08/58City-House-Crawler/" itemprop="url">
                  .NET_58同城品牌公寓爬虫
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-08T00:00:00+08:00" content="2016-08-08">
              2016-08-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/net/" itemprop="url" rel="index">
                    <span itemprop="name">.net</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/08/58City-House-Crawler/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/08/58City-House-Crawler/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>源码地址：<a href="https://github.com/liguobao/58HouseSearch" target="_blank" rel="external">https://github.com/liguobao/58HouseSearch</a></p>
<p>在线地址：<a href="http://codelover.link:8080/">58公寓高德搜房(全国版)：http://codelover.link:8080/</a></p>
<p>周末闲着无事刷知乎发现一个爬虫教程（<a href="https://zhuanlan.zhihu.com/p/21883516" target="_blank" rel="external">高德API+Python解决租房问题</a><br>），正中最近想要换地方住的痛点。然后大早上懒觉都没睡就屁颠屁颠开始研究这个教程了。这样教程在实验楼网站里面有手把手步骤，有兴趣自取（<a href="https://www.shiyanlou.com/courses/599" target="_blank" rel="external">实验楼：高德API+Python解决租房问题</a>）。</p>
<p>整体项目主要分成两步：</p>
<p>第一步:python爬取数据，生成数据文件;</p>
<p>第二步：导入数据文件，在地图上显示房源，设定上班地点后自动计算出行路线和路程时间。</p>
<p>研究了一下这个教程之后发现这货做得实在有点粗糙，只能当教程用，完全没有通用实际价值。</p>
<p>而且这里面还有个更大的问题：教程是基于北京的数据来做的，而我在上海…</p>
<p>虽然说改改python数据源，改改导航页面JS完事。不过是在难用…</p>
<p>于是，开始自己动手了。先看原有的python代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">#-*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</div><div class="line"><span class="keyword">from</span> urlparse <span class="keyword">import</span> urljoin</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> csv</div><div class="line"></div><div class="line">url = <span class="string">"http://bj.58.com/pinpaigongyu/pn/&#123;page&#125;/?minprice=2000_4000"</span></div><div class="line"></div><div class="line"><span class="comment">#已完成的页数序号，初时为0</span></div><div class="line">page = <span class="number">0</span></div><div class="line"></div><div class="line">csv_file = open(<span class="string">"rent.csv"</span>,<span class="string">"wb"</span>) </div><div class="line">csv_writer = csv.writer(csv_file, delimiter=<span class="string">','</span>)</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    page += <span class="number">1</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"fetch: "</span>, url.format(page=page)</div><div class="line">    response = requests.get(url.format(page=page))</div><div class="line">    html = BeautifulSoup(response.text)</div><div class="line">    house_list = html.select(<span class="string">".list &gt; li"</span>)</div><div class="line"></div><div class="line">    <span class="comment"># 循环在读不到新的房源时结束</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> house_list:</div><div class="line">        <span class="keyword">break</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> house <span class="keyword">in</span> house_list:</div><div class="line">        house_title = house.select(<span class="string">"h2"</span>)[<span class="number">0</span>].string.encode(<span class="string">"utf8"</span>)</div><div class="line">        house_url = urljoin(url, house.select(<span class="string">"a"</span>)[<span class="number">0</span>][<span class="string">"href"</span>])</div><div class="line">        house_info_list = house_title.split()</div><div class="line"></div><div class="line">        <span class="comment"># 如果第二列是公寓名则取第一列作为地址</span></div><div class="line">        <span class="keyword">if</span> <span class="string">"公寓"</span> <span class="keyword">in</span> house_info_list[<span class="number">1</span>] <span class="keyword">or</span> <span class="string">"青年社区"</span> <span class="keyword">in</span> house_info_list[<span class="number">1</span>]:</div><div class="line">            house_location = house_info_list[<span class="number">0</span>]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            house_location = house_info_list[<span class="number">1</span>]</div><div class="line"></div><div class="line">        house_money = house.select(<span class="string">".money"</span>)[<span class="number">0</span>].select(<span class="string">"b"</span>)[<span class="number">0</span>].string.encode(<span class="string">"utf8"</span>)</div><div class="line">        csv_writer.writerow([house_title, house_location, house_money, house_url])</div><div class="line"></div><div class="line">csv_file.close()</div></pre></td></tr></table></figure>
<p>整个代码基本思路就是，爬取<a href="http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000页面数据，然后扔到创建的csv文件里面作为下一步的数据源。" target="_blank" rel="external">http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000页面数据，然后扔到创建的csv文件里面作为下一步的数据源。</a><br>通过研究<a href="http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000这个页面的数据，我们可以很容易发现，在页面中，每条数据都是一个li标签。" target="_blank" rel="external">http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000这个页面的数据，我们可以很容易发现，在页面中，每条数据都是一个li标签。</a></p>
<p>如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/685849af-2ccc-4454-a26e-e2a1c3001378" alt=""></p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/909df442-b1d9-4073-84d0-99a5b3cc9022" alt=""></p>
<h4 id="li结构如下："><a href="#li结构如下：" class="headerlink" title="li结构如下："></a>li结构如下：</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">logr</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/pinpaigongyu/26851774057013x.shtml"</span></span></div><div class="line">  <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">onclick</span>=<span class="string">"clickLog('from=fcpc_list_gy_sh_tupian')"</span> </div><div class="line">  <span class="attr">tongji_label</span>=<span class="string">"listclick"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"img"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">img</span> <span class="attr">lazy_src</span>=<span class="string">""</span> <span class="attr">alt</span>=<span class="string">""</span> <span class="attr">src</span>=<span class="string">""</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"des"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>【合租】菊园新区 柳湖景庭 3室次卧<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"room"</span>&gt;</span></div><div class="line">            3室1厅1卫&amp;nbsp; &amp;nbsp; 13m²&amp;nbsp;&amp;nbsp; 3/6层&amp;nbsp; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"dist"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"spec"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"spec1"</span>&gt;</span>公共阳台<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"spec2"</span>&gt;</span>公共卫生间<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"spec3"</span>&gt;</span>离地铁近<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"spec4"</span>&gt;</span>厨房<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"money"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>1100<span class="tag">&lt;/<span class="name">b</span>&gt;</span>元/月 <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">p</span>&gt;</span>租房月付<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div></pre></td></tr></table></figure>
<p>照着python的思路，是把所有的li标签的数据提取出来的。</p>
<p>我自己研究的时候又看了下，其实数据都在一个属性为tongji_label=”listclick”的a标签里面。</p>
<p>一般来说，字符匹配用正则表达式完事，奈何正则水平实在不佳。我还是选择直接上HtmlAgilityPack算了。<br>关于HtmlAgilityPack的介绍还是看官网算了。<a href="http://htmlagilitypack.codeplex.com/" target="_blank" rel="external">HtmlAgilityPack</a></p>
<p>HtmlAgilityPack是.NET一个比较强大的HTML处理类库了，基本可以让你像JS来操作HTML标签。<br>安装这货很简单，直接在Nuget PM包管理工具里面输入下面命令就完事了。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Install-Package HtmlAgilityPack</div></pre></td></tr></table></figure>
<p>有需要使用教程可以看这个：<a href="http://www.cnblogs.com/ITmuse/archive/2010/05/29/1747199.html" target="_blank" rel="external">Html Agility Pack基础类介绍及运用</a></p>
<p>下面直接贴control源码算了。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="costFrom"&gt;</span>价格区间起始值<span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="costTo"&gt;</span>价格区间终止值<span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="cnName"&gt;</span>城市拼音首字母<span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Get58CityRoomData</span>(<span class="params"><span class="keyword">int</span> costFrom, <span class="keyword">int</span> costTo, <span class="keyword">string</span> cnName</span>)</span></div><div class="line">       &#123;</div><div class="line">           <span class="keyword">if</span> (costTo&lt;=<span class="number">0</span> || costTo &lt; costFrom)</div><div class="line">           &#123;</div><div class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; IsSuccess = <span class="literal">false</span>, Error = <span class="string">"输入数据有误，请重新输入。"</span> &#125;);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(cnName))</div><div class="line">           &#123;</div><div class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; IsSuccess = <span class="literal">false</span>, </div><div class="line">               Error = <span class="string">"城市定位失败，建议清除浏览器缓存后重新进入。"</span> &#125;);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">try</span></div><div class="line">           &#123;</div><div class="line">               <span class="keyword">var</span> lstHouse = <span class="keyword">new</span> List&lt;HouseInfo&gt;();</div><div class="line"></div><div class="line">               <span class="keyword">string</span> tempURL = <span class="string">"http://"</span> + </div><div class="line">               cnName + <span class="string">".58.com/pinpaigongyu//pn/&#123;0&#125;/?minprice="</span></div><div class="line">               + costFrom + <span class="string">"_"</span> + costTo;</div><div class="line"></div><div class="line">               Uri uri = <span class="keyword">new</span> Uri(tempURL);</div><div class="line"></div><div class="line">               <span class="keyword">var</span> htmlResult = HTTPHelper.GetHTMLByURL(<span class="keyword">string</span>.Format(tempURL, <span class="number">1</span>));</div><div class="line"></div><div class="line">               HtmlDocument htmlDoc = <span class="keyword">new</span> HtmlDocument();</div><div class="line">               htmlDoc.LoadHtml(htmlResult);</div><div class="line"></div><div class="line">               <span class="keyword">var</span> countNodes = htmlDoc.DocumentNode.</div><div class="line">               SelectSingleNode(<span class="string">".//span[contains(@class,'list')]"</span>);</div><div class="line">               <span class="keyword">int</span> pageCount = <span class="number">10</span>;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (countNodes != <span class="literal">null</span> &amp;&amp; countNodes.HasChildNodes)</div><div class="line">               &#123;</div><div class="line">                   pageCount = Convert.ToInt32(countNodes.ChildNodes[<span class="number">0</span>].InnerText) / <span class="number">20</span>;</div><div class="line"></div><div class="line">                   <span class="keyword">if</span>(pageCount==<span class="number">0</span>)</div><div class="line">                   &#123;</div><div class="line">                       <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; IsSuccess = <span class="literal">false</span>, </div><div class="line">                       Error =<span class="keyword">string</span>.Format(<span class="string">"没有找到价格区间为&#123;0&#125; - &#123;1&#125;的房子。"</span>,</div><div class="line">                       costFrom,costTo)&#125;);</div><div class="line">                   &#125;</div><div class="line">                   </div><div class="line">               &#125;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> pageIndex = <span class="number">1</span>; pageIndex &lt;= pageCount; pageIndex++)</div><div class="line">               &#123;</div><div class="line">                   htmlResult = HTTPHelper.GetHTMLByURL(<span class="keyword">string</span>.Format(tempURL, pageIndex));</div><div class="line">                   htmlDoc.LoadHtml(htmlResult);</div><div class="line">                   <span class="keyword">var</span> roomList = htmlDoc.DocumentNode</div><div class="line">                   .SelectNodes(<span class="string">".//a[contains(@tongji_label,'listclick')]"</span>);</div><div class="line">                   <span class="keyword">foreach</span> (<span class="keyword">var</span> room <span class="keyword">in</span> roomList)</div><div class="line">                   &#123;</div><div class="line">                       <span class="keyword">var</span> houseTitle = room.SelectSingleNode(<span class="string">".//h2"</span>).InnerHtml;</div><div class="line">                       <span class="keyword">var</span> houseURL = uri.Host + room.Attributes[<span class="string">"href"</span>].Value;</div><div class="line">                       <span class="keyword">var</span> house_info_list = houseTitle.Split(<span class="string">' '</span>);</div><div class="line">                       <span class="keyword">var</span> house_location = <span class="keyword">string</span>.Empty;</div><div class="line">                       <span class="keyword">if</span> (house_info_list[<span class="number">1</span>].Contains(<span class="string">"公寓"</span>) </div><div class="line">                       || house_info_list[<span class="number">1</span>].Contains(<span class="string">"青年社区"</span>))</div><div class="line">                       &#123;</div><div class="line">                           house_location = house_info_list[<span class="number">0</span>];</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">else</span></div><div class="line">                       &#123;</div><div class="line">                           house_location = house_info_list[<span class="number">1</span>];</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">var</span> momey = room.SelectSingleNode(<span class="string">".//b"</span>).InnerHtml;</div><div class="line"></div><div class="line">                       lstHouse.Add(<span class="keyword">new</span> HouseInfo()</div><div class="line">                       &#123;</div><div class="line">                           HouseTitle = houseTitle,</div><div class="line">                           HouseLocation = house_location,</div><div class="line">                           HouseURL = houseURL,</div><div class="line">                           Money = momey,</div><div class="line">                       &#125;);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; IsSuccess = <span class="literal">true</span>, HouseInfos = lstHouse &#125;);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (Exception ex)</div><div class="line">           &#123;</div><div class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; IsSuccess = <span class="literal">false</span>,</div><div class="line">               Error = <span class="string">"获取数据异常。"</span> + ex.ToString() &#125;);</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>下面解释一下核心代码。</p>
<p>片段一：获取总数。</p>
<p>在观察58同城页面的时候，无意发现其实第一个加载的页面中有一个数据总条数，隐藏在页面里面的。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"listsum"</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>1813<span class="tag">&lt;/<span class="name">em</span>&gt;</span>条结果<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这样一来，总页面就很清晰了。页面=总数/每页20条。然后我们根据已知的数据规则去循环请求页面，也就能拿到所有的搜索数据了。</p>
<p>核心代码，获取总条数。<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">var <span class="attr">countNodes</span> = htmlDoc.DocumentNode.</div><div class="line">SelectSingleNode(<span class="string">".//span[contains(@class,'list')]"</span>);</div><div class="line">int <span class="attr">pageCount</span> = <span class="number">10</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (countNodes != <span class="literal">null</span> &amp;&amp; countNodes.HasChildNodes)</div><div class="line">&#123;</div><div class="line">    <span class="attr">pageCount</span> = Convert.ToInt32(countNodes.ChildNodes[<span class="number">0</span>].InnerText) / <span class="number">20</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(<span class="attr">pageCount==0)</span></div><div class="line">    &#123;</div><div class="line">        return Json(new &#123; <span class="attr">IsSuccess</span> = <span class="literal">false</span>, </div><div class="line">        <span class="attr">Error</span> =string.Format(<span class="string">"没有找到价格区间为&#123;0&#125; - &#123;1&#125;的房子。"</span>,</div><div class="line">        costFrom,costTo)&#125;);</div><div class="line">    &#125;</div><div class="line">                    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在HTMLDoc里面找到一个span的class包含list的节点，获取它子节点（即em）的内容，强制转换成数字，也就是我们要找的总条数了。总条数除以20就得到了页数，下面就是开始循环请求页面了。</p>
<p>在最上面我们分析过公寓数据分布，数据是li里面套a标签，我们需要的地理位置、房间名称、价格都在a标签里面。</p>
<p>这样一来，我们这要获得到页面所有带有属性为tongji_label=”listclick”的a标签数据，也就得到了我们所有需要的数据。</p>
<p>看一下a标签的数据组成：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/pinpaigongyu/26851774057013x.shtml"</span></span></div><div class="line"> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">onclick</span>=<span class="string">"clickLog('from=fcpc_list_gy_sh_tupian')"</span> </div><div class="line"> <span class="attr">tongji_label</span>=<span class="string">"listclick"</span>&gt;</div><div class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"img"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">lazy_src</span>=<span class="string">""</span> <span class="attr">alt</span>=<span class="string">""</span> <span class="attr">src</span>=<span class="string">""</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"des"</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">h2</span>&gt;</span>【合租】菊园新区 柳湖景庭 3室次卧<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"room"</span>&gt;</span></div><div class="line">           3室1厅1卫&amp;nbsp; &amp;nbsp; 13m²&amp;nbsp;&amp;nbsp; 3/6层&amp;nbsp; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"dist"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"spec"</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"spec1"</span>&gt;</span>公共阳台<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"spec2"</span>&gt;</span>公共卫生间<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"spec3"</span>&gt;</span>离地铁近<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"spec4"</span>&gt;</span>厨房<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">           <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"money"</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>1100<span class="tag">&lt;/<span class="name">b</span>&gt;</span>元/月 <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>租房月付<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们要的房间信息在一个h2的标签里面，公寓租金价钱在class=”money”的div标签里面。</p>
<p>于是有了一下代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> <span class="keyword">for</span> (<span class="keyword">int</span> pageIndex = <span class="number">1</span>; pageIndex &lt;= pageCount; pageIndex++)</div><div class="line">&#123;</div><div class="line">    htmlResult = HTTPHelper.GetHTMLByURL(<span class="keyword">string</span>.Format(tempURL, pageIndex));</div><div class="line">    htmlDoc.LoadHtml(htmlResult);</div><div class="line">    <span class="comment">//找到所有的带有属性为tongji_label="listclick"的a标签数据</span></div><div class="line">    <span class="keyword">var</span> roomList = htmlDoc.DocumentNode.SelectNodes(<span class="string">".//a[contains(@tongji_label,'listclick')]"</span>);</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> room <span class="keyword">in</span> roomList)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">//获取其中为h2的房间数据，然后用空格分割成数组</span></div><div class="line">        <span class="keyword">var</span> houseTitle = room.SelectSingleNode(<span class="string">".//h2"</span>).InnerHtml;</div><div class="line">        <span class="keyword">var</span> houseURL = uri.Host + room.Attributes[<span class="string">"href"</span>].Value;</div><div class="line">        <span class="keyword">var</span> house_info_list = houseTitle.Split(<span class="string">' '</span>);</div><div class="line">        <span class="keyword">var</span> house_location = <span class="keyword">string</span>.Empty;</div><div class="line">        <span class="comment">//分割出来的数组，第二个包含公寓或青年社区，则取第一个数据为所在地区，否则取第二个数据</span></div><div class="line">        <span class="comment">//【合租】菊园新区 柳湖景庭 3室次卧 </span></div><div class="line">        <span class="comment">// 所在地区为：菊园新区</span></div><div class="line">        <span class="keyword">if</span> (house_info_list[<span class="number">1</span>].Contains(<span class="string">"公寓"</span>) || house_info_list[<span class="number">1</span>].Contains(<span class="string">"青年社区"</span>))</div><div class="line">        &#123;</div><div class="line">            house_location = house_info_list[<span class="number">0</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            house_location = house_info_list[<span class="number">1</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//获取标签为b的数据，价格就在里面了</span></div><div class="line">        <span class="keyword">var</span> momey = room.SelectSingleNode(<span class="string">".//b"</span>).InnerHtml;</div><div class="line"></div><div class="line">        lstHouse.Add(<span class="keyword">new</span> HouseInfo()</div><div class="line">        &#123;</div><div class="line">            HouseTitle = houseTitle,</div><div class="line">            HouseLocation = house_location,</div><div class="line">            HouseURL = houseURL,</div><div class="line">            Money = momey,</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>后端来说，基本就这些内容了。</p>
<p>还有一些前端高德地图接口调用下次再讲吧，要陪女票玩游戏去了…</p>
<p>^-^</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://7xrayk.com1.z0.glb.clouddn.com/%E5%A4%A7%E7%86%8A%E5%B0%8F%E7%86%8A.jpg"
               alt="李国宝" />
          <p class="site-author-name" itemprop="name">李国宝</p>
          <p class="site-description motion-element" itemprop="description">一直走在吃软饭路上的软狗</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">28</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/liguobao" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/codelover" target="_blank" title="知乎">
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.1234.sh" title="あまみや ゆうこ" target="_blank">あまみや ゆうこ</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://piratf.ml" title="潘雄飞的博客 - 我是魔法师啦啦啦。" target="_blank">潘雄飞的博客 - 我是魔法师啦啦啦。</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://codesky.me" title="CodeSky 代码之空" target="_blank">CodeSky 代码之空</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李国宝</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"codelover"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>

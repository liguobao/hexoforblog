{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/LICENSE","path":"vendors/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/README.md","path":"vendors/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/bower.json","path":"vendors/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/HELP-US-OUT.txt","path":"vendors/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/bower.json","path":"vendors/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/CONTRIBUTING.md","path":"vendors/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/README.md","path":"vendors/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/bower.json","path":"vendors/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.lazyload.js","path":"vendors/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.scrollstop.js","path":"vendors/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/bower.json","path":"vendors/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.min.js","path":"vendors/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.ui.js","path":"vendors/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.ui.min.js","path":"vendors/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery/index.js","path":"vendors/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/blank.gif","path":"vendors/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading.gif","path":"vendors/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading@2x.gif","path":"vendors/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_overlay.png","path":"vendors/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite@2x.png","path":"vendors/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite.png","path":"vendors/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.css","path":"vendors/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.js","path":"vendors/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.pack.js","path":"vendors/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.js","path":"vendors/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.min.js","path":"vendors/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css","path":"vendors/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css.map","path":"vendors/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.min.css","path":"vendors/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff2","path":"vendors/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.min.js","path":"vendors/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.pack.js","path":"vendors/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/FontAwesome.otf","path":"vendors/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.eot","path":"vendors/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff","path":"vendors/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.js","path":"vendors/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-media.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/fancybox_buttons.png","path":"vendors/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.ttf","path":"vendors/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.svg","path":"vendors/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1}],"Cache":[{"_id":"source/_posts/58City-House-Crawler-JS.md","hash":"bc6b9a8cfd59d0d373bd66de9c4c052e83294d52","modified":1473916273645},{"_id":"source/_posts/58City-House-Crawler.md","hash":"171cf6b0c0889289a6c001bd46da568d1fa16faa","modified":1473916273647},{"_id":"source/_posts/ASP.NET-Core-Middleware.md","hash":"ec3cb39457266ab364d33ac292a92b18c1683d30","modified":1473916273648},{"_id":"source/_posts/Bytes -To-String.md","hash":"709bdcfbfc1e71b831c99c29b887d5f47c785650","modified":1473916273648},{"_id":"source/_posts/CodeSmith to MySQL.md","hash":"cca2335154c302a9b951276847e2eaeda8d26c40","modified":1473916273649},{"_id":"source/_posts/CodeSmith-connect-MySQL-throw“can‘t find .Net Framework Data Provider”.md","hash":"e12ede68bc77b26f71dad25e35e61209958bab0c","modified":1473916273649},{"_id":"source/_posts/GC-1.md","hash":"300d0a9c2ade16b10469628eb10f8c09fed0e509","modified":1473916273650},{"_id":"source/_posts/GC-2.md","hash":"d84cad9bc885870c9e9df24cb32106b7eb22f55c","modified":1473916273650},{"_id":"source/_posts/Jexus-support-HTTPS.md","hash":"ff7037855caf386407c19c4686eafef98376b4b8","modified":1473916273650},{"_id":"source/_posts/Join.md","hash":"0faf2b1865c78bc461eeb1b24cff4f17d08fc15b","modified":1473916273651},{"_id":"source/_posts/LINQ-advantage.md","hash":"924ce2c1459d1f520c1e5b8fe0610138779789cf","modified":1473916273651},{"_id":"source/_posts/asp.net-core-startup.md","hash":"39bccfec59f94cd10f5401dd4285acdda5f4097c","modified":1473916273652},{"_id":"source/_posts/can't-modify-linq-object.md","hash":"6990a0031d1c5b4b0ae019d5a4c1beb6fb1927ba","modified":1473916273652},{"_id":"source/_posts/classfield-property.md","hash":"83f30661d10eef4680ab908dcf97365a735d3a9e","modified":1473916273653},{"_id":"source/_posts/don’t-throw-exception-in-foreach.md","hash":"310a1d28fd50bdb0eed740c4106181f231931faa","modified":1473916273653},{"_id":"source/_posts/something.md","hash":"db6e12c9886095a8bf4552ed421f1ccc24eb1290","modified":1473916273654},{"_id":"source/_posts/ubuntu-jexus-mywebsql.md","hash":"15da010bdf7788c0efe8a9fad92e6fc093de84a7","modified":1473916273654},{"_id":"source/about/index.md","hash":"f37380c4b8bd7f7e1eb0e68990022ffd867098f8","modified":1473916273655},{"_id":"source/categories/index.md","hash":"0d84e3962d8c7d558e0061a5d1642a56cc10d14c","modified":1473916273655},{"_id":"source/tags/index.md","hash":"0237a232cfd838cb1cae7f0e4e80709ccbe27fbc","modified":1473916273656},{"_id":"source/_posts/mono-webreques-https-exception.md","hash":"21efacfc926209b5d167b1713cc117f097871c77","modified":1473916273654},{"_id":"themes/next/.bowerrc","hash":"20038353db532b4c40625419d396da7359f89cbe","modified":1473779244000},{"_id":"themes/next/.editorconfig","hash":"211d2c92bfdddb3e81ea946f4ca7a539f150f4da","modified":1473779244000},{"_id":"themes/next/.gitignore","hash":"80710b94ff2f6c013859ebffffe90f9295fc94ed","modified":1473779244000},{"_id":"themes/next/.hound.yml","hash":"289dcf5bfe92dbd680d54d6e0668f41c9c9c0c78","modified":1473779244000},{"_id":"themes/next/.javascript_ignore","hash":"beb0b95736650284ceb712a162cc033847a83cd3","modified":1473779244000},{"_id":"themes/next/.jshintrc","hash":"b7d23f2ce8d99fa073f22f9960605f318acd7710","modified":1473779244000},{"_id":"themes/next/README.en.md","hash":"fa31bbc6dd8778b8dee469740c92b3b5b59702af","modified":1473779244000},{"_id":"themes/next/README.md","hash":"06aaf1241e9e1619956c86d8b1397a643840a9d1","modified":1473779244000},{"_id":"themes/next/_config.yml","hash":"dce5019621cbaf8c98499101f324b7b9786950a4","modified":1473782816000},{"_id":"themes/next/bower.json","hash":"da39b00fcdf2e7a42af412de0a4d3617cc6d7084","modified":1473779244000},{"_id":"themes/next/gulpfile.coffee","hash":"4e8c1082fa82e383494ff5b5963b7936d9c7bb2e","modified":1473779244000},{"_id":"themes/next/package.json","hash":"95eaba1607544965e432d56406bae391dd11bcbb","modified":1473779244000},{"_id":"themes/next/languages/de.yml","hash":"4c3ffeb0d214c807a226dd98214958cb5483df1c","modified":1473779244000},{"_id":"themes/next/languages/default.yml","hash":"d2f6784b9c6567b64e58736e36025dbf96d863d4","modified":1473779244000},{"_id":"themes/next/languages/en.yml","hash":"df81ab6b1cf3c88ed053d3766381cd12eb659fe3","modified":1473779244000},{"_id":"themes/next/languages/fr-FR.yml","hash":"d8a40fe025fad6f42df0cf16d4be2d513769b062","modified":1473779244000},{"_id":"themes/next/languages/id.yml","hash":"19537c8bae42c4c2e7d06a64537e8dfd503b7e19","modified":1473779244000},{"_id":"themes/next/languages/ja.yml","hash":"e594aa42a33c489e4a65065659a01bb76c3c0cb5","modified":1473779244000},{"_id":"themes/next/languages/ko.yml","hash":"feed5fdb677f87fbb9ba2b6e4413e7011180708e","modified":1473779244000},{"_id":"themes/next/languages/pt-BR.yml","hash":"81498b783372f11b2149bd2b1731e78432760a0e","modified":1473779244000},{"_id":"themes/next/languages/pt.yml","hash":"4c64594f477905d5d2d9ca2422f03175b7b0c617","modified":1473779244000},{"_id":"themes/next/languages/ru.yml","hash":"c3aedb94decf05a301662afc3398ab563dd9995a","modified":1473779244000},{"_id":"themes/next/languages/zh-Hans.yml","hash":"23b45e77c1846c9457b98c745a60a9461678c389","modified":1473779244000},{"_id":"themes/next/languages/zh-hk.yml","hash":"88e603eb0f3fd25c35bb37bd30372fd77bba7c46","modified":1473779244000},{"_id":"themes/next/languages/zh-tw.yml","hash":"04479b419c72b71fd34046f3fc33ebda4fe8de84","modified":1473779244000},{"_id":"themes/next/layout/_layout.swig","hash":"1138b849e1240249480849cc2b6c6d09b28207a5","modified":1473779244000},{"_id":"themes/next/layout/archive.swig","hash":"b867a08f6b43de8b5d700c84b943df55917407ae","modified":1473779244000},{"_id":"themes/next/layout/category.swig","hash":"58cf08388901f7549b1fca95548b2c79173aa840","modified":1473779244000},{"_id":"themes/next/layout/index.swig","hash":"e5b52e04296203262a400e8e36ae12426d31fd5b","modified":1473779244000},{"_id":"themes/next/layout/page.swig","hash":"a91e3fd7aef26e8a02e339e3372801c517f400cf","modified":1473779244000},{"_id":"themes/next/layout/post.swig","hash":"b8334c479840b7724638eec71971cbd8512ae58d","modified":1473779244000},{"_id":"themes/next/layout/tag.swig","hash":"6f764ea3ab11eeb7c530df45528d449b14f5dc62","modified":1473779244000},{"_id":"themes/next/scripts/merge-configs.js","hash":"f8cde6953939802f92da5b7a2458c6c539e9be69","modified":1473779244000},{"_id":"themes/next/test/.jshintrc","hash":"c9fca43ae0d99718e45a6f5ce736a18ba5fc8fb6","modified":1473779244000},{"_id":"themes/next/test/helpers.js","hash":"f25e7f3265eb5a6e1ccbb5e5012fa9bebf134105","modified":1473779244000},{"_id":"themes/next/test/intern.js","hash":"db90b1063356727d72be0d77054fdc32fa882a66","modified":1473779244000},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1473779244000},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"b87a5122dbff1d5fccf8f3d09d1640bd4b01c4a0","modified":1473779244000},{"_id":"themes/next/layout/_macro/post.swig","hash":"f0862e443e1c7b9ef4a6b619b51ba6038a99a567","modified":1473779244000},{"_id":"themes/next/layout/_macro/reward.swig","hash":"b6cb171f0ed227b82b8f7601814af2df93f3a09a","modified":1473779244000},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"8aa5212d803670179222dbc80e73eadd7328d8e5","modified":1473779244000},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"c5cc0070ca7c9a8dbd4b09e0398db536c3cdbe8a","modified":1473779244000},{"_id":"themes/next/layout/_partials/comments.swig","hash":"d04a53cb1bb8a5f462b05107e9c566c2dfbf4c7d","modified":1473779244000},{"_id":"themes/next/layout/_partials/duoshuo-hot-articles.swig","hash":"ba75672183d94f1de7c8bd0eeee497a58c70e889","modified":1473779244000},{"_id":"themes/next/layout/_partials/footer.swig","hash":"d749b5b6b48dac6ddf5084e470122b09ce0a215a","modified":1473779244000},{"_id":"themes/next/layout/_partials/head.swig","hash":"881abebed3a7fa71827365b0ba0e84ec525eeb7f","modified":1473779244000},{"_id":"themes/next/layout/_partials/header.swig","hash":"c0697644817f1570093de9f17ea096295da8c5f1","modified":1473779244000},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"1634fb887842698e01ff6e632597fe03c75d2d01","modified":1473779244000},{"_id":"themes/next/layout/_partials/search.swig","hash":"95b55fe35f2d2c22f2cc055d4379b5435314c7ec","modified":1473779244000},{"_id":"themes/next/layout/_scripts/baidu-push.swig","hash":"c5db707b46eac6a5df1d2a77f8556945a66fd181","modified":1473779244000},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"c0f5a0955f69ca4ed9ee64a2d5f8aa75064935ad","modified":1473779244000},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"931808ad9b8d8390c0dcf9bdeb0954eeb9185d68","modified":1473779244000},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"c9d45628330ce8bf5fbe71c9f131c7d75334c1c4","modified":1473779244000},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"99b66949f18398689b904907af23c013be1b978f","modified":1473779244000},{"_id":"themes/next/scripts/tags/full-image.js","hash":"86194a05a8c6499de0b2aaa525d6de135778c0ae","modified":1473779244000},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"ac681b0d0d8d39ba3817336c0270c6787c2b6b70","modified":1473779244000},{"_id":"themes/next/source/css/main.styl","hash":"a91dbb7ef799f0a171b5e726c801139efe545176","modified":1473779244000},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1473779244000},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1473779244000},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1473779244000},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1473779244000},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1473779244000},{"_id":"themes/next/source/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1473779244000},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1473779244000},{"_id":"themes/next/source/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1473779244000},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1473779244000},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1473779244000},{"_id":"themes/next/source/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1473779244000},{"_id":"themes/next/source/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1473779244000},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1473779244000},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1473779244000},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1473779244000},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1473779244000},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1473779244000},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1473779244000},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1473779244000},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1473779244000},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"f5e487b0d213ca0bd94aa30bc23b240d65081627","modified":1473779244000},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"efa7efcbb575381b508f9aa0e0c53140eef72a7b","modified":1473779244000},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"a8c7f9ca7c605d039a1f3bf4e4d3183700a3dd62","modified":1473779244000},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"b25002a83cbd2ca0c4a5df87ad5bff26477c0457","modified":1473779244000},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"bf8e9223a40748b2e3ef77d753a8e1dbbce8095e","modified":1473779244000},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"3fdde03f45a80f7a85097a40b40358adde618fc7","modified":1473779244000},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"d4fbffd7fa8f2090eb32a871872665d90a885fac","modified":1473779244000},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"12684840de632eb16e53ffa863166306a756fd4f","modified":1473779244000},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"9b84ab576982b2c3bb0291da49143bc77fba3cc6","modified":1473779244000},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a9a3995b9615adfb8d6b127c78c6771627bee19a","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/analytics.swig","hash":"91c5353fcb94cc3b3f265b06ad2341734bc4c826","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/comments.swig","hash":"8ba01f1ac07fbca62a4b00f5a0a3a506122c1530","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/lean-analytics.swig","hash":"e495aed8fb36bf8015ddbd64366270a7debad2b0","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/localsearch.swig","hash":"f6b46096208512b4d8680c024fcb68f03ceab008","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/mathjax.swig","hash":"4a5c6df1579a4ca72ed17f7dbd6d16a509aa7dc8","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/tinysou.swig","hash":"fe95dd3d166634c466e19aa756e65ad6e8254d3e","modified":1473779244000},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"3403fdd8efde1a0afd11ae8a5a97673f5903087f","modified":1473779244000},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"a0f23e75a137d8c996c70e2059e0074f1e97a127","modified":1473779244000},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"531934ea21ef4dc9f0978512050f54834f0a6cff","modified":1473779244000},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"e55265c8a8a6ae0c3c08e3509de92ee62c3cb5f6","modified":1473779244000},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"b8e3663996b39590509d843f674360872b0242ac","modified":1473779244000},{"_id":"themes/next/source/css/_variables/base.styl","hash":"a7ae72e846393493385275d934eaa78534d9834c","modified":1473779244000},{"_id":"themes/next/source/js/src/affix.js","hash":"1b509c3b5b290a6f4607f0f06461a0c33acb69b1","modified":1473779244000},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"4a0da1bed19e65bd7db42421b447061bc1618710","modified":1473779244000},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"b35a7dc47b634197b93487cea8671a40a9fdffce","modified":1473779244000},{"_id":"themes/next/source/js/src/motion.js","hash":"ff9ea37d05c269e3a140c4ab448af03efc4bcc76","modified":1473779244000},{"_id":"themes/next/source/js/src/post-details.js","hash":"458af3b1bd7783c1950808e66cedfa9fb68bf21f","modified":1473779244000},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"b7657be25fc52ec67c75ab5481bdcb483573338b","modified":1473779244000},{"_id":"themes/next/source/js/src/utils.js","hash":"418d09eb4df5dcc5e8d13d7f6245b1888200b51c","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/.bower.json","hash":"9be892a4e14e0da18ff9cb962c9ef71f163b1b22","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/.gitattributes","hash":"672d3b5767e0eacd83bb41b188c913f2cf754793","modified":1473779244000},{"_id":"themes/next/source/vendors/fastclick/.bower.json","hash":"bf3eef9d647cd7c9b62feda3bc708c6cdd7c0877","modified":1473779244000},{"_id":"themes/next/source/vendors/fastclick/LICENSE","hash":"6f474ea75c42442da7bbcf2e9143ce98258efd8d","modified":1473779244000},{"_id":"themes/next/source/vendors/fastclick/README.md","hash":"68a9b9d53126405b0fa5f3324f1fb96dbcc547aa","modified":1473779244000},{"_id":"themes/next/source/vendors/fastclick/bower.json","hash":"a9b3ee1e4db71a0e4ea6d5bed292d176dd68b261","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/.bower.json","hash":"bb093f2ac1f1305069d873a7941324c8e0de3135","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/.gitignore","hash":"03ddbf76c1dd1afb93eed0b670d2eee747472ef1","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/.npmignore","hash":"c31ff06a740955e44edd4403902e653ccabfd4db","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/HELP-US-OUT.txt","hash":"ed80b43dbc7e3009b2f436741b9796df8eb3be02","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/bower.json","hash":"71e7183634dc1b9449f590f15ebd7201add22ca7","modified":1473779244000},{"_id":"themes/next/source/vendors/jquery/.bower.json","hash":"865d6c1328ab209a4376b9d2b7a7824369565f28","modified":1473779244000},{"_id":"themes/next/source/vendors/jquery_lazyload/.bower.json","hash":"90fa628f156d8045357ff11eaf32e61abacf10e8","modified":1473779244000},{"_id":"themes/next/source/vendors/jquery_lazyload/CONTRIBUTING.md","hash":"4ded6fee668544778e97e38c2b211fc56c848e77","modified":1473779244000},{"_id":"themes/next/source/vendors/jquery_lazyload/README.md","hash":"b930297cb98b8e1dbd5abe9bc1ed9d5935d18ce8","modified":1473779244000},{"_id":"themes/next/source/vendors/jquery_lazyload/bower.json","hash":"e0acf1db27b0cc16128a59c46db1db406b5c4c58","modified":1473779244000},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.lazyload.js","hash":"f4a570908f6c89c6edfb1c74959e733eaadea4f2","modified":1473779244000},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.scrollstop.js","hash":"bf773ad48a0b9aa77681a89d7569eefc0f7b7b18","modified":1473779244000},{"_id":"themes/next/source/vendors/velocity/.bower.json","hash":"63da5e80ebb61bb66a2794d5936315ca44231f0c","modified":1473779244000},{"_id":"themes/next/source/vendors/velocity/bower.json","hash":"92d92860418c4216aa59eb4cb4a556290a7ad9c3","modified":1473779244000},{"_id":"themes/next/source/vendors/velocity/velocity.min.js","hash":"bf172816a9c57f9040e3d19c24e181a142daf92b","modified":1473779244000},{"_id":"themes/next/source/vendors/velocity/velocity.ui.js","hash":"dbbfb50f6502f6b81dcc9fee7b31f1e812da3464","modified":1473779244000},{"_id":"themes/next/source/vendors/velocity/velocity.ui.min.js","hash":"dde584994ac13dc601836e86f4cf490e418d9723","modified":1473779244000},{"_id":"themes/next/source/vendors/jquery/index.js","hash":"17a740d68a1c330876c198b6a4d9319f379f3af2","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/analytics/busuanzi-counter.swig","hash":"24105e62d7f26946907fa14cd02589f899bf8122","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/analytics/baidu-analytics.swig","hash":"ae5b8597603d4e42ee66ed121544e7b1c644767e","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/analytics/cnzz-analytics.swig","hash":"a576c23d426ab236eb3dcd0bfe1b3f0b0c54ad1a","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/analytics/facebook-sdk.swig","hash":"a79e7e0d809fcf407593dd7ed9e023db21c3cbd6","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/analytics/google-analytics.swig","hash":"1b6af02fd0ba3f729675cd95429a0cea4aebf358","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/analytics/tencent-analytics.swig","hash":"8a399df90dadba5ad4e781445b58f4765aeb701e","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/comments/disqus.swig","hash":"f8b6a3017ab79057ce99f1ccb512193d67f4a35f","modified":1473779244000},{"_id":"themes/next/layout/_scripts/third-party/comments/duoshuo.swig","hash":"0a2f48971d86ea72e1a8fd1d8bbf2b7d423666b2","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"ad69cbf94eedacc27e756cdb9c7073416db697d0","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"22828f5141c0cecb9ef25a110e194cdfa3a36423","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"b7d5cc29586ac796a50d90974ad99d24a5982137","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"ff4489cd582f518bba6909a301ac1292a38b4e96","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"88559b13ce94311405b170a0506ded91273beceb","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"6eb4bcc3056bd279d000607e8b4dad50d368ca69","modified":1473779244000},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"12662536c7a07fff548abe94171f34b768dd610f","modified":1473779244000},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"5a35aa0381b0e1d465b952a997194441020446ea","modified":1473779244000},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"b6ee5fefa6046086a76ddbcfafc82482816fa3e0","modified":1473779244000},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"3f40e8a9fe8e7bd5cfc4cf4cbbbcb9539462e973","modified":1473779244000},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"c9218b48c56e52c06af9ce3cc8fbdae737cf16fe","modified":1473779244000},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"ea9069645696f86c5df64208490876fe150c8cae","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"25d5e45a355ee2093f3b8b8eeac125ebf3905026","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"d0bfd1bef988c76f7d7dd72d88af6f0908a8b0db","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"b1025c421406d2c24cc92a02ae28c1915b01e240","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"26666c1f472bf5f3fb9bc62081cca22b4de15ccb","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9b913b73d31d21f057f97115ffab93cfa578b884","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"55b44e03054cd20ed8129bf986b15fba5fd85aad","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"124b540f059fd1ed13514362007cfc70355278c6","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"748dbfbf9c08e719ddc775958003c64b00d39dab","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"13af2fb21fabfc4df4b577ce5363e13d03daff71","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"5dbc0d0c897e46760e5dbee416530d485c747bba","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"c9875c010bebd77b4f59d459a10455fceb0a66a1","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Pisces/_full-image.styl","hash":"de31e923bf5102498f06b1ae6bdf2ea22409f3e0","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"2182a6da3434a6fd4d03ab1592c645d3d3c88500","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"9887bd3894db5394c1e64e800afaae55f47e8dd0","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"1f6e2ce674735269599acc6d77b3ea18d31967fc","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"983c0723e8cfd84b67c2e66da0c26425a8db06e0","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"88a5e0e95f93e4adb196bff1aac17d6cfb03768a","modified":1473779244000},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"a9d064d600ee35acd66508167e1ac8c6cfdbdcd8","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.css","hash":"82f33ad0842aa9c154d029e0dada2497d4eb1d57","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.js","hash":"d71602cbca33b9ecdb7ab291b7f86a49530f3601","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.pack.js","hash":"ae6318aeb62ad4ce7a7e9a4cdacd93ffb004f0fb","modified":1473779244000},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.js","hash":"1d6aeda0480d0e4cb6198edf7719d601d4ae2ccc","modified":1473779244000},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css","hash":"811432ad1e2d6c1f6da9a63fd919bf2a02b71dd9","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.min.css","hash":"4c2c5f5f6cc86d775a44b944661e038b7be98149","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff2","hash":"574ea2698c03ae9477db2ea3baf460ee32f1a7ea","modified":1473779244000},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.min.js","hash":"41ea797c68dbcff2f6fb3aba1d1043a22e7cc0f6","modified":1473779244000},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.pack.js","hash":"a817b6c158cbc5bab3582713de9fe18a18a80552","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/fonts/FontAwesome.otf","hash":"0112e96f327d413938d37c1693806f468ffdbace","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.eot","hash":"b3c2f08e73320135b69c23a3908b87a12053a2f6","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff","hash":"507970402e328b2baeb05bde73bf9ded4e2c3a2d","modified":1473779244000},{"_id":"themes/next/source/vendors/velocity/velocity.js","hash":"e63dc7cea055ca60a95d286f32349d88b10c5a4d","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"4c4ef6e997d0c6e21de39c2daa0c768e12c8c6fa","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"53cde051e0337f4bf42fb8d6d7a79fa3fa6d4ef2","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d63e0cacc53dd375fcc113465a4328c59ff5f2c1","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"852fd77500bda2c1a6651a14aa48d7d6222adc9d","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"0656e753f182c9f47fef7304c847b7587a85ef0d","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"1727702eac5d326b5c81a667944a245016668231","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"70ec8d38d2b3ee1906793d1dcb68032adfa65f03","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"12e366f04497e3f44388fd40111a03e02f7c26af","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"104b5c79cd891506e0beaf938b083685f1da8637","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"7fb593f90d74a99c21840679933b9ef6fdc16a61","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"b8f9c95702e87fd0b170ab586c82c9718a245f8a","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"4e3838d7ac81d9ad133960f0f7ed58a44a015285","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"7f2bdd6109614d35408ee5ac3335aad4464c69c7","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"761eba9811b050b25d548cc0854de4824b41eb08","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"821991c0890966a512b43e8b1cf9537e738a09a0","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"61f8cea3c01acd600e90e1bc2a07def405503748","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"1153bb71edf253765145559674390e16dd67c633","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"394888efec32749b353292a59ec7f1b609d6325e","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"06b9a99d63b4d57fdbf70b88ab7036fbc47e3f52","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"702be9e57dd6ff5fa99642a1f6e3df26215b8805","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"e71652d3216e289c8548b1ea2357822c1476a425","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"a45f5fce643eec4e1b927165229d560364bcace1","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"a200c0a1c5a895ac9dc41e0641a5dfcd766be99b","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"4866fb9453d7d4c83a1c4e55d74e4afed336eb8b","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"cd9e214e502697f2f2db84eb721bac57a49b0fce","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"ca20affaeaf33c0904cb6356864fc6b78e95f447","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-more-link.styl","hash":"2bc3e33fdfbcf348c96ca60598f629dcd7ba3617","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"8355b0e9375b3245508efda0e18acd069c2aa767","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"929fac3a505bacbce6ba63009fd15851e2a8669d","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"5a982d8ef3b3623ea5f59e63728990f5623c1b57","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"01567edaea6978628aa5521a122a85434c418bfd","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"681b7c8ce4dc47130a0ca67c1ec62be7c96e4c4f","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"2fe76476432b31993338cb45cdb3b29a518b6379","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"dd941824210733588841897457e0cc9697ca5608","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"2ad1a2a9bbf6742d1b0762c4c623b68113d1e0fe","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"a83f493e494f5c73fab8f6f5b686ef1670490095","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"5dbeed535d63a50265d96b396a5440f9bb31e4ba","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"7f7e9df15148608a9c29326dd880d8e8e8efc0ec","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"717cc7f82be9cc151e23a7678601ff2fd3a7fa1d","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"15975ba7456b96916b1dbac448a1a0d2c38b8f3d","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"dcb4548d07cbb38b645b1753cf3ee7157e16921a","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"7bd182d918f3117335a5ee87a1b544e6d2b54d7d","modified":1473779244000},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"350469437b20ecfd6f3ca45e400478f8e3f71cfb","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"cf900c5026ab36f31118317d0ae32a213e3ec2a9","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"a07aa12cc36ac5c819670c2a3c17d07ed7a08986","modified":1473779244000},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"cf900c5026ab36f31118317d0ae32a213e3ec2a9","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"6394c48092085788a8c0ef72670b0652006231a1","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"ee948b4489aedeb548a77c9e45d8c7c5732fd62d","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-media.js","hash":"51139a4c79573d372a347ef01a493222a1eaf10a","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"b88b589f5f1aa1b3d87cc7eef34c281ff749b1ae","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"d22b1629cb23a6181bebb70d0cf653ffe4b835c8","modified":1473779244000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.ttf","hash":"27cf1f2ec59aece6938c7bb2feb0e287ea778ff9","modified":1473779244000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.svg","hash":"f346b8b3df147e4059e1a7d66c52c9a6e1cec3e8","modified":1473779244000},{"_id":"public/atom.xml","hash":"c81699b248e0c0d96afa94c7c4969b76c3091c8d","modified":1473920369510},{"_id":"public/sitemap.xml","hash":"d741916e85cbda8a6c50a6037e45c130b5524b9a","modified":1473920369527},{"_id":"public/about/index.html","hash":"295836c31fa70a5397ca78a1354797ba31f855fa","modified":1473920369539},{"_id":"public/tags/index.html","hash":"1124f519359e9bd652c6fa22871f25b6e5987f40","modified":1473920369539},{"_id":"public/categories/index.html","hash":"7e4d21b7c7fae47894d1db32630c6273bcaab355","modified":1473920369539},{"_id":"public/2016/03/10/something/index.html","hash":"79de31cf5ff356850ed3db95b5a96fa1bcacb5c7","modified":1473920369539},{"_id":"public/archives/2016/01/index.html","hash":"464033dabe85e30385a06e809b0ba72e2eb6a8e7","modified":1473920369539},{"_id":"public/archives/2016/02/index.html","hash":"41336c23890f97716716d032c6252fd2b5408a2f","modified":1473920369539},{"_id":"public/archives/2016/03/index.html","hash":"715acc22e1f3be0d5a91ef572d0e55a150a705df","modified":1473920369539},{"_id":"public/archives/2016/04/index.html","hash":"baae1edbbc564208bf7375d6d46e3f2f13b7ce9d","modified":1473920369539},{"_id":"public/archives/2016/06/index.html","hash":"2dc1767618fef45e22dda1e51f094e166a1f81f2","modified":1473920369539},{"_id":"public/archives/2016/07/index.html","hash":"95f86b542d4662d150ea714df45592d303a0b512","modified":1473920369540},{"_id":"public/archives/2016/08/index.html","hash":"9466bd9360f1dd883024719c0a85759d086576a1","modified":1473920369540},{"_id":"public/categories/JavaScript/index.html","hash":"26a1fa2023bc0af7d6462009e478087064cbbd56","modified":1473920369540},{"_id":"public/categories/CodeSmith/index.html","hash":"5b9b27207bb18fa686a21009bc2e5bbb9c918d5e","modified":1473920369540},{"_id":"public/categories/GC/index.html","hash":"ec85e362f099ac5651224b361bbc28afa333fa35","modified":1473920369540},{"_id":"public/categories/jexus/index.html","hash":"235f6a5ba1ca890fb2e0c3450e7f6f5cc8bcf312","modified":1473920369540},{"_id":"public/categories/net-core/index.html","hash":"13843c0f1ec53621bfd77eb5bc42377e36cb5012","modified":1473920369540},{"_id":"public/categories/nothing/index.html","hash":"8a0699effd9b12c01a0b7ffaa41eda8bd4ab140f","modified":1473920369540},{"_id":"public/categories/ubuntu/index.html","hash":"9f493f415a1756274f1832230fb16fe232d6d58f","modified":1473920369540},{"_id":"public/tags/58City/index.html","hash":"ede2e69ffb7f091958884cf764f503ed0f6dc679","modified":1473920369540},{"_id":"public/tags/Crawler/index.html","hash":"e3931ca33f9f389888c13ee01d709b9e4e24912f","modified":1473920369540},{"_id":"public/tags/mono/index.html","hash":"e0b2cde36f061cfafa79ac5aabf11ef5c7352586","modified":1473920369541},{"_id":"public/tags/webreques-exception/index.html","hash":"eac23609a5bde7bff30e7a5a5b0f3bb9cb520e3d","modified":1473920369541},{"_id":"public/2016/08/13/58City-House-Crawler-JS/index.html","hash":"3f27d3abf6ff9ce4d57ad5de22d00aca407f3c7a","modified":1473920369541},{"_id":"public/2016/08/08/58City-House-Crawler/index.html","hash":"69956e99c0be5537e177d3c9ee3b4d3237e9e849","modified":1473920369541},{"_id":"public/2016/08/01/ASP.NET-Core-Middleware/index.html","hash":"35284c7839a751a468afc202cb62b97265383afe","modified":1473920369541},{"_id":"public/2016/07/28/asp.net-core-startup/index.html","hash":"a194d5df8b3d086cc590a5dc25852ce2caa0a542","modified":1473920369541},{"_id":"public/2016/06/20/don’t-throw-exception-in-foreach/index.html","hash":"5346ecbe6f89c34acc08b89f4045242ca2a06daa","modified":1473920369541},{"_id":"public/2016/04/20/CodeSmith-connect-MySQL-throw“can‘t find .Net Framework Data Provider”/index.html","hash":"d77e83f4316f87415852bff4d0d1f9402e2a85c7","modified":1473920369541},{"_id":"public/2016/04/20/Jexus-support-HTTPS/index.html","hash":"cbb231e23790fd22f1bdcfa67f65b2de1566e0f3","modified":1473920369541},{"_id":"public/2016/04/10/mono-webreques-https-exception/index.html","hash":"021a16e3befbf4ffc67baf295136999bce496af6","modified":1473920369541},{"_id":"public/2016/04/07/ubuntu-jexus-mywebsql/index.html","hash":"c8c7de37f4e7b4770c0fe63404874b548b3f2fb2","modified":1473920369541},{"_id":"public/2016/03/28/CodeSmith to MySQL/index.html","hash":"fc6e18ed0d1985f7419aefb9f93fbf16251cf44d","modified":1473920369541},{"_id":"public/2016/03/25/GC-1/index.html","hash":"3bfb56e7ae9b38c6bed8f937a2abf290aa25fc9d","modified":1473920369541},{"_id":"public/2016/03/20/GC-2/index.html","hash":"c4f3abadc4b944257509f52f1539ac087c918369","modified":1473920369541},{"_id":"public/2016/03/15/LINQ-advantage/index.html","hash":"53aef4c76a4fb4bda4bd3cb26b68043ac4c0bc96","modified":1473920369541},{"_id":"public/2016/03/03/Join/index.html","hash":"28bfa1805c7e4709a9a68bdb84b3afc34adf3406","modified":1473920369541},{"_id":"public/2016/02/15/can't-modify-linq-object/index.html","hash":"cf038a82e5cbc0727c69bb52f2dfc69a5b67efe3","modified":1473920369542},{"_id":"public/2016/02/10/classfield-property/index.html","hash":"c71e5eac8795fc3671d14701c311919344c15af6","modified":1473920369542},{"_id":"public/2016/01/20/Bytes -To-String/index.html","hash":"57cdca11cc7b51fa7fd1df689c391d05fea3ae83","modified":1473920369542},{"_id":"public/archives/index.html","hash":"2a62fd794a5f53428cb127f71fdd8159ec0278a1","modified":1473920369542},{"_id":"public/archives/page/2/index.html","hash":"d8cb6d20bae849343610b90dca81b7fc689bd050","modified":1473920369542},{"_id":"public/archives/2016/index.html","hash":"db99918fcc3b70d92b9f2a7fa05cf02adef812f2","modified":1473920369542},{"_id":"public/archives/2016/page/2/index.html","hash":"5b8419f4398c0c39914bb85dfe53ee63a987569c","modified":1473920369542},{"_id":"public/categories/net/index.html","hash":"24518219087d17770b2ab8f9fc58de03e3b9b3d0","modified":1473920369542},{"_id":"public/index.html","hash":"b3593ed6b00b15f4425a6ba6426dbdfd489a3e89","modified":1473920369542},{"_id":"public/page/2/index.html","hash":"0d6dd9c850f41024df6c2b707cafcc950161dab9","modified":1473920369542},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1473920369559},{"_id":"public/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1473920369559},{"_id":"public/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1473920369559},{"_id":"public/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1473920369559},{"_id":"public/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1473920369559},{"_id":"public/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1473920369559},{"_id":"public/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1473920369559},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1473920369560},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1473920369560},{"_id":"public/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1473920369560},{"_id":"public/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1473920369560},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1473920369560},{"_id":"public/vendors/fastclick/LICENSE","hash":"6f474ea75c42442da7bbcf2e9143ce98258efd8d","modified":1473920369560},{"_id":"public/vendors/font-awesome/HELP-US-OUT.txt","hash":"ed80b43dbc7e3009b2f436741b9796df8eb3be02","modified":1473920369561},{"_id":"public/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1473920369561},{"_id":"public/vendors/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1473920369561},{"_id":"public/vendors/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1473920369561},{"_id":"public/vendors/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1473920369561},{"_id":"public/vendors/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1473920369561},{"_id":"public/vendors/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1473920369561},{"_id":"public/vendors/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1473920369561},{"_id":"public/vendors/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1473920369561},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.woff2","hash":"574ea2698c03ae9477db2ea3baf460ee32f1a7ea","modified":1473920369561},{"_id":"public/vendors/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1473920369561},{"_id":"public/vendors/font-awesome/fonts/FontAwesome.otf","hash":"0112e96f327d413938d37c1693806f468ffdbace","modified":1473920370073},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.eot","hash":"b3c2f08e73320135b69c23a3908b87a12053a2f6","modified":1473920370079},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.woff","hash":"507970402e328b2baeb05bde73bf9ded4e2c3a2d","modified":1473920370080},{"_id":"public/js/src/bootstrap.js","hash":"39bf93769d9080fa01a9a875183b43198f79bc19","modified":1473920370085},{"_id":"public/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1473920370085},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1473920370085},{"_id":"public/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1473920370085},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1473920370085},{"_id":"public/js/src/post-details.js","hash":"2038f54e289b6da5def09689e69f623187147be5","modified":1473920370085},{"_id":"public/js/src/utils.js","hash":"e5cb720894c4bc28ca8f10b33df127fb394018d9","modified":1473920370085},{"_id":"public/vendors/fastclick/README.html","hash":"da3c74d484c73cc7df565e8abbfa4d6a5a18d4da","modified":1473920370086},{"_id":"public/vendors/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1473920370086},{"_id":"public/vendors/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1473920370086},{"_id":"public/vendors/jquery_lazyload/CONTRIBUTING.html","hash":"a6358170d346af13b1452ac157b60505bec7015c","modified":1473920370086},{"_id":"public/vendors/jquery_lazyload/README.html","hash":"bde24335f6bc09d8801c0dcd7274f71b466552bd","modified":1473920370086},{"_id":"public/vendors/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1473920370086},{"_id":"public/vendors/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1473920370086},{"_id":"public/vendors/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1473920370086},{"_id":"public/vendors/velocity/bower.json","hash":"0ef14e7ccdfba5db6eb3f8fc6aa3b47282c36409","modified":1473920370087},{"_id":"public/vendors/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1473920370087},{"_id":"public/js/src/schemes/pisces.js","hash":"7506e7490c69a200831393c38d25e91c156bd471","modified":1473920370087},{"_id":"public/vendors/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1473920370087},{"_id":"public/vendors/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1473920370087},{"_id":"public/vendors/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1473920370087},{"_id":"public/vendors/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1473920370087},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1473920370087},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1473920370087},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1473920370087},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1473920370087},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1473920370087},{"_id":"public/css/main.css","hash":"fe0d68cedf7d2407ca9775ca96bf00976e4e4bd4","modified":1473920370087},{"_id":"public/vendors/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1473920370087},{"_id":"public/vendors/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1473920370087},{"_id":"public/vendors/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1473920370087},{"_id":"public/vendors/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1473920370087},{"_id":"public/vendors/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1473920370087},{"_id":"public/vendors/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1473920370088},{"_id":"public/vendors/font-awesome/css/font-awesome.css","hash":"3b87c2560832748cd06f9bfd2fd6ea8edbdae8c7","modified":1473920370088},{"_id":"public/vendors/font-awesome/css/font-awesome.min.css","hash":"05ea25bc9b3ac48993e1fee322d3bc94b49a6e22","modified":1473920370088},{"_id":"public/vendors/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1473920370088},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.ttf","hash":"27cf1f2ec59aece6938c7bb2feb0e287ea778ff9","modified":1473920370088},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.svg","hash":"f346b8b3df147e4059e1a7d66c52c9a6e1cec3e8","modified":1473920370124}],"Category":[{"name":"JavaScript","_id":"cit3xw9s70002c0txwevsl9xq"},{"name":".net","_id":"cit3xw9si0007c0tx6be0j5in"},{"name":"CodeSmith","_id":"cit3xw9sy000hc0tx79i2ylvf"},{"name":"GC","_id":"cit3xw9tb000uc0txsfbwhp0i"},{"name":"jexus","_id":"cit3xw9te0011c0txrg8lmdpe"},{"name":".net core","_id":"cit3xw9th0013c0txfnyixq5n"},{"name":"nothing","_id":"cit3xw9ts001bc0txbiijvkwa"},{"name":"ubuntu","_id":"cit3xw9ts001dc0tx4xc46xy0"}],"Data":[],"Page":[{"title":"about","date":"2016-09-13T15:52:17.000Z","_content":"\n\n","source":"about/index.md","raw":"title: about\ndate: 2016-09-13 23:52:17\n---\n\n\n","updated":"2016-09-15T05:11:13.655Z","path":"about/index.html","comments":1,"layout":"page","_id":"cit3xw9tm0017c0txachjv0x5","content":"","excerpt":"","more":""},{"title":"categories","date":"2016-09-13T15:24:18.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"title: categories\ndate: 2016-09-13 23:24:18\ntype: \"categories\"\n---\n","updated":"2016-09-15T05:11:13.655Z","path":"categories/index.html","comments":1,"layout":"page","_id":"cit3xw9tp0019c0txo1kszl6y","content":"","excerpt":"","more":""},{"title":"tags","date":"2016-09-13T15:49:07.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"title: tags\ndate: 2016-09-13 23:49:07\ntype: \"tags\"\n---\n","updated":"2016-09-15T05:11:13.656Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cit3xw9ty001hc0txrrb065f7","content":"","excerpt":"","more":""}],"Post":[{"layout":"post","title":"58同城高德搜房项目JS相关知识","date":"2016-08-12T16:00:00.000Z","_content":"\n在线地址：[58同城品牌公寓高德搜房](http://codelover.link:8080/)\n\nGithub地址：[https://github.com/liguobao/58HouseSearch](https://github.com/liguobao/58HouseSearch)\n\n知乎专栏(点赞用的)：[高德API+Python解决租房问题(.NET版)](https://zhuanlan.zhihu.com/p/21960329)\n\n经过了一个星期的修补补，以及小伙伴奉献的代码，整个项目基本处于基本稳定运行的状态。\n\n同时加入了一下新功能：\n\n1. IP定位：调用高德地图IP定位功能实现\n2. 移动地图中心定位：调用高德地图移动地图定位实现\n3. 定位城市名转58同城城市名以获得准确58同城城市域名：抓取58同城城市分类信息\n4. 优化数据源、去除广告数据：小伙伴奉献代码\n\n今天主要简单讲解一下其中使用的一些高德地图API接口。\n\n#####高德地图JavaScript API 主体为map对象，基本所有的操作都是通过map对象来实现的。\nmap对象实例化是通过 Amap类来做的。如以下代码：\n```javascript\nmap = new AMap.Map(\"container\", {\n        resizeEnable: true,\n        zoomEnable: true,\n        center: [121.297428, 31.1345],//经纬度，此处为上海\n        zoom: 11\n    });\n\n```\n\n\n\n\n\n#### IP定位\n调用Map.CitySearch()获得当前IP所在城市，直接将地图显示成当前城市。代码如下：\n```JavaScript\nfunction showCityInfo(map) {\n    //实例化城市查询类\n    var citysearch = new AMap.CitySearch();\n    //自动获取用户IP，返回当前城市\n    citysearch.getLocalCity(function (status, result) {\n        if (status === 'complete' && result.info === 'OK') {\n            if (result && result.city && result.bounds) {\n                var cityinfo = result.city;//获得XX市\n                var citybounds = result.bounds;//用于设置地图显示位置的实例\n                cityName = cityinfo.substring(0, cityinfo.length - 1);//去掉市这个字\n                ConvertCityCNNameToShortCut();//城市名转换成58同城城市域名字母，如上海->sh,苏州->su,\n                                              //下面会有实现代码\n\n                document.getElementById('IPLocation').innerHTML = '您当前所在城市：' + cityName;\n                //地图显示当前城市\n                map.setBounds(citybounds);\n            }\n        } else {\n            document.getElementById('IPLocation').innerHTML = result.info;\n        }\n    });\n}\n\n```\n\n\n#### 移动地图自动中心定位\n\n之前有一版是让用户输入城市名，然后直接定位到输入的城市的。\n这个功能卡在了设置地图显示位置上，如果是使用高德地图提供的搜索控件的话，又存在输入结果之后搜索结果可能是多个的问题。而且这点我只是要取到用户想要定位的城市而已，感觉没必要做得太复杂。\n昨晚在看高德地图API的时候发现，有一个移动地图获得地图中心所在位置的样例，马上眼前一亮了。这个功能比我想要的还要好...果断上。\n\n```JavaScript\nfunction MapMoveToLocationCity()\n{\n    map.on('moveend', getCity);\n    function getCity() {\n        map.getCity(function (data) {\n            if (data['province'] && typeof data['province'] === 'string') {\n\n                var cityinfo = (data['city'] || data['province']);\n                cityName = cityinfo.substring(0, cityinfo.length - 1);\n                ConvertCityCNNameToShortCut();//城市名转58同城地区域名\n\n                document.getElementById('IPLocation').innerHTML = '地图中心所在城市：' + cityName;\n\n            }\n        });\n    }\n}\n```\n\n整个代码的意思是，给map绑定一下移动时间，移动完了之后，调用getCity的方法获取当前地图中心所在城市信息。\n\n这个时候要注意，城市名可能在city对象里面，也可能在province里面。\n\n原因很简单：普通城市等级就是城市，我国还存在一个和省份一个等级的城市：直辖市。因此直辖市的城市名是在province里面的。\n\n\n#### 城市名匹配58同城地区域名\n\n这个是上个版本(两三天前)的一个bug引出来的新功能。\n\n上个版本是让用户输入城市名，然后提取城市名的中文拼音首字母作为58同城地区域名。如上海 =sh，广州=gz，北京=bj，成都=cd。\n\n这个功能使用的是网上别人写的一个JS库，通过汉字匹配实现的。转换出来的数据没什么问题，不过我国汉字实在奥妙。\n\n广州=gz，赣州=gz；\n遂宁=sn；绥宁=sn；\n惠州=hz，杭州=hz。\n\n这样一来，上面这个做法就没法玩了。\n\n想了下怎么解决这个问题，灵机一动。反正是在爬58的数据，这个城市名和城市域名数据58同城肯定有啊，然后找到了这个。\n[58同城城市分类导航](http://www.58.com/changecity.aspx?PGTID=0d100000-0007-a77b-4c4b-a28f725b8f5a&ClickID=1)\n\n![](http://7xread.com1.z0.glb.clouddn.com/c01c293a-d5cc-4f58-80dc-13aa05d47b01)\n\n很明显，我要的所有城市名和城市域名都是里面了。\n\n晚上和衣衣说了下，衣衣一大早就把处理好的json数据给我了。\n\n于是来了下面一段代码：\n```JavaScript\n\n//加载json文件\n$.getJSON(\"DomainJS/city.json\", function (data)\n{\n      allCityInfo = data;\n});\n\n\nfunction ConvertCityCNNameToShortCut()\n{\n    var filterarray = $.grep(allCityInfo, function (obj) {\n        return obj.cityName == cityName;\n    });//找到当前城市名对应的json对象\n    //获取json对象的地区域名\n    cityNameCNPY = filterarray instanceof Array ? \n    filterarray[0].shortCut : filterarray != null ? filterarray.shortCut : \"\";\n}\n\n```\n\n\n#### 高德地图自动补全功能\n\n```html\n  <div class=\"control-input\">\n       <input id=\"work-location\" type=\"text\" style=\"width:60%\">\n  </div>\n```\n\n```JavaScript\n var auto = new AMap.Autocomplete({\n        input: \"work-location\"\n    });\n\n    AMap.event.addListener(auto, \"select\", workLocationSelected);\n    \n```\n看方法前面也知道，其实这就是把ID为work-location的input初始化为地图插件，然后给Amap增加了一个监听事件。\n当其中选中某一个数据的时候，触发workLocationSelected函数。效果如下：\n\n![](http://7xread.com1.z0.glb.clouddn.com/fe425992-e7c4-4cae-800e-319eff3b17e8)\n\n\n在这里locationSelected是定位到所选位置，代码如下：\n```\nfunction workLocationSelected(e) {\n    workAddress = e.poi.name;\n    loadWorkLocation();\n}\n\nfunction loadWorkLocation() {\n    delWorkLocation();\n    var geocoder = new AMap.Geocoder({\n        city: cityName,\n        radius: 1000\n    });\n\n    geocoder.getLocation(workAddress, function (status, result) {\n        if (status === \"complete\" && result.info === 'OK') {\n            var geocode = result.geocodes[0];\n            x = geocode.location.getLng();\n            y = geocode.location.getLat();\n            loadWorkMarker(x, y);\n            loadWorkRange(x, y, 60, \"#3f67a5\", vehicle);\n            map.setZoomAndCenter(12, [x, y]);\n        }\n    })\n}\n\n```\n\n至于导航功能代码我没怎么动，没去研究就不献丑了...\n\n\n最后来个效果图。\n\n#### 北京\n![](http://7xread.com1.z0.glb.clouddn.com/e7900aba-5a56-417c-9dd9-63527583e84b)\n\n#### 成都\n![](http://7xread.com1.z0.glb.clouddn.com/c9947d97-1b76-42bf-82b3-aca817e84e13)\n\n#### 苏州\n![](http://7xread.com1.z0.glb.clouddn.com/941809ae-aa37-4a3b-89c7-10646cc7e3e7)\n\n#### 深圳\n![](http://7xread.com1.z0.glb.clouddn.com/86712397-27ec-4b37-bbf8-81191e530ef6)\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/58City-House-Crawler-JS.md","raw":"---\nlayout: post\ntitle: 58同城高德搜房项目JS相关知识\ncategory: JavaScript\ndate: 2016-08-13 00:00:00\n---\n\n在线地址：[58同城品牌公寓高德搜房](http://codelover.link:8080/)\n\nGithub地址：[https://github.com/liguobao/58HouseSearch](https://github.com/liguobao/58HouseSearch)\n\n知乎专栏(点赞用的)：[高德API+Python解决租房问题(.NET版)](https://zhuanlan.zhihu.com/p/21960329)\n\n经过了一个星期的修补补，以及小伙伴奉献的代码，整个项目基本处于基本稳定运行的状态。\n\n同时加入了一下新功能：\n\n1. IP定位：调用高德地图IP定位功能实现\n2. 移动地图中心定位：调用高德地图移动地图定位实现\n3. 定位城市名转58同城城市名以获得准确58同城城市域名：抓取58同城城市分类信息\n4. 优化数据源、去除广告数据：小伙伴奉献代码\n\n今天主要简单讲解一下其中使用的一些高德地图API接口。\n\n#####高德地图JavaScript API 主体为map对象，基本所有的操作都是通过map对象来实现的。\nmap对象实例化是通过 Amap类来做的。如以下代码：\n```javascript\nmap = new AMap.Map(\"container\", {\n        resizeEnable: true,\n        zoomEnable: true,\n        center: [121.297428, 31.1345],//经纬度，此处为上海\n        zoom: 11\n    });\n\n```\n\n\n\n\n\n#### IP定位\n调用Map.CitySearch()获得当前IP所在城市，直接将地图显示成当前城市。代码如下：\n```JavaScript\nfunction showCityInfo(map) {\n    //实例化城市查询类\n    var citysearch = new AMap.CitySearch();\n    //自动获取用户IP，返回当前城市\n    citysearch.getLocalCity(function (status, result) {\n        if (status === 'complete' && result.info === 'OK') {\n            if (result && result.city && result.bounds) {\n                var cityinfo = result.city;//获得XX市\n                var citybounds = result.bounds;//用于设置地图显示位置的实例\n                cityName = cityinfo.substring(0, cityinfo.length - 1);//去掉市这个字\n                ConvertCityCNNameToShortCut();//城市名转换成58同城城市域名字母，如上海->sh,苏州->su,\n                                              //下面会有实现代码\n\n                document.getElementById('IPLocation').innerHTML = '您当前所在城市：' + cityName;\n                //地图显示当前城市\n                map.setBounds(citybounds);\n            }\n        } else {\n            document.getElementById('IPLocation').innerHTML = result.info;\n        }\n    });\n}\n\n```\n\n\n#### 移动地图自动中心定位\n\n之前有一版是让用户输入城市名，然后直接定位到输入的城市的。\n这个功能卡在了设置地图显示位置上，如果是使用高德地图提供的搜索控件的话，又存在输入结果之后搜索结果可能是多个的问题。而且这点我只是要取到用户想要定位的城市而已，感觉没必要做得太复杂。\n昨晚在看高德地图API的时候发现，有一个移动地图获得地图中心所在位置的样例，马上眼前一亮了。这个功能比我想要的还要好...果断上。\n\n```JavaScript\nfunction MapMoveToLocationCity()\n{\n    map.on('moveend', getCity);\n    function getCity() {\n        map.getCity(function (data) {\n            if (data['province'] && typeof data['province'] === 'string') {\n\n                var cityinfo = (data['city'] || data['province']);\n                cityName = cityinfo.substring(0, cityinfo.length - 1);\n                ConvertCityCNNameToShortCut();//城市名转58同城地区域名\n\n                document.getElementById('IPLocation').innerHTML = '地图中心所在城市：' + cityName;\n\n            }\n        });\n    }\n}\n```\n\n整个代码的意思是，给map绑定一下移动时间，移动完了之后，调用getCity的方法获取当前地图中心所在城市信息。\n\n这个时候要注意，城市名可能在city对象里面，也可能在province里面。\n\n原因很简单：普通城市等级就是城市，我国还存在一个和省份一个等级的城市：直辖市。因此直辖市的城市名是在province里面的。\n\n\n#### 城市名匹配58同城地区域名\n\n这个是上个版本(两三天前)的一个bug引出来的新功能。\n\n上个版本是让用户输入城市名，然后提取城市名的中文拼音首字母作为58同城地区域名。如上海 =sh，广州=gz，北京=bj，成都=cd。\n\n这个功能使用的是网上别人写的一个JS库，通过汉字匹配实现的。转换出来的数据没什么问题，不过我国汉字实在奥妙。\n\n广州=gz，赣州=gz；\n遂宁=sn；绥宁=sn；\n惠州=hz，杭州=hz。\n\n这样一来，上面这个做法就没法玩了。\n\n想了下怎么解决这个问题，灵机一动。反正是在爬58的数据，这个城市名和城市域名数据58同城肯定有啊，然后找到了这个。\n[58同城城市分类导航](http://www.58.com/changecity.aspx?PGTID=0d100000-0007-a77b-4c4b-a28f725b8f5a&ClickID=1)\n\n![](http://7xread.com1.z0.glb.clouddn.com/c01c293a-d5cc-4f58-80dc-13aa05d47b01)\n\n很明显，我要的所有城市名和城市域名都是里面了。\n\n晚上和衣衣说了下，衣衣一大早就把处理好的json数据给我了。\n\n于是来了下面一段代码：\n```JavaScript\n\n//加载json文件\n$.getJSON(\"DomainJS/city.json\", function (data)\n{\n      allCityInfo = data;\n});\n\n\nfunction ConvertCityCNNameToShortCut()\n{\n    var filterarray = $.grep(allCityInfo, function (obj) {\n        return obj.cityName == cityName;\n    });//找到当前城市名对应的json对象\n    //获取json对象的地区域名\n    cityNameCNPY = filterarray instanceof Array ? \n    filterarray[0].shortCut : filterarray != null ? filterarray.shortCut : \"\";\n}\n\n```\n\n\n#### 高德地图自动补全功能\n\n```html\n  <div class=\"control-input\">\n       <input id=\"work-location\" type=\"text\" style=\"width:60%\">\n  </div>\n```\n\n```JavaScript\n var auto = new AMap.Autocomplete({\n        input: \"work-location\"\n    });\n\n    AMap.event.addListener(auto, \"select\", workLocationSelected);\n    \n```\n看方法前面也知道，其实这就是把ID为work-location的input初始化为地图插件，然后给Amap增加了一个监听事件。\n当其中选中某一个数据的时候，触发workLocationSelected函数。效果如下：\n\n![](http://7xread.com1.z0.glb.clouddn.com/fe425992-e7c4-4cae-800e-319eff3b17e8)\n\n\n在这里locationSelected是定位到所选位置，代码如下：\n```\nfunction workLocationSelected(e) {\n    workAddress = e.poi.name;\n    loadWorkLocation();\n}\n\nfunction loadWorkLocation() {\n    delWorkLocation();\n    var geocoder = new AMap.Geocoder({\n        city: cityName,\n        radius: 1000\n    });\n\n    geocoder.getLocation(workAddress, function (status, result) {\n        if (status === \"complete\" && result.info === 'OK') {\n            var geocode = result.geocodes[0];\n            x = geocode.location.getLng();\n            y = geocode.location.getLat();\n            loadWorkMarker(x, y);\n            loadWorkRange(x, y, 60, \"#3f67a5\", vehicle);\n            map.setZoomAndCenter(12, [x, y]);\n        }\n    })\n}\n\n```\n\n至于导航功能代码我没怎么动，没去研究就不献丑了...\n\n\n最后来个效果图。\n\n#### 北京\n![](http://7xread.com1.z0.glb.clouddn.com/e7900aba-5a56-417c-9dd9-63527583e84b)\n\n#### 成都\n![](http://7xread.com1.z0.glb.clouddn.com/c9947d97-1b76-42bf-82b3-aca817e84e13)\n\n#### 苏州\n![](http://7xread.com1.z0.glb.clouddn.com/941809ae-aa37-4a3b-89c7-10646cc7e3e7)\n\n#### 深圳\n![](http://7xread.com1.z0.glb.clouddn.com/86712397-27ec-4b37-bbf8-81191e530ef6)\n\n\n\n\n\n\n\n\n\n\n\n","slug":"58City-House-Crawler-JS","published":1,"updated":"2016-09-15T05:11:13.645Z","comments":1,"photos":[],"link":"","_id":"cit3xw9rz0000c0txbwbzwlnz","content":"<p>在线地址：<a href=\"http://codelover.link:8080/\">58同城品牌公寓高德搜房</a></p>\n<p>Github地址：<a href=\"https://github.com/liguobao/58HouseSearch\" target=\"_blank\" rel=\"external\">https://github.com/liguobao/58HouseSearch</a></p>\n<p>知乎专栏(点赞用的)：<a href=\"https://zhuanlan.zhihu.com/p/21960329\" target=\"_blank\" rel=\"external\">高德API+Python解决租房问题(.NET版)</a></p>\n<p>经过了一个星期的修补补，以及小伙伴奉献的代码，整个项目基本处于基本稳定运行的状态。</p>\n<p>同时加入了一下新功能：</p>\n<ol>\n<li>IP定位：调用高德地图IP定位功能实现</li>\n<li>移动地图中心定位：调用高德地图移动地图定位实现</li>\n<li>定位城市名转58同城城市名以获得准确58同城城市域名：抓取58同城城市分类信息</li>\n<li>优化数据源、去除广告数据：小伙伴奉献代码</li>\n</ol>\n<p>今天主要简单讲解一下其中使用的一些高德地图API接口。</p>\n<p>#####高德地图JavaScript API 主体为map对象，基本所有的操作都是通过map对象来实现的。<br>map对象实例化是通过 Amap类来做的。如以下代码：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">map = <span class=\"keyword\">new</span> AMap.Map(<span class=\"string\">\"container\"</span>, &#123;</div><div class=\"line\">        resizeEnable: <span class=\"literal\">true</span>,</div><div class=\"line\">        zoomEnable: <span class=\"literal\">true</span>,</div><div class=\"line\">        center: [<span class=\"number\">121.297428</span>, <span class=\"number\">31.1345</span>],<span class=\"comment\">//经纬度，此处为上海</span></div><div class=\"line\">        zoom: <span class=\"number\">11</span></div><div class=\"line\">    &#125;);</div></pre></td></tr></table></figure></p>\n<h4 id=\"IP定位\"><a href=\"#IP定位\" class=\"headerlink\" title=\"IP定位\"></a>IP定位</h4><p>调用Map.CitySearch()获得当前IP所在城市，直接将地图显示成当前城市。代码如下：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">showCityInfo</span>(<span class=\"params\">map</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">//实例化城市查询类</span></div><div class=\"line\">    <span class=\"keyword\">var</span> citysearch = <span class=\"keyword\">new</span> AMap.CitySearch();</div><div class=\"line\">    <span class=\"comment\">//自动获取用户IP，返回当前城市</span></div><div class=\"line\">    citysearch.getLocalCity(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">status, result</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (status === <span class=\"string\">'complete'</span> &amp;&amp; result.info === <span class=\"string\">'OK'</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (result &amp;&amp; result.city &amp;&amp; result.bounds) &#123;</div><div class=\"line\">                <span class=\"keyword\">var</span> cityinfo = result.city;<span class=\"comment\">//获得XX市</span></div><div class=\"line\">                <span class=\"keyword\">var</span> citybounds = result.bounds;<span class=\"comment\">//用于设置地图显示位置的实例</span></div><div class=\"line\">                cityName = cityinfo.substring(<span class=\"number\">0</span>, cityinfo.length - <span class=\"number\">1</span>);<span class=\"comment\">//去掉市这个字</span></div><div class=\"line\">                ConvertCityCNNameToShortCut();<span class=\"comment\">//城市名转换成58同城城市域名字母，如上海-&gt;sh,苏州-&gt;su,</span></div><div class=\"line\">                                              <span class=\"comment\">//下面会有实现代码</span></div><div class=\"line\"></div><div class=\"line\">                <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'IPLocation'</span>).innerHTML = <span class=\"string\">'您当前所在城市：'</span> + cityName;</div><div class=\"line\">                <span class=\"comment\">//地图显示当前城市</span></div><div class=\"line\">                map.setBounds(citybounds);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'IPLocation'</span>).innerHTML = result.info;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"移动地图自动中心定位\"><a href=\"#移动地图自动中心定位\" class=\"headerlink\" title=\"移动地图自动中心定位\"></a>移动地图自动中心定位</h4><p>之前有一版是让用户输入城市名，然后直接定位到输入的城市的。<br>这个功能卡在了设置地图显示位置上，如果是使用高德地图提供的搜索控件的话，又存在输入结果之后搜索结果可能是多个的问题。而且这点我只是要取到用户想要定位的城市而已，感觉没必要做得太复杂。<br>昨晚在看高德地图API的时候发现，有一个移动地图获得地图中心所在位置的样例，马上眼前一亮了。这个功能比我想要的还要好…果断上。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">MapMoveToLocationCity</span>(<span class=\"params\"></span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">    map.on(<span class=\"string\">'moveend'</span>, getCity);</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getCity</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        map.getCity(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (data[<span class=\"string\">'province'</span>] &amp;&amp; <span class=\"keyword\">typeof</span> data[<span class=\"string\">'province'</span>] === <span class=\"string\">'string'</span>) &#123;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">var</span> cityinfo = (data[<span class=\"string\">'city'</span>] || data[<span class=\"string\">'province'</span>]);</div><div class=\"line\">                cityName = cityinfo.substring(<span class=\"number\">0</span>, cityinfo.length - <span class=\"number\">1</span>);</div><div class=\"line\">                ConvertCityCNNameToShortCut();<span class=\"comment\">//城市名转58同城地区域名</span></div><div class=\"line\"></div><div class=\"line\">                <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'IPLocation'</span>).innerHTML = <span class=\"string\">'地图中心所在城市：'</span> + cityName;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>整个代码的意思是，给map绑定一下移动时间，移动完了之后，调用getCity的方法获取当前地图中心所在城市信息。</p>\n<p>这个时候要注意，城市名可能在city对象里面，也可能在province里面。</p>\n<p>原因很简单：普通城市等级就是城市，我国还存在一个和省份一个等级的城市：直辖市。因此直辖市的城市名是在province里面的。</p>\n<h4 id=\"城市名匹配58同城地区域名\"><a href=\"#城市名匹配58同城地区域名\" class=\"headerlink\" title=\"城市名匹配58同城地区域名\"></a>城市名匹配58同城地区域名</h4><p>这个是上个版本(两三天前)的一个bug引出来的新功能。</p>\n<p>上个版本是让用户输入城市名，然后提取城市名的中文拼音首字母作为58同城地区域名。如上海 =sh，广州=gz，北京=bj，成都=cd。</p>\n<p>这个功能使用的是网上别人写的一个JS库，通过汉字匹配实现的。转换出来的数据没什么问题，不过我国汉字实在奥妙。</p>\n<p>广州=gz，赣州=gz；<br>遂宁=sn；绥宁=sn；<br>惠州=hz，杭州=hz。</p>\n<p>这样一来，上面这个做法就没法玩了。</p>\n<p>想了下怎么解决这个问题，灵机一动。反正是在爬58的数据，这个城市名和城市域名数据58同城肯定有啊，然后找到了这个。<br><a href=\"http://www.58.com/changecity.aspx?PGTID=0d100000-0007-a77b-4c4b-a28f725b8f5a&amp;ClickID=1\" target=\"_blank\" rel=\"external\">58同城城市分类导航</a></p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/c01c293a-d5cc-4f58-80dc-13aa05d47b01\" alt=\"\"></p>\n<p>很明显，我要的所有城市名和城市域名都是里面了。</p>\n<p>晚上和衣衣说了下，衣衣一大早就把处理好的json数据给我了。</p>\n<p>于是来了下面一段代码：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//加载json文件</span></div><div class=\"line\">$.getJSON(<span class=\"string\">\"DomainJS/city.json\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">      allCityInfo = data;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ConvertCityCNNameToShortCut</span>(<span class=\"params\"></span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> filterarray = $.grep(allCityInfo, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> obj.cityName == cityName;</div><div class=\"line\">    &#125;);<span class=\"comment\">//找到当前城市名对应的json对象</span></div><div class=\"line\">    <span class=\"comment\">//获取json对象的地区域名</span></div><div class=\"line\">    cityNameCNPY = filterarray <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Array</span> ? </div><div class=\"line\">    filterarray[<span class=\"number\">0</span>].shortCut : filterarray != <span class=\"literal\">null</span> ? filterarray.shortCut : <span class=\"string\">\"\"</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"高德地图自动补全功能\"><a href=\"#高德地图自动补全功能\" class=\"headerlink\" title=\"高德地图自动补全功能\"></a>高德地图自动补全功能</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"control-input\"</span>&gt;</span></div><div class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"work-location\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width:60%\"</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> auto = <span class=\"keyword\">new</span> AMap.Autocomplete(&#123;</div><div class=\"line\">       input: <span class=\"string\">\"work-location\"</span></div><div class=\"line\">   &#125;);</div><div class=\"line\"></div><div class=\"line\">   AMap.event.addListener(auto, <span class=\"string\">\"select\"</span>, workLocationSelected);</div></pre></td></tr></table></figure>\n<p>看方法前面也知道，其实这就是把ID为work-location的input初始化为地图插件，然后给Amap增加了一个监听事件。<br>当其中选中某一个数据的时候，触发workLocationSelected函数。效果如下：</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/fe425992-e7c4-4cae-800e-319eff3b17e8\" alt=\"\"></p>\n<p>在这里locationSelected是定位到所选位置，代码如下：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">workLocationSelected</span>(<span class=\"params\">e</span>) </span>&#123;</div><div class=\"line\">    workAddress = e.poi.name;</div><div class=\"line\">    loadWorkLocation();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">loadWorkLocation</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    delWorkLocation();</div><div class=\"line\">    <span class=\"keyword\">var</span> geocoder = <span class=\"keyword\">new</span> AMap.Geocoder(&#123;</div><div class=\"line\">        city: cityName,</div><div class=\"line\">        radius: <span class=\"number\">1000</span></div><div class=\"line\">    &#125;);</div><div class=\"line\"></div><div class=\"line\">    geocoder.getLocation(workAddress, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">status, result</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (status === <span class=\"string\">\"complete\"</span> &amp;&amp; result.info === <span class=\"string\">'OK'</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">var</span> geocode = result.geocodes[<span class=\"number\">0</span>];</div><div class=\"line\">            x = geocode.location.getLng();</div><div class=\"line\">            y = geocode.location.getLat();</div><div class=\"line\">            loadWorkMarker(x, y);</div><div class=\"line\">            loadWorkRange(x, y, <span class=\"number\">60</span>, <span class=\"string\">\"#3f67a5\"</span>, vehicle);</div><div class=\"line\">            map.setZoomAndCenter(<span class=\"number\">12</span>, [x, y]);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>至于导航功能代码我没怎么动，没去研究就不献丑了…</p>\n<p>最后来个效果图。</p>\n<h4 id=\"北京\"><a href=\"#北京\" class=\"headerlink\" title=\"北京\"></a>北京</h4><p><img src=\"http://7xread.com1.z0.glb.clouddn.com/e7900aba-5a56-417c-9dd9-63527583e84b\" alt=\"\"></p>\n<h4 id=\"成都\"><a href=\"#成都\" class=\"headerlink\" title=\"成都\"></a>成都</h4><p><img src=\"http://7xread.com1.z0.glb.clouddn.com/c9947d97-1b76-42bf-82b3-aca817e84e13\" alt=\"\"></p>\n<h4 id=\"苏州\"><a href=\"#苏州\" class=\"headerlink\" title=\"苏州\"></a>苏州</h4><p><img src=\"http://7xread.com1.z0.glb.clouddn.com/941809ae-aa37-4a3b-89c7-10646cc7e3e7\" alt=\"\"></p>\n<h4 id=\"深圳\"><a href=\"#深圳\" class=\"headerlink\" title=\"深圳\"></a>深圳</h4><p><img src=\"http://7xread.com1.z0.glb.clouddn.com/86712397-27ec-4b37-bbf8-81191e530ef6\" alt=\"\"></p>\n","excerpt":"","more":"<p>在线地址：<a href=\"http://codelover.link:8080/\">58同城品牌公寓高德搜房</a></p>\n<p>Github地址：<a href=\"https://github.com/liguobao/58HouseSearch\">https://github.com/liguobao/58HouseSearch</a></p>\n<p>知乎专栏(点赞用的)：<a href=\"https://zhuanlan.zhihu.com/p/21960329\">高德API+Python解决租房问题(.NET版)</a></p>\n<p>经过了一个星期的修补补，以及小伙伴奉献的代码，整个项目基本处于基本稳定运行的状态。</p>\n<p>同时加入了一下新功能：</p>\n<ol>\n<li>IP定位：调用高德地图IP定位功能实现</li>\n<li>移动地图中心定位：调用高德地图移动地图定位实现</li>\n<li>定位城市名转58同城城市名以获得准确58同城城市域名：抓取58同城城市分类信息</li>\n<li>优化数据源、去除广告数据：小伙伴奉献代码</li>\n</ol>\n<p>今天主要简单讲解一下其中使用的一些高德地图API接口。</p>\n<p>#####高德地图JavaScript API 主体为map对象，基本所有的操作都是通过map对象来实现的。<br>map对象实例化是通过 Amap类来做的。如以下代码：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">map = <span class=\"keyword\">new</span> AMap.Map(<span class=\"string\">\"container\"</span>, &#123;</div><div class=\"line\">        resizeEnable: <span class=\"literal\">true</span>,</div><div class=\"line\">        zoomEnable: <span class=\"literal\">true</span>,</div><div class=\"line\">        center: [<span class=\"number\">121.297428</span>, <span class=\"number\">31.1345</span>],<span class=\"comment\">//经纬度，此处为上海</span></div><div class=\"line\">        zoom: <span class=\"number\">11</span></div><div class=\"line\">    &#125;);</div></pre></td></tr></table></figure></p>\n<h4 id=\"IP定位\"><a href=\"#IP定位\" class=\"headerlink\" title=\"IP定位\"></a>IP定位</h4><p>调用Map.CitySearch()获得当前IP所在城市，直接将地图显示成当前城市。代码如下：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">showCityInfo</span>(<span class=\"params\">map</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">//实例化城市查询类</span></div><div class=\"line\">    <span class=\"keyword\">var</span> citysearch = <span class=\"keyword\">new</span> AMap.CitySearch();</div><div class=\"line\">    <span class=\"comment\">//自动获取用户IP，返回当前城市</span></div><div class=\"line\">    citysearch.getLocalCity(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">status, result</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (status === <span class=\"string\">'complete'</span> &amp;&amp; result.info === <span class=\"string\">'OK'</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (result &amp;&amp; result.city &amp;&amp; result.bounds) &#123;</div><div class=\"line\">                <span class=\"keyword\">var</span> cityinfo = result.city;<span class=\"comment\">//获得XX市</span></div><div class=\"line\">                <span class=\"keyword\">var</span> citybounds = result.bounds;<span class=\"comment\">//用于设置地图显示位置的实例</span></div><div class=\"line\">                cityName = cityinfo.substring(<span class=\"number\">0</span>, cityinfo.length - <span class=\"number\">1</span>);<span class=\"comment\">//去掉市这个字</span></div><div class=\"line\">                ConvertCityCNNameToShortCut();<span class=\"comment\">//城市名转换成58同城城市域名字母，如上海-&gt;sh,苏州-&gt;su,</span></div><div class=\"line\">                                              <span class=\"comment\">//下面会有实现代码</span></div><div class=\"line\"></div><div class=\"line\">                <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'IPLocation'</span>).innerHTML = <span class=\"string\">'您当前所在城市：'</span> + cityName;</div><div class=\"line\">                <span class=\"comment\">//地图显示当前城市</span></div><div class=\"line\">                map.setBounds(citybounds);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'IPLocation'</span>).innerHTML = result.info;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"移动地图自动中心定位\"><a href=\"#移动地图自动中心定位\" class=\"headerlink\" title=\"移动地图自动中心定位\"></a>移动地图自动中心定位</h4><p>之前有一版是让用户输入城市名，然后直接定位到输入的城市的。<br>这个功能卡在了设置地图显示位置上，如果是使用高德地图提供的搜索控件的话，又存在输入结果之后搜索结果可能是多个的问题。而且这点我只是要取到用户想要定位的城市而已，感觉没必要做得太复杂。<br>昨晚在看高德地图API的时候发现，有一个移动地图获得地图中心所在位置的样例，马上眼前一亮了。这个功能比我想要的还要好…果断上。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">MapMoveToLocationCity</span>(<span class=\"params\"></span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    map.on(<span class=\"string\">'moveend'</span>, getCity);</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getCity</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        map.getCity(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (data[<span class=\"string\">'province'</span>] &amp;&amp; <span class=\"keyword\">typeof</span> data[<span class=\"string\">'province'</span>] === <span class=\"string\">'string'</span>) &#123;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">var</span> cityinfo = (data[<span class=\"string\">'city'</span>] || data[<span class=\"string\">'province'</span>]);</div><div class=\"line\">                cityName = cityinfo.substring(<span class=\"number\">0</span>, cityinfo.length - <span class=\"number\">1</span>);</div><div class=\"line\">                ConvertCityCNNameToShortCut();<span class=\"comment\">//城市名转58同城地区域名</span></div><div class=\"line\"></div><div class=\"line\">                <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'IPLocation'</span>).innerHTML = <span class=\"string\">'地图中心所在城市：'</span> + cityName;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>整个代码的意思是，给map绑定一下移动时间，移动完了之后，调用getCity的方法获取当前地图中心所在城市信息。</p>\n<p>这个时候要注意，城市名可能在city对象里面，也可能在province里面。</p>\n<p>原因很简单：普通城市等级就是城市，我国还存在一个和省份一个等级的城市：直辖市。因此直辖市的城市名是在province里面的。</p>\n<h4 id=\"城市名匹配58同城地区域名\"><a href=\"#城市名匹配58同城地区域名\" class=\"headerlink\" title=\"城市名匹配58同城地区域名\"></a>城市名匹配58同城地区域名</h4><p>这个是上个版本(两三天前)的一个bug引出来的新功能。</p>\n<p>上个版本是让用户输入城市名，然后提取城市名的中文拼音首字母作为58同城地区域名。如上海 =sh，广州=gz，北京=bj，成都=cd。</p>\n<p>这个功能使用的是网上别人写的一个JS库，通过汉字匹配实现的。转换出来的数据没什么问题，不过我国汉字实在奥妙。</p>\n<p>广州=gz，赣州=gz；<br>遂宁=sn；绥宁=sn；<br>惠州=hz，杭州=hz。</p>\n<p>这样一来，上面这个做法就没法玩了。</p>\n<p>想了下怎么解决这个问题，灵机一动。反正是在爬58的数据，这个城市名和城市域名数据58同城肯定有啊，然后找到了这个。<br><a href=\"http://www.58.com/changecity.aspx?PGTID=0d100000-0007-a77b-4c4b-a28f725b8f5a&amp;ClickID=1\">58同城城市分类导航</a></p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/c01c293a-d5cc-4f58-80dc-13aa05d47b01\" alt=\"\"></p>\n<p>很明显，我要的所有城市名和城市域名都是里面了。</p>\n<p>晚上和衣衣说了下，衣衣一大早就把处理好的json数据给我了。</p>\n<p>于是来了下面一段代码：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//加载json文件</span></div><div class=\"line\">$.getJSON(<span class=\"string\">\"DomainJS/city.json\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">      allCityInfo = data;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ConvertCityCNNameToShortCut</span>(<span class=\"params\"></span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> filterarray = $.grep(allCityInfo, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> obj.cityName == cityName;</div><div class=\"line\">    &#125;);<span class=\"comment\">//找到当前城市名对应的json对象</span></div><div class=\"line\">    <span class=\"comment\">//获取json对象的地区域名</span></div><div class=\"line\">    cityNameCNPY = filterarray <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Array</span> ? </div><div class=\"line\">    filterarray[<span class=\"number\">0</span>].shortCut : filterarray != <span class=\"literal\">null</span> ? filterarray.shortCut : <span class=\"string\">\"\"</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"高德地图自动补全功能\"><a href=\"#高德地图自动补全功能\" class=\"headerlink\" title=\"高德地图自动补全功能\"></a>高德地图自动补全功能</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"control-input\"</span>&gt;</span></div><div class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"work-location\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width:60%\"</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> auto = <span class=\"keyword\">new</span> AMap.Autocomplete(&#123;</div><div class=\"line\">       input: <span class=\"string\">\"work-location\"</span></div><div class=\"line\">   &#125;);</div><div class=\"line\"></div><div class=\"line\">   AMap.event.addListener(auto, <span class=\"string\">\"select\"</span>, workLocationSelected);</div></pre></td></tr></table></figure>\n<p>看方法前面也知道，其实这就是把ID为work-location的input初始化为地图插件，然后给Amap增加了一个监听事件。<br>当其中选中某一个数据的时候，触发workLocationSelected函数。效果如下：</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/fe425992-e7c4-4cae-800e-319eff3b17e8\" alt=\"\"></p>\n<p>在这里locationSelected是定位到所选位置，代码如下：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">workLocationSelected</span>(<span class=\"params\">e</span>) </span>&#123;</div><div class=\"line\">    workAddress = e.poi.name;</div><div class=\"line\">    loadWorkLocation();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">loadWorkLocation</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    delWorkLocation();</div><div class=\"line\">    <span class=\"keyword\">var</span> geocoder = <span class=\"keyword\">new</span> AMap.Geocoder(&#123;</div><div class=\"line\">        city: cityName,</div><div class=\"line\">        radius: <span class=\"number\">1000</span></div><div class=\"line\">    &#125;);</div><div class=\"line\"></div><div class=\"line\">    geocoder.getLocation(workAddress, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">status, result</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (status === <span class=\"string\">\"complete\"</span> &amp;&amp; result.info === <span class=\"string\">'OK'</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">var</span> geocode = result.geocodes[<span class=\"number\">0</span>];</div><div class=\"line\">            x = geocode.location.getLng();</div><div class=\"line\">            y = geocode.location.getLat();</div><div class=\"line\">            loadWorkMarker(x, y);</div><div class=\"line\">            loadWorkRange(x, y, <span class=\"number\">60</span>, <span class=\"string\">\"#3f67a5\"</span>, vehicle);</div><div class=\"line\">            map.setZoomAndCenter(<span class=\"number\">12</span>, [x, y]);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>至于导航功能代码我没怎么动，没去研究就不献丑了…</p>\n<p>最后来个效果图。</p>\n<h4 id=\"北京\"><a href=\"#北京\" class=\"headerlink\" title=\"北京\"></a>北京</h4><p><img src=\"http://7xread.com1.z0.glb.clouddn.com/e7900aba-5a56-417c-9dd9-63527583e84b\" alt=\"\"></p>\n<h4 id=\"成都\"><a href=\"#成都\" class=\"headerlink\" title=\"成都\"></a>成都</h4><p><img src=\"http://7xread.com1.z0.glb.clouddn.com/c9947d97-1b76-42bf-82b3-aca817e84e13\" alt=\"\"></p>\n<h4 id=\"苏州\"><a href=\"#苏州\" class=\"headerlink\" title=\"苏州\"></a>苏州</h4><p><img src=\"http://7xread.com1.z0.glb.clouddn.com/941809ae-aa37-4a3b-89c7-10646cc7e3e7\" alt=\"\"></p>\n<h4 id=\"深圳\"><a href=\"#深圳\" class=\"headerlink\" title=\"深圳\"></a>深圳</h4><p><img src=\"http://7xread.com1.z0.glb.clouddn.com/86712397-27ec-4b37-bbf8-81191e530ef6\" alt=\"\"></p>\n"},{"layout":"post","title":".NET_58同城品牌公寓爬虫","date":"2016-08-07T16:00:00.000Z","_content":"\n源码地址：[https://github.com/liguobao/58HouseSearch](https://github.com/liguobao/58HouseSearch)\n\n在线地址：[58公寓高德搜房(全国版)：http://codelover.link:8080/](http://codelover.link:8080/)\n\n周末闲着无事刷知乎发现一个爬虫教程（[高德API+Python解决租房问题](https://zhuanlan.zhihu.com/p/21883516)\n），正中最近想要换地方住的痛点。然后大早上懒觉都没睡就屁颠屁颠开始研究这个教程了。这样教程在实验楼网站里面有手把手步骤，有兴趣自取（[实验楼：高德API+Python解决租房问题](https://www.shiyanlou.com/courses/599)）。\n\n整体项目主要分成两步：\n\n第一步:python爬取数据，生成数据文件;\n\n第二部：导入数据文件，在地图上显示房源，设定上班地点后自动计算出行路线和路程时间。\n\n研究了一下这个教程之后发现这货做得实在有点粗糙，只能当教程用，完全没有通用实际价值。\n\n而且这里面还有个更大的问题：教程是基于北京的数据来做的，而我在上海...\n\n虽然说改改python数据源，改改导航页面JS完事。不过是在难用...\n\n于是，开始自己动手了。先看原有的python代码。\n\n\n```python\n\n#-*- coding:utf-8 -*-\nfrom bs4 import BeautifulSoup\nfrom urlparse import urljoin\nimport requests\nimport csv\n\nurl = \"http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000\"\n\n#已完成的页数序号，初时为0\npage = 0\n\ncsv_file = open(\"rent.csv\",\"wb\") \ncsv_writer = csv.writer(csv_file, delimiter=',')\n\nwhile True:\n    page += 1\n    print \"fetch: \", url.format(page=page)\n    response = requests.get(url.format(page=page))\n    html = BeautifulSoup(response.text)\n    house_list = html.select(\".list > li\")\n\n    # 循环在读不到新的房源时结束\n    if not house_list:\n        break\n\n    for house in house_list:\n        house_title = house.select(\"h2\")[0].string.encode(\"utf8\")\n        house_url = urljoin(url, house.select(\"a\")[0][\"href\"])\n        house_info_list = house_title.split()\n\n        # 如果第二列是公寓名则取第一列作为地址\n        if \"公寓\" in house_info_list[1] or \"青年社区\" in house_info_list[1]:\n            house_location = house_info_list[0]\n        else:\n            house_location = house_info_list[1]\n\n        house_money = house.select(\".money\")[0].select(\"b\")[0].string.encode(\"utf8\")\n        csv_writer.writerow([house_title, house_location, house_money, house_url])\n\ncsv_file.close()\n\n```\n整个代码基本思路就是，爬取http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000页面数据，然后扔到创建的csv文件里面作为下一步的数据源。\n通过研究http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000这个页面的数据，我们可以很容易发现，在页面中，每条数据都是一个li标签。\n\n\n如下图：\n\n![](http://7xread.com1.z0.glb.clouddn.com/685849af-2ccc-4454-a26e-e2a1c3001378)\n\n![](http://7xread.com1.z0.glb.clouddn.com/909df442-b1d9-4073-84d0-99a5b3cc9022)\n\n#### li结构如下：\n\n```html\n<li logr=\"\" class=\"\">\n  <a href=\"/pinpaigongyu/26851774057013x.shtml\"\n  target=\"_blank\" onclick=\"clickLog('from=fcpc_list_gy_sh_tupian')\" \n  tongji_label=\"listclick\">\n    <div class=\"img\">\n     <img lazy_src=\"\" alt=\"\" src=\"\">\n    </div>\n        <div class=\"des\">\n            <h2>【合租】菊园新区 柳湖景庭 3室次卧</h2>\n            <p class=\"room\">\n            3室1厅1卫&nbsp; &nbsp; 13m²&nbsp;&nbsp; 3/6层&nbsp; </p>\n            <p class=\"dist\"></p>\n            <p class=\"spec\">\n            <span class=\"spec1\">公共阳台</span>\n            <span class=\"spec2\">公共卫生间</span>\n            <span class=\"spec3\">离地铁近</span>\n            <span class=\"spec4\">厨房</span>\n            </p>\n        </div>\n        <div class=\"money\">\n            <span><b>1100</b>元/月 </span>\n         <p>租房月付</p>\n        </div>\n  </a>\n</li>\n```\n照着python的思路，是把所有的li标签的数据提取出来的。\n\n我自己研究的时候又看了下，其实数据都在一个属性为tongji_label=\"listclick\"的a标签里面。\n\n一般来说，字符匹配用正则表达式完事，奈何正则水平实在不佳。我还是选择直接上HtmlAgilityPack算了。\n关于HtmlAgilityPack的介绍还是看官网算了。[HtmlAgilityPack](http://htmlagilitypack.codeplex.com/)\n\nHtmlAgilityPack是.NET一个比较强大的HTML处理类库了，基本可以让你像JS来操作HTML标签。\n安装这货很简单，直接在Nuget PM包管理工具里面输入下面命令就完事了。\n\n```csharp\nInstall-Package HtmlAgilityPack\n\n```\n有需要使用教程可以看这个：[Html Agility Pack基础类介绍及运用](http://www.cnblogs.com/ITmuse/archive/2010/05/29/1747199.html)\n\n\n下面直接贴control源码算了。\n\n```csharp\n /// </summary>\n /// <param name=\"costFrom\">价格区间起始值</param>\n /// <param name=\"costTo\">价格区间终止值</param>\n /// <param name=\"cnName\">城市拼音首字母</param>\n /// <returns></returns>\n public ActionResult Get58CityRoomData(int costFrom, int costTo, string cnName)\n        {\n            if (costTo<=0 || costTo < costFrom)\n            {\n                return Json(new { IsSuccess = false, Error = \"输入数据有误，请重新输入。\" });\n            }\n\n            if (string.IsNullOrEmpty(cnName))\n            {\n                return Json(new { IsSuccess = false, \n                Error = \"城市定位失败，建议清除浏览器缓存后重新进入。\" });\n            }\n\n            try\n            {\n                var lstHouse = new List<HouseInfo>();\n\n                string tempURL = \"http://\" + \n                cnName + \".58.com/pinpaigongyu//pn/{0}/?minprice=\"\n                + costFrom + \"_\" + costTo;\n\n                Uri uri = new Uri(tempURL);\n\n                var htmlResult = HTTPHelper.GetHTMLByURL(string.Format(tempURL, 1));\n\n                HtmlDocument htmlDoc = new HtmlDocument();\n                htmlDoc.LoadHtml(htmlResult);\n\n                var countNodes = htmlDoc.DocumentNode.\n                SelectSingleNode(\".//span[contains(@class,'list')]\");\n                int pageCount = 10;\n\n                if (countNodes != null && countNodes.HasChildNodes)\n                {\n                    pageCount = Convert.ToInt32(countNodes.ChildNodes[0].InnerText) / 20;\n\n                    if(pageCount==0)\n                    {\n                        return Json(new { IsSuccess = false, \n                        Error =string.Format(\"没有找到价格区间为{0} - {1}的房子。\",\n                        costFrom,costTo)});\n                    }\n                    \n                }\n                for (int pageIndex = 1; pageIndex <= pageCount; pageIndex++)\n                {\n                    htmlResult = HTTPHelper.GetHTMLByURL(string.Format(tempURL, pageIndex));\n                    htmlDoc.LoadHtml(htmlResult);\n                    var roomList = htmlDoc.DocumentNode\n                    .SelectNodes(\".//a[contains(@tongji_label,'listclick')]\");\n                    foreach (var room in roomList)\n                    {\n                        var houseTitle = room.SelectSingleNode(\".//h2\").InnerHtml;\n                        var houseURL = uri.Host + room.Attributes[\"href\"].Value;\n                        var house_info_list = houseTitle.Split(' ');\n                        var house_location = string.Empty;\n                        if (house_info_list[1].Contains(\"公寓\") \n                        || house_info_list[1].Contains(\"青年社区\"))\n                        {\n                            house_location = house_info_list[0];\n                        }\n                        else\n                        {\n                            house_location = house_info_list[1];\n                        }\n                        var momey = room.SelectSingleNode(\".//b\").InnerHtml;\n\n                        lstHouse.Add(new HouseInfo()\n                        {\n                            HouseTitle = houseTitle,\n                            HouseLocation = house_location,\n                            HouseURL = houseURL,\n                            Money = momey,\n                        });\n                    }\n                }\n\n                return Json(new { IsSuccess = true, HouseInfos = lstHouse });\n            }\n            catch (Exception ex)\n            {\n                return Json(new { IsSuccess = false,\n                Error = \"获取数据异常。\" + ex.ToString() });\n            }\n        }\n```\n\n下面解释一下核心代码。\n\n片段一：获取总数。\n\n在观察58同城页面的时候，无意发现其实第一个加载的页面中有一个数据总条数，隐藏在页面里面的。\n```html\n <span class=\"listsum\"><em>1813</em>条结果</span>\n```\n这样一来，总页面就很清晰了。页面=总数/每页20条。然后我们根据已知的数据规则去循环请求页面，也就能拿到所有的搜索数据了。\n\n核心代码，获取总条数。\n```\nvar countNodes = htmlDoc.DocumentNode.\nSelectSingleNode(\".//span[contains(@class,'list')]\");\nint pageCount = 10;\n\nif (countNodes != null && countNodes.HasChildNodes)\n{\n    pageCount = Convert.ToInt32(countNodes.ChildNodes[0].InnerText) / 20;\n\n    if(pageCount==0)\n    {\n        return Json(new { IsSuccess = false, \n        Error =string.Format(\"没有找到价格区间为{0} - {1}的房子。\",\n        costFrom,costTo)});\n    }\n                    \n}\n\n```\n\n在HTMLDoc里面找到一个span的class包含list的节点，获取它子节点（即em）的内容，强制转换成数字，也就是我们要找的总条数了。总条数除以20就得到了页数，下面就是开始循环请求页面了。\n\n在最上面我们分析过公寓数据分布，数据是li里面套a标签，我们需要的地理位置、房间名称、价格都在a标签里面。\n\n这样一来，我们这要获得到页面所有带有属性为tongji_label=\"listclick\"的a标签数据，也就得到了我们所有需要的数据。\n\n看一下a标签的数据组成：\n```html\n\n <a href=\"/pinpaigongyu/26851774057013x.shtml\"\n  target=\"_blank\" onclick=\"clickLog('from=fcpc_list_gy_sh_tupian')\" \n  tongji_label=\"listclick\">\n    <div class=\"img\">\n     <img lazy_src=\"\" alt=\"\" src=\"\">\n    </div>\n        <div class=\"des\">\n            <h2>【合租】菊园新区 柳湖景庭 3室次卧</h2>\n            <p class=\"room\">\n            3室1厅1卫&nbsp; &nbsp; 13m²&nbsp;&nbsp; 3/6层&nbsp; </p>\n            <p class=\"dist\"></p>\n            <p class=\"spec\">\n            <span class=\"spec1\">公共阳台</span>\n            <span class=\"spec2\">公共卫生间</span>\n            <span class=\"spec3\">离地铁近</span>\n            <span class=\"spec4\">厨房</span>\n            </p>\n        </div>\n        <div class=\"money\">\n            <span><b>1100</b>元/月 </span>\n         <p>租房月付</p>\n        </div>\n  </a>\n```\n\n我们要的房间信息在一个h2的标签里面，公寓租金价钱在class=\"money\"的div标签里面。\n\n于是有了一下代码：\n\n```csharp\n\n for (int pageIndex = 1; pageIndex <= pageCount; pageIndex++)\n{\n    htmlResult = HTTPHelper.GetHTMLByURL(string.Format(tempURL, pageIndex));\n    htmlDoc.LoadHtml(htmlResult);\n    //找到所有的带有属性为tongji_label=\"listclick\"的a标签数据\n    var roomList = htmlDoc.DocumentNode.SelectNodes(\".//a[contains(@tongji_label,'listclick')]\");\n    foreach (var room in roomList)\n    {\n        //获取其中为h2的房间数据，然后用空格分割成数组\n        var houseTitle = room.SelectSingleNode(\".//h2\").InnerHtml;\n        var houseURL = uri.Host + room.Attributes[\"href\"].Value;\n        var house_info_list = houseTitle.Split(' ');\n        var house_location = string.Empty;\n        //分割出来的数组，第二个包含公寓或青年社区，则取第一个数据为所在地区，否则取第二个数据\n        //【合租】菊园新区 柳湖景庭 3室次卧 \n        // 所在地区为：菊园新区\n        if (house_info_list[1].Contains(\"公寓\") || house_info_list[1].Contains(\"青年社区\"))\n        {\n            house_location = house_info_list[0];\n        }\n        else\n        {\n            house_location = house_info_list[1];\n        }\n        //获取标签为b的数据，价格就在里面了\n        var momey = room.SelectSingleNode(\".//b\").InnerHtml;\n\n        lstHouse.Add(new HouseInfo()\n        {\n            HouseTitle = houseTitle,\n            HouseLocation = house_location,\n            HouseURL = houseURL,\n            Money = momey,\n        });\n    }\n}\n\n```\n\n后端来说，基本就这些内容了。\n\n还有一些前端高德地图接口调用下次再讲吧，要陪女票玩游戏去了...\n\n^-^\n\n\n\n\n\n\n\n\n\n","source":"_posts/58City-House-Crawler.md","raw":"---\nlayout: post\ntitle: .NET_58同城品牌公寓爬虫\ncategory: .net\ndate: 2016-08-08 00:00:00\ntags:\n- 58City\n- Crawler\n---\n\n源码地址：[https://github.com/liguobao/58HouseSearch](https://github.com/liguobao/58HouseSearch)\n\n在线地址：[58公寓高德搜房(全国版)：http://codelover.link:8080/](http://codelover.link:8080/)\n\n周末闲着无事刷知乎发现一个爬虫教程（[高德API+Python解决租房问题](https://zhuanlan.zhihu.com/p/21883516)\n），正中最近想要换地方住的痛点。然后大早上懒觉都没睡就屁颠屁颠开始研究这个教程了。这样教程在实验楼网站里面有手把手步骤，有兴趣自取（[实验楼：高德API+Python解决租房问题](https://www.shiyanlou.com/courses/599)）。\n\n整体项目主要分成两步：\n\n第一步:python爬取数据，生成数据文件;\n\n第二部：导入数据文件，在地图上显示房源，设定上班地点后自动计算出行路线和路程时间。\n\n研究了一下这个教程之后发现这货做得实在有点粗糙，只能当教程用，完全没有通用实际价值。\n\n而且这里面还有个更大的问题：教程是基于北京的数据来做的，而我在上海...\n\n虽然说改改python数据源，改改导航页面JS完事。不过是在难用...\n\n于是，开始自己动手了。先看原有的python代码。\n\n\n```python\n\n#-*- coding:utf-8 -*-\nfrom bs4 import BeautifulSoup\nfrom urlparse import urljoin\nimport requests\nimport csv\n\nurl = \"http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000\"\n\n#已完成的页数序号，初时为0\npage = 0\n\ncsv_file = open(\"rent.csv\",\"wb\") \ncsv_writer = csv.writer(csv_file, delimiter=',')\n\nwhile True:\n    page += 1\n    print \"fetch: \", url.format(page=page)\n    response = requests.get(url.format(page=page))\n    html = BeautifulSoup(response.text)\n    house_list = html.select(\".list > li\")\n\n    # 循环在读不到新的房源时结束\n    if not house_list:\n        break\n\n    for house in house_list:\n        house_title = house.select(\"h2\")[0].string.encode(\"utf8\")\n        house_url = urljoin(url, house.select(\"a\")[0][\"href\"])\n        house_info_list = house_title.split()\n\n        # 如果第二列是公寓名则取第一列作为地址\n        if \"公寓\" in house_info_list[1] or \"青年社区\" in house_info_list[1]:\n            house_location = house_info_list[0]\n        else:\n            house_location = house_info_list[1]\n\n        house_money = house.select(\".money\")[0].select(\"b\")[0].string.encode(\"utf8\")\n        csv_writer.writerow([house_title, house_location, house_money, house_url])\n\ncsv_file.close()\n\n```\n整个代码基本思路就是，爬取http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000页面数据，然后扔到创建的csv文件里面作为下一步的数据源。\n通过研究http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000这个页面的数据，我们可以很容易发现，在页面中，每条数据都是一个li标签。\n\n\n如下图：\n\n![](http://7xread.com1.z0.glb.clouddn.com/685849af-2ccc-4454-a26e-e2a1c3001378)\n\n![](http://7xread.com1.z0.glb.clouddn.com/909df442-b1d9-4073-84d0-99a5b3cc9022)\n\n#### li结构如下：\n\n```html\n<li logr=\"\" class=\"\">\n  <a href=\"/pinpaigongyu/26851774057013x.shtml\"\n  target=\"_blank\" onclick=\"clickLog('from=fcpc_list_gy_sh_tupian')\" \n  tongji_label=\"listclick\">\n    <div class=\"img\">\n     <img lazy_src=\"\" alt=\"\" src=\"\">\n    </div>\n        <div class=\"des\">\n            <h2>【合租】菊园新区 柳湖景庭 3室次卧</h2>\n            <p class=\"room\">\n            3室1厅1卫&nbsp; &nbsp; 13m²&nbsp;&nbsp; 3/6层&nbsp; </p>\n            <p class=\"dist\"></p>\n            <p class=\"spec\">\n            <span class=\"spec1\">公共阳台</span>\n            <span class=\"spec2\">公共卫生间</span>\n            <span class=\"spec3\">离地铁近</span>\n            <span class=\"spec4\">厨房</span>\n            </p>\n        </div>\n        <div class=\"money\">\n            <span><b>1100</b>元/月 </span>\n         <p>租房月付</p>\n        </div>\n  </a>\n</li>\n```\n照着python的思路，是把所有的li标签的数据提取出来的。\n\n我自己研究的时候又看了下，其实数据都在一个属性为tongji_label=\"listclick\"的a标签里面。\n\n一般来说，字符匹配用正则表达式完事，奈何正则水平实在不佳。我还是选择直接上HtmlAgilityPack算了。\n关于HtmlAgilityPack的介绍还是看官网算了。[HtmlAgilityPack](http://htmlagilitypack.codeplex.com/)\n\nHtmlAgilityPack是.NET一个比较强大的HTML处理类库了，基本可以让你像JS来操作HTML标签。\n安装这货很简单，直接在Nuget PM包管理工具里面输入下面命令就完事了。\n\n```csharp\nInstall-Package HtmlAgilityPack\n\n```\n有需要使用教程可以看这个：[Html Agility Pack基础类介绍及运用](http://www.cnblogs.com/ITmuse/archive/2010/05/29/1747199.html)\n\n\n下面直接贴control源码算了。\n\n```csharp\n /// </summary>\n /// <param name=\"costFrom\">价格区间起始值</param>\n /// <param name=\"costTo\">价格区间终止值</param>\n /// <param name=\"cnName\">城市拼音首字母</param>\n /// <returns></returns>\n public ActionResult Get58CityRoomData(int costFrom, int costTo, string cnName)\n        {\n            if (costTo<=0 || costTo < costFrom)\n            {\n                return Json(new { IsSuccess = false, Error = \"输入数据有误，请重新输入。\" });\n            }\n\n            if (string.IsNullOrEmpty(cnName))\n            {\n                return Json(new { IsSuccess = false, \n                Error = \"城市定位失败，建议清除浏览器缓存后重新进入。\" });\n            }\n\n            try\n            {\n                var lstHouse = new List<HouseInfo>();\n\n                string tempURL = \"http://\" + \n                cnName + \".58.com/pinpaigongyu//pn/{0}/?minprice=\"\n                + costFrom + \"_\" + costTo;\n\n                Uri uri = new Uri(tempURL);\n\n                var htmlResult = HTTPHelper.GetHTMLByURL(string.Format(tempURL, 1));\n\n                HtmlDocument htmlDoc = new HtmlDocument();\n                htmlDoc.LoadHtml(htmlResult);\n\n                var countNodes = htmlDoc.DocumentNode.\n                SelectSingleNode(\".//span[contains(@class,'list')]\");\n                int pageCount = 10;\n\n                if (countNodes != null && countNodes.HasChildNodes)\n                {\n                    pageCount = Convert.ToInt32(countNodes.ChildNodes[0].InnerText) / 20;\n\n                    if(pageCount==0)\n                    {\n                        return Json(new { IsSuccess = false, \n                        Error =string.Format(\"没有找到价格区间为{0} - {1}的房子。\",\n                        costFrom,costTo)});\n                    }\n                    \n                }\n                for (int pageIndex = 1; pageIndex <= pageCount; pageIndex++)\n                {\n                    htmlResult = HTTPHelper.GetHTMLByURL(string.Format(tempURL, pageIndex));\n                    htmlDoc.LoadHtml(htmlResult);\n                    var roomList = htmlDoc.DocumentNode\n                    .SelectNodes(\".//a[contains(@tongji_label,'listclick')]\");\n                    foreach (var room in roomList)\n                    {\n                        var houseTitle = room.SelectSingleNode(\".//h2\").InnerHtml;\n                        var houseURL = uri.Host + room.Attributes[\"href\"].Value;\n                        var house_info_list = houseTitle.Split(' ');\n                        var house_location = string.Empty;\n                        if (house_info_list[1].Contains(\"公寓\") \n                        || house_info_list[1].Contains(\"青年社区\"))\n                        {\n                            house_location = house_info_list[0];\n                        }\n                        else\n                        {\n                            house_location = house_info_list[1];\n                        }\n                        var momey = room.SelectSingleNode(\".//b\").InnerHtml;\n\n                        lstHouse.Add(new HouseInfo()\n                        {\n                            HouseTitle = houseTitle,\n                            HouseLocation = house_location,\n                            HouseURL = houseURL,\n                            Money = momey,\n                        });\n                    }\n                }\n\n                return Json(new { IsSuccess = true, HouseInfos = lstHouse });\n            }\n            catch (Exception ex)\n            {\n                return Json(new { IsSuccess = false,\n                Error = \"获取数据异常。\" + ex.ToString() });\n            }\n        }\n```\n\n下面解释一下核心代码。\n\n片段一：获取总数。\n\n在观察58同城页面的时候，无意发现其实第一个加载的页面中有一个数据总条数，隐藏在页面里面的。\n```html\n <span class=\"listsum\"><em>1813</em>条结果</span>\n```\n这样一来，总页面就很清晰了。页面=总数/每页20条。然后我们根据已知的数据规则去循环请求页面，也就能拿到所有的搜索数据了。\n\n核心代码，获取总条数。\n```\nvar countNodes = htmlDoc.DocumentNode.\nSelectSingleNode(\".//span[contains(@class,'list')]\");\nint pageCount = 10;\n\nif (countNodes != null && countNodes.HasChildNodes)\n{\n    pageCount = Convert.ToInt32(countNodes.ChildNodes[0].InnerText) / 20;\n\n    if(pageCount==0)\n    {\n        return Json(new { IsSuccess = false, \n        Error =string.Format(\"没有找到价格区间为{0} - {1}的房子。\",\n        costFrom,costTo)});\n    }\n                    \n}\n\n```\n\n在HTMLDoc里面找到一个span的class包含list的节点，获取它子节点（即em）的内容，强制转换成数字，也就是我们要找的总条数了。总条数除以20就得到了页数，下面就是开始循环请求页面了。\n\n在最上面我们分析过公寓数据分布，数据是li里面套a标签，我们需要的地理位置、房间名称、价格都在a标签里面。\n\n这样一来，我们这要获得到页面所有带有属性为tongji_label=\"listclick\"的a标签数据，也就得到了我们所有需要的数据。\n\n看一下a标签的数据组成：\n```html\n\n <a href=\"/pinpaigongyu/26851774057013x.shtml\"\n  target=\"_blank\" onclick=\"clickLog('from=fcpc_list_gy_sh_tupian')\" \n  tongji_label=\"listclick\">\n    <div class=\"img\">\n     <img lazy_src=\"\" alt=\"\" src=\"\">\n    </div>\n        <div class=\"des\">\n            <h2>【合租】菊园新区 柳湖景庭 3室次卧</h2>\n            <p class=\"room\">\n            3室1厅1卫&nbsp; &nbsp; 13m²&nbsp;&nbsp; 3/6层&nbsp; </p>\n            <p class=\"dist\"></p>\n            <p class=\"spec\">\n            <span class=\"spec1\">公共阳台</span>\n            <span class=\"spec2\">公共卫生间</span>\n            <span class=\"spec3\">离地铁近</span>\n            <span class=\"spec4\">厨房</span>\n            </p>\n        </div>\n        <div class=\"money\">\n            <span><b>1100</b>元/月 </span>\n         <p>租房月付</p>\n        </div>\n  </a>\n```\n\n我们要的房间信息在一个h2的标签里面，公寓租金价钱在class=\"money\"的div标签里面。\n\n于是有了一下代码：\n\n```csharp\n\n for (int pageIndex = 1; pageIndex <= pageCount; pageIndex++)\n{\n    htmlResult = HTTPHelper.GetHTMLByURL(string.Format(tempURL, pageIndex));\n    htmlDoc.LoadHtml(htmlResult);\n    //找到所有的带有属性为tongji_label=\"listclick\"的a标签数据\n    var roomList = htmlDoc.DocumentNode.SelectNodes(\".//a[contains(@tongji_label,'listclick')]\");\n    foreach (var room in roomList)\n    {\n        //获取其中为h2的房间数据，然后用空格分割成数组\n        var houseTitle = room.SelectSingleNode(\".//h2\").InnerHtml;\n        var houseURL = uri.Host + room.Attributes[\"href\"].Value;\n        var house_info_list = houseTitle.Split(' ');\n        var house_location = string.Empty;\n        //分割出来的数组，第二个包含公寓或青年社区，则取第一个数据为所在地区，否则取第二个数据\n        //【合租】菊园新区 柳湖景庭 3室次卧 \n        // 所在地区为：菊园新区\n        if (house_info_list[1].Contains(\"公寓\") || house_info_list[1].Contains(\"青年社区\"))\n        {\n            house_location = house_info_list[0];\n        }\n        else\n        {\n            house_location = house_info_list[1];\n        }\n        //获取标签为b的数据，价格就在里面了\n        var momey = room.SelectSingleNode(\".//b\").InnerHtml;\n\n        lstHouse.Add(new HouseInfo()\n        {\n            HouseTitle = houseTitle,\n            HouseLocation = house_location,\n            HouseURL = houseURL,\n            Money = momey,\n        });\n    }\n}\n\n```\n\n后端来说，基本就这些内容了。\n\n还有一些前端高德地图接口调用下次再讲吧，要陪女票玩游戏去了...\n\n^-^\n\n\n\n\n\n\n\n\n\n","slug":"58City-House-Crawler","published":1,"updated":"2016-09-15T05:11:13.647Z","comments":1,"photos":[],"link":"","_id":"cit3xw9s40001c0txy560cuwd","content":"<p>源码地址：<a href=\"https://github.com/liguobao/58HouseSearch\" target=\"_blank\" rel=\"external\">https://github.com/liguobao/58HouseSearch</a></p>\n<p>在线地址：<a href=\"http://codelover.link:8080/\">58公寓高德搜房(全国版)：http://codelover.link:8080/</a></p>\n<p>周末闲着无事刷知乎发现一个爬虫教程（<a href=\"https://zhuanlan.zhihu.com/p/21883516\" target=\"_blank\" rel=\"external\">高德API+Python解决租房问题</a><br>），正中最近想要换地方住的痛点。然后大早上懒觉都没睡就屁颠屁颠开始研究这个教程了。这样教程在实验楼网站里面有手把手步骤，有兴趣自取（<a href=\"https://www.shiyanlou.com/courses/599\" target=\"_blank\" rel=\"external\">实验楼：高德API+Python解决租房问题</a>）。</p>\n<p>整体项目主要分成两步：</p>\n<p>第一步:python爬取数据，生成数据文件;</p>\n<p>第二部：导入数据文件，在地图上显示房源，设定上班地点后自动计算出行路线和路程时间。</p>\n<p>研究了一下这个教程之后发现这货做得实在有点粗糙，只能当教程用，完全没有通用实际价值。</p>\n<p>而且这里面还有个更大的问题：教程是基于北京的数据来做的，而我在上海…</p>\n<p>虽然说改改python数据源，改改导航页面JS完事。不过是在难用…</p>\n<p>于是，开始自己动手了。先看原有的python代码。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">#-*- coding:utf-8 -*-</span></div><div class=\"line\"><span class=\"keyword\">from</span> bs4 <span class=\"keyword\">import</span> BeautifulSoup</div><div class=\"line\"><span class=\"keyword\">from</span> urlparse <span class=\"keyword\">import</span> urljoin</div><div class=\"line\"><span class=\"keyword\">import</span> requests</div><div class=\"line\"><span class=\"keyword\">import</span> csv</div><div class=\"line\"></div><div class=\"line\">url = <span class=\"string\">\"http://bj.58.com/pinpaigongyu/pn/&#123;page&#125;/?minprice=2000_4000\"</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">#已完成的页数序号，初时为0</span></div><div class=\"line\">page = <span class=\"number\">0</span></div><div class=\"line\"></div><div class=\"line\">csv_file = open(<span class=\"string\">\"rent.csv\"</span>,<span class=\"string\">\"wb\"</span>) </div><div class=\"line\">csv_writer = csv.writer(csv_file, delimiter=<span class=\"string\">','</span>)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span> <span class=\"keyword\">True</span>:</div><div class=\"line\">    page += <span class=\"number\">1</span></div><div class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"fetch: \"</span>, url.format(page=page)</div><div class=\"line\">    response = requests.get(url.format(page=page))</div><div class=\"line\">    html = BeautifulSoup(response.text)</div><div class=\"line\">    house_list = html.select(<span class=\"string\">\".list &gt; li\"</span>)</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\"># 循环在读不到新的房源时结束</span></div><div class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> house_list:</div><div class=\"line\">        <span class=\"keyword\">break</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">for</span> house <span class=\"keyword\">in</span> house_list:</div><div class=\"line\">        house_title = house.select(<span class=\"string\">\"h2\"</span>)[<span class=\"number\">0</span>].string.encode(<span class=\"string\">\"utf8\"</span>)</div><div class=\"line\">        house_url = urljoin(url, house.select(<span class=\"string\">\"a\"</span>)[<span class=\"number\">0</span>][<span class=\"string\">\"href\"</span>])</div><div class=\"line\">        house_info_list = house_title.split()</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\"># 如果第二列是公寓名则取第一列作为地址</span></div><div class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">\"公寓\"</span> <span class=\"keyword\">in</span> house_info_list[<span class=\"number\">1</span>] <span class=\"keyword\">or</span> <span class=\"string\">\"青年社区\"</span> <span class=\"keyword\">in</span> house_info_list[<span class=\"number\">1</span>]:</div><div class=\"line\">            house_location = house_info_list[<span class=\"number\">0</span>]</div><div class=\"line\">        <span class=\"keyword\">else</span>:</div><div class=\"line\">            house_location = house_info_list[<span class=\"number\">1</span>]</div><div class=\"line\"></div><div class=\"line\">        house_money = house.select(<span class=\"string\">\".money\"</span>)[<span class=\"number\">0</span>].select(<span class=\"string\">\"b\"</span>)[<span class=\"number\">0</span>].string.encode(<span class=\"string\">\"utf8\"</span>)</div><div class=\"line\">        csv_writer.writerow([house_title, house_location, house_money, house_url])</div><div class=\"line\"></div><div class=\"line\">csv_file.close()</div></pre></td></tr></table></figure>\n<p>整个代码基本思路就是，爬取<a href=\"http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000页面数据，然后扔到创建的csv文件里面作为下一步的数据源。\" target=\"_blank\" rel=\"external\">http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000页面数据，然后扔到创建的csv文件里面作为下一步的数据源。</a><br>通过研究<a href=\"http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000这个页面的数据，我们可以很容易发现，在页面中，每条数据都是一个li标签。\" target=\"_blank\" rel=\"external\">http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000这个页面的数据，我们可以很容易发现，在页面中，每条数据都是一个li标签。</a></p>\n<p>如下图：</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/685849af-2ccc-4454-a26e-e2a1c3001378\" alt=\"\"></p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/909df442-b1d9-4073-84d0-99a5b3cc9022\" alt=\"\"></p>\n<h4 id=\"li结构如下：\"><a href=\"#li结构如下：\" class=\"headerlink\" title=\"li结构如下：\"></a>li结构如下：</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">li</span> <span class=\"attr\">logr</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"\"</span>&gt;</span></div><div class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/pinpaigongyu/26851774057013x.shtml\"</span></span></div><div class=\"line\">  <span class=\"attr\">target</span>=<span class=\"string\">\"_blank\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"clickLog('from=fcpc_list_gy_sh_tupian')\"</span> </div><div class=\"line\">  <span class=\"attr\">tongji_label</span>=<span class=\"string\">\"listclick\"</span>&gt;</div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"img\"</span>&gt;</span></div><div class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">lazy_src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">alt</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"des\"</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">h2</span>&gt;</span>【合租】菊园新区 柳湖景庭 3室次卧<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"room\"</span>&gt;</span></div><div class=\"line\">            3室1厅1卫&amp;nbsp; &amp;nbsp; 13m²&amp;nbsp;&amp;nbsp; 3/6层&amp;nbsp; <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dist\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec\"</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec1\"</span>&gt;</span>公共阳台<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec2\"</span>&gt;</span>公共卫生间<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec3\"</span>&gt;</span>离地铁近<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec4\"</span>&gt;</span>厨房<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"money\"</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">b</span>&gt;</span>1100<span class=\"tag\">&lt;/<span class=\"name\">b</span>&gt;</span>元/月 <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>租房月付<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>照着python的思路，是把所有的li标签的数据提取出来的。</p>\n<p>我自己研究的时候又看了下，其实数据都在一个属性为tongji_label=”listclick”的a标签里面。</p>\n<p>一般来说，字符匹配用正则表达式完事，奈何正则水平实在不佳。我还是选择直接上HtmlAgilityPack算了。<br>关于HtmlAgilityPack的介绍还是看官网算了。<a href=\"http://htmlagilitypack.codeplex.com/\" target=\"_blank\" rel=\"external\">HtmlAgilityPack</a></p>\n<p>HtmlAgilityPack是.NET一个比较强大的HTML处理类库了，基本可以让你像JS来操作HTML标签。<br>安装这货很简单，直接在Nuget PM包管理工具里面输入下面命令就完事了。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Install-Package HtmlAgilityPack</div></pre></td></tr></table></figure>\n<p>有需要使用教程可以看这个：<a href=\"http://www.cnblogs.com/ITmuse/archive/2010/05/29/1747199.html\" target=\"_blank\" rel=\"external\">Html Agility Pack基础类介绍及运用</a></p>\n<p>下面直接贴control源码算了。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"costFrom\"&gt;</span>价格区间起始值<span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"costTo\"&gt;</span>价格区间终止值<span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"cnName\"&gt;</span>城市拼音首字母<span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;returns&gt;</span><span class=\"doctag\">&lt;/returns&gt;</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ActionResult <span class=\"title\">Get58CityRoomData</span>(<span class=\"params\"><span class=\"keyword\">int</span> costFrom, <span class=\"keyword\">int</span> costTo, <span class=\"keyword\">string</span> cnName</span>)</span></div><div class=\"line\">       &#123;</div><div class=\"line\">           <span class=\"keyword\">if</span> (costTo&lt;=<span class=\"number\">0</span> || costTo &lt; costFrom)</div><div class=\"line\">           &#123;</div><div class=\"line\">               <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">false</span>, Error = <span class=\"string\">\"输入数据有误，请重新输入。\"</span> &#125;);</div><div class=\"line\">           &#125;</div><div class=\"line\"></div><div class=\"line\">           <span class=\"keyword\">if</span> (<span class=\"keyword\">string</span>.IsNullOrEmpty(cnName))</div><div class=\"line\">           &#123;</div><div class=\"line\">               <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">false</span>, </div><div class=\"line\">               Error = <span class=\"string\">\"城市定位失败，建议清除浏览器缓存后重新进入。\"</span> &#125;);</div><div class=\"line\">           &#125;</div><div class=\"line\"></div><div class=\"line\">           <span class=\"keyword\">try</span></div><div class=\"line\">           &#123;</div><div class=\"line\">               <span class=\"keyword\">var</span> lstHouse = <span class=\"keyword\">new</span> List&lt;HouseInfo&gt;();</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">string</span> tempURL = <span class=\"string\">\"http://\"</span> + </div><div class=\"line\">               cnName + <span class=\"string\">\".58.com/pinpaigongyu//pn/&#123;0&#125;/?minprice=\"</span></div><div class=\"line\">               + costFrom + <span class=\"string\">\"_\"</span> + costTo;</div><div class=\"line\"></div><div class=\"line\">               Uri uri = <span class=\"keyword\">new</span> Uri(tempURL);</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">var</span> htmlResult = HTTPHelper.GetHTMLByURL(<span class=\"keyword\">string</span>.Format(tempURL, <span class=\"number\">1</span>));</div><div class=\"line\"></div><div class=\"line\">               HtmlDocument htmlDoc = <span class=\"keyword\">new</span> HtmlDocument();</div><div class=\"line\">               htmlDoc.LoadHtml(htmlResult);</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">var</span> countNodes = htmlDoc.DocumentNode.</div><div class=\"line\">               SelectSingleNode(<span class=\"string\">\".//span[contains(@class,'list')]\"</span>);</div><div class=\"line\">               <span class=\"keyword\">int</span> pageCount = <span class=\"number\">10</span>;</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">if</span> (countNodes != <span class=\"literal\">null</span> &amp;&amp; countNodes.HasChildNodes)</div><div class=\"line\">               &#123;</div><div class=\"line\">                   pageCount = Convert.ToInt32(countNodes.ChildNodes[<span class=\"number\">0</span>].InnerText) / <span class=\"number\">20</span>;</div><div class=\"line\"></div><div class=\"line\">                   <span class=\"keyword\">if</span>(pageCount==<span class=\"number\">0</span>)</div><div class=\"line\">                   &#123;</div><div class=\"line\">                       <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">false</span>, </div><div class=\"line\">                       Error =<span class=\"keyword\">string</span>.Format(<span class=\"string\">\"没有找到价格区间为&#123;0&#125; - &#123;1&#125;的房子。\"</span>,</div><div class=\"line\">                       costFrom,costTo)&#125;);</div><div class=\"line\">                   &#125;</div><div class=\"line\">                   </div><div class=\"line\">               &#125;</div><div class=\"line\">               <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> pageIndex = <span class=\"number\">1</span>; pageIndex &lt;= pageCount; pageIndex++)</div><div class=\"line\">               &#123;</div><div class=\"line\">                   htmlResult = HTTPHelper.GetHTMLByURL(<span class=\"keyword\">string</span>.Format(tempURL, pageIndex));</div><div class=\"line\">                   htmlDoc.LoadHtml(htmlResult);</div><div class=\"line\">                   <span class=\"keyword\">var</span> roomList = htmlDoc.DocumentNode</div><div class=\"line\">                   .SelectNodes(<span class=\"string\">\".//a[contains(@tongji_label,'listclick')]\"</span>);</div><div class=\"line\">                   <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> room <span class=\"keyword\">in</span> roomList)</div><div class=\"line\">                   &#123;</div><div class=\"line\">                       <span class=\"keyword\">var</span> houseTitle = room.SelectSingleNode(<span class=\"string\">\".//h2\"</span>).InnerHtml;</div><div class=\"line\">                       <span class=\"keyword\">var</span> houseURL = uri.Host + room.Attributes[<span class=\"string\">\"href\"</span>].Value;</div><div class=\"line\">                       <span class=\"keyword\">var</span> house_info_list = houseTitle.Split(<span class=\"string\">' '</span>);</div><div class=\"line\">                       <span class=\"keyword\">var</span> house_location = <span class=\"keyword\">string</span>.Empty;</div><div class=\"line\">                       <span class=\"keyword\">if</span> (house_info_list[<span class=\"number\">1</span>].Contains(<span class=\"string\">\"公寓\"</span>) </div><div class=\"line\">                       || house_info_list[<span class=\"number\">1</span>].Contains(<span class=\"string\">\"青年社区\"</span>))</div><div class=\"line\">                       &#123;</div><div class=\"line\">                           house_location = house_info_list[<span class=\"number\">0</span>];</div><div class=\"line\">                       &#125;</div><div class=\"line\">                       <span class=\"keyword\">else</span></div><div class=\"line\">                       &#123;</div><div class=\"line\">                           house_location = house_info_list[<span class=\"number\">1</span>];</div><div class=\"line\">                       &#125;</div><div class=\"line\">                       <span class=\"keyword\">var</span> momey = room.SelectSingleNode(<span class=\"string\">\".//b\"</span>).InnerHtml;</div><div class=\"line\"></div><div class=\"line\">                       lstHouse.Add(<span class=\"keyword\">new</span> HouseInfo()</div><div class=\"line\">                       &#123;</div><div class=\"line\">                           HouseTitle = houseTitle,</div><div class=\"line\">                           HouseLocation = house_location,</div><div class=\"line\">                           HouseURL = houseURL,</div><div class=\"line\">                           Money = momey,</div><div class=\"line\">                       &#125;);</div><div class=\"line\">                   &#125;</div><div class=\"line\">               &#125;</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">true</span>, HouseInfos = lstHouse &#125;);</div><div class=\"line\">           &#125;</div><div class=\"line\">           <span class=\"keyword\">catch</span> (Exception ex)</div><div class=\"line\">           &#123;</div><div class=\"line\">               <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">false</span>,</div><div class=\"line\">               Error = <span class=\"string\">\"获取数据异常。\"</span> + ex.ToString() &#125;);</div><div class=\"line\">           &#125;</div><div class=\"line\">       &#125;</div></pre></td></tr></table></figure>\n<p>下面解释一下核心代码。</p>\n<p>片段一：获取总数。</p>\n<p>在观察58同城页面的时候，无意发现其实第一个加载的页面中有一个数据总条数，隐藏在页面里面的。<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"listsum\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">em</span>&gt;</span>1813<span class=\"tag\">&lt;/<span class=\"name\">em</span>&gt;</span>条结果<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>这样一来，总页面就很清晰了。页面=总数/每页20条。然后我们根据已知的数据规则去循环请求页面，也就能拿到所有的搜索数据了。</p>\n<p>核心代码，获取总条数。<br><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">var <span class=\"attr\">countNodes</span> = htmlDoc.DocumentNode.</div><div class=\"line\">SelectSingleNode(<span class=\"string\">\".//span[contains(@class,'list')]\"</span>);</div><div class=\"line\">int <span class=\"attr\">pageCount</span> = <span class=\"number\">10</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> (countNodes != <span class=\"literal\">null</span> &amp;&amp; countNodes.HasChildNodes)</div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"attr\">pageCount</span> = Convert.ToInt32(countNodes.ChildNodes[<span class=\"number\">0</span>].InnerText) / <span class=\"number\">20</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"attr\">pageCount==0)</span></div><div class=\"line\">    &#123;</div><div class=\"line\">        return Json(new &#123; <span class=\"attr\">IsSuccess</span> = <span class=\"literal\">false</span>, </div><div class=\"line\">        <span class=\"attr\">Error</span> =string.Format(<span class=\"string\">\"没有找到价格区间为&#123;0&#125; - &#123;1&#125;的房子。\"</span>,</div><div class=\"line\">        costFrom,costTo)&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">                    </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>在HTMLDoc里面找到一个span的class包含list的节点，获取它子节点（即em）的内容，强制转换成数字，也就是我们要找的总条数了。总条数除以20就得到了页数，下面就是开始循环请求页面了。</p>\n<p>在最上面我们分析过公寓数据分布，数据是li里面套a标签，我们需要的地理位置、房间名称、价格都在a标签里面。</p>\n<p>这样一来，我们这要获得到页面所有带有属性为tongji_label=”listclick”的a标签数据，也就得到了我们所有需要的数据。</p>\n<p>看一下a标签的数据组成：<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/pinpaigongyu/26851774057013x.shtml\"</span></span></div><div class=\"line\"> <span class=\"attr\">target</span>=<span class=\"string\">\"_blank\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"clickLog('from=fcpc_list_gy_sh_tupian')\"</span> </div><div class=\"line\"> <span class=\"attr\">tongji_label</span>=<span class=\"string\">\"listclick\"</span>&gt;</div><div class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"img\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">lazy_src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">alt</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span>&gt;</span></div><div class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"des\"</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">h2</span>&gt;</span>【合租】菊园新区 柳湖景庭 3室次卧<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"room\"</span>&gt;</span></div><div class=\"line\">           3室1厅1卫&amp;nbsp; &amp;nbsp; 13m²&amp;nbsp;&amp;nbsp; 3/6层&amp;nbsp; <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dist\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec\"</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec1\"</span>&gt;</span>公共阳台<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec2\"</span>&gt;</span>公共卫生间<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec3\"</span>&gt;</span>离地铁近<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec4\"</span>&gt;</span>厨房<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"money\"</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">b</span>&gt;</span>1100<span class=\"tag\">&lt;/<span class=\"name\">b</span>&gt;</span>元/月 <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>租房月付<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>我们要的房间信息在一个h2的标签里面，公寓租金价钱在class=”money”的div标签里面。</p>\n<p>于是有了一下代码：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"> <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> pageIndex = <span class=\"number\">1</span>; pageIndex &lt;= pageCount; pageIndex++)</div><div class=\"line\">&#123;</div><div class=\"line\">    htmlResult = HTTPHelper.GetHTMLByURL(<span class=\"keyword\">string</span>.Format(tempURL, pageIndex));</div><div class=\"line\">    htmlDoc.LoadHtml(htmlResult);</div><div class=\"line\">    <span class=\"comment\">//找到所有的带有属性为tongji_label=\"listclick\"的a标签数据</span></div><div class=\"line\">    <span class=\"keyword\">var</span> roomList = htmlDoc.DocumentNode.SelectNodes(<span class=\"string\">\".//a[contains(@tongji_label,'listclick')]\"</span>);</div><div class=\"line\">    <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> room <span class=\"keyword\">in</span> roomList)</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"comment\">//获取其中为h2的房间数据，然后用空格分割成数组</span></div><div class=\"line\">        <span class=\"keyword\">var</span> houseTitle = room.SelectSingleNode(<span class=\"string\">\".//h2\"</span>).InnerHtml;</div><div class=\"line\">        <span class=\"keyword\">var</span> houseURL = uri.Host + room.Attributes[<span class=\"string\">\"href\"</span>].Value;</div><div class=\"line\">        <span class=\"keyword\">var</span> house_info_list = houseTitle.Split(<span class=\"string\">' '</span>);</div><div class=\"line\">        <span class=\"keyword\">var</span> house_location = <span class=\"keyword\">string</span>.Empty;</div><div class=\"line\">        <span class=\"comment\">//分割出来的数组，第二个包含公寓或青年社区，则取第一个数据为所在地区，否则取第二个数据</span></div><div class=\"line\">        <span class=\"comment\">//【合租】菊园新区 柳湖景庭 3室次卧 </span></div><div class=\"line\">        <span class=\"comment\">// 所在地区为：菊园新区</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (house_info_list[<span class=\"number\">1</span>].Contains(<span class=\"string\">\"公寓\"</span>) || house_info_list[<span class=\"number\">1</span>].Contains(<span class=\"string\">\"青年社区\"</span>))</div><div class=\"line\">        &#123;</div><div class=\"line\">            house_location = house_info_list[<span class=\"number\">0</span>];</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span></div><div class=\"line\">        &#123;</div><div class=\"line\">            house_location = house_info_list[<span class=\"number\">1</span>];</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"comment\">//获取标签为b的数据，价格就在里面了</span></div><div class=\"line\">        <span class=\"keyword\">var</span> momey = room.SelectSingleNode(<span class=\"string\">\".//b\"</span>).InnerHtml;</div><div class=\"line\"></div><div class=\"line\">        lstHouse.Add(<span class=\"keyword\">new</span> HouseInfo()</div><div class=\"line\">        &#123;</div><div class=\"line\">            HouseTitle = houseTitle,</div><div class=\"line\">            HouseLocation = house_location,</div><div class=\"line\">            HouseURL = houseURL,</div><div class=\"line\">            Money = momey,</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>后端来说，基本就这些内容了。</p>\n<p>还有一些前端高德地图接口调用下次再讲吧，要陪女票玩游戏去了…</p>\n<p>^-^</p>\n","excerpt":"","more":"<p>源码地址：<a href=\"https://github.com/liguobao/58HouseSearch\">https://github.com/liguobao/58HouseSearch</a></p>\n<p>在线地址：<a href=\"http://codelover.link:8080/\">58公寓高德搜房(全国版)：http://codelover.link:8080/</a></p>\n<p>周末闲着无事刷知乎发现一个爬虫教程（<a href=\"https://zhuanlan.zhihu.com/p/21883516\">高德API+Python解决租房问题</a><br>），正中最近想要换地方住的痛点。然后大早上懒觉都没睡就屁颠屁颠开始研究这个教程了。这样教程在实验楼网站里面有手把手步骤，有兴趣自取（<a href=\"https://www.shiyanlou.com/courses/599\">实验楼：高德API+Python解决租房问题</a>）。</p>\n<p>整体项目主要分成两步：</p>\n<p>第一步:python爬取数据，生成数据文件;</p>\n<p>第二部：导入数据文件，在地图上显示房源，设定上班地点后自动计算出行路线和路程时间。</p>\n<p>研究了一下这个教程之后发现这货做得实在有点粗糙，只能当教程用，完全没有通用实际价值。</p>\n<p>而且这里面还有个更大的问题：教程是基于北京的数据来做的，而我在上海…</p>\n<p>虽然说改改python数据源，改改导航页面JS完事。不过是在难用…</p>\n<p>于是，开始自己动手了。先看原有的python代码。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">#-*- coding:utf-8 -*-</span></div><div class=\"line\"><span class=\"keyword\">from</span> bs4 <span class=\"keyword\">import</span> BeautifulSoup</div><div class=\"line\"><span class=\"keyword\">from</span> urlparse <span class=\"keyword\">import</span> urljoin</div><div class=\"line\"><span class=\"keyword\">import</span> requests</div><div class=\"line\"><span class=\"keyword\">import</span> csv</div><div class=\"line\"></div><div class=\"line\">url = <span class=\"string\">\"http://bj.58.com/pinpaigongyu/pn/&#123;page&#125;/?minprice=2000_4000\"</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">#已完成的页数序号，初时为0</span></div><div class=\"line\">page = <span class=\"number\">0</span></div><div class=\"line\"></div><div class=\"line\">csv_file = open(<span class=\"string\">\"rent.csv\"</span>,<span class=\"string\">\"wb\"</span>) </div><div class=\"line\">csv_writer = csv.writer(csv_file, delimiter=<span class=\"string\">','</span>)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span> <span class=\"keyword\">True</span>:</div><div class=\"line\">    page += <span class=\"number\">1</span></div><div class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"fetch: \"</span>, url.format(page=page)</div><div class=\"line\">    response = requests.get(url.format(page=page))</div><div class=\"line\">    html = BeautifulSoup(response.text)</div><div class=\"line\">    house_list = html.select(<span class=\"string\">\".list &gt; li\"</span>)</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\"># 循环在读不到新的房源时结束</span></div><div class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> house_list:</div><div class=\"line\">        <span class=\"keyword\">break</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">for</span> house <span class=\"keyword\">in</span> house_list:</div><div class=\"line\">        house_title = house.select(<span class=\"string\">\"h2\"</span>)[<span class=\"number\">0</span>].string.encode(<span class=\"string\">\"utf8\"</span>)</div><div class=\"line\">        house_url = urljoin(url, house.select(<span class=\"string\">\"a\"</span>)[<span class=\"number\">0</span>][<span class=\"string\">\"href\"</span>])</div><div class=\"line\">        house_info_list = house_title.split()</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\"># 如果第二列是公寓名则取第一列作为地址</span></div><div class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">\"公寓\"</span> <span class=\"keyword\">in</span> house_info_list[<span class=\"number\">1</span>] <span class=\"keyword\">or</span> <span class=\"string\">\"青年社区\"</span> <span class=\"keyword\">in</span> house_info_list[<span class=\"number\">1</span>]:</div><div class=\"line\">            house_location = house_info_list[<span class=\"number\">0</span>]</div><div class=\"line\">        <span class=\"keyword\">else</span>:</div><div class=\"line\">            house_location = house_info_list[<span class=\"number\">1</span>]</div><div class=\"line\"></div><div class=\"line\">        house_money = house.select(<span class=\"string\">\".money\"</span>)[<span class=\"number\">0</span>].select(<span class=\"string\">\"b\"</span>)[<span class=\"number\">0</span>].string.encode(<span class=\"string\">\"utf8\"</span>)</div><div class=\"line\">        csv_writer.writerow([house_title, house_location, house_money, house_url])</div><div class=\"line\"></div><div class=\"line\">csv_file.close()</div></pre></td></tr></table></figure>\n<p>整个代码基本思路就是，爬取<a href=\"http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000页面数据，然后扔到创建的csv文件里面作为下一步的数据源。\">http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000页面数据，然后扔到创建的csv文件里面作为下一步的数据源。</a><br>通过研究<a href=\"http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000这个页面的数据，我们可以很容易发现，在页面中，每条数据都是一个li标签。\">http://bj.58.com/pinpaigongyu/pn/{page}/?minprice=2000_4000这个页面的数据，我们可以很容易发现，在页面中，每条数据都是一个li标签。</a></p>\n<p>如下图：</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/685849af-2ccc-4454-a26e-e2a1c3001378\" alt=\"\"></p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/909df442-b1d9-4073-84d0-99a5b3cc9022\" alt=\"\"></p>\n<h4 id=\"li结构如下：\"><a href=\"#li结构如下：\" class=\"headerlink\" title=\"li结构如下：\"></a>li结构如下：</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">li</span> <span class=\"attr\">logr</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"\"</span>&gt;</span></div><div class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/pinpaigongyu/26851774057013x.shtml\"</span></div><div class=\"line\">  <span class=\"attr\">target</span>=<span class=\"string\">\"_blank\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"clickLog('from=fcpc_list_gy_sh_tupian')\"</span> </div><div class=\"line\">  <span class=\"attr\">tongji_label</span>=<span class=\"string\">\"listclick\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"img\"</span>&gt;</span></div><div class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">lazy_src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">alt</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"des\"</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">h2</span>&gt;</span>【合租】菊园新区 柳湖景庭 3室次卧<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"room\"</span>&gt;</span></div><div class=\"line\">            3室1厅1卫&amp;nbsp; &amp;nbsp; 13m²&amp;nbsp;&amp;nbsp; 3/6层&amp;nbsp; <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dist\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec\"</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec1\"</span>&gt;</span>公共阳台<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec2\"</span>&gt;</span>公共卫生间<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec3\"</span>&gt;</span>离地铁近<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec4\"</span>&gt;</span>厨房<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"money\"</span>&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">b</span>&gt;</span>1100<span class=\"tag\">&lt;/<span class=\"name\">b</span>&gt;</span>元/月 <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>租房月付<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>照着python的思路，是把所有的li标签的数据提取出来的。</p>\n<p>我自己研究的时候又看了下，其实数据都在一个属性为tongji_label=”listclick”的a标签里面。</p>\n<p>一般来说，字符匹配用正则表达式完事，奈何正则水平实在不佳。我还是选择直接上HtmlAgilityPack算了。<br>关于HtmlAgilityPack的介绍还是看官网算了。<a href=\"http://htmlagilitypack.codeplex.com/\">HtmlAgilityPack</a></p>\n<p>HtmlAgilityPack是.NET一个比较强大的HTML处理类库了，基本可以让你像JS来操作HTML标签。<br>安装这货很简单，直接在Nuget PM包管理工具里面输入下面命令就完事了。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Install-Package HtmlAgilityPack</div></pre></td></tr></table></figure>\n<p>有需要使用教程可以看这个：<a href=\"http://www.cnblogs.com/ITmuse/archive/2010/05/29/1747199.html\">Html Agility Pack基础类介绍及运用</a></p>\n<p>下面直接贴control源码算了。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"costFrom\"&gt;</span>价格区间起始值<span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"costTo\"&gt;</span>价格区间终止值<span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"cnName\"&gt;</span>城市拼音首字母<span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;returns&gt;</span><span class=\"doctag\">&lt;/returns&gt;</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ActionResult <span class=\"title\">Get58CityRoomData</span>(<span class=\"params\"><span class=\"keyword\">int</span> costFrom, <span class=\"keyword\">int</span> costTo, <span class=\"keyword\">string</span> cnName</span>)</div><div class=\"line\">       </span>&#123;</div><div class=\"line\">           <span class=\"keyword\">if</span> (costTo&lt;=<span class=\"number\">0</span> || costTo &lt; costFrom)</div><div class=\"line\">           &#123;</div><div class=\"line\">               <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">false</span>, Error = <span class=\"string\">\"输入数据有误，请重新输入。\"</span> &#125;);</div><div class=\"line\">           &#125;</div><div class=\"line\"></div><div class=\"line\">           <span class=\"keyword\">if</span> (<span class=\"keyword\">string</span>.IsNullOrEmpty(cnName))</div><div class=\"line\">           &#123;</div><div class=\"line\">               <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">false</span>, </div><div class=\"line\">               Error = <span class=\"string\">\"城市定位失败，建议清除浏览器缓存后重新进入。\"</span> &#125;);</div><div class=\"line\">           &#125;</div><div class=\"line\"></div><div class=\"line\">           <span class=\"keyword\">try</span></div><div class=\"line\">           &#123;</div><div class=\"line\">               <span class=\"keyword\">var</span> lstHouse = <span class=\"keyword\">new</span> List&lt;HouseInfo&gt;();</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">string</span> tempURL = <span class=\"string\">\"http://\"</span> + </div><div class=\"line\">               cnName + <span class=\"string\">\".58.com/pinpaigongyu//pn/&#123;0&#125;/?minprice=\"</span></div><div class=\"line\">               + costFrom + <span class=\"string\">\"_\"</span> + costTo;</div><div class=\"line\"></div><div class=\"line\">               Uri uri = <span class=\"keyword\">new</span> Uri(tempURL);</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">var</span> htmlResult = HTTPHelper.GetHTMLByURL(<span class=\"keyword\">string</span>.Format(tempURL, <span class=\"number\">1</span>));</div><div class=\"line\"></div><div class=\"line\">               HtmlDocument htmlDoc = <span class=\"keyword\">new</span> HtmlDocument();</div><div class=\"line\">               htmlDoc.LoadHtml(htmlResult);</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">var</span> countNodes = htmlDoc.DocumentNode.</div><div class=\"line\">               SelectSingleNode(<span class=\"string\">\".//span[contains(@class,'list')]\"</span>);</div><div class=\"line\">               <span class=\"keyword\">int</span> pageCount = <span class=\"number\">10</span>;</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">if</span> (countNodes != <span class=\"literal\">null</span> &amp;&amp; countNodes.HasChildNodes)</div><div class=\"line\">               &#123;</div><div class=\"line\">                   pageCount = Convert.ToInt32(countNodes.ChildNodes[<span class=\"number\">0</span>].InnerText) / <span class=\"number\">20</span>;</div><div class=\"line\"></div><div class=\"line\">                   <span class=\"keyword\">if</span>(pageCount==<span class=\"number\">0</span>)</div><div class=\"line\">                   &#123;</div><div class=\"line\">                       <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">false</span>, </div><div class=\"line\">                       Error =<span class=\"keyword\">string</span>.Format(<span class=\"string\">\"没有找到价格区间为&#123;0&#125; - &#123;1&#125;的房子。\"</span>,</div><div class=\"line\">                       costFrom,costTo)&#125;);</div><div class=\"line\">                   &#125;</div><div class=\"line\">                   </div><div class=\"line\">               &#125;</div><div class=\"line\">               <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> pageIndex = <span class=\"number\">1</span>; pageIndex &lt;= pageCount; pageIndex++)</div><div class=\"line\">               &#123;</div><div class=\"line\">                   htmlResult = HTTPHelper.GetHTMLByURL(<span class=\"keyword\">string</span>.Format(tempURL, pageIndex));</div><div class=\"line\">                   htmlDoc.LoadHtml(htmlResult);</div><div class=\"line\">                   <span class=\"keyword\">var</span> roomList = htmlDoc.DocumentNode</div><div class=\"line\">                   .SelectNodes(<span class=\"string\">\".//a[contains(@tongji_label,'listclick')]\"</span>);</div><div class=\"line\">                   <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> room <span class=\"keyword\">in</span> roomList)</div><div class=\"line\">                   &#123;</div><div class=\"line\">                       <span class=\"keyword\">var</span> houseTitle = room.SelectSingleNode(<span class=\"string\">\".//h2\"</span>).InnerHtml;</div><div class=\"line\">                       <span class=\"keyword\">var</span> houseURL = uri.Host + room.Attributes[<span class=\"string\">\"href\"</span>].Value;</div><div class=\"line\">                       <span class=\"keyword\">var</span> house_info_list = houseTitle.Split(<span class=\"string\">' '</span>);</div><div class=\"line\">                       <span class=\"keyword\">var</span> house_location = <span class=\"keyword\">string</span>.Empty;</div><div class=\"line\">                       <span class=\"keyword\">if</span> (house_info_list[<span class=\"number\">1</span>].Contains(<span class=\"string\">\"公寓\"</span>) </div><div class=\"line\">                       || house_info_list[<span class=\"number\">1</span>].Contains(<span class=\"string\">\"青年社区\"</span>))</div><div class=\"line\">                       &#123;</div><div class=\"line\">                           house_location = house_info_list[<span class=\"number\">0</span>];</div><div class=\"line\">                       &#125;</div><div class=\"line\">                       <span class=\"keyword\">else</span></div><div class=\"line\">                       &#123;</div><div class=\"line\">                           house_location = house_info_list[<span class=\"number\">1</span>];</div><div class=\"line\">                       &#125;</div><div class=\"line\">                       <span class=\"keyword\">var</span> momey = room.SelectSingleNode(<span class=\"string\">\".//b\"</span>).InnerHtml;</div><div class=\"line\"></div><div class=\"line\">                       lstHouse.Add(<span class=\"keyword\">new</span> HouseInfo()</div><div class=\"line\">                       &#123;</div><div class=\"line\">                           HouseTitle = houseTitle,</div><div class=\"line\">                           HouseLocation = house_location,</div><div class=\"line\">                           HouseURL = houseURL,</div><div class=\"line\">                           Money = momey,</div><div class=\"line\">                       &#125;);</div><div class=\"line\">                   &#125;</div><div class=\"line\">               &#125;</div><div class=\"line\"></div><div class=\"line\">               <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">true</span>, HouseInfos = lstHouse &#125;);</div><div class=\"line\">           &#125;</div><div class=\"line\">           <span class=\"keyword\">catch</span> (Exception ex)</div><div class=\"line\">           &#123;</div><div class=\"line\">               <span class=\"keyword\">return</span> Json(<span class=\"keyword\">new</span> &#123; IsSuccess = <span class=\"literal\">false</span>,</div><div class=\"line\">               Error = <span class=\"string\">\"获取数据异常。\"</span> + ex.ToString() &#125;);</div><div class=\"line\">           &#125;</div><div class=\"line\">       &#125;</div></pre></td></tr></table></figure>\n<p>下面解释一下核心代码。</p>\n<p>片段一：获取总数。</p>\n<p>在观察58同城页面的时候，无意发现其实第一个加载的页面中有一个数据总条数，隐藏在页面里面的。<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"listsum\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">em</span>&gt;</span>1813<span class=\"tag\">&lt;/<span class=\"name\">em</span>&gt;</span>条结果<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>这样一来，总页面就很清晰了。页面=总数/每页20条。然后我们根据已知的数据规则去循环请求页面，也就能拿到所有的搜索数据了。</p>\n<p>核心代码，获取总条数。<br><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">var <span class=\"attr\">countNodes</span> = htmlDoc.DocumentNode.</div><div class=\"line\">SelectSingleNode(<span class=\"string\">\".//span[contains(@class,'list')]\"</span>);</div><div class=\"line\">int <span class=\"attr\">pageCount</span> = <span class=\"number\">10</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> (countNodes != <span class=\"literal\">null</span> &amp;&amp; countNodes.HasChildNodes)</div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"attr\">pageCount</span> = Convert.ToInt32(countNodes.ChildNodes[<span class=\"number\">0</span>].InnerText) / <span class=\"number\">20</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"attr\">pageCount==0)</span></div><div class=\"line\">    &#123;</div><div class=\"line\">        return Json(new &#123; <span class=\"attr\">IsSuccess</span> = <span class=\"literal\">false</span>, </div><div class=\"line\">        <span class=\"attr\">Error</span> =string.Format(<span class=\"string\">\"没有找到价格区间为&#123;0&#125; - &#123;1&#125;的房子。\"</span>,</div><div class=\"line\">        costFrom,costTo)&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">                    </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>在HTMLDoc里面找到一个span的class包含list的节点，获取它子节点（即em）的内容，强制转换成数字，也就是我们要找的总条数了。总条数除以20就得到了页数，下面就是开始循环请求页面了。</p>\n<p>在最上面我们分析过公寓数据分布，数据是li里面套a标签，我们需要的地理位置、房间名称、价格都在a标签里面。</p>\n<p>这样一来，我们这要获得到页面所有带有属性为tongji_label=”listclick”的a标签数据，也就得到了我们所有需要的数据。</p>\n<p>看一下a标签的数据组成：<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/pinpaigongyu/26851774057013x.shtml\"</span></div><div class=\"line\"> <span class=\"attr\">target</span>=<span class=\"string\">\"_blank\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"clickLog('from=fcpc_list_gy_sh_tupian')\"</span> </div><div class=\"line\"> <span class=\"attr\">tongji_label</span>=<span class=\"string\">\"listclick\"</span>&gt;</span></div><div class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"img\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">lazy_src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">alt</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span>&gt;</span></div><div class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"des\"</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">h2</span>&gt;</span>【合租】菊园新区 柳湖景庭 3室次卧<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"room\"</span>&gt;</span></div><div class=\"line\">           3室1厅1卫&amp;nbsp; &amp;nbsp; 13m²&amp;nbsp;&amp;nbsp; 3/6层&amp;nbsp; <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dist\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec\"</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec1\"</span>&gt;</span>公共阳台<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec2\"</span>&gt;</span>公共卫生间<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec3\"</span>&gt;</span>离地铁近<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"spec4\"</span>&gt;</span>厨房<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"money\"</span>&gt;</span></div><div class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">b</span>&gt;</span>1100<span class=\"tag\">&lt;/<span class=\"name\">b</span>&gt;</span>元/月 <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>租房月付<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></div><div class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>我们要的房间信息在一个h2的标签里面，公寓租金价钱在class=”money”的div标签里面。</p>\n<p>于是有了一下代码：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"> <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> pageIndex = <span class=\"number\">1</span>; pageIndex &lt;= pageCount; pageIndex++)</div><div class=\"line\">&#123;</div><div class=\"line\">    htmlResult = HTTPHelper.GetHTMLByURL(<span class=\"keyword\">string</span>.Format(tempURL, pageIndex));</div><div class=\"line\">    htmlDoc.LoadHtml(htmlResult);</div><div class=\"line\">    <span class=\"comment\">//找到所有的带有属性为tongji_label=\"listclick\"的a标签数据</span></div><div class=\"line\">    <span class=\"keyword\">var</span> roomList = htmlDoc.DocumentNode.SelectNodes(<span class=\"string\">\".//a[contains(@tongji_label,'listclick')]\"</span>);</div><div class=\"line\">    <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> room <span class=\"keyword\">in</span> roomList)</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"comment\">//获取其中为h2的房间数据，然后用空格分割成数组</span></div><div class=\"line\">        <span class=\"keyword\">var</span> houseTitle = room.SelectSingleNode(<span class=\"string\">\".//h2\"</span>).InnerHtml;</div><div class=\"line\">        <span class=\"keyword\">var</span> houseURL = uri.Host + room.Attributes[<span class=\"string\">\"href\"</span>].Value;</div><div class=\"line\">        <span class=\"keyword\">var</span> house_info_list = houseTitle.Split(<span class=\"string\">' '</span>);</div><div class=\"line\">        <span class=\"keyword\">var</span> house_location = <span class=\"keyword\">string</span>.Empty;</div><div class=\"line\">        <span class=\"comment\">//分割出来的数组，第二个包含公寓或青年社区，则取第一个数据为所在地区，否则取第二个数据</span></div><div class=\"line\">        <span class=\"comment\">//【合租】菊园新区 柳湖景庭 3室次卧 </span></div><div class=\"line\">        <span class=\"comment\">// 所在地区为：菊园新区</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (house_info_list[<span class=\"number\">1</span>].Contains(<span class=\"string\">\"公寓\"</span>) || house_info_list[<span class=\"number\">1</span>].Contains(<span class=\"string\">\"青年社区\"</span>))</div><div class=\"line\">        &#123;</div><div class=\"line\">            house_location = house_info_list[<span class=\"number\">0</span>];</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span></div><div class=\"line\">        &#123;</div><div class=\"line\">            house_location = house_info_list[<span class=\"number\">1</span>];</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"comment\">//获取标签为b的数据，价格就在里面了</span></div><div class=\"line\">        <span class=\"keyword\">var</span> momey = room.SelectSingleNode(<span class=\"string\">\".//b\"</span>).InnerHtml;</div><div class=\"line\"></div><div class=\"line\">        lstHouse.Add(<span class=\"keyword\">new</span> HouseInfo()</div><div class=\"line\">        &#123;</div><div class=\"line\">            HouseTitle = houseTitle,</div><div class=\"line\">            HouseLocation = house_location,</div><div class=\"line\">            HouseURL = houseURL,</div><div class=\"line\">            Money = momey,</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>后端来说，基本就这些内容了。</p>\n<p>还有一些前端高德地图接口调用下次再讲吧，要陪女票玩游戏去了…</p>\n<p>^-^</p>\n"},{"layout":"post","title":"ASP.NET Core Middleware","date":"2016-07-31T16:00:00.000Z","_content":"\n在ASP.NET 时代，一般来说我们很少会用到HttpModule/HttpHandler，然而有些场景我们使用HttpModule/HttpHandler倒方便快捷完成我们的需求。有兴趣了解HttpModule/HttpHandler以及使用场景的话，可以看下面这个链接的内容。\n\n[选择HttpHandler还是HttpModule？](http://www.cnblogs.com/fish-li/archive/2013/01/04/2844908.html)\n\n来到ASP.NET Core时代，类似功能的内容可能我们看得就要多得多了。因为在ASP.NET Core时代，微软将HttpModule“变更”之后，并为它授予了更灵活应用场景。\n\n##### 这就是这个文章要介绍的主角：Middleware（中间件）。\n\n## Middleware\n\n为了使用跨平台，ASP.NET Core整个架构和代码都重写了一遍，所以 HttpModule 自然也就不存在了。但是相似的功能还是有的，它的名字叫： Middleware。和以前不同，在ASP.NET Core中我们将会经常看到 Middleware的存在，因为现在的每一个服务都是用Middleware的方式呈现在ASP.NET Core 管道中。不仅如此，meddleware比起之前的HttpModule也更弹性易用了。\n\n首先先来看看什么是middleware。\n\n```csharp\n\npublic void Configure(IApplicationBuilder app, IHostingEnvironment env, \n                      ILoggerFactory loggerFactory)\n{\n    loggerFactory.AddConsole(Configuration.GetSection(\"Logging\"));\n    loggerFactory.AddDebug();\n\n    app.UseStaticFiles();\n\n    app.UseMvc(routes =>\n    {\n        routes.MapRoute(\"default\",\n        \"{controller=Home}/{action=Index}/{id?}\");\n    });\n}\n\n```\n看过ASP.NET Core项目的话，相信大家对Satarup.cs并不会陌生。在Starup.cs里面便有一个Configure()函数用于定义项目需要使用哪些middleware。\n\n上面的例子使用了两个middleware，一个是 UseStaticFiles，另一个是 UseMvc。这两个都是core自带的middleware，所以我们可以直接使用。UseStaticFiles 是为HTTP Request提供存取网站的文件，简单理解就是使得网站上的静态文件可访问，而UseMvc就是启用MVC routing机制。有了这两个middleware，我们的的网站就有了MVC routing和读取静态文件的功能。\n\n如果我们把UseMvc去掉，那么MVC routing也就不存在了，我们输入 http://website/[Controller]/[Action] 类似的地址也就无效了。\n\n### 和HttpModule的不同之处\n\n在使用HttpModule的时候，我们是在实现/重写接口，这个时候就要求我们在适当的地方做适当的事情。例如，要做 authorization 的话就最好在 HttpModule 定义好的 Authorization 事件 (AuthorizatRequest) 中完成这个功能。在 ASP.NET life cycle 的文件里我们可以查到 HttpModule  定义了那些事件，每一個事件都有哪些特別的功能。因此我们需要全面了解之后再来选择实现/重写我们需要的事件。而在Middleware中，完全没有这样的限制，也不存在这样的事件，我们可以自行设计实现我们的机制。\n\n## Middleware 流程\n[https://docs.asp.net/en/latest/fundamentals/middleware.html](https://docs.asp.net/en/latest/fundamentals/middleware.html) 这个文章中说明了基本的middleware概念。目前asp.net docs里面有不少的内容都是开源社区开发者贡献的\n\n在这个文章里面有一个简单的流程图说明了ASP.NET runtime中middleware的执行过程。\n\n![middleware执行过程](http://7xread.com1.z0.glb.clouddn.com/0b6d43ad-7d95-48ea-bbf3-ea7a93c4a366)\n\n在 middleware 里面一定要定义 Invoke()函数，因为这是让 engine 默认调用 middleware 的Incoke函数。Middleware 里面所需要做什么事情就放在 Invoke() 里面，同时 Invoke() 里面还需要调用下一个 middleware。因此执行内容就如上图所示。Middleware 之间除了必须传送 HttpContext之外，也可以自定义传入其他的参数，这比以前的HttpModule方便多了。\n\n\n所以当 HTTP request 进来之后，engine 便会呼叫第一个 middleware 的 Invoke()，同时把传入HttpContext，然后第一个 middleware 可以再接着呼叫第二个 middleware 的 Invoke()，同时再把 HttpContext 继续传入，一直到最后一个middleware 的 Invoke() 结束之后，整个 HttpContext 的內容可能在 middleware 里面新增或被改变了，最后再按照整個原先的 call stack 从最后一个 middleware 回到第一个 middleware，再通过  engine 回传到client 端，完成request.\n\n\n下来通过一个例子我们一起来了解一下Middleware。\n\n## 编写简单的 Middleware \n\n```csharp\npublic class SampleMiddleware\n{\n    private readonly RequestDelegate _next;\n\n    public SampleMiddleware(RequestDelegate next)\n    {\n        _next = next;\n    }\n\n    public async Task Invoke(HttpContext context)\n    {\n        if (string.IsNullOrEmpty(context.User.Identity.Name))\n        {\n            context.Response.Redirect(\"/NoName.html\");\n            return;\n        }\n        await _next.Invoke(context);\n    }\n}\n\n```\n\n\n这一个middleware的名字叫SampleMiddleware。它有一个构造函数以及Invoke函数，而Invoke()只接收一个参数HttpContext。\n\n_next是一个叫 RequestDelegate类型，换言之这就是一个delegate，用于代表下一个middleware是谁。所以在构造函数中要把下一个middleware delegate传入。看到这里或许会觉得奇怪，我们的middleware在执行过程中怎么会知道下一个middleware是谁？这一部分稍后解释。\n\n\n在 Invoke() 里面，在 await _next.Invoke() 之前都是当前middleware的逻辑代码，从上面流程图来看的话就是由左自右的方向． await _next.Invoke() 之后的代码是就是流程图上由右至右的方向，因此，透過这样简单的设计，开发者就能很明确地控制什么样逻辑要先做或后做了。\n\n在 SampleMiddleware 之中，这里只做了一個很简单的动作，如果 username 是空白的话，就将该连接重定向到到 NoName.html 然后中断 middleware 的执行。\n\n为了能让这个middleware作为 ApplicationBuilder来使用，我们另外需要写一个扩展方法。代码如下：\n\n```csharp\n\npublic static partial class MiddlewareExtensions\n{\n    public static IApplicationBuilder UseSampleMiddleware(\n    this IApplicationBuilder builder)\n    {\n        return builder.UseMiddleware<SampleMiddleware>();\n    }\n}\n```\n\n这给扩展方法建立了UseSampleMiddleware()，使得我们可以让ApplicationBuilder 去读 SampleMiddleware。\n\n这是回到Startup.cs中，在 Configure() 里面我们就可以把 SampleMiddleware 加入到我们的 pipeline中了。具体代码如下：\n```csharp\n\npublic void Configure(IApplicationBuilder app,IHostingEnvironment env, \n                      ILoggerFactory loggerFactory)\n{\n    loggerFactory.AddConsole(Configuration.GetSection(\"Logging\"));\n    loggerFactory.AddDebug();\n\n    app.UseStaticFiles();\n\n    app.UseSampleMiddleware();   // <-- SampleMiddleware\n\n    app.UseMvc(routes =>\n    {\n        routes.MapRoute(\"default\",\n        \"{controller=Home}/{action=Index}/{id?}\");\n    });\n}\n\n```\n把 SampleMiddleware 放在 UseStaticFiles 和 UseMvc 之间，也就是说在 http request 还沒进入到 MVC routing 之前，就会先检查 HttpContext 里面是不是有空白的 username。很显然username肯定是空白的，因为我并沒有加入任何使用者验证代码这里面，所以利用 dotnet run 來运行这个项目的时候，你就会看到 Http code 302 出現，它的意思就是 http redirect，也就是 SampleMiddleware 里面面所做的 redirect 发生作用了。\n\n![http redirect](http://7xread.com1.z0.glb.clouddn.com/1d7e4c87-9fff-4401-8933-36dcbf857199)\n\n## Middleware 的执行顺序很重要\n\n前面解释了 middleware 执行过程是一个接着一个的．不同的 middleware 对 HttpContext 的內容都可能有不同的处理或更改，因此执行舒服便格外重要。举个例子，如果将上面 Configure() 的代码变更如下:\n\n```csharp\n\npublic void Configure(IApplicationBuilder app, IHostingEnvironment env,\n                       ILoggerFactory loggerFactory)\n{\n    loggerFactory.AddConsole(Configuration.GetSection(\"Logging\"));\n    loggerFactory.AddDebug();\n\n    app.UseSampleMiddleware();   // SampleMiddleware\n\n    app.UseStaticFiles();        // StaticFiles\n\n    app.UseMvc(routes =>\n    {\n        routes.MapRoute(\"default\",\"{controller=Home}/{action=Index}/{id?}\");\n    });\n}\n```\n我们把SampleMiddleware 放到StaticFiles 之前。这就导致在 SampleMiddleware 里重定向到 NoName.html会失败。\n\n为什么会失败呢? 因为我们的 ApplicationBuilder 执行到行到 SampleMiddleware 时候重定向到NoName.html，也就是做读取静态页面，而这个功能服务方是在下一个 middleware (StaticFiles) 才会提供的，因此 ApplicationBuilder 无法找到 NoName.html，所以在浏览器上也就看不到 NoName.html 的內容。\n\n#### Middleware 这样的设计带来了很大的方便和弹性，同時我们自己也要小心 middleware 前后相依性的问题。\n\n## Middleware 背后原理\n\n现在 ASP.NET Core 已是开源项目了，所以最后说明一下 middleware 原理的基本概念．整個 ASP.NET fundamental 的部份用了许多的 function delegate , task, denepdency injection 的编写方法，所以要看 source code 之前，建议先对这三个东西先行了解，这样对理解 ASP.NET Core源码很有帮助．\n\n在前面的代码中，我们看到 RequestDelegate,  顾名思义就知道这是一个delegate（委托），它是用来代表 middleware 的 delegate. 它的 source code 在 [RequestDelegate.cs](https://github.com/aspnet/httpabstractions/blob/master/src/Microsoft.AspNet.Http.Abstractions/RequestDelegate.cs)\n\nIApplicationBuilder interface 是一個相当重要的接口，它定义了整個APP要用哪些服务和參數，当然也包含要使用那些 middleware，它的 souce code 在 [IApplicationBuilder.cs](https://github.com/aspnet/httpabstractions/blob/master/src/Microsoft.AspNet.Http.Abstractions/IApplicationBuilder.cs)。\n\n其中你可以看到 Use()，通过 Use() 的实例就可以把 middleware delegate 注册到 host engine 上。\n\n另外一个就是 UseMiddlewareExtensions ，前面的代码曾用了 builder.UseMiddleware<SampleMiddleware>(); 它会检查你写的 middleware 是不是合法的，比如有沒有 Invoke()，是不是只有一个Invoke()，Invoke() 的参数有沒有一个是 HttpContext type，所有的检查都通过之后便建立出该middleware instance 的 delegate。\n\n因此，当你的 ASP.NET Core APP刚启动的时候，在 Startup.cs 的 Configure() 就会把所有的 middleware delegate 建立起來，然后依序地放到內部的 stack 结构中。以上面的范例来说， stack 结构第一个元素是 StaticFiles,  然后是 SampleMiddleware 最后是 Mvc。接着每個 middleware 要被建立时是做 stack pop 的操作，所以 Mvc 的 _next 是 engine 里一些內部的 middleware 处理器，然後 pop 出 SampleMiddleware 时，就把 SampleMiddleware 的 _next 指向前面一個 pop 出來的 Mvc。依照着这样的逻辑一直到最前面的 middleware。所以在 host engine 在 Build() 之前这些动作都会完成，然后 host engine 才能执行Run()。有关 host engine 可參考 \n[WebHostBuilder.cs](https://github.com/aspnet/hosting/blob/master/src/Microsoft.AspNet.Hosting/WebHostBuilder.cs)\n\n\n全文完。\n\n\n本文整理于[https://dotblogs.com.tw/aspnetshare/2016/03/20/201603191](https://dotblogs.com.tw/aspnetshare/2016/03/20/201603191)并已征得作者同意。\n感谢Bruce的分享。","source":"_posts/ASP.NET-Core-Middleware.md","raw":"---\nlayout: post\ntitle: ASP.NET Core Middleware\ncategory: .net\ndate: 2016-08-01 00:00:00\n---\n\n在ASP.NET 时代，一般来说我们很少会用到HttpModule/HttpHandler，然而有些场景我们使用HttpModule/HttpHandler倒方便快捷完成我们的需求。有兴趣了解HttpModule/HttpHandler以及使用场景的话，可以看下面这个链接的内容。\n\n[选择HttpHandler还是HttpModule？](http://www.cnblogs.com/fish-li/archive/2013/01/04/2844908.html)\n\n来到ASP.NET Core时代，类似功能的内容可能我们看得就要多得多了。因为在ASP.NET Core时代，微软将HttpModule“变更”之后，并为它授予了更灵活应用场景。\n\n##### 这就是这个文章要介绍的主角：Middleware（中间件）。\n\n## Middleware\n\n为了使用跨平台，ASP.NET Core整个架构和代码都重写了一遍，所以 HttpModule 自然也就不存在了。但是相似的功能还是有的，它的名字叫： Middleware。和以前不同，在ASP.NET Core中我们将会经常看到 Middleware的存在，因为现在的每一个服务都是用Middleware的方式呈现在ASP.NET Core 管道中。不仅如此，meddleware比起之前的HttpModule也更弹性易用了。\n\n首先先来看看什么是middleware。\n\n```csharp\n\npublic void Configure(IApplicationBuilder app, IHostingEnvironment env, \n                      ILoggerFactory loggerFactory)\n{\n    loggerFactory.AddConsole(Configuration.GetSection(\"Logging\"));\n    loggerFactory.AddDebug();\n\n    app.UseStaticFiles();\n\n    app.UseMvc(routes =>\n    {\n        routes.MapRoute(\"default\",\n        \"{controller=Home}/{action=Index}/{id?}\");\n    });\n}\n\n```\n看过ASP.NET Core项目的话，相信大家对Satarup.cs并不会陌生。在Starup.cs里面便有一个Configure()函数用于定义项目需要使用哪些middleware。\n\n上面的例子使用了两个middleware，一个是 UseStaticFiles，另一个是 UseMvc。这两个都是core自带的middleware，所以我们可以直接使用。UseStaticFiles 是为HTTP Request提供存取网站的文件，简单理解就是使得网站上的静态文件可访问，而UseMvc就是启用MVC routing机制。有了这两个middleware，我们的的网站就有了MVC routing和读取静态文件的功能。\n\n如果我们把UseMvc去掉，那么MVC routing也就不存在了，我们输入 http://website/[Controller]/[Action] 类似的地址也就无效了。\n\n### 和HttpModule的不同之处\n\n在使用HttpModule的时候，我们是在实现/重写接口，这个时候就要求我们在适当的地方做适当的事情。例如，要做 authorization 的话就最好在 HttpModule 定义好的 Authorization 事件 (AuthorizatRequest) 中完成这个功能。在 ASP.NET life cycle 的文件里我们可以查到 HttpModule  定义了那些事件，每一個事件都有哪些特別的功能。因此我们需要全面了解之后再来选择实现/重写我们需要的事件。而在Middleware中，完全没有这样的限制，也不存在这样的事件，我们可以自行设计实现我们的机制。\n\n## Middleware 流程\n[https://docs.asp.net/en/latest/fundamentals/middleware.html](https://docs.asp.net/en/latest/fundamentals/middleware.html) 这个文章中说明了基本的middleware概念。目前asp.net docs里面有不少的内容都是开源社区开发者贡献的\n\n在这个文章里面有一个简单的流程图说明了ASP.NET runtime中middleware的执行过程。\n\n![middleware执行过程](http://7xread.com1.z0.glb.clouddn.com/0b6d43ad-7d95-48ea-bbf3-ea7a93c4a366)\n\n在 middleware 里面一定要定义 Invoke()函数，因为这是让 engine 默认调用 middleware 的Incoke函数。Middleware 里面所需要做什么事情就放在 Invoke() 里面，同时 Invoke() 里面还需要调用下一个 middleware。因此执行内容就如上图所示。Middleware 之间除了必须传送 HttpContext之外，也可以自定义传入其他的参数，这比以前的HttpModule方便多了。\n\n\n所以当 HTTP request 进来之后，engine 便会呼叫第一个 middleware 的 Invoke()，同时把传入HttpContext，然后第一个 middleware 可以再接着呼叫第二个 middleware 的 Invoke()，同时再把 HttpContext 继续传入，一直到最后一个middleware 的 Invoke() 结束之后，整个 HttpContext 的內容可能在 middleware 里面新增或被改变了，最后再按照整個原先的 call stack 从最后一个 middleware 回到第一个 middleware，再通过  engine 回传到client 端，完成request.\n\n\n下来通过一个例子我们一起来了解一下Middleware。\n\n## 编写简单的 Middleware \n\n```csharp\npublic class SampleMiddleware\n{\n    private readonly RequestDelegate _next;\n\n    public SampleMiddleware(RequestDelegate next)\n    {\n        _next = next;\n    }\n\n    public async Task Invoke(HttpContext context)\n    {\n        if (string.IsNullOrEmpty(context.User.Identity.Name))\n        {\n            context.Response.Redirect(\"/NoName.html\");\n            return;\n        }\n        await _next.Invoke(context);\n    }\n}\n\n```\n\n\n这一个middleware的名字叫SampleMiddleware。它有一个构造函数以及Invoke函数，而Invoke()只接收一个参数HttpContext。\n\n_next是一个叫 RequestDelegate类型，换言之这就是一个delegate，用于代表下一个middleware是谁。所以在构造函数中要把下一个middleware delegate传入。看到这里或许会觉得奇怪，我们的middleware在执行过程中怎么会知道下一个middleware是谁？这一部分稍后解释。\n\n\n在 Invoke() 里面，在 await _next.Invoke() 之前都是当前middleware的逻辑代码，从上面流程图来看的话就是由左自右的方向． await _next.Invoke() 之后的代码是就是流程图上由右至右的方向，因此，透過这样简单的设计，开发者就能很明确地控制什么样逻辑要先做或后做了。\n\n在 SampleMiddleware 之中，这里只做了一個很简单的动作，如果 username 是空白的话，就将该连接重定向到到 NoName.html 然后中断 middleware 的执行。\n\n为了能让这个middleware作为 ApplicationBuilder来使用，我们另外需要写一个扩展方法。代码如下：\n\n```csharp\n\npublic static partial class MiddlewareExtensions\n{\n    public static IApplicationBuilder UseSampleMiddleware(\n    this IApplicationBuilder builder)\n    {\n        return builder.UseMiddleware<SampleMiddleware>();\n    }\n}\n```\n\n这给扩展方法建立了UseSampleMiddleware()，使得我们可以让ApplicationBuilder 去读 SampleMiddleware。\n\n这是回到Startup.cs中，在 Configure() 里面我们就可以把 SampleMiddleware 加入到我们的 pipeline中了。具体代码如下：\n```csharp\n\npublic void Configure(IApplicationBuilder app,IHostingEnvironment env, \n                      ILoggerFactory loggerFactory)\n{\n    loggerFactory.AddConsole(Configuration.GetSection(\"Logging\"));\n    loggerFactory.AddDebug();\n\n    app.UseStaticFiles();\n\n    app.UseSampleMiddleware();   // <-- SampleMiddleware\n\n    app.UseMvc(routes =>\n    {\n        routes.MapRoute(\"default\",\n        \"{controller=Home}/{action=Index}/{id?}\");\n    });\n}\n\n```\n把 SampleMiddleware 放在 UseStaticFiles 和 UseMvc 之间，也就是说在 http request 还沒进入到 MVC routing 之前，就会先检查 HttpContext 里面是不是有空白的 username。很显然username肯定是空白的，因为我并沒有加入任何使用者验证代码这里面，所以利用 dotnet run 來运行这个项目的时候，你就会看到 Http code 302 出現，它的意思就是 http redirect，也就是 SampleMiddleware 里面面所做的 redirect 发生作用了。\n\n![http redirect](http://7xread.com1.z0.glb.clouddn.com/1d7e4c87-9fff-4401-8933-36dcbf857199)\n\n## Middleware 的执行顺序很重要\n\n前面解释了 middleware 执行过程是一个接着一个的．不同的 middleware 对 HttpContext 的內容都可能有不同的处理或更改，因此执行舒服便格外重要。举个例子，如果将上面 Configure() 的代码变更如下:\n\n```csharp\n\npublic void Configure(IApplicationBuilder app, IHostingEnvironment env,\n                       ILoggerFactory loggerFactory)\n{\n    loggerFactory.AddConsole(Configuration.GetSection(\"Logging\"));\n    loggerFactory.AddDebug();\n\n    app.UseSampleMiddleware();   // SampleMiddleware\n\n    app.UseStaticFiles();        // StaticFiles\n\n    app.UseMvc(routes =>\n    {\n        routes.MapRoute(\"default\",\"{controller=Home}/{action=Index}/{id?}\");\n    });\n}\n```\n我们把SampleMiddleware 放到StaticFiles 之前。这就导致在 SampleMiddleware 里重定向到 NoName.html会失败。\n\n为什么会失败呢? 因为我们的 ApplicationBuilder 执行到行到 SampleMiddleware 时候重定向到NoName.html，也就是做读取静态页面，而这个功能服务方是在下一个 middleware (StaticFiles) 才会提供的，因此 ApplicationBuilder 无法找到 NoName.html，所以在浏览器上也就看不到 NoName.html 的內容。\n\n#### Middleware 这样的设计带来了很大的方便和弹性，同時我们自己也要小心 middleware 前后相依性的问题。\n\n## Middleware 背后原理\n\n现在 ASP.NET Core 已是开源项目了，所以最后说明一下 middleware 原理的基本概念．整個 ASP.NET fundamental 的部份用了许多的 function delegate , task, denepdency injection 的编写方法，所以要看 source code 之前，建议先对这三个东西先行了解，这样对理解 ASP.NET Core源码很有帮助．\n\n在前面的代码中，我们看到 RequestDelegate,  顾名思义就知道这是一个delegate（委托），它是用来代表 middleware 的 delegate. 它的 source code 在 [RequestDelegate.cs](https://github.com/aspnet/httpabstractions/blob/master/src/Microsoft.AspNet.Http.Abstractions/RequestDelegate.cs)\n\nIApplicationBuilder interface 是一個相当重要的接口，它定义了整個APP要用哪些服务和參數，当然也包含要使用那些 middleware，它的 souce code 在 [IApplicationBuilder.cs](https://github.com/aspnet/httpabstractions/blob/master/src/Microsoft.AspNet.Http.Abstractions/IApplicationBuilder.cs)。\n\n其中你可以看到 Use()，通过 Use() 的实例就可以把 middleware delegate 注册到 host engine 上。\n\n另外一个就是 UseMiddlewareExtensions ，前面的代码曾用了 builder.UseMiddleware<SampleMiddleware>(); 它会检查你写的 middleware 是不是合法的，比如有沒有 Invoke()，是不是只有一个Invoke()，Invoke() 的参数有沒有一个是 HttpContext type，所有的检查都通过之后便建立出该middleware instance 的 delegate。\n\n因此，当你的 ASP.NET Core APP刚启动的时候，在 Startup.cs 的 Configure() 就会把所有的 middleware delegate 建立起來，然后依序地放到內部的 stack 结构中。以上面的范例来说， stack 结构第一个元素是 StaticFiles,  然后是 SampleMiddleware 最后是 Mvc。接着每個 middleware 要被建立时是做 stack pop 的操作，所以 Mvc 的 _next 是 engine 里一些內部的 middleware 处理器，然後 pop 出 SampleMiddleware 时，就把 SampleMiddleware 的 _next 指向前面一個 pop 出來的 Mvc。依照着这样的逻辑一直到最前面的 middleware。所以在 host engine 在 Build() 之前这些动作都会完成，然后 host engine 才能执行Run()。有关 host engine 可參考 \n[WebHostBuilder.cs](https://github.com/aspnet/hosting/blob/master/src/Microsoft.AspNet.Hosting/WebHostBuilder.cs)\n\n\n全文完。\n\n\n本文整理于[https://dotblogs.com.tw/aspnetshare/2016/03/20/201603191](https://dotblogs.com.tw/aspnetshare/2016/03/20/201603191)并已征得作者同意。\n感谢Bruce的分享。","slug":"ASP.NET-Core-Middleware","published":1,"updated":"2016-09-15T05:11:13.648Z","comments":1,"photos":[],"link":"","_id":"cit3xw9s90003c0txrif9sn16","content":"<p>在ASP.NET 时代，一般来说我们很少会用到HttpModule/HttpHandler，然而有些场景我们使用HttpModule/HttpHandler倒方便快捷完成我们的需求。有兴趣了解HttpModule/HttpHandler以及使用场景的话，可以看下面这个链接的内容。</p>\n<p><a href=\"http://www.cnblogs.com/fish-li/archive/2013/01/04/2844908.html\" target=\"_blank\" rel=\"external\">选择HttpHandler还是HttpModule？</a></p>\n<p>来到ASP.NET Core时代，类似功能的内容可能我们看得就要多得多了。因为在ASP.NET Core时代，微软将HttpModule“变更”之后，并为它授予了更灵活应用场景。</p>\n<h5 id=\"这就是这个文章要介绍的主角：Middleware（中间件）。\"><a href=\"#这就是这个文章要介绍的主角：Middleware（中间件）。\" class=\"headerlink\" title=\"这就是这个文章要介绍的主角：Middleware（中间件）。\"></a>这就是这个文章要介绍的主角：Middleware（中间件）。</h5><h2 id=\"Middleware\"><a href=\"#Middleware\" class=\"headerlink\" title=\"Middleware\"></a>Middleware</h2><p>为了使用跨平台，ASP.NET Core整个架构和代码都重写了一遍，所以 HttpModule 自然也就不存在了。但是相似的功能还是有的，它的名字叫： Middleware。和以前不同，在ASP.NET Core中我们将会经常看到 Middleware的存在，因为现在的每一个服务都是用Middleware的方式呈现在ASP.NET Core 管道中。不仅如此，meddleware比起之前的HttpModule也更弹性易用了。</p>\n<p>首先先来看看什么是middleware。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IHostingEnvironment env, </span></span></div><div class=\"line\">                      ILoggerFactory loggerFactory)</div><div class=\"line\">&#123;</div><div class=\"line\">    loggerFactory.AddConsole(Configuration.GetSection(<span class=\"string\">\"Logging\"</span>));</div><div class=\"line\">    loggerFactory.AddDebug();</div><div class=\"line\"></div><div class=\"line\">    app.UseStaticFiles();</div><div class=\"line\"></div><div class=\"line\">    app.UseMvc(routes =&gt;</div><div class=\"line\">    &#123;</div><div class=\"line\">        routes.MapRoute(<span class=\"string\">\"default\"</span>,</div><div class=\"line\">        <span class=\"string\">\"&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;\"</span>);</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>看过ASP.NET Core项目的话，相信大家对Satarup.cs并不会陌生。在Starup.cs里面便有一个Configure()函数用于定义项目需要使用哪些middleware。</p>\n<p>上面的例子使用了两个middleware，一个是 UseStaticFiles，另一个是 UseMvc。这两个都是core自带的middleware，所以我们可以直接使用。UseStaticFiles 是为HTTP Request提供存取网站的文件，简单理解就是使得网站上的静态文件可访问，而UseMvc就是启用MVC routing机制。有了这两个middleware，我们的的网站就有了MVC routing和读取静态文件的功能。</p>\n<p>如果我们把UseMvc去掉，那么MVC routing也就不存在了，我们输入 <a href=\"http://website/[Controller]/[Action\" target=\"_blank\" rel=\"external\">http://website/[Controller]/[Action</a>] 类似的地址也就无效了。</p>\n<h3 id=\"和HttpModule的不同之处\"><a href=\"#和HttpModule的不同之处\" class=\"headerlink\" title=\"和HttpModule的不同之处\"></a>和HttpModule的不同之处</h3><p>在使用HttpModule的时候，我们是在实现/重写接口，这个时候就要求我们在适当的地方做适当的事情。例如，要做 authorization 的话就最好在 HttpModule 定义好的 Authorization 事件 (AuthorizatRequest) 中完成这个功能。在 ASP.NET life cycle 的文件里我们可以查到 HttpModule  定义了那些事件，每一個事件都有哪些特別的功能。因此我们需要全面了解之后再来选择实现/重写我们需要的事件。而在Middleware中，完全没有这样的限制，也不存在这样的事件，我们可以自行设计实现我们的机制。</p>\n<h2 id=\"Middleware-流程\"><a href=\"#Middleware-流程\" class=\"headerlink\" title=\"Middleware 流程\"></a>Middleware 流程</h2><p><a href=\"https://docs.asp.net/en/latest/fundamentals/middleware.html\" target=\"_blank\" rel=\"external\">https://docs.asp.net/en/latest/fundamentals/middleware.html</a> 这个文章中说明了基本的middleware概念。目前asp.net docs里面有不少的内容都是开源社区开发者贡献的</p>\n<p>在这个文章里面有一个简单的流程图说明了ASP.NET runtime中middleware的执行过程。</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/0b6d43ad-7d95-48ea-bbf3-ea7a93c4a366\" alt=\"middleware执行过程\"></p>\n<p>在 middleware 里面一定要定义 Invoke()函数，因为这是让 engine 默认调用 middleware 的Incoke函数。Middleware 里面所需要做什么事情就放在 Invoke() 里面，同时 Invoke() 里面还需要调用下一个 middleware。因此执行内容就如上图所示。Middleware 之间除了必须传送 HttpContext之外，也可以自定义传入其他的参数，这比以前的HttpModule方便多了。</p>\n<p>所以当 HTTP request 进来之后，engine 便会呼叫第一个 middleware 的 Invoke()，同时把传入HttpContext，然后第一个 middleware 可以再接着呼叫第二个 middleware 的 Invoke()，同时再把 HttpContext 继续传入，一直到最后一个middleware 的 Invoke() 结束之后，整个 HttpContext 的內容可能在 middleware 里面新增或被改变了，最后再按照整個原先的 call stack 从最后一个 middleware 回到第一个 middleware，再通过  engine 回传到client 端，完成request.</p>\n<p>下来通过一个例子我们一起来了解一下Middleware。</p>\n<h2 id=\"编写简单的-Middleware\"><a href=\"#编写简单的-Middleware\" class=\"headerlink\" title=\"编写简单的 Middleware\"></a>编写简单的 Middleware</h2><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SampleMiddleware</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> RequestDelegate _next;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SampleMiddleware</span>(<span class=\"params\">RequestDelegate next</span>)</span></div><div class=\"line\">    &#123;</div><div class=\"line\">        _next = next;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">Invoke</span>(<span class=\"params\">HttpContext context</span>)</span></div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">string</span>.IsNullOrEmpty(context.User.Identity.Name))</div><div class=\"line\">        &#123;</div><div class=\"line\">            context.Response.Redirect(<span class=\"string\">\"/NoName.html\"</span>);</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">await</span> _next.Invoke(context);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>这一个middleware的名字叫SampleMiddleware。它有一个构造函数以及Invoke函数，而Invoke()只接收一个参数HttpContext。</p>\n<p>_next是一个叫 RequestDelegate类型，换言之这就是一个delegate，用于代表下一个middleware是谁。所以在构造函数中要把下一个middleware delegate传入。看到这里或许会觉得奇怪，我们的middleware在执行过程中怎么会知道下一个middleware是谁？这一部分稍后解释。</p>\n<p>在 Invoke() 里面，在 await _next.Invoke() 之前都是当前middleware的逻辑代码，从上面流程图来看的话就是由左自右的方向． await _next.Invoke() 之后的代码是就是流程图上由右至右的方向，因此，透過这样简单的设计，开发者就能很明确地控制什么样逻辑要先做或后做了。</p>\n<p>在 SampleMiddleware 之中，这里只做了一個很简单的动作，如果 username 是空白的话，就将该连接重定向到到 NoName.html 然后中断 middleware 的执行。</p>\n<p>为了能让这个middleware作为 ApplicationBuilder来使用，我们另外需要写一个扩展方法。代码如下：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">partial</span> <span class=\"keyword\">class</span> <span class=\"title\">MiddlewareExtensions</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IApplicationBuilder <span class=\"title\">UseSampleMiddleware</span>(<span class=\"params\"></span></span></div><div class=\"line\">    <span class=\"keyword\">this</span> IApplicationBuilder builder)</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> builder.UseMiddleware&lt;SampleMiddleware&gt;();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>这给扩展方法建立了UseSampleMiddleware()，使得我们可以让ApplicationBuilder 去读 SampleMiddleware。</p>\n<p>这是回到Startup.cs中，在 Configure() 里面我们就可以把 SampleMiddleware 加入到我们的 pipeline中了。具体代码如下：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app,IHostingEnvironment env, </span></span></div><div class=\"line\">                      ILoggerFactory loggerFactory)</div><div class=\"line\">&#123;</div><div class=\"line\">    loggerFactory.AddConsole(Configuration.GetSection(<span class=\"string\">\"Logging\"</span>));</div><div class=\"line\">    loggerFactory.AddDebug();</div><div class=\"line\"></div><div class=\"line\">    app.UseStaticFiles();</div><div class=\"line\"></div><div class=\"line\">    app.UseSampleMiddleware();   <span class=\"comment\">// &lt;-- SampleMiddleware</span></div><div class=\"line\"></div><div class=\"line\">    app.UseMvc(routes =&gt;</div><div class=\"line\">    &#123;</div><div class=\"line\">        routes.MapRoute(<span class=\"string\">\"default\"</span>,</div><div class=\"line\">        <span class=\"string\">\"&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;\"</span>);</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>把 SampleMiddleware 放在 UseStaticFiles 和 UseMvc 之间，也就是说在 http request 还沒进入到 MVC routing 之前，就会先检查 HttpContext 里面是不是有空白的 username。很显然username肯定是空白的，因为我并沒有加入任何使用者验证代码这里面，所以利用 dotnet run 來运行这个项目的时候，你就会看到 Http code 302 出現，它的意思就是 http redirect，也就是 SampleMiddleware 里面面所做的 redirect 发生作用了。</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/1d7e4c87-9fff-4401-8933-36dcbf857199\" alt=\"http redirect\"></p>\n<h2 id=\"Middleware-的执行顺序很重要\"><a href=\"#Middleware-的执行顺序很重要\" class=\"headerlink\" title=\"Middleware 的执行顺序很重要\"></a>Middleware 的执行顺序很重要</h2><p>前面解释了 middleware 执行过程是一个接着一个的．不同的 middleware 对 HttpContext 的內容都可能有不同的处理或更改，因此执行舒服便格外重要。举个例子，如果将上面 Configure() 的代码变更如下:</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IHostingEnvironment env,</span></span></div><div class=\"line\">                       ILoggerFactory loggerFactory)</div><div class=\"line\">&#123;</div><div class=\"line\">    loggerFactory.AddConsole(Configuration.GetSection(<span class=\"string\">\"Logging\"</span>));</div><div class=\"line\">    loggerFactory.AddDebug();</div><div class=\"line\"></div><div class=\"line\">    app.UseSampleMiddleware();   <span class=\"comment\">// SampleMiddleware</span></div><div class=\"line\"></div><div class=\"line\">    app.UseStaticFiles();        <span class=\"comment\">// StaticFiles</span></div><div class=\"line\"></div><div class=\"line\">    app.UseMvc(routes =&gt;</div><div class=\"line\">    &#123;</div><div class=\"line\">        routes.MapRoute(<span class=\"string\">\"default\"</span>,<span class=\"string\">\"&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;\"</span>);</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>我们把SampleMiddleware 放到StaticFiles 之前。这就导致在 SampleMiddleware 里重定向到 NoName.html会失败。</p>\n<p>为什么会失败呢? 因为我们的 ApplicationBuilder 执行到行到 SampleMiddleware 时候重定向到NoName.html，也就是做读取静态页面，而这个功能服务方是在下一个 middleware (StaticFiles) 才会提供的，因此 ApplicationBuilder 无法找到 NoName.html，所以在浏览器上也就看不到 NoName.html 的內容。</p>\n<h4 id=\"Middleware-这样的设计带来了很大的方便和弹性，同時我们自己也要小心-middleware-前后相依性的问题。\"><a href=\"#Middleware-这样的设计带来了很大的方便和弹性，同時我们自己也要小心-middleware-前后相依性的问题。\" class=\"headerlink\" title=\"Middleware 这样的设计带来了很大的方便和弹性，同時我们自己也要小心 middleware 前后相依性的问题。\"></a>Middleware 这样的设计带来了很大的方便和弹性，同時我们自己也要小心 middleware 前后相依性的问题。</h4><h2 id=\"Middleware-背后原理\"><a href=\"#Middleware-背后原理\" class=\"headerlink\" title=\"Middleware 背后原理\"></a>Middleware 背后原理</h2><p>现在 ASP.NET Core 已是开源项目了，所以最后说明一下 middleware 原理的基本概念．整個 ASP.NET fundamental 的部份用了许多的 function delegate , task, denepdency injection 的编写方法，所以要看 source code 之前，建议先对这三个东西先行了解，这样对理解 ASP.NET Core源码很有帮助．</p>\n<p>在前面的代码中，我们看到 RequestDelegate,  顾名思义就知道这是一个delegate（委托），它是用来代表 middleware 的 delegate. 它的 source code 在 <a href=\"https://github.com/aspnet/httpabstractions/blob/master/src/Microsoft.AspNet.Http.Abstractions/RequestDelegate.cs\" target=\"_blank\" rel=\"external\">RequestDelegate.cs</a></p>\n<p>IApplicationBuilder interface 是一個相当重要的接口，它定义了整個APP要用哪些服务和參數，当然也包含要使用那些 middleware，它的 souce code 在 <a href=\"https://github.com/aspnet/httpabstractions/blob/master/src/Microsoft.AspNet.Http.Abstractions/IApplicationBuilder.cs\" target=\"_blank\" rel=\"external\">IApplicationBuilder.cs</a>。</p>\n<p>其中你可以看到 Use()，通过 Use() 的实例就可以把 middleware delegate 注册到 host engine 上。</p>\n<p>另外一个就是 UseMiddlewareExtensions ，前面的代码曾用了 builder.UseMiddleware<samplemiddleware>(); 它会检查你写的 middleware 是不是合法的，比如有沒有 Invoke()，是不是只有一个Invoke()，Invoke() 的参数有沒有一个是 HttpContext type，所有的检查都通过之后便建立出该middleware instance 的 delegate。</samplemiddleware></p>\n<p>因此，当你的 ASP.NET Core APP刚启动的时候，在 Startup.cs 的 Configure() 就会把所有的 middleware delegate 建立起來，然后依序地放到內部的 stack 结构中。以上面的范例来说， stack 结构第一个元素是 StaticFiles,  然后是 SampleMiddleware 最后是 Mvc。接着每個 middleware 要被建立时是做 stack pop 的操作，所以 Mvc 的 _next 是 engine 里一些內部的 middleware 处理器，然後 pop 出 SampleMiddleware 时，就把 SampleMiddleware 的 _next 指向前面一個 pop 出來的 Mvc。依照着这样的逻辑一直到最前面的 middleware。所以在 host engine 在 Build() 之前这些动作都会完成，然后 host engine 才能执行Run()。有关 host engine 可參考<br><a href=\"https://github.com/aspnet/hosting/blob/master/src/Microsoft.AspNet.Hosting/WebHostBuilder.cs\" target=\"_blank\" rel=\"external\">WebHostBuilder.cs</a></p>\n<p>全文完。</p>\n<p>本文整理于<a href=\"https://dotblogs.com.tw/aspnetshare/2016/03/20/201603191\" target=\"_blank\" rel=\"external\">https://dotblogs.com.tw/aspnetshare/2016/03/20/201603191</a>并已征得作者同意。<br>感谢Bruce的分享。</p>\n","excerpt":"","more":"<p>在ASP.NET 时代，一般来说我们很少会用到HttpModule/HttpHandler，然而有些场景我们使用HttpModule/HttpHandler倒方便快捷完成我们的需求。有兴趣了解HttpModule/HttpHandler以及使用场景的话，可以看下面这个链接的内容。</p>\n<p><a href=\"http://www.cnblogs.com/fish-li/archive/2013/01/04/2844908.html\">选择HttpHandler还是HttpModule？</a></p>\n<p>来到ASP.NET Core时代，类似功能的内容可能我们看得就要多得多了。因为在ASP.NET Core时代，微软将HttpModule“变更”之后，并为它授予了更灵活应用场景。</p>\n<h5 id=\"这就是这个文章要介绍的主角：Middleware（中间件）。\"><a href=\"#这就是这个文章要介绍的主角：Middleware（中间件）。\" class=\"headerlink\" title=\"这就是这个文章要介绍的主角：Middleware（中间件）。\"></a>这就是这个文章要介绍的主角：Middleware（中间件）。</h5><h2 id=\"Middleware\"><a href=\"#Middleware\" class=\"headerlink\" title=\"Middleware\"></a>Middleware</h2><p>为了使用跨平台，ASP.NET Core整个架构和代码都重写了一遍，所以 HttpModule 自然也就不存在了。但是相似的功能还是有的，它的名字叫： Middleware。和以前不同，在ASP.NET Core中我们将会经常看到 Middleware的存在，因为现在的每一个服务都是用Middleware的方式呈现在ASP.NET Core 管道中。不仅如此，meddleware比起之前的HttpModule也更弹性易用了。</p>\n<p>首先先来看看什么是middleware。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IHostingEnvironment env, </div><div class=\"line\">                      ILoggerFactory loggerFactory</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    loggerFactory.AddConsole(Configuration.GetSection(<span class=\"string\">\"Logging\"</span>));</div><div class=\"line\">    loggerFactory.AddDebug();</div><div class=\"line\"></div><div class=\"line\">    app.UseStaticFiles();</div><div class=\"line\"></div><div class=\"line\">    app.UseMvc(routes =&gt;</div><div class=\"line\">    &#123;</div><div class=\"line\">        routes.MapRoute(<span class=\"string\">\"default\"</span>,</div><div class=\"line\">        <span class=\"string\">\"&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;\"</span>);</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>看过ASP.NET Core项目的话，相信大家对Satarup.cs并不会陌生。在Starup.cs里面便有一个Configure()函数用于定义项目需要使用哪些middleware。</p>\n<p>上面的例子使用了两个middleware，一个是 UseStaticFiles，另一个是 UseMvc。这两个都是core自带的middleware，所以我们可以直接使用。UseStaticFiles 是为HTTP Request提供存取网站的文件，简单理解就是使得网站上的静态文件可访问，而UseMvc就是启用MVC routing机制。有了这两个middleware，我们的的网站就有了MVC routing和读取静态文件的功能。</p>\n<p>如果我们把UseMvc去掉，那么MVC routing也就不存在了，我们输入 <a href=\"http://website/[Controller]/[Action\">http://website/[Controller]/[Action</a>] 类似的地址也就无效了。</p>\n<h3 id=\"和HttpModule的不同之处\"><a href=\"#和HttpModule的不同之处\" class=\"headerlink\" title=\"和HttpModule的不同之处\"></a>和HttpModule的不同之处</h3><p>在使用HttpModule的时候，我们是在实现/重写接口，这个时候就要求我们在适当的地方做适当的事情。例如，要做 authorization 的话就最好在 HttpModule 定义好的 Authorization 事件 (AuthorizatRequest) 中完成这个功能。在 ASP.NET life cycle 的文件里我们可以查到 HttpModule  定义了那些事件，每一個事件都有哪些特別的功能。因此我们需要全面了解之后再来选择实现/重写我们需要的事件。而在Middleware中，完全没有这样的限制，也不存在这样的事件，我们可以自行设计实现我们的机制。</p>\n<h2 id=\"Middleware-流程\"><a href=\"#Middleware-流程\" class=\"headerlink\" title=\"Middleware 流程\"></a>Middleware 流程</h2><p><a href=\"https://docs.asp.net/en/latest/fundamentals/middleware.html\">https://docs.asp.net/en/latest/fundamentals/middleware.html</a> 这个文章中说明了基本的middleware概念。目前asp.net docs里面有不少的内容都是开源社区开发者贡献的</p>\n<p>在这个文章里面有一个简单的流程图说明了ASP.NET runtime中middleware的执行过程。</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/0b6d43ad-7d95-48ea-bbf3-ea7a93c4a366\" alt=\"middleware执行过程\"></p>\n<p>在 middleware 里面一定要定义 Invoke()函数，因为这是让 engine 默认调用 middleware 的Incoke函数。Middleware 里面所需要做什么事情就放在 Invoke() 里面，同时 Invoke() 里面还需要调用下一个 middleware。因此执行内容就如上图所示。Middleware 之间除了必须传送 HttpContext之外，也可以自定义传入其他的参数，这比以前的HttpModule方便多了。</p>\n<p>所以当 HTTP request 进来之后，engine 便会呼叫第一个 middleware 的 Invoke()，同时把传入HttpContext，然后第一个 middleware 可以再接着呼叫第二个 middleware 的 Invoke()，同时再把 HttpContext 继续传入，一直到最后一个middleware 的 Invoke() 结束之后，整个 HttpContext 的內容可能在 middleware 里面新增或被改变了，最后再按照整個原先的 call stack 从最后一个 middleware 回到第一个 middleware，再通过  engine 回传到client 端，完成request.</p>\n<p>下来通过一个例子我们一起来了解一下Middleware。</p>\n<h2 id=\"编写简单的-Middleware\"><a href=\"#编写简单的-Middleware\" class=\"headerlink\" title=\"编写简单的 Middleware\"></a>编写简单的 Middleware</h2><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SampleMiddleware</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> RequestDelegate _next;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SampleMiddleware</span>(<span class=\"params\">RequestDelegate next</span>)</div><div class=\"line\">    </span>&#123;</div><div class=\"line\">        _next = next;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">Invoke</span>(<span class=\"params\">HttpContext context</span>)</div><div class=\"line\">    </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">string</span>.IsNullOrEmpty(context.User.Identity.Name))</div><div class=\"line\">        &#123;</div><div class=\"line\">            context.Response.Redirect(<span class=\"string\">\"/NoName.html\"</span>);</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">await</span> _next.Invoke(context);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>这一个middleware的名字叫SampleMiddleware。它有一个构造函数以及Invoke函数，而Invoke()只接收一个参数HttpContext。</p>\n<p>_next是一个叫 RequestDelegate类型，换言之这就是一个delegate，用于代表下一个middleware是谁。所以在构造函数中要把下一个middleware delegate传入。看到这里或许会觉得奇怪，我们的middleware在执行过程中怎么会知道下一个middleware是谁？这一部分稍后解释。</p>\n<p>在 Invoke() 里面，在 await _next.Invoke() 之前都是当前middleware的逻辑代码，从上面流程图来看的话就是由左自右的方向． await _next.Invoke() 之后的代码是就是流程图上由右至右的方向，因此，透過这样简单的设计，开发者就能很明确地控制什么样逻辑要先做或后做了。</p>\n<p>在 SampleMiddleware 之中，这里只做了一個很简单的动作，如果 username 是空白的话，就将该连接重定向到到 NoName.html 然后中断 middleware 的执行。</p>\n<p>为了能让这个middleware作为 ApplicationBuilder来使用，我们另外需要写一个扩展方法。代码如下：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">partial</span> <span class=\"keyword\">class</span> <span class=\"title\">MiddlewareExtensions</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IApplicationBuilder <span class=\"title\">UseSampleMiddleware</span>(<span class=\"params\"></div><div class=\"line\">    <span class=\"keyword\">this</span> IApplicationBuilder builder</span>)</div><div class=\"line\">    </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> builder.UseMiddleware&lt;SampleMiddleware&gt;();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>这给扩展方法建立了UseSampleMiddleware()，使得我们可以让ApplicationBuilder 去读 SampleMiddleware。</p>\n<p>这是回到Startup.cs中，在 Configure() 里面我们就可以把 SampleMiddleware 加入到我们的 pipeline中了。具体代码如下：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app,IHostingEnvironment env, </div><div class=\"line\">                      ILoggerFactory loggerFactory</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    loggerFactory.AddConsole(Configuration.GetSection(<span class=\"string\">\"Logging\"</span>));</div><div class=\"line\">    loggerFactory.AddDebug();</div><div class=\"line\"></div><div class=\"line\">    app.UseStaticFiles();</div><div class=\"line\"></div><div class=\"line\">    app.UseSampleMiddleware();   <span class=\"comment\">// &lt;-- SampleMiddleware</span></div><div class=\"line\"></div><div class=\"line\">    app.UseMvc(routes =&gt;</div><div class=\"line\">    &#123;</div><div class=\"line\">        routes.MapRoute(<span class=\"string\">\"default\"</span>,</div><div class=\"line\">        <span class=\"string\">\"&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;\"</span>);</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>把 SampleMiddleware 放在 UseStaticFiles 和 UseMvc 之间，也就是说在 http request 还沒进入到 MVC routing 之前，就会先检查 HttpContext 里面是不是有空白的 username。很显然username肯定是空白的，因为我并沒有加入任何使用者验证代码这里面，所以利用 dotnet run 來运行这个项目的时候，你就会看到 Http code 302 出現，它的意思就是 http redirect，也就是 SampleMiddleware 里面面所做的 redirect 发生作用了。</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/1d7e4c87-9fff-4401-8933-36dcbf857199\" alt=\"http redirect\"></p>\n<h2 id=\"Middleware-的执行顺序很重要\"><a href=\"#Middleware-的执行顺序很重要\" class=\"headerlink\" title=\"Middleware 的执行顺序很重要\"></a>Middleware 的执行顺序很重要</h2><p>前面解释了 middleware 执行过程是一个接着一个的．不同的 middleware 对 HttpContext 的內容都可能有不同的处理或更改，因此执行舒服便格外重要。举个例子，如果将上面 Configure() 的代码变更如下:</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IHostingEnvironment env,</div><div class=\"line\">                       ILoggerFactory loggerFactory</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    loggerFactory.AddConsole(Configuration.GetSection(<span class=\"string\">\"Logging\"</span>));</div><div class=\"line\">    loggerFactory.AddDebug();</div><div class=\"line\"></div><div class=\"line\">    app.UseSampleMiddleware();   <span class=\"comment\">// SampleMiddleware</span></div><div class=\"line\"></div><div class=\"line\">    app.UseStaticFiles();        <span class=\"comment\">// StaticFiles</span></div><div class=\"line\"></div><div class=\"line\">    app.UseMvc(routes =&gt;</div><div class=\"line\">    &#123;</div><div class=\"line\">        routes.MapRoute(<span class=\"string\">\"default\"</span>,<span class=\"string\">\"&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;\"</span>);</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>我们把SampleMiddleware 放到StaticFiles 之前。这就导致在 SampleMiddleware 里重定向到 NoName.html会失败。</p>\n<p>为什么会失败呢? 因为我们的 ApplicationBuilder 执行到行到 SampleMiddleware 时候重定向到NoName.html，也就是做读取静态页面，而这个功能服务方是在下一个 middleware (StaticFiles) 才会提供的，因此 ApplicationBuilder 无法找到 NoName.html，所以在浏览器上也就看不到 NoName.html 的內容。</p>\n<h4 id=\"Middleware-这样的设计带来了很大的方便和弹性，同時我们自己也要小心-middleware-前后相依性的问题。\"><a href=\"#Middleware-这样的设计带来了很大的方便和弹性，同時我们自己也要小心-middleware-前后相依性的问题。\" class=\"headerlink\" title=\"Middleware 这样的设计带来了很大的方便和弹性，同時我们自己也要小心 middleware 前后相依性的问题。\"></a>Middleware 这样的设计带来了很大的方便和弹性，同時我们自己也要小心 middleware 前后相依性的问题。</h4><h2 id=\"Middleware-背后原理\"><a href=\"#Middleware-背后原理\" class=\"headerlink\" title=\"Middleware 背后原理\"></a>Middleware 背后原理</h2><p>现在 ASP.NET Core 已是开源项目了，所以最后说明一下 middleware 原理的基本概念．整個 ASP.NET fundamental 的部份用了许多的 function delegate , task, denepdency injection 的编写方法，所以要看 source code 之前，建议先对这三个东西先行了解，这样对理解 ASP.NET Core源码很有帮助．</p>\n<p>在前面的代码中，我们看到 RequestDelegate,  顾名思义就知道这是一个delegate（委托），它是用来代表 middleware 的 delegate. 它的 source code 在 <a href=\"https://github.com/aspnet/httpabstractions/blob/master/src/Microsoft.AspNet.Http.Abstractions/RequestDelegate.cs\">RequestDelegate.cs</a></p>\n<p>IApplicationBuilder interface 是一個相当重要的接口，它定义了整個APP要用哪些服务和參數，当然也包含要使用那些 middleware，它的 souce code 在 <a href=\"https://github.com/aspnet/httpabstractions/blob/master/src/Microsoft.AspNet.Http.Abstractions/IApplicationBuilder.cs\">IApplicationBuilder.cs</a>。</p>\n<p>其中你可以看到 Use()，通过 Use() 的实例就可以把 middleware delegate 注册到 host engine 上。</p>\n<p>另外一个就是 UseMiddlewareExtensions ，前面的代码曾用了 builder.UseMiddleware<SampleMiddleware>(); 它会检查你写的 middleware 是不是合法的，比如有沒有 Invoke()，是不是只有一个Invoke()，Invoke() 的参数有沒有一个是 HttpContext type，所有的检查都通过之后便建立出该middleware instance 的 delegate。</p>\n<p>因此，当你的 ASP.NET Core APP刚启动的时候，在 Startup.cs 的 Configure() 就会把所有的 middleware delegate 建立起來，然后依序地放到內部的 stack 结构中。以上面的范例来说， stack 结构第一个元素是 StaticFiles,  然后是 SampleMiddleware 最后是 Mvc。接着每個 middleware 要被建立时是做 stack pop 的操作，所以 Mvc 的 _next 是 engine 里一些內部的 middleware 处理器，然後 pop 出 SampleMiddleware 时，就把 SampleMiddleware 的 _next 指向前面一個 pop 出來的 Mvc。依照着这样的逻辑一直到最前面的 middleware。所以在 host engine 在 Build() 之前这些动作都会完成，然后 host engine 才能执行Run()。有关 host engine 可參考<br><a href=\"https://github.com/aspnet/hosting/blob/master/src/Microsoft.AspNet.Hosting/WebHostBuilder.cs\">WebHostBuilder.cs</a></p>\n<p>全文完。</p>\n<p>本文整理于<a href=\"https://dotblogs.com.tw/aspnetshare/2016/03/20/201603191\">https://dotblogs.com.tw/aspnetshare/2016/03/20/201603191</a>并已征得作者同意。<br>感谢Bruce的分享。</p>\n"},{"layout":"post","title":"CodeSmith for MySQL template","date":"2016-03-27T16:00:00.000Z","_content":"\n\n对于.NET平台上的代码生成器来说，codesmith是一个非常好的选择。\n\n<br> \n以前在学院实验室用的都是SQL server数据库，老师给的一套codesmith模板用来生成model/DAL/BLL很是方便。\n<br> \n不过后来放弃SQL server 投入MySQL之后，刚开始都是手写SQL，还是很痛苦的。\n<br> \n再后来又去找MySQL codesmith模板,这个对应的资料就不多了。不过最后还是找到了一套不错的，凑合能用。起初也懒，codesmith语法不熟，就没想过去修改一下了。\n<br> 最近又要用到这套东西，于是决定还是去修改一番，更便于使用。\n\n这个文章就主要讲一下修改过程，顺便说一下codesmith的简单语法。\n\n\n先说一下操作步骤：\n\n把模板的文件夹扔到codesmith模板文件的路径下，接着打开Codesmith，找到刚扔过去的文件夹，选择Main.cst,右键-execute-选择对应的MySQL库-选中表。\n<br>（注：codesmith连接MySQL有问题的话，\n<br>移步这里解决 [CodeSmith 连接MySQL数据库报“can't find .net framework data provider”](http://codelover.link/2016/02/25/CodeSmith%E8%BF%9E%E6%8E%A5MySQL%E6%8A%A5%E9%94%99%E2%80%9C%E6%89%BE%E4%B8%8D%E5%88%B0%E8%AF%B7%E6%B1%82%E7%9A%84%20.Net%20Framework%20Data%20Provider%E3%80%82%E5%8F%AF%E8%83%BD%E6%B2%A1%E6%9C%89%E5%AE%89%E8%A3%85%E3%80%82%E2%80%9D%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/)\n\n如下图：\n![1](http://7xrayk.com1.z0.glb.clouddn.com/20160228-1.png)\n\n\n\n然后点击Generate就能顺利生成model/dal/bll了。\n\n\n生成代码结构如下：\n![2](http://7xrayk.com1.z0.glb.clouddn.com/20160228-2.png)\n\n\n\n<p>这样操作没什么问题，顺利生成了我们要的model/dal/bll了，然后....我懒嘛。\n每次都要把表一个个选一次，麻不麻烦啊。然后就想了，能不能改一下模板呢。于是便开始google相关资料了。找到了几个相关文章，参考这就开始改造了。\n先看看原来的Main.cst里面写了撒。\n\n```csharp\n<%@ CodeTemplate Language=\"C#\" ResponseEncoding=\"UTF-8\" \nTargetLanguage=\"Text\" Src=\"\" Inherits=\"\" Debug=\"False\" \nDescription=\"Template description here.\" \n Output=\"None\"%>\n<%@ Register Name=\"Models\" Template=\"DBMad.Models.cst\" \n\tMergeProperties=\"False\" ExcludeProperties=\"\" %>\t\n<%@ Register Name=\"DAL\" Template=\"DBMad.DAL.cst\" \nMergeProperties=\"False\" ExcludeProperties=\"\" %> \n<%@ Register Name=\"BLL\" Template=\"DBMad.BLL.cst\" \nMergeProperties=\"False\" ExcludeProperties=\"\" %>\n\n<%@ Property Name=\"SourceTable\" \nType=\"SchemaExplorer.TableSchema\" Optional=\"False\"%>\n<%@ Property Name=\"RootNamespace\" Default=\"Net.Itcast.CN\" \nType=\"System.String\" Optional=\"False\"%>\n\n<%@ Assembly Name=\"SchemaExplorer\" %>\n<%@ Assembly Name=\"System.Data\" %>\n<%@ Import Namespace=\"SchemaExplorer\" %>\n<%@ Import Namespace=\"System.Data\" %>\n<script runat=\"template\">\n\tprivate string _outputDirectory = String.Empty;\n\t[Editor(typeof(System.Windows.Forms.Design.FolderNameEditor), \n\ttypeof(System.Drawing.Design.UITypeEditor))] \n\t[Description(\"The directory to output the results to.\")]\n\tpublic string OutputDirectory \n\t{\n\t\tget\n\t\t{\t\t\n\t\t\treturn _outputDirectory;\n\t\t}\n\t\tset\n\t\t{\n\t\t\tif (value != null && !value.EndsWith(\"\\\\\"))\n\t\t\t{\n\t\t\t\tvalue += \"\\\\\";\n\t\t    }\n\t\t\t_outputDirectory = value;\n\t\t} \n\t}\n</script>\n```\n\n\n这一段基本就是在声明选项以及引用命名空间，表现出来的便是我们看到的下图：\n\n![1](http://7xrayk.com1.z0.glb.clouddn.com/20160228-1.png)\n\n\n```csharp\n\n<%\n    Models model = this.Create<Models>();\n\tmodel.ModelsNamespace = this.RootNamespace+\".Model\";\n\tmodel.TargetTable = this.SourceTable;\n\tmodel.RenderToFile(this.OutputDirectory+\"Model/\"+model.GetFileName(),true);\n\t\n\n   DAL dal = this.Create<DAL>();\n   dal.TargetTable = this.SourceTable;\n   dal.ModelsNamespace = model.ModelsNamespace;\n   dal.DALClassNameSurfix = \"DAL\";\n   dal.DALNamespace =this.RootNamespace+\".DAL\";\n   dal.RenderToFile(this.OutputDirectory+\"DAL/\"\n   +dal.GetFileName(),true);\n\n   BLL bll = this.Create<BLL>();\n   bll.ModelsNamespace = model.ModelsNamespace;\n   bll.DALClassNameSurfix = dal.DALClassNameSurfix;\n   bll.DALNamespace = dal.DALNamespace;\n   bll.BLLClassNameSurfix = \"BLL\";\n   bll.BLLNamespace = this.RootNamespace+\".BLL\";\n   bll.TargetTable = this.SourceTable;\n   bll.RenderToFile(this.OutputDirectory+\"BLL/\"\n   +bll.GetFileName(),true);\n\n   Response.Write(\"ok,see \"+this.OutputDirectory);\n%>\n```\n\n这一段就是我们点击Generate之后执行的代码，基本功能就是调用\nDBMad.Models.cst,DBMad.DAL.cst,DBMad.BLL.cst。\n因为在上面声明数据源的时候，使用了SchemaExplorer.TableSchema，导致我们选择表的时候不能多选。代码如下：\n\n<%@ Property Name=\"SourceTable\" Type=\"SchemaExplorer.TableSchema\" Optional=\"False\"%>\n\n这样一想，这个Main.cst就是一个可以处理单表的生成模板了，我们只要自己写一个可以多选表的模板，然后循环调用这个模板去生成，不就完事了？\n\n找了一下资料，发现只需要把上面的选项Type改一下，便可以多选表了。\n\n如下：\n\n<%@ Property Name=\"SourceTables\" Type=\"SchemaExplorer.TableSchemaCollection\" Default=\"\" Optional=\"False\" Category=\"\"%> \n\n\n整体代码如下：\n\n```csharp\n<%@ CodeTemplate Language=\"C#\" ResponseEncoding=\"UTF-8\" \nTargetLanguage=\"Text\" Src=\"\" Inherits=\"\" Debug=\"False\" \nDescription=\"Template description here.\" Output=\"None\"%>\n<%@ Property Name=\"SourceTables\" \nType=\"SchemaExplorer.TableSchemaCollection\" Default=\"\" \nOptional=\"False\" Category=\"\"%> \n<%@ Register Name=\"SE\" Template=\"CreatSingleTable.cst\" \nMergeProperties=\"False\" ExcludeProperties=\"\" %> \n<%@ Property Name=\"RootNamespace\" Default=\"Net.Itcast.CN\" \nType=\"System.String\" Optional=\"False\"%>\n<%@ Assembly Name=\"SchemaExplorer\" %> \n<%@ Assembly Name=\"System.Data\" %>\n<%@ Import Namespace=\"SchemaExplorer\" %> \n<%@ Import Namespace=\"System.Data\" %> \n<%@ Import Namespace=\"System.Collections\" %> \n<script runat=\"template\">\n\tprivate string _outputDirectory = String.Empty;\n\t[Editor(typeof(System.Windows.Forms.Design.FolderNameEditor), \n\ttypeof(System.Drawing.Design.UITypeEditor))] \n\t[Description(\"The directory to output the results to.\")]\n\tpublic string OutputDirectory \n\t{\n\t\tget\n\t\t{\t\t\n\t\t\treturn _outputDirectory;\n\t\t}\n\t\tset\n\t\t{\n\t\t\tif (value != null && !value.EndsWith(\"\\\\\"))\n\t\t\t{\n\t\t\t\tvalue += \"\\\\\";\n\t\t    }\n\t\t\t_outputDirectory = value;\n\t\t} \n\t}\n</script>\n\n<% \nforeach(TableSchema ts in SourceTables) \n{ \nSE s = new SE(); \n   s.SourceTable = ts; \n   s.RootNamespace = RootNamespace;\n   s.OutputDirectory = OutputDirectory;\n   s.Render(this.Response); \n} \n%> \n<script runat=\"template\"> \n</script> \n\n```\n\n前面一部分还是一样的声明，\n\n<%@ Property Name=\"SourceTables\" Type=\"SchemaExplorer.TableSchemaCollection\" Default=\"\" Optional=\"False\" Category=\"\"%> \n\n这一句把选项类型修改成可多选的（既 集合）。\n效果如下图：\n![3](http://7xrayk.com1.z0.glb.clouddn.com/20160228-4.png)\n\n\n\n```csharp\n<% \nforeach(TableSchema ts in SourceTables) \n{ \nSE s = new SE(); \n   s.SourceTable = ts; \n   s.RootNamespace = RootNamespace;\n   s.OutputDirectory = OutputDirectory;\n   s.Render(this.Response); \n} \n%> \n<script runat=\"template\"> \n</script> \n\n```\n\n\n这一段代码便是获取刚得到的表集合，遍历集合然后依次调用之前的单表生成模板。\n\n\n到这里差不多已经完成了我要的效果，选择多表，实现一次生成所有的表对应的model/dal/bll。\n\n\n这个效果基本就是我要的了，但是后来又发现，model里面的字段居然没有注释，我在建表的时候写了字段注释的呀。\n\n打开model的cst文件之后发现，模板并没有做注释这个工作。\n代码如下：\n\n```csharp\n<%@ CodeTemplate Language=\"C#\" TargetLanguage=\"C#\" \nSrc=\"ToolsCodeTemplate.cs\" Inherits=\"ToolsCodeTemplate\"%>\n<%@ Property Name=\"TargetTable\" Type=\"SchemaExplorer.TableSchema\" \nCategory=\"Context\" Description=\"TargetTable that the object is \nbased on.\" %>\n<%@ Property Name=\"ModelsNamespace\" Default=\"Model\" \nType=\"System.String\" Category=\"Context\" Description=\"TargetTable \nthat the object is based on.\" %>\n<%@ Assembly Name=\"SchemaExplorer\" %>\n<%@ Assembly Name=\"System.Data\" %>\n<%@ Import Namespace=\"SchemaExplorer\" %>\n<%@ Import Namespace=\"System.Data\" %>\n<% PrintHeader(); %>\nusing System;\nusing System.Collections.Generic;\nusing System.Text;\n\nnamespace <%= ModelsNamespace %>\n{\t\n\t[Serializable()]\n\tpublic class <%= GetModelClassName() %>\n\t{\n\t    <% \n\t\tforeach (ColumnSchema column in TargetTable.Columns)\n\t   {\n\t\t%>\n\t\t\tprivate <%= GetPropertyType(column) %>  _<%= \n\t\t\tGetPropertyName(column) %>;\t\t\t\n\t\t<%\n\t\t}\n\t\t%>\n\t    \n\t\t<% \n\t\tforeach (ColumnSchema column in TargetTable.Columns)\n\t\t{\n\t\t%>\n\t\t\tpublic <%= GetPropertyType(column) %> <%= \n\t\t\tGetPropertyName(column) %>\n\t\t\t{\n\t\t\t\t get { return _<%= GetPropertyName(column) %>; }\n\t             set { _<%= GetPropertyName(column) %> = value; }\n\t\t\t}\n\t\t<%\n\t\t}\n\t\t%>\t\n\t}\n}\n<script runat=\"template\">\npublic string GetModelClassName()\n{\n\treturn GetModelClassName(TargetTable);\n}\n\npublic override string GetFileName()\n{\n\treturn this.GetModelClassName(this.TargetTable) + \".cs\";\n}\n\n</script>\n```\n\n获取表中字段名使用的是GetPropertyName(column)，咦，在哪实现了这个东西呢？回去翻一下文件，哦，还有一个ToolsCodeTemplate.cs文一直没管呢。\n\n果然，GetPropertyName(column)在这里。\n\n```csharp\npublic string GetPropertyName(ColumnSchema column)\n{\n   return GetNameFromDBFieldName(column);\n}\npublic string GetNameFromDBFieldName(ColumnSchema column)\n{\n\treturn column.Name;\n}\n\n```\n读取列名就是这么简单，那么我们对应写一个函数读取一下列注释，然后再model里面调用一下不好了。\n\n又查了一下资料，\n\n```csharp\n    public string GetColumnComment(ColumnSchema column)\n    {\n         return column.Description;\n    }\n\n```\n嗯，理论上这样是可以的...\n然而，我想多了。倒腾了好久，这个属性值都是空的...\ngoogle了一圈之后发现，原来是SchemaExplorer.MySQLSchemaProvider.dll 里面压根没实现读取列注释的实现....\n\n\n不过也有对应的解决方法：\n\n[完美解决CodeSmith无法获取MySQL表及列Description说明注释的方案](http://www.cnblogs.com/LonelyShadow/p/4147743.html)\n\n把DLL替换一下就好了。\n\n最后附上模板连接:[CodeSmith-for-MySQL-Template](https://github.com/liguobao/CodeSmith-for-MySQL-Template)\n\n\n\n注：\n\n1. 模板会把MySQL的表名前三个字符截取掉，建议把表明设置为tbl开头，或者自行修改模板文件。\n2. 想让字段注释生效记得替换SchemaExplorer.MySQLSchemaProvider.dll(替换前记得备份！)\n\n","source":"_posts/CodeSmith to MySQL.md","raw":"---\nlayout: post\ntitle: CodeSmith for MySQL template\ncategory: CodeSmith\ndate: 2016-03-28 00:00:00\n---\n\n\n对于.NET平台上的代码生成器来说，codesmith是一个非常好的选择。\n\n<br> \n以前在学院实验室用的都是SQL server数据库，老师给的一套codesmith模板用来生成model/DAL/BLL很是方便。\n<br> \n不过后来放弃SQL server 投入MySQL之后，刚开始都是手写SQL，还是很痛苦的。\n<br> \n再后来又去找MySQL codesmith模板,这个对应的资料就不多了。不过最后还是找到了一套不错的，凑合能用。起初也懒，codesmith语法不熟，就没想过去修改一下了。\n<br> 最近又要用到这套东西，于是决定还是去修改一番，更便于使用。\n\n这个文章就主要讲一下修改过程，顺便说一下codesmith的简单语法。\n\n\n先说一下操作步骤：\n\n把模板的文件夹扔到codesmith模板文件的路径下，接着打开Codesmith，找到刚扔过去的文件夹，选择Main.cst,右键-execute-选择对应的MySQL库-选中表。\n<br>（注：codesmith连接MySQL有问题的话，\n<br>移步这里解决 [CodeSmith 连接MySQL数据库报“can't find .net framework data provider”](http://codelover.link/2016/02/25/CodeSmith%E8%BF%9E%E6%8E%A5MySQL%E6%8A%A5%E9%94%99%E2%80%9C%E6%89%BE%E4%B8%8D%E5%88%B0%E8%AF%B7%E6%B1%82%E7%9A%84%20.Net%20Framework%20Data%20Provider%E3%80%82%E5%8F%AF%E8%83%BD%E6%B2%A1%E6%9C%89%E5%AE%89%E8%A3%85%E3%80%82%E2%80%9D%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/)\n\n如下图：\n![1](http://7xrayk.com1.z0.glb.clouddn.com/20160228-1.png)\n\n\n\n然后点击Generate就能顺利生成model/dal/bll了。\n\n\n生成代码结构如下：\n![2](http://7xrayk.com1.z0.glb.clouddn.com/20160228-2.png)\n\n\n\n<p>这样操作没什么问题，顺利生成了我们要的model/dal/bll了，然后....我懒嘛。\n每次都要把表一个个选一次，麻不麻烦啊。然后就想了，能不能改一下模板呢。于是便开始google相关资料了。找到了几个相关文章，参考这就开始改造了。\n先看看原来的Main.cst里面写了撒。\n\n```csharp\n<%@ CodeTemplate Language=\"C#\" ResponseEncoding=\"UTF-8\" \nTargetLanguage=\"Text\" Src=\"\" Inherits=\"\" Debug=\"False\" \nDescription=\"Template description here.\" \n Output=\"None\"%>\n<%@ Register Name=\"Models\" Template=\"DBMad.Models.cst\" \n\tMergeProperties=\"False\" ExcludeProperties=\"\" %>\t\n<%@ Register Name=\"DAL\" Template=\"DBMad.DAL.cst\" \nMergeProperties=\"False\" ExcludeProperties=\"\" %> \n<%@ Register Name=\"BLL\" Template=\"DBMad.BLL.cst\" \nMergeProperties=\"False\" ExcludeProperties=\"\" %>\n\n<%@ Property Name=\"SourceTable\" \nType=\"SchemaExplorer.TableSchema\" Optional=\"False\"%>\n<%@ Property Name=\"RootNamespace\" Default=\"Net.Itcast.CN\" \nType=\"System.String\" Optional=\"False\"%>\n\n<%@ Assembly Name=\"SchemaExplorer\" %>\n<%@ Assembly Name=\"System.Data\" %>\n<%@ Import Namespace=\"SchemaExplorer\" %>\n<%@ Import Namespace=\"System.Data\" %>\n<script runat=\"template\">\n\tprivate string _outputDirectory = String.Empty;\n\t[Editor(typeof(System.Windows.Forms.Design.FolderNameEditor), \n\ttypeof(System.Drawing.Design.UITypeEditor))] \n\t[Description(\"The directory to output the results to.\")]\n\tpublic string OutputDirectory \n\t{\n\t\tget\n\t\t{\t\t\n\t\t\treturn _outputDirectory;\n\t\t}\n\t\tset\n\t\t{\n\t\t\tif (value != null && !value.EndsWith(\"\\\\\"))\n\t\t\t{\n\t\t\t\tvalue += \"\\\\\";\n\t\t    }\n\t\t\t_outputDirectory = value;\n\t\t} \n\t}\n</script>\n```\n\n\n这一段基本就是在声明选项以及引用命名空间，表现出来的便是我们看到的下图：\n\n![1](http://7xrayk.com1.z0.glb.clouddn.com/20160228-1.png)\n\n\n```csharp\n\n<%\n    Models model = this.Create<Models>();\n\tmodel.ModelsNamespace = this.RootNamespace+\".Model\";\n\tmodel.TargetTable = this.SourceTable;\n\tmodel.RenderToFile(this.OutputDirectory+\"Model/\"+model.GetFileName(),true);\n\t\n\n   DAL dal = this.Create<DAL>();\n   dal.TargetTable = this.SourceTable;\n   dal.ModelsNamespace = model.ModelsNamespace;\n   dal.DALClassNameSurfix = \"DAL\";\n   dal.DALNamespace =this.RootNamespace+\".DAL\";\n   dal.RenderToFile(this.OutputDirectory+\"DAL/\"\n   +dal.GetFileName(),true);\n\n   BLL bll = this.Create<BLL>();\n   bll.ModelsNamespace = model.ModelsNamespace;\n   bll.DALClassNameSurfix = dal.DALClassNameSurfix;\n   bll.DALNamespace = dal.DALNamespace;\n   bll.BLLClassNameSurfix = \"BLL\";\n   bll.BLLNamespace = this.RootNamespace+\".BLL\";\n   bll.TargetTable = this.SourceTable;\n   bll.RenderToFile(this.OutputDirectory+\"BLL/\"\n   +bll.GetFileName(),true);\n\n   Response.Write(\"ok,see \"+this.OutputDirectory);\n%>\n```\n\n这一段就是我们点击Generate之后执行的代码，基本功能就是调用\nDBMad.Models.cst,DBMad.DAL.cst,DBMad.BLL.cst。\n因为在上面声明数据源的时候，使用了SchemaExplorer.TableSchema，导致我们选择表的时候不能多选。代码如下：\n\n<%@ Property Name=\"SourceTable\" Type=\"SchemaExplorer.TableSchema\" Optional=\"False\"%>\n\n这样一想，这个Main.cst就是一个可以处理单表的生成模板了，我们只要自己写一个可以多选表的模板，然后循环调用这个模板去生成，不就完事了？\n\n找了一下资料，发现只需要把上面的选项Type改一下，便可以多选表了。\n\n如下：\n\n<%@ Property Name=\"SourceTables\" Type=\"SchemaExplorer.TableSchemaCollection\" Default=\"\" Optional=\"False\" Category=\"\"%> \n\n\n整体代码如下：\n\n```csharp\n<%@ CodeTemplate Language=\"C#\" ResponseEncoding=\"UTF-8\" \nTargetLanguage=\"Text\" Src=\"\" Inherits=\"\" Debug=\"False\" \nDescription=\"Template description here.\" Output=\"None\"%>\n<%@ Property Name=\"SourceTables\" \nType=\"SchemaExplorer.TableSchemaCollection\" Default=\"\" \nOptional=\"False\" Category=\"\"%> \n<%@ Register Name=\"SE\" Template=\"CreatSingleTable.cst\" \nMergeProperties=\"False\" ExcludeProperties=\"\" %> \n<%@ Property Name=\"RootNamespace\" Default=\"Net.Itcast.CN\" \nType=\"System.String\" Optional=\"False\"%>\n<%@ Assembly Name=\"SchemaExplorer\" %> \n<%@ Assembly Name=\"System.Data\" %>\n<%@ Import Namespace=\"SchemaExplorer\" %> \n<%@ Import Namespace=\"System.Data\" %> \n<%@ Import Namespace=\"System.Collections\" %> \n<script runat=\"template\">\n\tprivate string _outputDirectory = String.Empty;\n\t[Editor(typeof(System.Windows.Forms.Design.FolderNameEditor), \n\ttypeof(System.Drawing.Design.UITypeEditor))] \n\t[Description(\"The directory to output the results to.\")]\n\tpublic string OutputDirectory \n\t{\n\t\tget\n\t\t{\t\t\n\t\t\treturn _outputDirectory;\n\t\t}\n\t\tset\n\t\t{\n\t\t\tif (value != null && !value.EndsWith(\"\\\\\"))\n\t\t\t{\n\t\t\t\tvalue += \"\\\\\";\n\t\t    }\n\t\t\t_outputDirectory = value;\n\t\t} \n\t}\n</script>\n\n<% \nforeach(TableSchema ts in SourceTables) \n{ \nSE s = new SE(); \n   s.SourceTable = ts; \n   s.RootNamespace = RootNamespace;\n   s.OutputDirectory = OutputDirectory;\n   s.Render(this.Response); \n} \n%> \n<script runat=\"template\"> \n</script> \n\n```\n\n前面一部分还是一样的声明，\n\n<%@ Property Name=\"SourceTables\" Type=\"SchemaExplorer.TableSchemaCollection\" Default=\"\" Optional=\"False\" Category=\"\"%> \n\n这一句把选项类型修改成可多选的（既 集合）。\n效果如下图：\n![3](http://7xrayk.com1.z0.glb.clouddn.com/20160228-4.png)\n\n\n\n```csharp\n<% \nforeach(TableSchema ts in SourceTables) \n{ \nSE s = new SE(); \n   s.SourceTable = ts; \n   s.RootNamespace = RootNamespace;\n   s.OutputDirectory = OutputDirectory;\n   s.Render(this.Response); \n} \n%> \n<script runat=\"template\"> \n</script> \n\n```\n\n\n这一段代码便是获取刚得到的表集合，遍历集合然后依次调用之前的单表生成模板。\n\n\n到这里差不多已经完成了我要的效果，选择多表，实现一次生成所有的表对应的model/dal/bll。\n\n\n这个效果基本就是我要的了，但是后来又发现，model里面的字段居然没有注释，我在建表的时候写了字段注释的呀。\n\n打开model的cst文件之后发现，模板并没有做注释这个工作。\n代码如下：\n\n```csharp\n<%@ CodeTemplate Language=\"C#\" TargetLanguage=\"C#\" \nSrc=\"ToolsCodeTemplate.cs\" Inherits=\"ToolsCodeTemplate\"%>\n<%@ Property Name=\"TargetTable\" Type=\"SchemaExplorer.TableSchema\" \nCategory=\"Context\" Description=\"TargetTable that the object is \nbased on.\" %>\n<%@ Property Name=\"ModelsNamespace\" Default=\"Model\" \nType=\"System.String\" Category=\"Context\" Description=\"TargetTable \nthat the object is based on.\" %>\n<%@ Assembly Name=\"SchemaExplorer\" %>\n<%@ Assembly Name=\"System.Data\" %>\n<%@ Import Namespace=\"SchemaExplorer\" %>\n<%@ Import Namespace=\"System.Data\" %>\n<% PrintHeader(); %>\nusing System;\nusing System.Collections.Generic;\nusing System.Text;\n\nnamespace <%= ModelsNamespace %>\n{\t\n\t[Serializable()]\n\tpublic class <%= GetModelClassName() %>\n\t{\n\t    <% \n\t\tforeach (ColumnSchema column in TargetTable.Columns)\n\t   {\n\t\t%>\n\t\t\tprivate <%= GetPropertyType(column) %>  _<%= \n\t\t\tGetPropertyName(column) %>;\t\t\t\n\t\t<%\n\t\t}\n\t\t%>\n\t    \n\t\t<% \n\t\tforeach (ColumnSchema column in TargetTable.Columns)\n\t\t{\n\t\t%>\n\t\t\tpublic <%= GetPropertyType(column) %> <%= \n\t\t\tGetPropertyName(column) %>\n\t\t\t{\n\t\t\t\t get { return _<%= GetPropertyName(column) %>; }\n\t             set { _<%= GetPropertyName(column) %> = value; }\n\t\t\t}\n\t\t<%\n\t\t}\n\t\t%>\t\n\t}\n}\n<script runat=\"template\">\npublic string GetModelClassName()\n{\n\treturn GetModelClassName(TargetTable);\n}\n\npublic override string GetFileName()\n{\n\treturn this.GetModelClassName(this.TargetTable) + \".cs\";\n}\n\n</script>\n```\n\n获取表中字段名使用的是GetPropertyName(column)，咦，在哪实现了这个东西呢？回去翻一下文件，哦，还有一个ToolsCodeTemplate.cs文一直没管呢。\n\n果然，GetPropertyName(column)在这里。\n\n```csharp\npublic string GetPropertyName(ColumnSchema column)\n{\n   return GetNameFromDBFieldName(column);\n}\npublic string GetNameFromDBFieldName(ColumnSchema column)\n{\n\treturn column.Name;\n}\n\n```\n读取列名就是这么简单，那么我们对应写一个函数读取一下列注释，然后再model里面调用一下不好了。\n\n又查了一下资料，\n\n```csharp\n    public string GetColumnComment(ColumnSchema column)\n    {\n         return column.Description;\n    }\n\n```\n嗯，理论上这样是可以的...\n然而，我想多了。倒腾了好久，这个属性值都是空的...\ngoogle了一圈之后发现，原来是SchemaExplorer.MySQLSchemaProvider.dll 里面压根没实现读取列注释的实现....\n\n\n不过也有对应的解决方法：\n\n[完美解决CodeSmith无法获取MySQL表及列Description说明注释的方案](http://www.cnblogs.com/LonelyShadow/p/4147743.html)\n\n把DLL替换一下就好了。\n\n最后附上模板连接:[CodeSmith-for-MySQL-Template](https://github.com/liguobao/CodeSmith-for-MySQL-Template)\n\n\n\n注：\n\n1. 模板会把MySQL的表名前三个字符截取掉，建议把表明设置为tbl开头，或者自行修改模板文件。\n2. 想让字段注释生效记得替换SchemaExplorer.MySQLSchemaProvider.dll(替换前记得备份！)\n\n","slug":"CodeSmith to MySQL","published":1,"updated":"2016-09-15T05:11:13.649Z","comments":1,"photos":[],"link":"","_id":"cit3xw9sf0005c0txn429l3ms","content":"<p>对于.NET平台上的代码生成器来说，codesmith是一个非常好的选择。</p>\n<p><br><br>以前在学院实验室用的都是SQL server数据库，老师给的一套codesmith模板用来生成model/DAL/BLL很是方便。<br><br><br>不过后来放弃SQL server 投入MySQL之后，刚开始都是手写SQL，还是很痛苦的。<br><br><br>再后来又去找MySQL codesmith模板,这个对应的资料就不多了。不过最后还是找到了一套不错的，凑合能用。起初也懒，codesmith语法不熟，就没想过去修改一下了。<br><br> 最近又要用到这套东西，于是决定还是去修改一番，更便于使用。</p>\n<p>这个文章就主要讲一下修改过程，顺便说一下codesmith的简单语法。</p>\n<p>先说一下操作步骤：</p>\n<p>把模板的文件夹扔到codesmith模板文件的路径下，接着打开Codesmith，找到刚扔过去的文件夹，选择Main.cst,右键-execute-选择对应的MySQL库-选中表。<br><br>（注：codesmith连接MySQL有问题的话，<br><br>移步这里解决 <a href=\"http://codelover.link/2016/02/25/CodeSmith%E8%BF%9E%E6%8E%A5MySQL%E6%8A%A5%E9%94%99%E2%80%9C%E6%89%BE%E4%B8%8D%E5%88%B0%E8%AF%B7%E6%B1%82%E7%9A%84%20.Net%20Framework%20Data%20Provider%E3%80%82%E5%8F%AF%E8%83%BD%E6%B2%A1%E6%9C%89%E5%AE%89%E8%A3%85%E3%80%82%E2%80%9D%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/\">CodeSmith 连接MySQL数据库报“can’t find .net framework data provider”</a></p>\n<p>如下图：<br><img src=\"http://7xrayk.com1.z0.glb.clouddn.com/20160228-1.png\" alt=\"1\"></p>\n<p>然后点击Generate就能顺利生成model/dal/bll了。</p>\n<p>生成代码结构如下：<br><img src=\"http://7xrayk.com1.z0.glb.clouddn.com/20160228-2.png\" alt=\"2\"></p>\n<p></p><p>这样操作没什么问题，顺利生成了我们要的model/dal/bll了，然后….我懒嘛。<br>每次都要把表一个个选一次，麻不麻烦啊。然后就想了，能不能改一下模板呢。于是便开始google相关资料了。找到了几个相关文章，参考这就开始改造了。<br>先看看原来的Main.cst里面写了撒。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;%@ CodeTemplate Language=<span class=\"string\">\"C#\"</span> ResponseEncoding=<span class=\"string\">\"UTF-8\"</span> </div><div class=\"line\">TargetLanguage=<span class=\"string\">\"Text\"</span> Src=<span class=\"string\">\"\"</span> Inherits=<span class=\"string\">\"\"</span> Debug=<span class=\"string\">\"False\"</span> </div><div class=\"line\">Description=<span class=\"string\">\"Template description here.\"</span> </div><div class=\"line\"> Output=<span class=\"string\">\"None\"</span>%&gt;</div><div class=\"line\">&lt;%@ Register Name=<span class=\"string\">\"Models\"</span> Template=<span class=\"string\">\"DBMad.Models.cst\"</span> </div><div class=\"line\">\tMergeProperties=<span class=\"string\">\"False\"</span> ExcludeProperties=<span class=\"string\">\"\"</span> %&gt;\t</div><div class=\"line\">&lt;%@ Register Name=<span class=\"string\">\"DAL\"</span> Template=<span class=\"string\">\"DBMad.DAL.cst\"</span> </div><div class=\"line\">MergeProperties=<span class=\"string\">\"False\"</span> ExcludeProperties=<span class=\"string\">\"\"</span> %&gt; </div><div class=\"line\">&lt;%@ Register Name=<span class=\"string\">\"BLL\"</span> Template=<span class=\"string\">\"DBMad.BLL.cst\"</span> </div><div class=\"line\">MergeProperties=<span class=\"string\">\"False\"</span> ExcludeProperties=<span class=\"string\">\"\"</span> %&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;%@ Property Name=<span class=\"string\">\"SourceTable\"</span> </div><div class=\"line\">Type=<span class=\"string\">\"SchemaExplorer.TableSchema\"</span> Optional=<span class=\"string\">\"False\"</span>%&gt;</div><div class=\"line\">&lt;%@ Property Name=<span class=\"string\">\"RootNamespace\"</span> Default=<span class=\"string\">\"Net.Itcast.CN\"</span> </div><div class=\"line\">Type=<span class=\"string\">\"System.String\"</span> Optional=<span class=\"string\">\"False\"</span>%&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;%@ Assembly Name=<span class=\"string\">\"SchemaExplorer\"</span> %&gt;</div><div class=\"line\">&lt;%@ Assembly Name=<span class=\"string\">\"System.Data\"</span> %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"SchemaExplorer\"</span> %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"System.Data\"</span> %&gt;</div><div class=\"line\">&lt;script runat=<span class=\"string\">\"template\"</span>&gt;</div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">string</span> _outputDirectory = String.Empty;</div><div class=\"line\">\t[Editor(<span class=\"keyword\">typeof</span>(System.Windows.Forms.Design.FolderNameEditor), </div><div class=\"line\">\t<span class=\"keyword\">typeof</span>(System.Drawing.Design.UITypeEditor))] </div><div class=\"line\">\t[Description(<span class=\"string\">\"The directory to output the results to.\"</span>)]</div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">string</span> OutputDirectory </div><div class=\"line\">\t&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">get</span></div><div class=\"line\">\t\t&#123;\t\t</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> _outputDirectory;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">set</span></div><div class=\"line\">\t\t&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">value</span> != <span class=\"literal\">null</span> &amp;&amp; !<span class=\"keyword\">value</span>.EndsWith(<span class=\"string\">\"\\\\\"</span>))</div><div class=\"line\">\t\t\t&#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">value</span> += <span class=\"string\">\"\\\\\"</span>;</div><div class=\"line\">\t\t    &#125;</div><div class=\"line\">\t\t\t_outputDirectory = <span class=\"keyword\">value</span>;</div><div class=\"line\">\t\t&#125; </div><div class=\"line\">\t&#125;</div><div class=\"line\">&lt;/script&gt;</div></pre></td></tr></table></figure>\n<p>这一段基本就是在声明选项以及引用命名空间，表现出来的便是我们看到的下图：</p>\n<p><img src=\"http://7xrayk.com1.z0.glb.clouddn.com/20160228-1.png\" alt=\"1\"></p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">&lt;%</div><div class=\"line\">    Models model = <span class=\"keyword\">this</span>.Create&lt;Models&gt;();</div><div class=\"line\">\tmodel.ModelsNamespace = <span class=\"keyword\">this</span>.RootNamespace+<span class=\"string\">\".Model\"</span>;</div><div class=\"line\">\tmodel.TargetTable = <span class=\"keyword\">this</span>.SourceTable;</div><div class=\"line\">\tmodel.RenderToFile(<span class=\"keyword\">this</span>.OutputDirectory+<span class=\"string\">\"Model/\"</span>+model.GetFileName(),<span class=\"literal\">true</span>);</div><div class=\"line\">\t</div><div class=\"line\"></div><div class=\"line\">   DAL dal = <span class=\"keyword\">this</span>.Create&lt;DAL&gt;();</div><div class=\"line\">   dal.TargetTable = <span class=\"keyword\">this</span>.SourceTable;</div><div class=\"line\">   dal.ModelsNamespace = model.ModelsNamespace;</div><div class=\"line\">   dal.DALClassNameSurfix = <span class=\"string\">\"DAL\"</span>;</div><div class=\"line\">   dal.DALNamespace =<span class=\"keyword\">this</span>.RootNamespace+<span class=\"string\">\".DAL\"</span>;</div><div class=\"line\">   dal.RenderToFile(<span class=\"keyword\">this</span>.OutputDirectory+<span class=\"string\">\"DAL/\"</span></div><div class=\"line\">   +dal.GetFileName(),<span class=\"literal\">true</span>);</div><div class=\"line\"></div><div class=\"line\">   BLL bll = <span class=\"keyword\">this</span>.Create&lt;BLL&gt;();</div><div class=\"line\">   bll.ModelsNamespace = model.ModelsNamespace;</div><div class=\"line\">   bll.DALClassNameSurfix = dal.DALClassNameSurfix;</div><div class=\"line\">   bll.DALNamespace = dal.DALNamespace;</div><div class=\"line\">   bll.BLLClassNameSurfix = <span class=\"string\">\"BLL\"</span>;</div><div class=\"line\">   bll.BLLNamespace = <span class=\"keyword\">this</span>.RootNamespace+<span class=\"string\">\".BLL\"</span>;</div><div class=\"line\">   bll.TargetTable = <span class=\"keyword\">this</span>.SourceTable;</div><div class=\"line\">   bll.RenderToFile(<span class=\"keyword\">this</span>.OutputDirectory+<span class=\"string\">\"BLL/\"</span></div><div class=\"line\">   +bll.GetFileName(),<span class=\"literal\">true</span>);</div><div class=\"line\"></div><div class=\"line\">   Response.Write(<span class=\"string\">\"ok,see \"</span>+<span class=\"keyword\">this</span>.OutputDirectory);</div><div class=\"line\">%&gt;</div></pre></td></tr></table></figure>\n<p>这一段就是我们点击Generate之后执行的代码，基本功能就是调用<br>DBMad.Models.cst,DBMad.DAL.cst,DBMad.BLL.cst。<br>因为在上面声明数据源的时候，使用了SchemaExplorer.TableSchema，导致我们选择表的时候不能多选。代码如下：</p>\n<p>&lt;%@ Property Name=”SourceTable” Type=”SchemaExplorer.TableSchema” Optional=”False”%&gt;</p>\n<p>这样一想，这个Main.cst就是一个可以处理单表的生成模板了，我们只要自己写一个可以多选表的模板，然后循环调用这个模板去生成，不就完事了？</p>\n<p>找了一下资料，发现只需要把上面的选项Type改一下，便可以多选表了。</p>\n<p>如下：</p>\n<p>&lt;%@ Property Name=”SourceTables” Type=”SchemaExplorer.TableSchemaCollection” Default=”” Optional=”False” Category=””%&gt; </p>\n<p>整体代码如下：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;%@ CodeTemplate Language=<span class=\"string\">\"C#\"</span> ResponseEncoding=<span class=\"string\">\"UTF-8\"</span> </div><div class=\"line\">TargetLanguage=<span class=\"string\">\"Text\"</span> Src=<span class=\"string\">\"\"</span> Inherits=<span class=\"string\">\"\"</span> Debug=<span class=\"string\">\"False\"</span> </div><div class=\"line\">Description=<span class=\"string\">\"Template description here.\"</span> Output=<span class=\"string\">\"None\"</span>%&gt;</div><div class=\"line\">&lt;%@ Property Name=<span class=\"string\">\"SourceTables\"</span> </div><div class=\"line\">Type=<span class=\"string\">\"SchemaExplorer.TableSchemaCollection\"</span> Default=<span class=\"string\">\"\"</span> </div><div class=\"line\">Optional=<span class=\"string\">\"False\"</span> Category=<span class=\"string\">\"\"</span>%&gt; </div><div class=\"line\">&lt;%@ Register Name=<span class=\"string\">\"SE\"</span> Template=<span class=\"string\">\"CreatSingleTable.cst\"</span> </div><div class=\"line\">MergeProperties=<span class=\"string\">\"False\"</span> ExcludeProperties=<span class=\"string\">\"\"</span> %&gt; </div><div class=\"line\">&lt;%@ Property Name=<span class=\"string\">\"RootNamespace\"</span> Default=<span class=\"string\">\"Net.Itcast.CN\"</span> </div><div class=\"line\">Type=<span class=\"string\">\"System.String\"</span> Optional=<span class=\"string\">\"False\"</span>%&gt;</div><div class=\"line\">&lt;%@ Assembly Name=<span class=\"string\">\"SchemaExplorer\"</span> %&gt; </div><div class=\"line\">&lt;%@ Assembly Name=<span class=\"string\">\"System.Data\"</span> %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"SchemaExplorer\"</span> %&gt; </div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"System.Data\"</span> %&gt; </div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"System.Collections\"</span> %&gt; </div><div class=\"line\">&lt;script runat=<span class=\"string\">\"template\"</span>&gt;</div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">string</span> _outputDirectory = String.Empty;</div><div class=\"line\">\t[Editor(<span class=\"keyword\">typeof</span>(System.Windows.Forms.Design.FolderNameEditor), </div><div class=\"line\">\t<span class=\"keyword\">typeof</span>(System.Drawing.Design.UITypeEditor))] </div><div class=\"line\">\t[Description(<span class=\"string\">\"The directory to output the results to.\"</span>)]</div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">string</span> OutputDirectory </div><div class=\"line\">\t&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">get</span></div><div class=\"line\">\t\t&#123;\t\t</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> _outputDirectory;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">set</span></div><div class=\"line\">\t\t&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">value</span> != <span class=\"literal\">null</span> &amp;&amp; !<span class=\"keyword\">value</span>.EndsWith(<span class=\"string\">\"\\\\\"</span>))</div><div class=\"line\">\t\t\t&#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">value</span> += <span class=\"string\">\"\\\\\"</span>;</div><div class=\"line\">\t\t    &#125;</div><div class=\"line\">\t\t\t_outputDirectory = <span class=\"keyword\">value</span>;</div><div class=\"line\">\t\t&#125; </div><div class=\"line\">\t&#125;</div><div class=\"line\">&lt;/script&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;% </div><div class=\"line\"><span class=\"keyword\">foreach</span>(TableSchema ts <span class=\"keyword\">in</span> SourceTables) </div><div class=\"line\">&#123; </div><div class=\"line\">SE s = <span class=\"keyword\">new</span> SE(); </div><div class=\"line\">   s.SourceTable = ts; </div><div class=\"line\">   s.RootNamespace = RootNamespace;</div><div class=\"line\">   s.OutputDirectory = OutputDirectory;</div><div class=\"line\">   s.Render(<span class=\"keyword\">this</span>.Response); </div><div class=\"line\">&#125; </div><div class=\"line\">%&gt; </div><div class=\"line\">&lt;script runat=<span class=\"string\">\"template\"</span>&gt; </div><div class=\"line\">&lt;/script&gt;</div></pre></td></tr></table></figure>\n<p>前面一部分还是一样的声明，</p>\n<p>&lt;%@ Property Name=”SourceTables” Type=”SchemaExplorer.TableSchemaCollection” Default=”” Optional=”False” Category=””%&gt; </p>\n<p>这一句把选项类型修改成可多选的（既 集合）。<br>效果如下图：<br><img src=\"http://7xrayk.com1.z0.glb.clouddn.com/20160228-4.png\" alt=\"3\"></p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;% </div><div class=\"line\"><span class=\"keyword\">foreach</span>(TableSchema ts <span class=\"keyword\">in</span> SourceTables) </div><div class=\"line\">&#123; </div><div class=\"line\">SE s = <span class=\"keyword\">new</span> SE(); </div><div class=\"line\">   s.SourceTable = ts; </div><div class=\"line\">   s.RootNamespace = RootNamespace;</div><div class=\"line\">   s.OutputDirectory = OutputDirectory;</div><div class=\"line\">   s.Render(<span class=\"keyword\">this</span>.Response); </div><div class=\"line\">&#125; </div><div class=\"line\">%&gt; </div><div class=\"line\">&lt;script runat=<span class=\"string\">\"template\"</span>&gt; </div><div class=\"line\">&lt;/script&gt;</div></pre></td></tr></table></figure>\n<p>这一段代码便是获取刚得到的表集合，遍历集合然后依次调用之前的单表生成模板。</p>\n<p>到这里差不多已经完成了我要的效果，选择多表，实现一次生成所有的表对应的model/dal/bll。</p>\n<p>这个效果基本就是我要的了，但是后来又发现，model里面的字段居然没有注释，我在建表的时候写了字段注释的呀。</p>\n<p>打开model的cst文件之后发现，模板并没有做注释这个工作。<br>代码如下：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;%@ CodeTemplate Language=\"C#\" TargetLanguage=\"C#\" </div><div class=\"line\">Src=\"ToolsCodeTemplate.cs\" Inherits=\"ToolsCodeTemplate\"%&gt;</div><div class=\"line\">&lt;%@ Property Name=\"TargetTable\" Type=\"SchemaExplorer.TableSchema\" </div><div class=\"line\">Category=\"Context\" Description=\"TargetTable that the object is </div><div class=\"line\">based on.\" %&gt;</div><div class=\"line\">&lt;%@ Property Name=\"ModelsNamespace\" Default=\"Model\" </div><div class=\"line\">Type=\"System.String\" Category=\"Context\" Description=\"TargetTable </div><div class=\"line\">that the object is based on.\" %&gt;</div><div class=\"line\">&lt;%@ Assembly Name=\"SchemaExplorer\" %&gt;</div><div class=\"line\">&lt;%@ Assembly Name=\"System.Data\" %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=\"SchemaExplorer\" %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=\"System.Data\" %&gt;</div><div class=\"line\">&lt;% PrintHeader(); %&gt;</div><div class=\"line\">using System;</div><div class=\"line\">using System.Collections.Generic;</div><div class=\"line\">using System.Text;</div><div class=\"line\"></div><div class=\"line\">namespace &lt;%= ModelsNamespace %&gt;</div><div class=\"line\">&#123;\t</div><div class=\"line\">\t[Serializable()]</div><div class=\"line\">\tpublic class &lt;%= GetModelClassName() %&gt;</div><div class=\"line\">\t&#123;</div><div class=\"line\">\t    &lt;% </div><div class=\"line\">\t\tforeach (ColumnSchema column in TargetTable.Columns)</div><div class=\"line\">\t   &#123;</div><div class=\"line\">\t\t%&gt;</div><div class=\"line\">\t\t\tprivate &lt;%= GetPropertyType(column) %&gt;  _&lt;%= </div><div class=\"line\">\t\t\tGetPropertyName(column) %&gt;;\t\t\t</div><div class=\"line\">\t\t&lt;%</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t%&gt;</div><div class=\"line\">\t    </div><div class=\"line\">\t\t&lt;% </div><div class=\"line\">\t\tforeach (ColumnSchema column in TargetTable.Columns)</div><div class=\"line\">\t\t&#123;</div><div class=\"line\">\t\t%&gt;</div><div class=\"line\">\t\t\tpublic &lt;%= GetPropertyType(column) %&gt; &lt;%= </div><div class=\"line\">\t\t\tGetPropertyName(column) %&gt;</div><div class=\"line\">\t\t\t&#123;</div><div class=\"line\">\t\t\t\t get &#123; return _&lt;%= GetPropertyName(column) %&gt;; &#125;</div><div class=\"line\">\t             set &#123; _&lt;%= GetPropertyName(column) %&gt; = value; &#125;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&lt;%</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t%&gt;\t</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div><div class=\"line\">&lt;script runat=\"template\"&gt;</div><div class=\"line\">public string GetModelClassName()</div><div class=\"line\">&#123;</div><div class=\"line\">\treturn GetModelClassName(TargetTable);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">public override string GetFileName()</div><div class=\"line\">&#123;</div><div class=\"line\">\treturn this.GetModelClassName(this.TargetTable) + \".cs\";</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">&lt;/script&gt;</div></pre></td></tr></table></figure>\n<p>获取表中字段名使用的是GetPropertyName(column)，咦，在哪实现了这个东西呢？回去翻一下文件，哦，还有一个ToolsCodeTemplate.cs文一直没管呢。</p>\n<p>果然，GetPropertyName(column)在这里。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">string</span> <span class=\"title\">GetPropertyName</span>(<span class=\"params\">ColumnSchema column</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">   <span class=\"keyword\">return</span> GetNameFromDBFieldName(column);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">string</span> <span class=\"title\">GetNameFromDBFieldName</span>(<span class=\"params\">ColumnSchema column</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">\t<span class=\"keyword\">return</span> column.Name;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>读取列名就是这么简单，那么我们对应写一个函数读取一下列注释，然后再model里面调用一下不好了。</p>\n<p>又查了一下资料，</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">string</span> <span class=\"title\">GetColumnComment</span>(<span class=\"params\">ColumnSchema column</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">     <span class=\"keyword\">return</span> column.Description;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>嗯，理论上这样是可以的…<br>然而，我想多了。倒腾了好久，这个属性值都是空的…<br>google了一圈之后发现，原来是SchemaExplorer.MySQLSchemaProvider.dll 里面压根没实现读取列注释的实现….</p>\n<p>不过也有对应的解决方法：</p>\n<p><a href=\"http://www.cnblogs.com/LonelyShadow/p/4147743.html\" target=\"_blank\" rel=\"external\">完美解决CodeSmith无法获取MySQL表及列Description说明注释的方案</a></p>\n<p>把DLL替换一下就好了。</p>\n<p>最后附上模板连接:<a href=\"https://github.com/liguobao/CodeSmith-for-MySQL-Template\" target=\"_blank\" rel=\"external\">CodeSmith-for-MySQL-Template</a></p>\n<p>注：</p>\n<ol>\n<li>模板会把MySQL的表名前三个字符截取掉，建议把表明设置为tbl开头，或者自行修改模板文件。</li>\n<li>想让字段注释生效记得替换SchemaExplorer.MySQLSchemaProvider.dll(替换前记得备份！)</li>\n</ol>\n","excerpt":"","more":"<p>对于.NET平台上的代码生成器来说，codesmith是一个非常好的选择。</p>\n<p><br><br>以前在学院实验室用的都是SQL server数据库，老师给的一套codesmith模板用来生成model/DAL/BLL很是方便。<br><br><br>不过后来放弃SQL server 投入MySQL之后，刚开始都是手写SQL，还是很痛苦的。<br><br><br>再后来又去找MySQL codesmith模板,这个对应的资料就不多了。不过最后还是找到了一套不错的，凑合能用。起初也懒，codesmith语法不熟，就没想过去修改一下了。<br><br> 最近又要用到这套东西，于是决定还是去修改一番，更便于使用。</p>\n<p>这个文章就主要讲一下修改过程，顺便说一下codesmith的简单语法。</p>\n<p>先说一下操作步骤：</p>\n<p>把模板的文件夹扔到codesmith模板文件的路径下，接着打开Codesmith，找到刚扔过去的文件夹，选择Main.cst,右键-execute-选择对应的MySQL库-选中表。<br><br>（注：codesmith连接MySQL有问题的话，<br><br>移步这里解决 <a href=\"http://codelover.link/2016/02/25/CodeSmith%E8%BF%9E%E6%8E%A5MySQL%E6%8A%A5%E9%94%99%E2%80%9C%E6%89%BE%E4%B8%8D%E5%88%B0%E8%AF%B7%E6%B1%82%E7%9A%84%20.Net%20Framework%20Data%20Provider%E3%80%82%E5%8F%AF%E8%83%BD%E6%B2%A1%E6%9C%89%E5%AE%89%E8%A3%85%E3%80%82%E2%80%9D%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/\">CodeSmith 连接MySQL数据库报“can’t find .net framework data provider”</a></p>\n<p>如下图：<br><img src=\"http://7xrayk.com1.z0.glb.clouddn.com/20160228-1.png\" alt=\"1\"></p>\n<p>然后点击Generate就能顺利生成model/dal/bll了。</p>\n<p>生成代码结构如下：<br><img src=\"http://7xrayk.com1.z0.glb.clouddn.com/20160228-2.png\" alt=\"2\"></p>\n<p><p>这样操作没什么问题，顺利生成了我们要的model/dal/bll了，然后….我懒嘛。<br>每次都要把表一个个选一次，麻不麻烦啊。然后就想了，能不能改一下模板呢。于是便开始google相关资料了。找到了几个相关文章，参考这就开始改造了。<br>先看看原来的Main.cst里面写了撒。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;%@ CodeTemplate Language=<span class=\"string\">\"C#\"</span> ResponseEncoding=<span class=\"string\">\"UTF-8\"</span> </div><div class=\"line\">TargetLanguage=<span class=\"string\">\"Text\"</span> Src=<span class=\"string\">\"\"</span> Inherits=<span class=\"string\">\"\"</span> Debug=<span class=\"string\">\"False\"</span> </div><div class=\"line\">Description=<span class=\"string\">\"Template description here.\"</span> </div><div class=\"line\"> Output=<span class=\"string\">\"None\"</span>%&gt;</div><div class=\"line\">&lt;%@ Register Name=<span class=\"string\">\"Models\"</span> Template=<span class=\"string\">\"DBMad.Models.cst\"</span> </div><div class=\"line\">\tMergeProperties=<span class=\"string\">\"False\"</span> ExcludeProperties=<span class=\"string\">\"\"</span> %&gt;\t</div><div class=\"line\">&lt;%@ Register Name=<span class=\"string\">\"DAL\"</span> Template=<span class=\"string\">\"DBMad.DAL.cst\"</span> </div><div class=\"line\">MergeProperties=<span class=\"string\">\"False\"</span> ExcludeProperties=<span class=\"string\">\"\"</span> %&gt; </div><div class=\"line\">&lt;%@ Register Name=<span class=\"string\">\"BLL\"</span> Template=<span class=\"string\">\"DBMad.BLL.cst\"</span> </div><div class=\"line\">MergeProperties=<span class=\"string\">\"False\"</span> ExcludeProperties=<span class=\"string\">\"\"</span> %&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;%@ Property Name=<span class=\"string\">\"SourceTable\"</span> </div><div class=\"line\">Type=<span class=\"string\">\"SchemaExplorer.TableSchema\"</span> Optional=<span class=\"string\">\"False\"</span>%&gt;</div><div class=\"line\">&lt;%@ Property Name=<span class=\"string\">\"RootNamespace\"</span> Default=<span class=\"string\">\"Net.Itcast.CN\"</span> </div><div class=\"line\">Type=<span class=\"string\">\"System.String\"</span> Optional=<span class=\"string\">\"False\"</span>%&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;%@ Assembly Name=<span class=\"string\">\"SchemaExplorer\"</span> %&gt;</div><div class=\"line\">&lt;%@ Assembly Name=<span class=\"string\">\"System.Data\"</span> %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"SchemaExplorer\"</span> %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"System.Data\"</span> %&gt;</div><div class=\"line\">&lt;script runat=<span class=\"string\">\"template\"</span>&gt;</div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">string</span> _outputDirectory = String.Empty;</div><div class=\"line\">\t[Editor(<span class=\"keyword\">typeof</span>(System.Windows.Forms.Design.FolderNameEditor), </div><div class=\"line\">\t<span class=\"keyword\">typeof</span>(System.Drawing.Design.UITypeEditor))] </div><div class=\"line\">\t[Description(<span class=\"string\">\"The directory to output the results to.\"</span>)]</div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">string</span> OutputDirectory </div><div class=\"line\">\t&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">get</span></div><div class=\"line\">\t\t&#123;\t\t</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> _outputDirectory;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">set</span></div><div class=\"line\">\t\t&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">value</span> != <span class=\"literal\">null</span> &amp;&amp; !<span class=\"keyword\">value</span>.EndsWith(<span class=\"string\">\"\\\\\"</span>))</div><div class=\"line\">\t\t\t&#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">value</span> += <span class=\"string\">\"\\\\\"</span>;</div><div class=\"line\">\t\t    &#125;</div><div class=\"line\">\t\t\t_outputDirectory = <span class=\"keyword\">value</span>;</div><div class=\"line\">\t\t&#125; </div><div class=\"line\">\t&#125;</div><div class=\"line\">&lt;/script&gt;</div></pre></td></tr></table></figure>\n<p>这一段基本就是在声明选项以及引用命名空间，表现出来的便是我们看到的下图：</p>\n<p><img src=\"http://7xrayk.com1.z0.glb.clouddn.com/20160228-1.png\" alt=\"1\"></p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">&lt;%</div><div class=\"line\">    Models model = <span class=\"keyword\">this</span>.Create&lt;Models&gt;();</div><div class=\"line\">\tmodel.ModelsNamespace = <span class=\"keyword\">this</span>.RootNamespace+<span class=\"string\">\".Model\"</span>;</div><div class=\"line\">\tmodel.TargetTable = <span class=\"keyword\">this</span>.SourceTable;</div><div class=\"line\">\tmodel.RenderToFile(<span class=\"keyword\">this</span>.OutputDirectory+<span class=\"string\">\"Model/\"</span>+model.GetFileName(),<span class=\"literal\">true</span>);</div><div class=\"line\">\t</div><div class=\"line\"></div><div class=\"line\">   DAL dal = <span class=\"keyword\">this</span>.Create&lt;DAL&gt;();</div><div class=\"line\">   dal.TargetTable = <span class=\"keyword\">this</span>.SourceTable;</div><div class=\"line\">   dal.ModelsNamespace = model.ModelsNamespace;</div><div class=\"line\">   dal.DALClassNameSurfix = <span class=\"string\">\"DAL\"</span>;</div><div class=\"line\">   dal.DALNamespace =<span class=\"keyword\">this</span>.RootNamespace+<span class=\"string\">\".DAL\"</span>;</div><div class=\"line\">   dal.RenderToFile(<span class=\"keyword\">this</span>.OutputDirectory+<span class=\"string\">\"DAL/\"</span></div><div class=\"line\">   +dal.GetFileName(),<span class=\"literal\">true</span>);</div><div class=\"line\"></div><div class=\"line\">   BLL bll = <span class=\"keyword\">this</span>.Create&lt;BLL&gt;();</div><div class=\"line\">   bll.ModelsNamespace = model.ModelsNamespace;</div><div class=\"line\">   bll.DALClassNameSurfix = dal.DALClassNameSurfix;</div><div class=\"line\">   bll.DALNamespace = dal.DALNamespace;</div><div class=\"line\">   bll.BLLClassNameSurfix = <span class=\"string\">\"BLL\"</span>;</div><div class=\"line\">   bll.BLLNamespace = <span class=\"keyword\">this</span>.RootNamespace+<span class=\"string\">\".BLL\"</span>;</div><div class=\"line\">   bll.TargetTable = <span class=\"keyword\">this</span>.SourceTable;</div><div class=\"line\">   bll.RenderToFile(<span class=\"keyword\">this</span>.OutputDirectory+<span class=\"string\">\"BLL/\"</span></div><div class=\"line\">   +bll.GetFileName(),<span class=\"literal\">true</span>);</div><div class=\"line\"></div><div class=\"line\">   Response.Write(<span class=\"string\">\"ok,see \"</span>+<span class=\"keyword\">this</span>.OutputDirectory);</div><div class=\"line\">%&gt;</div></pre></td></tr></table></figure>\n<p>这一段就是我们点击Generate之后执行的代码，基本功能就是调用<br>DBMad.Models.cst,DBMad.DAL.cst,DBMad.BLL.cst。<br>因为在上面声明数据源的时候，使用了SchemaExplorer.TableSchema，导致我们选择表的时候不能多选。代码如下：</p>\n<p>&lt;%@ Property Name=”SourceTable” Type=”SchemaExplorer.TableSchema” Optional=”False”%&gt;</p>\n<p>这样一想，这个Main.cst就是一个可以处理单表的生成模板了，我们只要自己写一个可以多选表的模板，然后循环调用这个模板去生成，不就完事了？</p>\n<p>找了一下资料，发现只需要把上面的选项Type改一下，便可以多选表了。</p>\n<p>如下：</p>\n<p>&lt;%@ Property Name=”SourceTables” Type=”SchemaExplorer.TableSchemaCollection” Default=”” Optional=”False” Category=””%&gt; </p>\n<p>整体代码如下：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;%@ CodeTemplate Language=<span class=\"string\">\"C#\"</span> ResponseEncoding=<span class=\"string\">\"UTF-8\"</span> </div><div class=\"line\">TargetLanguage=<span class=\"string\">\"Text\"</span> Src=<span class=\"string\">\"\"</span> Inherits=<span class=\"string\">\"\"</span> Debug=<span class=\"string\">\"False\"</span> </div><div class=\"line\">Description=<span class=\"string\">\"Template description here.\"</span> Output=<span class=\"string\">\"None\"</span>%&gt;</div><div class=\"line\">&lt;%@ Property Name=<span class=\"string\">\"SourceTables\"</span> </div><div class=\"line\">Type=<span class=\"string\">\"SchemaExplorer.TableSchemaCollection\"</span> Default=<span class=\"string\">\"\"</span> </div><div class=\"line\">Optional=<span class=\"string\">\"False\"</span> Category=<span class=\"string\">\"\"</span>%&gt; </div><div class=\"line\">&lt;%@ Register Name=<span class=\"string\">\"SE\"</span> Template=<span class=\"string\">\"CreatSingleTable.cst\"</span> </div><div class=\"line\">MergeProperties=<span class=\"string\">\"False\"</span> ExcludeProperties=<span class=\"string\">\"\"</span> %&gt; </div><div class=\"line\">&lt;%@ Property Name=<span class=\"string\">\"RootNamespace\"</span> Default=<span class=\"string\">\"Net.Itcast.CN\"</span> </div><div class=\"line\">Type=<span class=\"string\">\"System.String\"</span> Optional=<span class=\"string\">\"False\"</span>%&gt;</div><div class=\"line\">&lt;%@ Assembly Name=<span class=\"string\">\"SchemaExplorer\"</span> %&gt; </div><div class=\"line\">&lt;%@ Assembly Name=<span class=\"string\">\"System.Data\"</span> %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"SchemaExplorer\"</span> %&gt; </div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"System.Data\"</span> %&gt; </div><div class=\"line\">&lt;%@ Import Namespace=<span class=\"string\">\"System.Collections\"</span> %&gt; </div><div class=\"line\">&lt;script runat=<span class=\"string\">\"template\"</span>&gt;</div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">string</span> _outputDirectory = String.Empty;</div><div class=\"line\">\t[Editor(<span class=\"keyword\">typeof</span>(System.Windows.Forms.Design.FolderNameEditor), </div><div class=\"line\">\t<span class=\"keyword\">typeof</span>(System.Drawing.Design.UITypeEditor))] </div><div class=\"line\">\t[Description(<span class=\"string\">\"The directory to output the results to.\"</span>)]</div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">string</span> OutputDirectory </div><div class=\"line\">\t&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">get</span></div><div class=\"line\">\t\t&#123;\t\t</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> _outputDirectory;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">set</span></div><div class=\"line\">\t\t&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">value</span> != <span class=\"literal\">null</span> &amp;&amp; !<span class=\"keyword\">value</span>.EndsWith(<span class=\"string\">\"\\\\\"</span>))</div><div class=\"line\">\t\t\t&#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">value</span> += <span class=\"string\">\"\\\\\"</span>;</div><div class=\"line\">\t\t    &#125;</div><div class=\"line\">\t\t\t_outputDirectory = <span class=\"keyword\">value</span>;</div><div class=\"line\">\t\t&#125; </div><div class=\"line\">\t&#125;</div><div class=\"line\">&lt;/script&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;% </div><div class=\"line\"><span class=\"keyword\">foreach</span>(TableSchema ts <span class=\"keyword\">in</span> SourceTables) </div><div class=\"line\">&#123; </div><div class=\"line\">SE s = <span class=\"keyword\">new</span> SE(); </div><div class=\"line\">   s.SourceTable = ts; </div><div class=\"line\">   s.RootNamespace = RootNamespace;</div><div class=\"line\">   s.OutputDirectory = OutputDirectory;</div><div class=\"line\">   s.Render(<span class=\"keyword\">this</span>.Response); </div><div class=\"line\">&#125; </div><div class=\"line\">%&gt; </div><div class=\"line\">&lt;script runat=<span class=\"string\">\"template\"</span>&gt; </div><div class=\"line\">&lt;/script&gt;</div></pre></td></tr></table></figure>\n<p>前面一部分还是一样的声明，</p>\n<p>&lt;%@ Property Name=”SourceTables” Type=”SchemaExplorer.TableSchemaCollection” Default=”” Optional=”False” Category=””%&gt; </p>\n<p>这一句把选项类型修改成可多选的（既 集合）。<br>效果如下图：<br><img src=\"http://7xrayk.com1.z0.glb.clouddn.com/20160228-4.png\" alt=\"3\"></p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;% </div><div class=\"line\"><span class=\"keyword\">foreach</span>(TableSchema ts <span class=\"keyword\">in</span> SourceTables) </div><div class=\"line\">&#123; </div><div class=\"line\">SE s = <span class=\"keyword\">new</span> SE(); </div><div class=\"line\">   s.SourceTable = ts; </div><div class=\"line\">   s.RootNamespace = RootNamespace;</div><div class=\"line\">   s.OutputDirectory = OutputDirectory;</div><div class=\"line\">   s.Render(<span class=\"keyword\">this</span>.Response); </div><div class=\"line\">&#125; </div><div class=\"line\">%&gt; </div><div class=\"line\">&lt;script runat=<span class=\"string\">\"template\"</span>&gt; </div><div class=\"line\">&lt;/script&gt;</div></pre></td></tr></table></figure>\n<p>这一段代码便是获取刚得到的表集合，遍历集合然后依次调用之前的单表生成模板。</p>\n<p>到这里差不多已经完成了我要的效果，选择多表，实现一次生成所有的表对应的model/dal/bll。</p>\n<p>这个效果基本就是我要的了，但是后来又发现，model里面的字段居然没有注释，我在建表的时候写了字段注释的呀。</p>\n<p>打开model的cst文件之后发现，模板并没有做注释这个工作。<br>代码如下：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;%@ CodeTemplate Language=\"C#\" TargetLanguage=\"C#\" </div><div class=\"line\">Src=\"ToolsCodeTemplate.cs\" Inherits=\"ToolsCodeTemplate\"%&gt;</div><div class=\"line\">&lt;%@ Property Name=\"TargetTable\" Type=\"SchemaExplorer.TableSchema\" </div><div class=\"line\">Category=\"Context\" Description=\"TargetTable that the object is </div><div class=\"line\">based on.\" %&gt;</div><div class=\"line\">&lt;%@ Property Name=\"ModelsNamespace\" Default=\"Model\" </div><div class=\"line\">Type=\"System.String\" Category=\"Context\" Description=\"TargetTable </div><div class=\"line\">that the object is based on.\" %&gt;</div><div class=\"line\">&lt;%@ Assembly Name=\"SchemaExplorer\" %&gt;</div><div class=\"line\">&lt;%@ Assembly Name=\"System.Data\" %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=\"SchemaExplorer\" %&gt;</div><div class=\"line\">&lt;%@ Import Namespace=\"System.Data\" %&gt;</div><div class=\"line\">&lt;% PrintHeader(); %&gt;</div><div class=\"line\">using System;</div><div class=\"line\">using System.Collections.Generic;</div><div class=\"line\">using System.Text;</div><div class=\"line\"></div><div class=\"line\">namespace &lt;%= ModelsNamespace %&gt;</div><div class=\"line\">&#123;\t</div><div class=\"line\">\t[Serializable()]</div><div class=\"line\">\tpublic class &lt;%= GetModelClassName() %&gt;</div><div class=\"line\">\t&#123;</div><div class=\"line\">\t    &lt;% </div><div class=\"line\">\t\tforeach (ColumnSchema column in TargetTable.Columns)</div><div class=\"line\">\t   &#123;</div><div class=\"line\">\t\t%&gt;</div><div class=\"line\">\t\t\tprivate &lt;%= GetPropertyType(column) %&gt;  _&lt;%= </div><div class=\"line\">\t\t\tGetPropertyName(column) %&gt;;\t\t\t</div><div class=\"line\">\t\t&lt;%</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t%&gt;</div><div class=\"line\">\t    </div><div class=\"line\">\t\t&lt;% </div><div class=\"line\">\t\tforeach (ColumnSchema column in TargetTable.Columns)</div><div class=\"line\">\t\t&#123;</div><div class=\"line\">\t\t%&gt;</div><div class=\"line\">\t\t\tpublic &lt;%= GetPropertyType(column) %&gt; &lt;%= </div><div class=\"line\">\t\t\tGetPropertyName(column) %&gt;</div><div class=\"line\">\t\t\t&#123;</div><div class=\"line\">\t\t\t\t get &#123; return _&lt;%= GetPropertyName(column) %&gt;; &#125;</div><div class=\"line\">\t             set &#123; _&lt;%= GetPropertyName(column) %&gt; = value; &#125;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&lt;%</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t%&gt;\t</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div><div class=\"line\">&lt;script runat=\"template\"&gt;</div><div class=\"line\">public string GetModelClassName()</div><div class=\"line\">&#123;</div><div class=\"line\">\treturn GetModelClassName(TargetTable);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">public override string GetFileName()</div><div class=\"line\">&#123;</div><div class=\"line\">\treturn this.GetModelClassName(this.TargetTable) + \".cs\";</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">&lt;/script&gt;</div></pre></td></tr></table></figure>\n<p>获取表中字段名使用的是GetPropertyName(column)，咦，在哪实现了这个东西呢？回去翻一下文件，哦，还有一个ToolsCodeTemplate.cs文一直没管呢。</p>\n<p>果然，GetPropertyName(column)在这里。</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">string</span> <span class=\"title\">GetPropertyName</span>(<span class=\"params\">ColumnSchema column</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">   <span class=\"keyword\">return</span> GetNameFromDBFieldName(column);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">string</span> <span class=\"title\">GetNameFromDBFieldName</span>(<span class=\"params\">ColumnSchema column</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">return</span> column.Name;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>读取列名就是这么简单，那么我们对应写一个函数读取一下列注释，然后再model里面调用一下不好了。</p>\n<p>又查了一下资料，</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">string</span> <span class=\"title\">GetColumnComment</span>(<span class=\"params\">ColumnSchema column</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">     <span class=\"keyword\">return</span> column.Description;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>嗯，理论上这样是可以的…<br>然而，我想多了。倒腾了好久，这个属性值都是空的…<br>google了一圈之后发现，原来是SchemaExplorer.MySQLSchemaProvider.dll 里面压根没实现读取列注释的实现….</p>\n<p>不过也有对应的解决方法：</p>\n<p><a href=\"http://www.cnblogs.com/LonelyShadow/p/4147743.html\">完美解决CodeSmith无法获取MySQL表及列Description说明注释的方案</a></p>\n<p>把DLL替换一下就好了。</p>\n<p>最后附上模板连接:<a href=\"https://github.com/liguobao/CodeSmith-for-MySQL-Template\">CodeSmith-for-MySQL-Template</a></p>\n<p>注：</p>\n<ol>\n<li>模板会把MySQL的表名前三个字符截取掉，建议把表明设置为tbl开头，或者自行修改模板文件。</li>\n<li>想让字段注释生效记得替换SchemaExplorer.MySQLSchemaProvider.dll(替换前记得备份！)</li>\n</ol>\n"},{"layout":"post","title":"bytes to string","date":"2016-01-19T16:00:00.000Z","_content":"\n有时候我们会遇到需要把数据加密之后再网络上传输的需求，这样的话一般使用AES256之类的算法，经过运算之后得到一个byte数组，接着转换成string，就扔出去了。对方拿到之后，用密钥解密之后便得到了对应的数据。\n\n在C#里面，Byte数组转String字符串我们一般用Convert.ToBase64()完成。\n\n代码如下：\n```csharp\n    public string BytesToString(byte[] buff)\n    {\n       return Convert.ToBase64String(buff);\n    }\n\n    public byte[] StringToBytes(string input)\n    {\n        return Encoding.UTF8.GetBytes(input);\n    }\n```\n \n 一般来说这样也没撒问题了，不过，如果这个数据是通过URL的方式给出去的，这时候就要考虑一下特殊字符编码问题了。+、空格、%之类的特殊字符可能会导致切断URL传参的数据，导致得到的数据不一致。这样的话，解密也做不下去了。\n \n 相关资料：\n <br>1、[关于URL编码](http://www.ruanyifeng.com/blog/2010/02/url_encoding.html)\n <br>2、[URL编码----url参数中有+、空格、=、%、&、#等特殊符号的问题解决](http://blog.csdn.net/luo_deng/article/details/12186535)\n \n \n 不过也好在，C#提供了一个HttpUtility.UrlEncode(input)和HttpUtility.UrlEncode(input)这两个函数，让我们直接把上面的特殊字符转换成URL可识别的转义字符。\n 数据出去之后先Encode一下，回来之后Decode一下，好像问题都解决了吧。\n \n \n然而我们都忘了一件事情，URL到了浏览器之后，自然会对URL里面的东西Decode一次。\n我实现的时候，在后台验证的时候又Decode一次,这就出问题了。\n\n问题在哪呢？一个encode的字符被decode两次，内容已经被改掉了...\n这就导致解密的时候直接挂了....\n\n\n\n这样看来，\nConvert.ToBase64String()这个不够靠谱，出来的数据可能会有特殊字符的问题。\n怎么解决呢？那天晚上和老大/CTO都在看这个bug。一下子都没撒好办法....\n\n后来CTO想了一下，说byte不就是最大不久255么？直接转16进制字符就是嘛。\n于是有了下面的代码：\n \n \n```csharp\n\t/// <summary>\n\t/// byte数组转string\n\t/// </summary>\n\t/// <param name=\"bytes\"></param>\n\t/// <returns></returns>\n\tprivate static string BytesToString(byte[] bytes)\n\t{\n\t    if (bytes == null)\n\t        return string.Empty;\n\t   return string.Join(string.Empty, \n\t   bytes.Select(b => string.Format(\"{0:x2}\", b)).ToArray());\n\t}\n\t\n\t/// <summary>\n\t/// string转byte数组\n\t/// </summary>\n\t/// <param name=\"str\"></param>\n\t/// <returns></returns>\n\tprivate static byte[] StringToBytes(string str)\n\t{\n\t    if (string.IsNullOrEmpty(str))\n\t        return null;\n\t    byte[] bytes = new byte[str.Length / 2];\n\t    for (int i = 0; i < str.Length; i += 2)\n\t    {\n\t        bytes[i / 2] = Convert.ToByte(\"0x\" + str[i] + str[i + 1], 16);\n\t    }\n\t    return bytes;\n\t}\n```\n\n\n问题解决。\n\n关于base64的实现，下面这个链接是相关资料，有兴趣自己看啦。\n\n[C#/ASP.NET Base64编码原理及实现](http://www.hejingzong.cn/blog/ViewBlog_36.aspx)\n\n[C＃实现Base64编码与解码](http://www.cnblogs.com/tuyile006/archive/2008/01/17/1043178.html)\n\n\n","source":"_posts/Bytes -To-String.md","raw":"---\nlayout: post\ntitle: bytes to string\ncategory: .net\ndate: 2016-01-20 00:00:00\n---\n\n有时候我们会遇到需要把数据加密之后再网络上传输的需求，这样的话一般使用AES256之类的算法，经过运算之后得到一个byte数组，接着转换成string，就扔出去了。对方拿到之后，用密钥解密之后便得到了对应的数据。\n\n在C#里面，Byte数组转String字符串我们一般用Convert.ToBase64()完成。\n\n代码如下：\n```csharp\n    public string BytesToString(byte[] buff)\n    {\n       return Convert.ToBase64String(buff);\n    }\n\n    public byte[] StringToBytes(string input)\n    {\n        return Encoding.UTF8.GetBytes(input);\n    }\n```\n \n 一般来说这样也没撒问题了，不过，如果这个数据是通过URL的方式给出去的，这时候就要考虑一下特殊字符编码问题了。+、空格、%之类的特殊字符可能会导致切断URL传参的数据，导致得到的数据不一致。这样的话，解密也做不下去了。\n \n 相关资料：\n <br>1、[关于URL编码](http://www.ruanyifeng.com/blog/2010/02/url_encoding.html)\n <br>2、[URL编码----url参数中有+、空格、=、%、&、#等特殊符号的问题解决](http://blog.csdn.net/luo_deng/article/details/12186535)\n \n \n 不过也好在，C#提供了一个HttpUtility.UrlEncode(input)和HttpUtility.UrlEncode(input)这两个函数，让我们直接把上面的特殊字符转换成URL可识别的转义字符。\n 数据出去之后先Encode一下，回来之后Decode一下，好像问题都解决了吧。\n \n \n然而我们都忘了一件事情，URL到了浏览器之后，自然会对URL里面的东西Decode一次。\n我实现的时候，在后台验证的时候又Decode一次,这就出问题了。\n\n问题在哪呢？一个encode的字符被decode两次，内容已经被改掉了...\n这就导致解密的时候直接挂了....\n\n\n\n这样看来，\nConvert.ToBase64String()这个不够靠谱，出来的数据可能会有特殊字符的问题。\n怎么解决呢？那天晚上和老大/CTO都在看这个bug。一下子都没撒好办法....\n\n后来CTO想了一下，说byte不就是最大不久255么？直接转16进制字符就是嘛。\n于是有了下面的代码：\n \n \n```csharp\n\t/// <summary>\n\t/// byte数组转string\n\t/// </summary>\n\t/// <param name=\"bytes\"></param>\n\t/// <returns></returns>\n\tprivate static string BytesToString(byte[] bytes)\n\t{\n\t    if (bytes == null)\n\t        return string.Empty;\n\t   return string.Join(string.Empty, \n\t   bytes.Select(b => string.Format(\"{0:x2}\", b)).ToArray());\n\t}\n\t\n\t/// <summary>\n\t/// string转byte数组\n\t/// </summary>\n\t/// <param name=\"str\"></param>\n\t/// <returns></returns>\n\tprivate static byte[] StringToBytes(string str)\n\t{\n\t    if (string.IsNullOrEmpty(str))\n\t        return null;\n\t    byte[] bytes = new byte[str.Length / 2];\n\t    for (int i = 0; i < str.Length; i += 2)\n\t    {\n\t        bytes[i / 2] = Convert.ToByte(\"0x\" + str[i] + str[i + 1], 16);\n\t    }\n\t    return bytes;\n\t}\n```\n\n\n问题解决。\n\n关于base64的实现，下面这个链接是相关资料，有兴趣自己看啦。\n\n[C#/ASP.NET Base64编码原理及实现](http://www.hejingzong.cn/blog/ViewBlog_36.aspx)\n\n[C＃实现Base64编码与解码](http://www.cnblogs.com/tuyile006/archive/2008/01/17/1043178.html)\n\n\n","slug":"Bytes -To-String","published":1,"updated":"2016-09-15T05:11:13.648Z","comments":1,"photos":[],"link":"","_id":"cit3xw9sh0006c0tx7fbhwjb3","content":"<p>有时候我们会遇到需要把数据加密之后再网络上传输的需求，这样的话一般使用AES256之类的算法，经过运算之后得到一个byte数组，接着转换成string，就扔出去了。对方拿到之后，用密钥解密之后便得到了对应的数据。</p>\n<p>在C#里面，Byte数组转String字符串我们一般用Convert.ToBase64()完成。</p>\n<p>代码如下：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">string</span> <span class=\"title\">BytesToString</span>(<span class=\"params\"><span class=\"keyword\">byte</span>[] buff</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">   <span class=\"keyword\">return</span> Convert.ToBase64String(buff);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">byte</span>[] <span class=\"title\">StringToBytes</span>(<span class=\"params\"><span class=\"keyword\">string</span> input</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> Encoding.UTF8.GetBytes(input);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p> 一般来说这样也没撒问题了，不过，如果这个数据是通过URL的方式给出去的，这时候就要考虑一下特殊字符编码问题了。+、空格、%之类的特殊字符可能会导致切断URL传参的数据，导致得到的数据不一致。这样的话，解密也做不下去了。</p>\n<p> 相关资料：<br> <br>1、<a href=\"http://www.ruanyifeng.com/blog/2010/02/url_encoding.html\" target=\"_blank\" rel=\"external\">关于URL编码</a><br> <br>2、<a href=\"http://blog.csdn.net/luo_deng/article/details/12186535\" target=\"_blank\" rel=\"external\">URL编码—-url参数中有+、空格、=、%、&amp;、#等特殊符号的问题解决</a></p>\n<p> 不过也好在，C#提供了一个HttpUtility.UrlEncode(input)和HttpUtility.UrlEncode(input)这两个函数，让我们直接把上面的特殊字符转换成URL可识别的转义字符。<br> 数据出去之后先Encode一下，回来之后Decode一下，好像问题都解决了吧。</p>\n<p>然而我们都忘了一件事情，URL到了浏览器之后，自然会对URL里面的东西Decode一次。<br>我实现的时候，在后台验证的时候又Decode一次,这就出问题了。</p>\n<p>问题在哪呢？一个encode的字符被decode两次，内容已经被改掉了…<br>这就导致解密的时候直接挂了….</p>\n<p>这样看来，<br>Convert.ToBase64String()这个不够靠谱，出来的数据可能会有特殊字符的问题。<br>怎么解决呢？那天晚上和老大/CTO都在看这个bug。一下子都没撒好办法….</p>\n<p>后来CTO想了一下，说byte不就是最大不久255么？直接转16进制字符就是嘛。<br>于是有了下面的代码：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> byte数组转string</span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"bytes\"&gt;</span><span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;returns&gt;</span><span class=\"doctag\">&lt;/returns&gt;</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">string</span> <span class=\"title\">BytesToString</span>(<span class=\"params\"><span class=\"keyword\">byte</span>[] bytes</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (bytes == <span class=\"literal\">null</span>)</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">string</span>.Empty;</div><div class=\"line\">   <span class=\"keyword\">return</span> <span class=\"keyword\">string</span>.Join(<span class=\"keyword\">string</span>.Empty, </div><div class=\"line\">   bytes.Select(b =&gt; <span class=\"keyword\">string</span>.Format(<span class=\"string\">\"&#123;0:x2&#125;\"</span>, b)).ToArray());</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> string转byte数组</span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"str\"&gt;</span><span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;returns&gt;</span><span class=\"doctag\">&lt;/returns&gt;</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] <span class=\"title\">StringToBytes</span>(<span class=\"params\"><span class=\"keyword\">string</span> str</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">string</span>.IsNullOrEmpty(str))</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</div><div class=\"line\">    <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[str.Length / <span class=\"number\">2</span>];</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; str.Length; i += <span class=\"number\">2</span>)</div><div class=\"line\">    &#123;</div><div class=\"line\">        bytes[i / <span class=\"number\">2</span>] = Convert.ToByte(<span class=\"string\">\"0x\"</span> + str[i] + str[i + <span class=\"number\">1</span>], <span class=\"number\">16</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> bytes;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>问题解决。</p>\n<p>关于base64的实现，下面这个链接是相关资料，有兴趣自己看啦。</p>\n<p><a href=\"http://www.hejingzong.cn/blog/ViewBlog_36.aspx\" target=\"_blank\" rel=\"external\">C#/ASP.NET Base64编码原理及实现</a></p>\n<p><a href=\"http://www.cnblogs.com/tuyile006/archive/2008/01/17/1043178.html\" target=\"_blank\" rel=\"external\">C＃实现Base64编码与解码</a></p>\n","excerpt":"","more":"<p>有时候我们会遇到需要把数据加密之后再网络上传输的需求，这样的话一般使用AES256之类的算法，经过运算之后得到一个byte数组，接着转换成string，就扔出去了。对方拿到之后，用密钥解密之后便得到了对应的数据。</p>\n<p>在C#里面，Byte数组转String字符串我们一般用Convert.ToBase64()完成。</p>\n<p>代码如下：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">string</span> <span class=\"title\">BytesToString</span>(<span class=\"params\"><span class=\"keyword\">byte</span>[] buff</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">   <span class=\"keyword\">return</span> Convert.ToBase64String(buff);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">byte</span>[] <span class=\"title\">StringToBytes</span>(<span class=\"params\"><span class=\"keyword\">string</span> input</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> Encoding.UTF8.GetBytes(input);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p> 一般来说这样也没撒问题了，不过，如果这个数据是通过URL的方式给出去的，这时候就要考虑一下特殊字符编码问题了。+、空格、%之类的特殊字符可能会导致切断URL传参的数据，导致得到的数据不一致。这样的话，解密也做不下去了。</p>\n<p> 相关资料：<br> <br>1、<a href=\"http://www.ruanyifeng.com/blog/2010/02/url_encoding.html\">关于URL编码</a><br> <br>2、<a href=\"http://blog.csdn.net/luo_deng/article/details/12186535\">URL编码—-url参数中有+、空格、=、%、&amp;、#等特殊符号的问题解决</a></p>\n<p> 不过也好在，C#提供了一个HttpUtility.UrlEncode(input)和HttpUtility.UrlEncode(input)这两个函数，让我们直接把上面的特殊字符转换成URL可识别的转义字符。<br> 数据出去之后先Encode一下，回来之后Decode一下，好像问题都解决了吧。</p>\n<p>然而我们都忘了一件事情，URL到了浏览器之后，自然会对URL里面的东西Decode一次。<br>我实现的时候，在后台验证的时候又Decode一次,这就出问题了。</p>\n<p>问题在哪呢？一个encode的字符被decode两次，内容已经被改掉了…<br>这就导致解密的时候直接挂了….</p>\n<p>这样看来，<br>Convert.ToBase64String()这个不够靠谱，出来的数据可能会有特殊字符的问题。<br>怎么解决呢？那天晚上和老大/CTO都在看这个bug。一下子都没撒好办法….</p>\n<p>后来CTO想了一下，说byte不就是最大不久255么？直接转16进制字符就是嘛。<br>于是有了下面的代码：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> byte数组转string</span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"bytes\"&gt;</span><span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;returns&gt;</span><span class=\"doctag\">&lt;/returns&gt;</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">string</span> <span class=\"title\">BytesToString</span>(<span class=\"params\"><span class=\"keyword\">byte</span>[] bytes</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (bytes == <span class=\"literal\">null</span>)</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">string</span>.Empty;</div><div class=\"line\">   <span class=\"keyword\">return</span> <span class=\"keyword\">string</span>.Join(<span class=\"keyword\">string</span>.Empty, </div><div class=\"line\">   bytes.Select(b =&gt; <span class=\"keyword\">string</span>.Format(<span class=\"string\">\"&#123;0:x2&#125;\"</span>, b)).ToArray());</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> string转byte数组</span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=\"str\"&gt;</span><span class=\"doctag\">&lt;/param&gt;</span></span></div><div class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;returns&gt;</span><span class=\"doctag\">&lt;/returns&gt;</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] <span class=\"title\">StringToBytes</span>(<span class=\"params\"><span class=\"keyword\">string</span> str</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">string</span>.IsNullOrEmpty(str))</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</div><div class=\"line\">    <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[str.Length / <span class=\"number\">2</span>];</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; str.Length; i += <span class=\"number\">2</span>)</div><div class=\"line\">    &#123;</div><div class=\"line\">        bytes[i / <span class=\"number\">2</span>] = Convert.ToByte(<span class=\"string\">\"0x\"</span> + str[i] + str[i + <span class=\"number\">1</span>], <span class=\"number\">16</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> bytes;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>问题解决。</p>\n<p>关于base64的实现，下面这个链接是相关资料，有兴趣自己看啦。</p>\n<p><a href=\"http://www.hejingzong.cn/blog/ViewBlog_36.aspx\">C#/ASP.NET Base64编码原理及实现</a></p>\n<p><a href=\"http://www.cnblogs.com/tuyile006/archive/2008/01/17/1043178.html\">C＃实现Base64编码与解码</a></p>\n"},{"layout":"post","title":"CodeSmith 连接MySQL数据库报“can't find .net framework data provider”","date":"2016-04-19T16:00:00.000Z","_content":"\n1、下载 mysql-connector-net 安装\n\n[mysql-connector-net](https://dev.mysql.com/downloads/connector/net/6.9.html)\n\n2、mysql-connector-net 安装完毕之后，到对应的安装目录下，把对应的MySQL .NET dll拷贝到 CodeSmith的bin目录和SchemaProviders目录。\n\n一般DLL所在目录是：\n\nC:\\\\Program Files (x86)\\\\MySQL\\\\MySQL Connector Net 6.9.8\\\\Assemblies\\\\v4.0\n\n\n3、重启CodeSmith生效\n\n\n<br>\n<br>\n\n其余解决方案：\n<br>\n[codesmith无法连接Mysql的解决方法](http://blog.csdn.net/joke01/article/details/9469515)\n\n[codesmith6.5连接Mysql提示“找不到请求的 .Net Framework Data Provider。可能没有安装。”解决方法](http://www.cnblogs.com/tim190/archive/2013/01/18/2866161.html)\n\n\n\n\n","source":"_posts/CodeSmith-connect-MySQL-throw“can‘t find .Net Framework Data Provider”.md","raw":"---\nlayout: post\ntitle: CodeSmith 连接MySQL数据库报“can't find .net framework data provider”\ncategory: CodeSmith\ndate: 2016-04-20 00:00:00\n---\n\n1、下载 mysql-connector-net 安装\n\n[mysql-connector-net](https://dev.mysql.com/downloads/connector/net/6.9.html)\n\n2、mysql-connector-net 安装完毕之后，到对应的安装目录下，把对应的MySQL .NET dll拷贝到 CodeSmith的bin目录和SchemaProviders目录。\n\n一般DLL所在目录是：\n\nC:\\\\Program Files (x86)\\\\MySQL\\\\MySQL Connector Net 6.9.8\\\\Assemblies\\\\v4.0\n\n\n3、重启CodeSmith生效\n\n\n<br>\n<br>\n\n其余解决方案：\n<br>\n[codesmith无法连接Mysql的解决方法](http://blog.csdn.net/joke01/article/details/9469515)\n\n[codesmith6.5连接Mysql提示“找不到请求的 .Net Framework Data Provider。可能没有安装。”解决方法](http://www.cnblogs.com/tim190/archive/2013/01/18/2866161.html)\n\n\n\n\n","slug":"CodeSmith-connect-MySQL-throw“can‘t find .Net Framework Data Provider”","published":1,"updated":"2016-09-15T05:11:13.649Z","comments":1,"photos":[],"link":"","_id":"cit3xw9sj0008c0txilmauj66","content":"<p>1、下载 mysql-connector-net 安装</p>\n<p><a href=\"https://dev.mysql.com/downloads/connector/net/6.9.html\" target=\"_blank\" rel=\"external\">mysql-connector-net</a></p>\n<p>2、mysql-connector-net 安装完毕之后，到对应的安装目录下，把对应的MySQL .NET dll拷贝到 CodeSmith的bin目录和SchemaProviders目录。</p>\n<p>一般DLL所在目录是：</p>\n<p>C:\\Program Files (x86)\\MySQL\\MySQL Connector Net 6.9.8\\Assemblies\\v4.0</p>\n<p>3、重启CodeSmith生效</p>\n<p><br><br><br></p>\n<p>其余解决方案：<br><br><br><a href=\"http://blog.csdn.net/joke01/article/details/9469515\" target=\"_blank\" rel=\"external\">codesmith无法连接Mysql的解决方法</a></p>\n<p><a href=\"http://www.cnblogs.com/tim190/archive/2013/01/18/2866161.html\" target=\"_blank\" rel=\"external\">codesmith6.5连接Mysql提示“找不到请求的 .Net Framework Data Provider。可能没有安装。”解决方法</a></p>\n","excerpt":"","more":"<p>1、下载 mysql-connector-net 安装</p>\n<p><a href=\"https://dev.mysql.com/downloads/connector/net/6.9.html\">mysql-connector-net</a></p>\n<p>2、mysql-connector-net 安装完毕之后，到对应的安装目录下，把对应的MySQL .NET dll拷贝到 CodeSmith的bin目录和SchemaProviders目录。</p>\n<p>一般DLL所在目录是：</p>\n<p>C:\\Program Files (x86)\\MySQL\\MySQL Connector Net 6.9.8\\Assemblies\\v4.0</p>\n<p>3、重启CodeSmith生效</p>\n<p><br><br><br></p>\n<p>其余解决方案：<br><br><br><a href=\"http://blog.csdn.net/joke01/article/details/9469515\">codesmith无法连接Mysql的解决方法</a></p>\n<p><a href=\"http://www.cnblogs.com/tim190/archive/2013/01/18/2866161.html\">codesmith6.5连接Mysql提示“找不到请求的 .Net Framework Data Provider。可能没有安装。”解决方法</a></p>\n"},{"layout":"post","title":"C#.NET托管堆和垃圾回收(续)","date":"2016-03-19T16:00:00.000Z","_content":"\n\n##大对象\n CLR将对象分成大对象和小对象。目前认为85000字节或者更大的对象是大对象。CLR以不同方式对待大小对象。\n \n1. 大对象不是在小对象的地址空间分配的，而是在进程地址空间的其他地方分配。\n\n2. 目前版本的GC不“压缩”大对象，因为在内存中移动它们代价过高。但这可能在进程中的大对象之间造成地址空间碎片化，以至于抛出OutMemoryException。CLR将来的版本可能会压缩大对象。\n3. 大对象总是第2代，绝不可能是第0代或者第1代。所以只能为需要长时间存活的资源创建大对象。分配短时间存活的大对象会导致第2代被更频繁地回收，损失性能。大对象一般是大字符串（XML/JSON）或者用于I/O操作的字节数组（从文件/网络将字节读入缓冲区以便处理）。\n\n\n\n##垃圾回收模式 \n CLR启动时会选择一个GC模式，进程中之前该模式都不会改变。\n \n 有两个基本GC模式。\n\n###工作站 \n该模式针对客户端应用程序优化GC。GC造成的延时很低，应用程序线程挂起时间很短，避免用户感到焦虑。在该模式中,GC假定机器上运行的其他应用程序都不会消耗太多的CPU资源。\n\n###服务器 \n 该模式针对服务器端应用程序优化GC。被优化的主要是吞吐量和资源利用。GC假定机器上没有运行其他应用程序（无论客户端还是服务器应用程序），并假定机器的所有CPU都可以用来辅助完成GC。该模式造成托管堆被拆分成几个区域，每个CPU一个。开始垃圾回收时，垃圾回收器在每个CPU上运行一个特殊线程；每个线程都和其他线程并发回收它自己的区域。对于工作者线程行为一致的服务器应用程序，并发回收能很好进行。这个功能要求应用程序在多CPU计算机上运行，是线程能真正同时工作，从而得到性能上的提升。\n\n\n\n应用程序默认以“工作站”GC模式运行。寄宿了CLR的服务器应用程序（如ASP.NET ）可请求CLR加载服务器 GC.但如果应用程序在单处理器计算机上运行，CLR总是使用“工作站”GC模式。\n\n独立应用程序可以创建一个配置文件告诉CLR 使用CLR使用服务器回收器。配置文件要为应用程序添加gcServer元素。下面是一个示例配置文件：\n<configuration>\n       <runtime>\n             <gcServer enabled=\"true\">\n      </runtime>\n</configuration> \n可以使用GCSettings类的只读Boolean属性IsServerGC得到CLR是否处于“服务器”GC模式。\n\n\n\n除了这两种模式，GC还支持两种子模式：并发(默认)或者非并发。\n在并发方式中，垃圾回收器有一个额外的后台线程，它能在应用程序运行时并发标记对象。 程序运行时，垃圾回收器运行一个普通优先级的后台线程来查找不可达对象。找到之后，垃圾回收器再次挂起所以线程，判断是否要“压缩”内存。如决定压缩，内存会被压缩，根引用会被修正，应用程序线程恢复运行。这一次垃圾回收花费的时间比平常少，因为不可达对象集合已构造好了。但垃圾回收器也可能决定不压缩内存；事实上，垃圾回收器更倾向不压缩。可用内存多，垃圾回收器便不会压缩堆；这有利于增强性能，但会增大程序的工作集。使用并发垃圾回收器，应用程序消耗的内存通常比使用非并发垃圾回收器多。","source":"_posts/GC-2.md","raw":"---\nlayout: post\ntitle: C#.NET托管堆和垃圾回收(续)\ncategory: GC\ndate: 2016-03-20 00:00:00\n---\n\n\n##大对象\n CLR将对象分成大对象和小对象。目前认为85000字节或者更大的对象是大对象。CLR以不同方式对待大小对象。\n \n1. 大对象不是在小对象的地址空间分配的，而是在进程地址空间的其他地方分配。\n\n2. 目前版本的GC不“压缩”大对象，因为在内存中移动它们代价过高。但这可能在进程中的大对象之间造成地址空间碎片化，以至于抛出OutMemoryException。CLR将来的版本可能会压缩大对象。\n3. 大对象总是第2代，绝不可能是第0代或者第1代。所以只能为需要长时间存活的资源创建大对象。分配短时间存活的大对象会导致第2代被更频繁地回收，损失性能。大对象一般是大字符串（XML/JSON）或者用于I/O操作的字节数组（从文件/网络将字节读入缓冲区以便处理）。\n\n\n\n##垃圾回收模式 \n CLR启动时会选择一个GC模式，进程中之前该模式都不会改变。\n \n 有两个基本GC模式。\n\n###工作站 \n该模式针对客户端应用程序优化GC。GC造成的延时很低，应用程序线程挂起时间很短，避免用户感到焦虑。在该模式中,GC假定机器上运行的其他应用程序都不会消耗太多的CPU资源。\n\n###服务器 \n 该模式针对服务器端应用程序优化GC。被优化的主要是吞吐量和资源利用。GC假定机器上没有运行其他应用程序（无论客户端还是服务器应用程序），并假定机器的所有CPU都可以用来辅助完成GC。该模式造成托管堆被拆分成几个区域，每个CPU一个。开始垃圾回收时，垃圾回收器在每个CPU上运行一个特殊线程；每个线程都和其他线程并发回收它自己的区域。对于工作者线程行为一致的服务器应用程序，并发回收能很好进行。这个功能要求应用程序在多CPU计算机上运行，是线程能真正同时工作，从而得到性能上的提升。\n\n\n\n应用程序默认以“工作站”GC模式运行。寄宿了CLR的服务器应用程序（如ASP.NET ）可请求CLR加载服务器 GC.但如果应用程序在单处理器计算机上运行，CLR总是使用“工作站”GC模式。\n\n独立应用程序可以创建一个配置文件告诉CLR 使用CLR使用服务器回收器。配置文件要为应用程序添加gcServer元素。下面是一个示例配置文件：\n<configuration>\n       <runtime>\n             <gcServer enabled=\"true\">\n      </runtime>\n</configuration> \n可以使用GCSettings类的只读Boolean属性IsServerGC得到CLR是否处于“服务器”GC模式。\n\n\n\n除了这两种模式，GC还支持两种子模式：并发(默认)或者非并发。\n在并发方式中，垃圾回收器有一个额外的后台线程，它能在应用程序运行时并发标记对象。 程序运行时，垃圾回收器运行一个普通优先级的后台线程来查找不可达对象。找到之后，垃圾回收器再次挂起所以线程，判断是否要“压缩”内存。如决定压缩，内存会被压缩，根引用会被修正，应用程序线程恢复运行。这一次垃圾回收花费的时间比平常少，因为不可达对象集合已构造好了。但垃圾回收器也可能决定不压缩内存；事实上，垃圾回收器更倾向不压缩。可用内存多，垃圾回收器便不会压缩堆；这有利于增强性能，但会增大程序的工作集。使用并发垃圾回收器，应用程序消耗的内存通常比使用非并发垃圾回收器多。","slug":"GC-2","published":1,"updated":"2016-09-15T05:11:13.650Z","comments":1,"photos":[],"link":"","_id":"cit3xw9sl000bc0txkusfuw7s","content":"<p>##大对象<br> CLR将对象分成大对象和小对象。目前认为85000字节或者更大的对象是大对象。CLR以不同方式对待大小对象。</p>\n<ol>\n<li><p>大对象不是在小对象的地址空间分配的，而是在进程地址空间的其他地方分配。</p>\n</li>\n<li><p>目前版本的GC不“压缩”大对象，因为在内存中移动它们代价过高。但这可能在进程中的大对象之间造成地址空间碎片化，以至于抛出OutMemoryException。CLR将来的版本可能会压缩大对象。</p>\n</li>\n<li>大对象总是第2代，绝不可能是第0代或者第1代。所以只能为需要长时间存活的资源创建大对象。分配短时间存活的大对象会导致第2代被更频繁地回收，损失性能。大对象一般是大字符串（XML/JSON）或者用于I/O操作的字节数组（从文件/网络将字节读入缓冲区以便处理）。</li>\n</ol>\n<p>##垃圾回收模式<br> CLR启动时会选择一个GC模式，进程中之前该模式都不会改变。</p>\n<p> 有两个基本GC模式。</p>\n<p>###工作站<br>该模式针对客户端应用程序优化GC。GC造成的延时很低，应用程序线程挂起时间很短，避免用户感到焦虑。在该模式中,GC假定机器上运行的其他应用程序都不会消耗太多的CPU资源。</p>\n<p>###服务器<br> 该模式针对服务器端应用程序优化GC。被优化的主要是吞吐量和资源利用。GC假定机器上没有运行其他应用程序（无论客户端还是服务器应用程序），并假定机器的所有CPU都可以用来辅助完成GC。该模式造成托管堆被拆分成几个区域，每个CPU一个。开始垃圾回收时，垃圾回收器在每个CPU上运行一个特殊线程；每个线程都和其他线程并发回收它自己的区域。对于工作者线程行为一致的服务器应用程序，并发回收能很好进行。这个功能要求应用程序在多CPU计算机上运行，是线程能真正同时工作，从而得到性能上的提升。</p>\n<p>应用程序默认以“工作站”GC模式运行。寄宿了CLR的服务器应用程序（如ASP.NET ）可请求CLR加载服务器 GC.但如果应用程序在单处理器计算机上运行，CLR总是使用“工作站”GC模式。</p>\n<p>独立应用程序可以创建一个配置文件告诉CLR 使用CLR使用服务器回收器。配置文件要为应用程序添加gcServer元素。下面是一个示例配置文件：</p>\n<p><configuration><br>       <runtime><br>             <gcserver enabled=\"true\"><br>      </gcserver></runtime><br></configuration><br>可以使用GCSettings类的只读Boolean属性IsServerGC得到CLR是否处于“服务器”GC模式。</p>\n<p>除了这两种模式，GC还支持两种子模式：并发(默认)或者非并发。<br>在并发方式中，垃圾回收器有一个额外的后台线程，它能在应用程序运行时并发标记对象。 程序运行时，垃圾回收器运行一个普通优先级的后台线程来查找不可达对象。找到之后，垃圾回收器再次挂起所以线程，判断是否要“压缩”内存。如决定压缩，内存会被压缩，根引用会被修正，应用程序线程恢复运行。这一次垃圾回收花费的时间比平常少，因为不可达对象集合已构造好了。但垃圾回收器也可能决定不压缩内存；事实上，垃圾回收器更倾向不压缩。可用内存多，垃圾回收器便不会压缩堆；这有利于增强性能，但会增大程序的工作集。使用并发垃圾回收器，应用程序消耗的内存通常比使用非并发垃圾回收器多。</p>\n","excerpt":"","more":"<p>##大对象<br> CLR将对象分成大对象和小对象。目前认为85000字节或者更大的对象是大对象。CLR以不同方式对待大小对象。</p>\n<ol>\n<li><p>大对象不是在小对象的地址空间分配的，而是在进程地址空间的其他地方分配。</p>\n</li>\n<li><p>目前版本的GC不“压缩”大对象，因为在内存中移动它们代价过高。但这可能在进程中的大对象之间造成地址空间碎片化，以至于抛出OutMemoryException。CLR将来的版本可能会压缩大对象。</p>\n</li>\n<li>大对象总是第2代，绝不可能是第0代或者第1代。所以只能为需要长时间存活的资源创建大对象。分配短时间存活的大对象会导致第2代被更频繁地回收，损失性能。大对象一般是大字符串（XML/JSON）或者用于I/O操作的字节数组（从文件/网络将字节读入缓冲区以便处理）。</li>\n</ol>\n<p>##垃圾回收模式<br> CLR启动时会选择一个GC模式，进程中之前该模式都不会改变。</p>\n<p> 有两个基本GC模式。</p>\n<p>###工作站<br>该模式针对客户端应用程序优化GC。GC造成的延时很低，应用程序线程挂起时间很短，避免用户感到焦虑。在该模式中,GC假定机器上运行的其他应用程序都不会消耗太多的CPU资源。</p>\n<p>###服务器<br> 该模式针对服务器端应用程序优化GC。被优化的主要是吞吐量和资源利用。GC假定机器上没有运行其他应用程序（无论客户端还是服务器应用程序），并假定机器的所有CPU都可以用来辅助完成GC。该模式造成托管堆被拆分成几个区域，每个CPU一个。开始垃圾回收时，垃圾回收器在每个CPU上运行一个特殊线程；每个线程都和其他线程并发回收它自己的区域。对于工作者线程行为一致的服务器应用程序，并发回收能很好进行。这个功能要求应用程序在多CPU计算机上运行，是线程能真正同时工作，从而得到性能上的提升。</p>\n<p>应用程序默认以“工作站”GC模式运行。寄宿了CLR的服务器应用程序（如ASP.NET ）可请求CLR加载服务器 GC.但如果应用程序在单处理器计算机上运行，CLR总是使用“工作站”GC模式。</p>\n<p>独立应用程序可以创建一个配置文件告诉CLR 使用CLR使用服务器回收器。配置文件要为应用程序添加gcServer元素。下面是一个示例配置文件：</p>\n<p><configuration><br>       <runtime><br>             <gcServer enabled=\"true\"><br>      </runtime><br></configuration><br>可以使用GCSettings类的只读Boolean属性IsServerGC得到CLR是否处于“服务器”GC模式。</p>\n<p>除了这两种模式，GC还支持两种子模式：并发(默认)或者非并发。<br>在并发方式中，垃圾回收器有一个额外的后台线程，它能在应用程序运行时并发标记对象。 程序运行时，垃圾回收器运行一个普通优先级的后台线程来查找不可达对象。找到之后，垃圾回收器再次挂起所以线程，判断是否要“压缩”内存。如决定压缩，内存会被压缩，根引用会被修正，应用程序线程恢复运行。这一次垃圾回收花费的时间比平常少，因为不可达对象集合已构造好了。但垃圾回收器也可能决定不压缩内存；事实上，垃圾回收器更倾向不压缩。可用内存多，垃圾回收器便不会压缩堆；这有利于增强性能，但会增大程序的工作集。使用并发垃圾回收器，应用程序消耗的内存通常比使用非并发垃圾回收器多。</p>\n"},{"layout":"post","title":"C#.NET托管堆和垃圾回收","date":"2016-03-24T16:00:00.000Z","_content":"\n###托管堆基础\n 简述：每个程序都要使用这样或那样的资源，包括文件、内存缓冲区、屏幕空间、网络连接.....事实上，在面向对象的环境中，每个类型都代表可供程序使用的一种资源。要使用这些资源，必须为代表资源的类型分配内存。\n \n 以下是访问一个资源所需步骤：\n\n1. 调用IL指令newobj，为代表资源的类型分配内存。(C# new操作符)\n2. 初始化内存，设置资源的初始状态。（一般指构造函数）\n3. 访问类型的成员来使用资源。（使用成员变量、方法、属性等）\n4. 摧毁资源的状态以进行清除。（Dispose？？？）\n5. 释放内存。（GC） \n\n\n###从托管堆分配资源\n\nCLR要求所有的对象都从托管堆分配。\n进程初始化，CLR划出一个地址空间区域作为托管堆。CLR还要维护一个指针，姑且叫NextObjPtr，该指针指向下一个对象在堆中的分配位置。刚开始的时候， NextObjPtr 设为地址空间区域的基地址。\n一个区域被非垃圾对象填满后，CLR会分配更多的区域。\n\n\n这一个过程一直重复，直至整个进程地址空间被填满。所以，应用程序内存收进程的虚拟地址空间的限制。\n\n\n32位进程最多能分配1.5GB，64位进程最多能分配8T。\n注：进程内存大小的相关资料\n\n[Memory Support and Windows Operating Systems](https://msdn.microsoft.com/zh-cn/library/windows/hardware/Dn613959(v=vs.85).aspx)\n\n[进程地址空间](https://msdn.microsoft.com/zh-cn/library/ms189334.aspx)\n\n[ 32位模式下C/C++程序可用最大内存](http://blog.csdn.net/yusiguyuan/article/details/12405799)\n\n\n\n \n###C# 的new操作符导致CLR执行以下操作：\n \n \n1、计算类型的字段（以及从基类型继承的字段）所需要的字节数。\n\n\n2、加上对象的开销所需的字节数。每个对象都有两个开销字段：类型对象指针和同步块索引。对于32位应用程序，这两个字段各需要32位，所以每个对象需要增加8字节。对于64位应用程序，这两个字段各需要64位，所以每个对象要增加16字节。\n\n\n3、CLR检查区域中是否有分配对象所需的字节数。如果托管堆有足够的可用空间，就在NetxObjPtr指针指向的地址处放入对象，为对象分配的字节会被清零。接着调用类型的构造器（为this参数传递NextObjPtr），new操作符返回对象引用。就在返回这个对象引用之前，NextObjPtr指针的值会加上这个对象占用的字节数来得到一个新值，即下个对象放入托管堆时的地址。如下图：\n\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/i3rlSCPAcnT9pL0El0BptPIBpuvnxHpBw9Nkp*UqIjw!/o/dJMAAAAAAAAA&ek=1&kp=1&pt=0&bo=LwKNAC8CjQADACU!&su=1199793361&sce=0-12-12&rf=2-9)\n\n\n\n\n\n###垃圾回收算法\n####CLR使用引用跟踪算法。\n引用跟踪算法只关心引用类型的变量，因为只有这种变量才能引用堆上面的对象；\n值类型变量直接包含值类型实例。引用类型变量可在许多场合使用，包括类的静态和实例字段，或者方法的参数和局部变量。这里我们将所有引用类型的变量都称为根。\nCLR开始GC时，首先暂停所有的线程。(这样可以防止线程在CLR检查期间访问对象并更改其状态。) 然后CLR进入GC标记阶段。在这个阶段，CLR遍历堆中的所有对象，将同步块索引字段中的一位设为0。这表明所有的对象都应删除。然后，CLR检查所有的活动根，查看他们引用了哪些对象。这正是CLR的GC被称作引用跟踪GC的原因。如果一个根包含null，CLR忽略这个根并继续检查下一个根。\n下图展示一个堆，其中包含几个对象。\n![图片1](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/eVBVeXGrNAfoWfyRgl4aC2RRSGgiDpmbrocv4lTSJMA!/o/dJIAAAAAAAAA&ek=1&kp=1&pt=0&bo=gAIFAYACBQEDACU!&su=1176931729&sce=0-12-12&rf=2-9)\n \n \n \n应用程序的根直接引用对象A 、C、D 、F。所有的对象都已经被标记。标记对象D时，GC发现这个对象含有一个引用对象H的字段，造成对象H也被标记。标记过程会持续，直至应用程序的所有根所有检查完毕。\n检查完毕后，堆中的对象要么已标记，要么未标记。已标记的对象不能被垃圾回收，因为至少有一个根在引用它。我们说这种对象是可达的，因为应用程序可以通过引用它的变量抵达它。 未标记的对象是不可达的，因为应用程序中不存在使对象能被再次访问的根。\n\n\n\n\nCLR知道哪些对象可以幸存，哪些可以被删除后，进入GC的压缩（类似于碎片整理）阶段。在压缩阶段，CLR对堆中已标记的对象进行“乾坤大挪移”，整理所有幸存下来的对象，使他们占用连续的内存。\n\n\n这样做的好处在于：\n\n\n1、所有幸存对象在内存中紧挨在一起，恢复了引用的“局部性”，减少了应用程序的工作集，从而提升了将来访问这些对象时的性能；\n\n\n2、经过整理后，可用空间也是连续的，整个地址空间区段得到了解放，允许其他东西进驻。\n\n\n\n在内存中移动了对象之后有一个问题亟待解决。引用幸存对象的根现在引用的还是对象最初在内存中的位置，而非移动后的位置。被暂停的线程恢复执行时，将访问旧的内存位置，会造成内存损坏。 这显然是不能容忍的，所以作为压缩阶段的一部分，CLR还要从每个根减去所引用对象在内存中偏移的字节数。这样就能保证每个根还是引用和之前一样的对象，只是对象在内存中变换了位置。\n如图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/FyP2yk1O6kMsq3.u4e4x3qrAxpwbajgSHOd4QHTJOhE!/o/dJIAAAAAAAAA&ek=1&kp=1&pt=0&bo=TQI*AU0CPwEDACU!&su=1202148209&sce=0-12-12&rf=2-9)\n\n\n\n\n\n\n\n\n##代：提升性能 (待续)\nCLR的GC是基于代的垃圾回收器，它对你的代码做出了以下几点假设：\n\n\n1、对象越新，生存周期越短。\n\n\n2、对象越老，生存周期越长。\n\n\n3、回收堆的一部分 ，速度快于回收整个堆。\n\n\n大量研究表明，这些假设对于现今大多数的应用程序都是成立的，它们影响了垃圾回收器的实现方式。这里将解释代的工作原理。\n\n托管堆在初始化时不包括对象。添加到堆的对象成为第0代对象。简单来说，第0代对象就是那些新构造的对象，垃圾回收器从未检查过它们。如下图，新启动的应用程序，分配了5个对象（从A到E）。过了一会，C和E变得不可达了。\n\n\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/77WJus7lssJpEJ2RZREQoNx.5CL31HLdboJbAgCqS0E!/o/dJMAAAAAAAAA&ek=1&kp=1&pt=0&bo=tQIVAbUCFQEDACU!&su=172682065&sce=0-12-12&rf=2-9)\n\nCLR初始化第0代对象选择一个预算容量。如果分配一个新对象造成第0代超预算，就必须启动一次GC。假设对象A到E刚好用完了第0代的空间，那么分配对象F就必须启动GC。GC之后存活的对象现场成为第1代对象。如下图：\n\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/GEDzaV4pNFNQUuDwl2EQrv*eD9Sk9OJCzx5SpRRI2fk!/o/dGUBAAAAAAAA&ek=1&kp=1&pt=0&bo=OAL5ADgC.QADACU!&su=1155276897&sce=0-12-12&rf=2-9)\n一次GC之后，第0代就不包含任何对象。和前面一样，新对象会分配到第0代。新分配对象F到对象K都到了第0代。\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/Op0QokzBTNYCFR6zzm2tpc2V7U70IsIJTeWrd0UAUb0!/o/dGUBAAAAAAAA&ek=1&kp=1&pt=0&bo=yAJeAcgCXgEDACU!&su=1124261217&sce=0-12-12&rf=2-9)\n\n之后，程序继续运行，B、H、J变得不可达，它们的内存将在某一个时刻回收。\n\n假设现在新分配对象L会造成第0代超出预算,造成必须启动垃圾回收。\n\n\n开始垃圾回收时,垃圾回收器必须决定检查哪些代。前面说过,CLR初始化时会为第0代对象选择预算.事实上,它还必须为第1代选择预算.\n\n\n开始一次垃圾回收时,垃圾回收器还会检查第一代占用了多少内存。在本例中,由于第1代占用内存远少于预算,所以垃圾回收器只检查第0代对象。回顾之前基于代的垃圾回收器做出的第一个假设：对象越新，生存期越短。 因此，第0代包含更多的垃圾的可能性更大，能回收更多的内存。由于忽略第1代中的对象，所以加快了垃圾回收速度。\n\n\n\n\n显然，忽略第1代中的对象能提升垃圾回收器的性能。但对性能有更大提振作用的是现在不必遍历托管堆中的每个对象。如果根或对象引用了老一代的某个对象，垃圾回收器就可以忽略老对象内部的所有引用，能在更短的时间内构造好可达对象图。当然，如果老对象的字段也可能引用新对象。为了确保对老对象的已更新字段进行检查，垃圾回收器利用了JIT编译器内部的一个机制。这个机制在对象的引用字段发生变化时，会设置一个对应的标志位。这样，垃圾回收器就知道自上一次垃圾回收以来，哪些老对象（如果有的话）已被写入。只有字段发生变化的老对象才需要检查是否引用了第0代中的任何新对象。\n\n\n\n基于代的垃圾回收器还假设越老的对象活得越长。也就是说，第1代对象在应用程序中有可能是继续可达的。如果垃圾回收器检查第1代的对象，很有可能找不到多少垃圾，结果是也回收不了多少内存。因此，对第1代进行垃圾回收很可能是浪费时间的。如果第一代真有垃圾，垃圾将留在那里。如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/Do.yRCBJEnaOfZaUOdxj4II9*pX2BEcX2QmIG6NQPBE!/o/dGUBAAAAAAAA&ek=1&kp=1&pt=0&bo=qAI5AagCOQEDACU!&su=187009937&sce=0-12-12&rf=2-9)\n\n程序继续运行，继续往第0代分配对象，同时程序停止对第1代某对象的使用。\n\n\n如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/YEqIM16xFsSgXdvEzgrerLnKw7fEItnrSqEzlaYnUfE!/o/dGUBAAAAAAAA&ek=1&kp=1&pt=0&bo=egJPAXoCTwEDACU!&su=1118118497&sce=0-12-12&rf=2-9)\n分配对象P导致第0代超预算，开始GC。第1代的所有对象占据内存仍小于预算，垃圾回收器再次决定只回收第0代。忽略第1代中的垃圾对象。如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/EcdSNU5AatqRERWtVdlJ7LiIPHHXe8.mklN.0hHDK9U!/o/dJQAAAAAAAAA&ek=1&kp=1&pt=0&bo=aAIxAWgCMQEDACU!&su=1214124305&sce=0-12-12&rf=2-9)\n\n\n程序继续运行，假设第一代的增长导致它的全部对象占用了全部预算。这时候应用程序分配对象P到对象S，使第0代对象达到它的预算总和。如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/6dB68RIUYrqMZ4p0VIY3REJZPg.g3ybkZFIazJ3h.CQ!/o/dJIAAAAAAAAA&ek=1&kp=1&pt=0&bo=jwIiAY8CIgEDACU!&su=177976657&sce=0-12-12&rf=2-9)\n\n\n这时候，应用程序准备分配对象T，由于第一代已满，所以必须开始GC。但这一次垃圾回收器发现第一代占用了太多内存，以至于用完了预算。由于前几次对第0代进行GC时，第1代中可能已经有很多对象变得不可达。所以这次垃圾回收器决定检查第1代和第0代中的所有对象。两代都被垃圾回收后，堆的情况如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/bxdZDsZi2Y6FSDWs7RXNPkkJK8dCzMD.cfnjwNY2Mjs!/o/dJIAAAAAAAAA&ek=1&kp=1&pt=0&bo=tgI2AbYCNgEDACU!&su=197762641&sce=0-12-12&rf=2-9)\n\n\n\n托管堆只支持三代：第0代、第1代和第2代。\n\n\nCLR初始化时，会为每一代选择预算。\n\n\n然而，CLR的垃圾回收是自调节的。\n\n\n这意味着垃圾回收器会在执行垃圾回收的过程了解程序的行为。\n\n\n例如：假设应用程序构造了许多对象，但每个对象的时间都很短。\n在这种情况下，对第0代的垃圾回收会回收到大量的内存。事实上，第0代的所有对象都可能被回收。\n\n\n\n如果垃圾回收器发现在回收第0代后存活下来的对象很少，就可能减少第0代的预算。已分配空间的减少意味着垃圾回收将更频繁地发生，但垃圾回收器每次做的事情也减少，这减少了进程的工作集。\n\n\n\n另一方面，如果垃圾回收器回收了第0代，发现还有很多对象存活，没多少内存可以被回收，就会增大第0代的预算。\n\n同样的启发性算法调整预算适用于了第1代和第2代的预算。\n\n引自：《CLR VIA C# -21章》\n\n\n[自动内存管理](https://msdn.microsoft.com/zh-cn/library/vstudio/f144e03t(v=vs.100).aspx)\n\n\n[垃圾回收的基础](https://msdn.microsoft.com/zh-cn/library/vstudio/ee787088(v=vs.100).aspx)\n\n\n[代数](https://msdn.microsoft.com/zh-cn/library/vstudio/ee787088(v=vs.100).aspx#generations )","source":"_posts/GC-1.md","raw":"---\nlayout: post\ntitle: C#.NET托管堆和垃圾回收\ncategory: GC\ndate: 2016-03-25 00:00:00\n---\n\n###托管堆基础\n 简述：每个程序都要使用这样或那样的资源，包括文件、内存缓冲区、屏幕空间、网络连接.....事实上，在面向对象的环境中，每个类型都代表可供程序使用的一种资源。要使用这些资源，必须为代表资源的类型分配内存。\n \n 以下是访问一个资源所需步骤：\n\n1. 调用IL指令newobj，为代表资源的类型分配内存。(C# new操作符)\n2. 初始化内存，设置资源的初始状态。（一般指构造函数）\n3. 访问类型的成员来使用资源。（使用成员变量、方法、属性等）\n4. 摧毁资源的状态以进行清除。（Dispose？？？）\n5. 释放内存。（GC） \n\n\n###从托管堆分配资源\n\nCLR要求所有的对象都从托管堆分配。\n进程初始化，CLR划出一个地址空间区域作为托管堆。CLR还要维护一个指针，姑且叫NextObjPtr，该指针指向下一个对象在堆中的分配位置。刚开始的时候， NextObjPtr 设为地址空间区域的基地址。\n一个区域被非垃圾对象填满后，CLR会分配更多的区域。\n\n\n这一个过程一直重复，直至整个进程地址空间被填满。所以，应用程序内存收进程的虚拟地址空间的限制。\n\n\n32位进程最多能分配1.5GB，64位进程最多能分配8T。\n注：进程内存大小的相关资料\n\n[Memory Support and Windows Operating Systems](https://msdn.microsoft.com/zh-cn/library/windows/hardware/Dn613959(v=vs.85).aspx)\n\n[进程地址空间](https://msdn.microsoft.com/zh-cn/library/ms189334.aspx)\n\n[ 32位模式下C/C++程序可用最大内存](http://blog.csdn.net/yusiguyuan/article/details/12405799)\n\n\n\n \n###C# 的new操作符导致CLR执行以下操作：\n \n \n1、计算类型的字段（以及从基类型继承的字段）所需要的字节数。\n\n\n2、加上对象的开销所需的字节数。每个对象都有两个开销字段：类型对象指针和同步块索引。对于32位应用程序，这两个字段各需要32位，所以每个对象需要增加8字节。对于64位应用程序，这两个字段各需要64位，所以每个对象要增加16字节。\n\n\n3、CLR检查区域中是否有分配对象所需的字节数。如果托管堆有足够的可用空间，就在NetxObjPtr指针指向的地址处放入对象，为对象分配的字节会被清零。接着调用类型的构造器（为this参数传递NextObjPtr），new操作符返回对象引用。就在返回这个对象引用之前，NextObjPtr指针的值会加上这个对象占用的字节数来得到一个新值，即下个对象放入托管堆时的地址。如下图：\n\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/i3rlSCPAcnT9pL0El0BptPIBpuvnxHpBw9Nkp*UqIjw!/o/dJMAAAAAAAAA&ek=1&kp=1&pt=0&bo=LwKNAC8CjQADACU!&su=1199793361&sce=0-12-12&rf=2-9)\n\n\n\n\n\n###垃圾回收算法\n####CLR使用引用跟踪算法。\n引用跟踪算法只关心引用类型的变量，因为只有这种变量才能引用堆上面的对象；\n值类型变量直接包含值类型实例。引用类型变量可在许多场合使用，包括类的静态和实例字段，或者方法的参数和局部变量。这里我们将所有引用类型的变量都称为根。\nCLR开始GC时，首先暂停所有的线程。(这样可以防止线程在CLR检查期间访问对象并更改其状态。) 然后CLR进入GC标记阶段。在这个阶段，CLR遍历堆中的所有对象，将同步块索引字段中的一位设为0。这表明所有的对象都应删除。然后，CLR检查所有的活动根，查看他们引用了哪些对象。这正是CLR的GC被称作引用跟踪GC的原因。如果一个根包含null，CLR忽略这个根并继续检查下一个根。\n下图展示一个堆，其中包含几个对象。\n![图片1](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/eVBVeXGrNAfoWfyRgl4aC2RRSGgiDpmbrocv4lTSJMA!/o/dJIAAAAAAAAA&ek=1&kp=1&pt=0&bo=gAIFAYACBQEDACU!&su=1176931729&sce=0-12-12&rf=2-9)\n \n \n \n应用程序的根直接引用对象A 、C、D 、F。所有的对象都已经被标记。标记对象D时，GC发现这个对象含有一个引用对象H的字段，造成对象H也被标记。标记过程会持续，直至应用程序的所有根所有检查完毕。\n检查完毕后，堆中的对象要么已标记，要么未标记。已标记的对象不能被垃圾回收，因为至少有一个根在引用它。我们说这种对象是可达的，因为应用程序可以通过引用它的变量抵达它。 未标记的对象是不可达的，因为应用程序中不存在使对象能被再次访问的根。\n\n\n\n\nCLR知道哪些对象可以幸存，哪些可以被删除后，进入GC的压缩（类似于碎片整理）阶段。在压缩阶段，CLR对堆中已标记的对象进行“乾坤大挪移”，整理所有幸存下来的对象，使他们占用连续的内存。\n\n\n这样做的好处在于：\n\n\n1、所有幸存对象在内存中紧挨在一起，恢复了引用的“局部性”，减少了应用程序的工作集，从而提升了将来访问这些对象时的性能；\n\n\n2、经过整理后，可用空间也是连续的，整个地址空间区段得到了解放，允许其他东西进驻。\n\n\n\n在内存中移动了对象之后有一个问题亟待解决。引用幸存对象的根现在引用的还是对象最初在内存中的位置，而非移动后的位置。被暂停的线程恢复执行时，将访问旧的内存位置，会造成内存损坏。 这显然是不能容忍的，所以作为压缩阶段的一部分，CLR还要从每个根减去所引用对象在内存中偏移的字节数。这样就能保证每个根还是引用和之前一样的对象，只是对象在内存中变换了位置。\n如图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/FyP2yk1O6kMsq3.u4e4x3qrAxpwbajgSHOd4QHTJOhE!/o/dJIAAAAAAAAA&ek=1&kp=1&pt=0&bo=TQI*AU0CPwEDACU!&su=1202148209&sce=0-12-12&rf=2-9)\n\n\n\n\n\n\n\n\n##代：提升性能 (待续)\nCLR的GC是基于代的垃圾回收器，它对你的代码做出了以下几点假设：\n\n\n1、对象越新，生存周期越短。\n\n\n2、对象越老，生存周期越长。\n\n\n3、回收堆的一部分 ，速度快于回收整个堆。\n\n\n大量研究表明，这些假设对于现今大多数的应用程序都是成立的，它们影响了垃圾回收器的实现方式。这里将解释代的工作原理。\n\n托管堆在初始化时不包括对象。添加到堆的对象成为第0代对象。简单来说，第0代对象就是那些新构造的对象，垃圾回收器从未检查过它们。如下图，新启动的应用程序，分配了5个对象（从A到E）。过了一会，C和E变得不可达了。\n\n\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/77WJus7lssJpEJ2RZREQoNx.5CL31HLdboJbAgCqS0E!/o/dJMAAAAAAAAA&ek=1&kp=1&pt=0&bo=tQIVAbUCFQEDACU!&su=172682065&sce=0-12-12&rf=2-9)\n\nCLR初始化第0代对象选择一个预算容量。如果分配一个新对象造成第0代超预算，就必须启动一次GC。假设对象A到E刚好用完了第0代的空间，那么分配对象F就必须启动GC。GC之后存活的对象现场成为第1代对象。如下图：\n\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/GEDzaV4pNFNQUuDwl2EQrv*eD9Sk9OJCzx5SpRRI2fk!/o/dGUBAAAAAAAA&ek=1&kp=1&pt=0&bo=OAL5ADgC.QADACU!&su=1155276897&sce=0-12-12&rf=2-9)\n一次GC之后，第0代就不包含任何对象。和前面一样，新对象会分配到第0代。新分配对象F到对象K都到了第0代。\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/Op0QokzBTNYCFR6zzm2tpc2V7U70IsIJTeWrd0UAUb0!/o/dGUBAAAAAAAA&ek=1&kp=1&pt=0&bo=yAJeAcgCXgEDACU!&su=1124261217&sce=0-12-12&rf=2-9)\n\n之后，程序继续运行，B、H、J变得不可达，它们的内存将在某一个时刻回收。\n\n假设现在新分配对象L会造成第0代超出预算,造成必须启动垃圾回收。\n\n\n开始垃圾回收时,垃圾回收器必须决定检查哪些代。前面说过,CLR初始化时会为第0代对象选择预算.事实上,它还必须为第1代选择预算.\n\n\n开始一次垃圾回收时,垃圾回收器还会检查第一代占用了多少内存。在本例中,由于第1代占用内存远少于预算,所以垃圾回收器只检查第0代对象。回顾之前基于代的垃圾回收器做出的第一个假设：对象越新，生存期越短。 因此，第0代包含更多的垃圾的可能性更大，能回收更多的内存。由于忽略第1代中的对象，所以加快了垃圾回收速度。\n\n\n\n\n显然，忽略第1代中的对象能提升垃圾回收器的性能。但对性能有更大提振作用的是现在不必遍历托管堆中的每个对象。如果根或对象引用了老一代的某个对象，垃圾回收器就可以忽略老对象内部的所有引用，能在更短的时间内构造好可达对象图。当然，如果老对象的字段也可能引用新对象。为了确保对老对象的已更新字段进行检查，垃圾回收器利用了JIT编译器内部的一个机制。这个机制在对象的引用字段发生变化时，会设置一个对应的标志位。这样，垃圾回收器就知道自上一次垃圾回收以来，哪些老对象（如果有的话）已被写入。只有字段发生变化的老对象才需要检查是否引用了第0代中的任何新对象。\n\n\n\n基于代的垃圾回收器还假设越老的对象活得越长。也就是说，第1代对象在应用程序中有可能是继续可达的。如果垃圾回收器检查第1代的对象，很有可能找不到多少垃圾，结果是也回收不了多少内存。因此，对第1代进行垃圾回收很可能是浪费时间的。如果第一代真有垃圾，垃圾将留在那里。如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/Do.yRCBJEnaOfZaUOdxj4II9*pX2BEcX2QmIG6NQPBE!/o/dGUBAAAAAAAA&ek=1&kp=1&pt=0&bo=qAI5AagCOQEDACU!&su=187009937&sce=0-12-12&rf=2-9)\n\n程序继续运行，继续往第0代分配对象，同时程序停止对第1代某对象的使用。\n\n\n如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/YEqIM16xFsSgXdvEzgrerLnKw7fEItnrSqEzlaYnUfE!/o/dGUBAAAAAAAA&ek=1&kp=1&pt=0&bo=egJPAXoCTwEDACU!&su=1118118497&sce=0-12-12&rf=2-9)\n分配对象P导致第0代超预算，开始GC。第1代的所有对象占据内存仍小于预算，垃圾回收器再次决定只回收第0代。忽略第1代中的垃圾对象。如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/EcdSNU5AatqRERWtVdlJ7LiIPHHXe8.mklN.0hHDK9U!/o/dJQAAAAAAAAA&ek=1&kp=1&pt=0&bo=aAIxAWgCMQEDACU!&su=1214124305&sce=0-12-12&rf=2-9)\n\n\n程序继续运行，假设第一代的增长导致它的全部对象占用了全部预算。这时候应用程序分配对象P到对象S，使第0代对象达到它的预算总和。如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/6dB68RIUYrqMZ4p0VIY3REJZPg.g3ybkZFIazJ3h.CQ!/o/dJIAAAAAAAAA&ek=1&kp=1&pt=0&bo=jwIiAY8CIgEDACU!&su=177976657&sce=0-12-12&rf=2-9)\n\n\n这时候，应用程序准备分配对象T，由于第一代已满，所以必须开始GC。但这一次垃圾回收器发现第一代占用了太多内存，以至于用完了预算。由于前几次对第0代进行GC时，第1代中可能已经有很多对象变得不可达。所以这次垃圾回收器决定检查第1代和第0代中的所有对象。两代都被垃圾回收后，堆的情况如下图：\n![](http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/bxdZDsZi2Y6FSDWs7RXNPkkJK8dCzMD.cfnjwNY2Mjs!/o/dJIAAAAAAAAA&ek=1&kp=1&pt=0&bo=tgI2AbYCNgEDACU!&su=197762641&sce=0-12-12&rf=2-9)\n\n\n\n托管堆只支持三代：第0代、第1代和第2代。\n\n\nCLR初始化时，会为每一代选择预算。\n\n\n然而，CLR的垃圾回收是自调节的。\n\n\n这意味着垃圾回收器会在执行垃圾回收的过程了解程序的行为。\n\n\n例如：假设应用程序构造了许多对象，但每个对象的时间都很短。\n在这种情况下，对第0代的垃圾回收会回收到大量的内存。事实上，第0代的所有对象都可能被回收。\n\n\n\n如果垃圾回收器发现在回收第0代后存活下来的对象很少，就可能减少第0代的预算。已分配空间的减少意味着垃圾回收将更频繁地发生，但垃圾回收器每次做的事情也减少，这减少了进程的工作集。\n\n\n\n另一方面，如果垃圾回收器回收了第0代，发现还有很多对象存活，没多少内存可以被回收，就会增大第0代的预算。\n\n同样的启发性算法调整预算适用于了第1代和第2代的预算。\n\n引自：《CLR VIA C# -21章》\n\n\n[自动内存管理](https://msdn.microsoft.com/zh-cn/library/vstudio/f144e03t(v=vs.100).aspx)\n\n\n[垃圾回收的基础](https://msdn.microsoft.com/zh-cn/library/vstudio/ee787088(v=vs.100).aspx)\n\n\n[代数](https://msdn.microsoft.com/zh-cn/library/vstudio/ee787088(v=vs.100).aspx#generations )","slug":"GC-1","published":1,"updated":"2016-09-15T05:11:13.650Z","comments":1,"photos":[],"link":"","_id":"cit3xw9ss000dc0tx5cbem0t6","content":"<p>###托管堆基础<br> 简述：每个程序都要使用这样或那样的资源，包括文件、内存缓冲区、屏幕空间、网络连接…..事实上，在面向对象的环境中，每个类型都代表可供程序使用的一种资源。要使用这些资源，必须为代表资源的类型分配内存。</p>\n<p> 以下是访问一个资源所需步骤：</p>\n<ol>\n<li>调用IL指令newobj，为代表资源的类型分配内存。(C# new操作符)</li>\n<li>初始化内存，设置资源的初始状态。（一般指构造函数）</li>\n<li>访问类型的成员来使用资源。（使用成员变量、方法、属性等）</li>\n<li>摧毁资源的状态以进行清除。（Dispose？？？）</li>\n<li>释放内存。（GC） </li>\n</ol>\n<p>###从托管堆分配资源</p>\n<p>CLR要求所有的对象都从托管堆分配。<br>进程初始化，CLR划出一个地址空间区域作为托管堆。CLR还要维护一个指针，姑且叫NextObjPtr，该指针指向下一个对象在堆中的分配位置。刚开始的时候， NextObjPtr 设为地址空间区域的基地址。<br>一个区域被非垃圾对象填满后，CLR会分配更多的区域。</p>\n<p>这一个过程一直重复，直至整个进程地址空间被填满。所以，应用程序内存收进程的虚拟地址空间的限制。</p>\n<p>32位进程最多能分配1.5GB，64位进程最多能分配8T。<br>注：进程内存大小的相关资料</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/windows/hardware/Dn613959(v=vs.85\" target=\"_blank\" rel=\"external\">Memory Support and Windows Operating Systems</a>.aspx)</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/ms189334.aspx\" target=\"_blank\" rel=\"external\">进程地址空间</a></p>\n<p><a href=\"http://blog.csdn.net/yusiguyuan/article/details/12405799\" target=\"_blank\" rel=\"external\"> 32位模式下C/C++程序可用最大内存</a></p>\n<p>###C# 的new操作符导致CLR执行以下操作：</p>\n<p>1、计算类型的字段（以及从基类型继承的字段）所需要的字节数。</p>\n<p>2、加上对象的开销所需的字节数。每个对象都有两个开销字段：类型对象指针和同步块索引。对于32位应用程序，这两个字段各需要32位，所以每个对象需要增加8字节。对于64位应用程序，这两个字段各需要64位，所以每个对象要增加16字节。</p>\n<p>3、CLR检查区域中是否有分配对象所需的字节数。如果托管堆有足够的可用空间，就在NetxObjPtr指针指向的地址处放入对象，为对象分配的字节会被清零。接着调用类型的构造器（为this参数传递NextObjPtr），new操作符返回对象引用。就在返回这个对象引用之前，NextObjPtr指针的值会加上这个对象占用的字节数来得到一个新值，即下个对象放入托管堆时的地址。如下图：</p>\n<p><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/i3rlSCPAcnT9pL0El0BptPIBpuvnxHpBw9Nkp*UqIjw!/o/dJMAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=LwKNAC8CjQADACU!&amp;su=1199793361&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>###垃圾回收算法</p>\n<p>####CLR使用引用跟踪算法。<br>引用跟踪算法只关心引用类型的变量，因为只有这种变量才能引用堆上面的对象；<br>值类型变量直接包含值类型实例。引用类型变量可在许多场合使用，包括类的静态和实例字段，或者方法的参数和局部变量。这里我们将所有引用类型的变量都称为根。<br>CLR开始GC时，首先暂停所有的线程。(这样可以防止线程在CLR检查期间访问对象并更改其状态。) 然后CLR进入GC标记阶段。在这个阶段，CLR遍历堆中的所有对象，将同步块索引字段中的一位设为0。这表明所有的对象都应删除。然后，CLR检查所有的活动根，查看他们引用了哪些对象。这正是CLR的GC被称作引用跟踪GC的原因。如果一个根包含null，CLR忽略这个根并继续检查下一个根。<br>下图展示一个堆，其中包含几个对象。<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/eVBVeXGrNAfoWfyRgl4aC2RRSGgiDpmbrocv4lTSJMA!/o/dJIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=gAIFAYACBQEDACU!&amp;su=1176931729&amp;sce=0-12-12&amp;rf=2-9\" alt=\"图片1\"></p>\n<p>应用程序的根直接引用对象A 、C、D 、F。所有的对象都已经被标记。标记对象D时，GC发现这个对象含有一个引用对象H的字段，造成对象H也被标记。标记过程会持续，直至应用程序的所有根所有检查完毕。<br>检查完毕后，堆中的对象要么已标记，要么未标记。已标记的对象不能被垃圾回收，因为至少有一个根在引用它。我们说这种对象是可达的，因为应用程序可以通过引用它的变量抵达它。 未标记的对象是不可达的，因为应用程序中不存在使对象能被再次访问的根。</p>\n<p>CLR知道哪些对象可以幸存，哪些可以被删除后，进入GC的压缩（类似于碎片整理）阶段。在压缩阶段，CLR对堆中已标记的对象进行“乾坤大挪移”，整理所有幸存下来的对象，使他们占用连续的内存。</p>\n<p>这样做的好处在于：</p>\n<p>1、所有幸存对象在内存中紧挨在一起，恢复了引用的“局部性”，减少了应用程序的工作集，从而提升了将来访问这些对象时的性能；</p>\n<p>2、经过整理后，可用空间也是连续的，整个地址空间区段得到了解放，允许其他东西进驻。</p>\n<p>在内存中移动了对象之后有一个问题亟待解决。引用幸存对象的根现在引用的还是对象最初在内存中的位置，而非移动后的位置。被暂停的线程恢复执行时，将访问旧的内存位置，会造成内存损坏。 这显然是不能容忍的，所以作为压缩阶段的一部分，CLR还要从每个根减去所引用对象在内存中偏移的字节数。这样就能保证每个根还是引用和之前一样的对象，只是对象在内存中变换了位置。<br>如图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/FyP2yk1O6kMsq3.u4e4x3qrAxpwbajgSHOd4QHTJOhE!/o/dJIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=TQI*AU0CPwEDACU!&amp;su=1202148209&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>##代：提升性能 (待续)<br>CLR的GC是基于代的垃圾回收器，它对你的代码做出了以下几点假设：</p>\n<p>1、对象越新，生存周期越短。</p>\n<p>2、对象越老，生存周期越长。</p>\n<p>3、回收堆的一部分 ，速度快于回收整个堆。</p>\n<p>大量研究表明，这些假设对于现今大多数的应用程序都是成立的，它们影响了垃圾回收器的实现方式。这里将解释代的工作原理。</p>\n<p>托管堆在初始化时不包括对象。添加到堆的对象成为第0代对象。简单来说，第0代对象就是那些新构造的对象，垃圾回收器从未检查过它们。如下图，新启动的应用程序，分配了5个对象（从A到E）。过了一会，C和E变得不可达了。</p>\n<p><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/77WJus7lssJpEJ2RZREQoNx.5CL31HLdboJbAgCqS0E!/o/dJMAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=tQIVAbUCFQEDACU!&amp;su=172682065&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>CLR初始化第0代对象选择一个预算容量。如果分配一个新对象造成第0代超预算，就必须启动一次GC。假设对象A到E刚好用完了第0代的空间，那么分配对象F就必须启动GC。GC之后存活的对象现场成为第1代对象。如下图：</p>\n<p><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/GEDzaV4pNFNQUuDwl2EQrv*eD9Sk9OJCzx5SpRRI2fk!/o/dGUBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=OAL5ADgC.QADACU!&amp;su=1155276897&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"><br>一次GC之后，第0代就不包含任何对象。和前面一样，新对象会分配到第0代。新分配对象F到对象K都到了第0代。<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/Op0QokzBTNYCFR6zzm2tpc2V7U70IsIJTeWrd0UAUb0!/o/dGUBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=yAJeAcgCXgEDACU!&amp;su=1124261217&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>之后，程序继续运行，B、H、J变得不可达，它们的内存将在某一个时刻回收。</p>\n<p>假设现在新分配对象L会造成第0代超出预算,造成必须启动垃圾回收。</p>\n<p>开始垃圾回收时,垃圾回收器必须决定检查哪些代。前面说过,CLR初始化时会为第0代对象选择预算.事实上,它还必须为第1代选择预算.</p>\n<p>开始一次垃圾回收时,垃圾回收器还会检查第一代占用了多少内存。在本例中,由于第1代占用内存远少于预算,所以垃圾回收器只检查第0代对象。回顾之前基于代的垃圾回收器做出的第一个假设：对象越新，生存期越短。 因此，第0代包含更多的垃圾的可能性更大，能回收更多的内存。由于忽略第1代中的对象，所以加快了垃圾回收速度。</p>\n<p>显然，忽略第1代中的对象能提升垃圾回收器的性能。但对性能有更大提振作用的是现在不必遍历托管堆中的每个对象。如果根或对象引用了老一代的某个对象，垃圾回收器就可以忽略老对象内部的所有引用，能在更短的时间内构造好可达对象图。当然，如果老对象的字段也可能引用新对象。为了确保对老对象的已更新字段进行检查，垃圾回收器利用了JIT编译器内部的一个机制。这个机制在对象的引用字段发生变化时，会设置一个对应的标志位。这样，垃圾回收器就知道自上一次垃圾回收以来，哪些老对象（如果有的话）已被写入。只有字段发生变化的老对象才需要检查是否引用了第0代中的任何新对象。</p>\n<p>基于代的垃圾回收器还假设越老的对象活得越长。也就是说，第1代对象在应用程序中有可能是继续可达的。如果垃圾回收器检查第1代的对象，很有可能找不到多少垃圾，结果是也回收不了多少内存。因此，对第1代进行垃圾回收很可能是浪费时间的。如果第一代真有垃圾，垃圾将留在那里。如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/Do.yRCBJEnaOfZaUOdxj4II9*pX2BEcX2QmIG6NQPBE!/o/dGUBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=qAI5AagCOQEDACU!&amp;su=187009937&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>程序继续运行，继续往第0代分配对象，同时程序停止对第1代某对象的使用。</p>\n<p>如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/YEqIM16xFsSgXdvEzgrerLnKw7fEItnrSqEzlaYnUfE!/o/dGUBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=egJPAXoCTwEDACU!&amp;su=1118118497&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"><br>分配对象P导致第0代超预算，开始GC。第1代的所有对象占据内存仍小于预算，垃圾回收器再次决定只回收第0代。忽略第1代中的垃圾对象。如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/EcdSNU5AatqRERWtVdlJ7LiIPHHXe8.mklN.0hHDK9U!/o/dJQAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=aAIxAWgCMQEDACU!&amp;su=1214124305&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>程序继续运行，假设第一代的增长导致它的全部对象占用了全部预算。这时候应用程序分配对象P到对象S，使第0代对象达到它的预算总和。如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/6dB68RIUYrqMZ4p0VIY3REJZPg.g3ybkZFIazJ3h.CQ!/o/dJIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=jwIiAY8CIgEDACU!&amp;su=177976657&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>这时候，应用程序准备分配对象T，由于第一代已满，所以必须开始GC。但这一次垃圾回收器发现第一代占用了太多内存，以至于用完了预算。由于前几次对第0代进行GC时，第1代中可能已经有很多对象变得不可达。所以这次垃圾回收器决定检查第1代和第0代中的所有对象。两代都被垃圾回收后，堆的情况如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/bxdZDsZi2Y6FSDWs7RXNPkkJK8dCzMD.cfnjwNY2Mjs!/o/dJIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=tgI2AbYCNgEDACU!&amp;su=197762641&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>托管堆只支持三代：第0代、第1代和第2代。</p>\n<p>CLR初始化时，会为每一代选择预算。</p>\n<p>然而，CLR的垃圾回收是自调节的。</p>\n<p>这意味着垃圾回收器会在执行垃圾回收的过程了解程序的行为。</p>\n<p>例如：假设应用程序构造了许多对象，但每个对象的时间都很短。<br>在这种情况下，对第0代的垃圾回收会回收到大量的内存。事实上，第0代的所有对象都可能被回收。</p>\n<p>如果垃圾回收器发现在回收第0代后存活下来的对象很少，就可能减少第0代的预算。已分配空间的减少意味着垃圾回收将更频繁地发生，但垃圾回收器每次做的事情也减少，这减少了进程的工作集。</p>\n<p>另一方面，如果垃圾回收器回收了第0代，发现还有很多对象存活，没多少内存可以被回收，就会增大第0代的预算。</p>\n<p>同样的启发性算法调整预算适用于了第1代和第2代的预算。</p>\n<p>引自：《CLR VIA C# -21章》</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/vstudio/f144e03t(v=vs.100\" target=\"_blank\" rel=\"external\">自动内存管理</a>.aspx)</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/vstudio/ee787088(v=vs.100\" target=\"_blank\" rel=\"external\">垃圾回收的基础</a>.aspx)</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/vstudio/ee787088(v=vs.100\" target=\"_blank\" rel=\"external\">代数</a>.aspx#generations )</p>\n","excerpt":"","more":"<p>###托管堆基础<br> 简述：每个程序都要使用这样或那样的资源，包括文件、内存缓冲区、屏幕空间、网络连接…..事实上，在面向对象的环境中，每个类型都代表可供程序使用的一种资源。要使用这些资源，必须为代表资源的类型分配内存。</p>\n<p> 以下是访问一个资源所需步骤：</p>\n<ol>\n<li>调用IL指令newobj，为代表资源的类型分配内存。(C# new操作符)</li>\n<li>初始化内存，设置资源的初始状态。（一般指构造函数）</li>\n<li>访问类型的成员来使用资源。（使用成员变量、方法、属性等）</li>\n<li>摧毁资源的状态以进行清除。（Dispose？？？）</li>\n<li>释放内存。（GC） </li>\n</ol>\n<p>###从托管堆分配资源</p>\n<p>CLR要求所有的对象都从托管堆分配。<br>进程初始化，CLR划出一个地址空间区域作为托管堆。CLR还要维护一个指针，姑且叫NextObjPtr，该指针指向下一个对象在堆中的分配位置。刚开始的时候， NextObjPtr 设为地址空间区域的基地址。<br>一个区域被非垃圾对象填满后，CLR会分配更多的区域。</p>\n<p>这一个过程一直重复，直至整个进程地址空间被填满。所以，应用程序内存收进程的虚拟地址空间的限制。</p>\n<p>32位进程最多能分配1.5GB，64位进程最多能分配8T。<br>注：进程内存大小的相关资料</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/windows/hardware/Dn613959(v=vs.85\">Memory Support and Windows Operating Systems</a>.aspx)</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/ms189334.aspx\">进程地址空间</a></p>\n<p><a href=\"http://blog.csdn.net/yusiguyuan/article/details/12405799\"> 32位模式下C/C++程序可用最大内存</a></p>\n<p>###C# 的new操作符导致CLR执行以下操作：</p>\n<p>1、计算类型的字段（以及从基类型继承的字段）所需要的字节数。</p>\n<p>2、加上对象的开销所需的字节数。每个对象都有两个开销字段：类型对象指针和同步块索引。对于32位应用程序，这两个字段各需要32位，所以每个对象需要增加8字节。对于64位应用程序，这两个字段各需要64位，所以每个对象要增加16字节。</p>\n<p>3、CLR检查区域中是否有分配对象所需的字节数。如果托管堆有足够的可用空间，就在NetxObjPtr指针指向的地址处放入对象，为对象分配的字节会被清零。接着调用类型的构造器（为this参数传递NextObjPtr），new操作符返回对象引用。就在返回这个对象引用之前，NextObjPtr指针的值会加上这个对象占用的字节数来得到一个新值，即下个对象放入托管堆时的地址。如下图：</p>\n<p><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/i3rlSCPAcnT9pL0El0BptPIBpuvnxHpBw9Nkp*UqIjw!/o/dJMAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=LwKNAC8CjQADACU!&amp;su=1199793361&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>###垃圾回收算法</p>\n<p>####CLR使用引用跟踪算法。<br>引用跟踪算法只关心引用类型的变量，因为只有这种变量才能引用堆上面的对象；<br>值类型变量直接包含值类型实例。引用类型变量可在许多场合使用，包括类的静态和实例字段，或者方法的参数和局部变量。这里我们将所有引用类型的变量都称为根。<br>CLR开始GC时，首先暂停所有的线程。(这样可以防止线程在CLR检查期间访问对象并更改其状态。) 然后CLR进入GC标记阶段。在这个阶段，CLR遍历堆中的所有对象，将同步块索引字段中的一位设为0。这表明所有的对象都应删除。然后，CLR检查所有的活动根，查看他们引用了哪些对象。这正是CLR的GC被称作引用跟踪GC的原因。如果一个根包含null，CLR忽略这个根并继续检查下一个根。<br>下图展示一个堆，其中包含几个对象。<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/eVBVeXGrNAfoWfyRgl4aC2RRSGgiDpmbrocv4lTSJMA!/o/dJIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=gAIFAYACBQEDACU!&amp;su=1176931729&amp;sce=0-12-12&amp;rf=2-9\" alt=\"图片1\"></p>\n<p>应用程序的根直接引用对象A 、C、D 、F。所有的对象都已经被标记。标记对象D时，GC发现这个对象含有一个引用对象H的字段，造成对象H也被标记。标记过程会持续，直至应用程序的所有根所有检查完毕。<br>检查完毕后，堆中的对象要么已标记，要么未标记。已标记的对象不能被垃圾回收，因为至少有一个根在引用它。我们说这种对象是可达的，因为应用程序可以通过引用它的变量抵达它。 未标记的对象是不可达的，因为应用程序中不存在使对象能被再次访问的根。</p>\n<p>CLR知道哪些对象可以幸存，哪些可以被删除后，进入GC的压缩（类似于碎片整理）阶段。在压缩阶段，CLR对堆中已标记的对象进行“乾坤大挪移”，整理所有幸存下来的对象，使他们占用连续的内存。</p>\n<p>这样做的好处在于：</p>\n<p>1、所有幸存对象在内存中紧挨在一起，恢复了引用的“局部性”，减少了应用程序的工作集，从而提升了将来访问这些对象时的性能；</p>\n<p>2、经过整理后，可用空间也是连续的，整个地址空间区段得到了解放，允许其他东西进驻。</p>\n<p>在内存中移动了对象之后有一个问题亟待解决。引用幸存对象的根现在引用的还是对象最初在内存中的位置，而非移动后的位置。被暂停的线程恢复执行时，将访问旧的内存位置，会造成内存损坏。 这显然是不能容忍的，所以作为压缩阶段的一部分，CLR还要从每个根减去所引用对象在内存中偏移的字节数。这样就能保证每个根还是引用和之前一样的对象，只是对象在内存中变换了位置。<br>如图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/FyP2yk1O6kMsq3.u4e4x3qrAxpwbajgSHOd4QHTJOhE!/o/dJIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=TQI*AU0CPwEDACU!&amp;su=1202148209&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>##代：提升性能 (待续)<br>CLR的GC是基于代的垃圾回收器，它对你的代码做出了以下几点假设：</p>\n<p>1、对象越新，生存周期越短。</p>\n<p>2、对象越老，生存周期越长。</p>\n<p>3、回收堆的一部分 ，速度快于回收整个堆。</p>\n<p>大量研究表明，这些假设对于现今大多数的应用程序都是成立的，它们影响了垃圾回收器的实现方式。这里将解释代的工作原理。</p>\n<p>托管堆在初始化时不包括对象。添加到堆的对象成为第0代对象。简单来说，第0代对象就是那些新构造的对象，垃圾回收器从未检查过它们。如下图，新启动的应用程序，分配了5个对象（从A到E）。过了一会，C和E变得不可达了。</p>\n<p><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/77WJus7lssJpEJ2RZREQoNx.5CL31HLdboJbAgCqS0E!/o/dJMAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=tQIVAbUCFQEDACU!&amp;su=172682065&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>CLR初始化第0代对象选择一个预算容量。如果分配一个新对象造成第0代超预算，就必须启动一次GC。假设对象A到E刚好用完了第0代的空间，那么分配对象F就必须启动GC。GC之后存活的对象现场成为第1代对象。如下图：</p>\n<p><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/GEDzaV4pNFNQUuDwl2EQrv*eD9Sk9OJCzx5SpRRI2fk!/o/dGUBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=OAL5ADgC.QADACU!&amp;su=1155276897&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"><br>一次GC之后，第0代就不包含任何对象。和前面一样，新对象会分配到第0代。新分配对象F到对象K都到了第0代。<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/Op0QokzBTNYCFR6zzm2tpc2V7U70IsIJTeWrd0UAUb0!/o/dGUBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=yAJeAcgCXgEDACU!&amp;su=1124261217&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>之后，程序继续运行，B、H、J变得不可达，它们的内存将在某一个时刻回收。</p>\n<p>假设现在新分配对象L会造成第0代超出预算,造成必须启动垃圾回收。</p>\n<p>开始垃圾回收时,垃圾回收器必须决定检查哪些代。前面说过,CLR初始化时会为第0代对象选择预算.事实上,它还必须为第1代选择预算.</p>\n<p>开始一次垃圾回收时,垃圾回收器还会检查第一代占用了多少内存。在本例中,由于第1代占用内存远少于预算,所以垃圾回收器只检查第0代对象。回顾之前基于代的垃圾回收器做出的第一个假设：对象越新，生存期越短。 因此，第0代包含更多的垃圾的可能性更大，能回收更多的内存。由于忽略第1代中的对象，所以加快了垃圾回收速度。</p>\n<p>显然，忽略第1代中的对象能提升垃圾回收器的性能。但对性能有更大提振作用的是现在不必遍历托管堆中的每个对象。如果根或对象引用了老一代的某个对象，垃圾回收器就可以忽略老对象内部的所有引用，能在更短的时间内构造好可达对象图。当然，如果老对象的字段也可能引用新对象。为了确保对老对象的已更新字段进行检查，垃圾回收器利用了JIT编译器内部的一个机制。这个机制在对象的引用字段发生变化时，会设置一个对应的标志位。这样，垃圾回收器就知道自上一次垃圾回收以来，哪些老对象（如果有的话）已被写入。只有字段发生变化的老对象才需要检查是否引用了第0代中的任何新对象。</p>\n<p>基于代的垃圾回收器还假设越老的对象活得越长。也就是说，第1代对象在应用程序中有可能是继续可达的。如果垃圾回收器检查第1代的对象，很有可能找不到多少垃圾，结果是也回收不了多少内存。因此，对第1代进行垃圾回收很可能是浪费时间的。如果第一代真有垃圾，垃圾将留在那里。如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/Do.yRCBJEnaOfZaUOdxj4II9*pX2BEcX2QmIG6NQPBE!/o/dGUBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=qAI5AagCOQEDACU!&amp;su=187009937&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>程序继续运行，继续往第0代分配对象，同时程序停止对第1代某对象的使用。</p>\n<p>如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/YEqIM16xFsSgXdvEzgrerLnKw7fEItnrSqEzlaYnUfE!/o/dGUBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=egJPAXoCTwEDACU!&amp;su=1118118497&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"><br>分配对象P导致第0代超预算，开始GC。第1代的所有对象占据内存仍小于预算，垃圾回收器再次决定只回收第0代。忽略第1代中的垃圾对象。如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/EcdSNU5AatqRERWtVdlJ7LiIPHHXe8.mklN.0hHDK9U!/o/dJQAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=aAIxAWgCMQEDACU!&amp;su=1214124305&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>程序继续运行，假设第一代的增长导致它的全部对象占用了全部预算。这时候应用程序分配对象P到对象S，使第0代对象达到它的预算总和。如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/6dB68RIUYrqMZ4p0VIY3REJZPg.g3ybkZFIazJ3h.CQ!/o/dJIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=jwIiAY8CIgEDACU!&amp;su=177976657&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>这时候，应用程序准备分配对象T，由于第一代已满，所以必须开始GC。但这一次垃圾回收器发现第一代占用了太多内存，以至于用完了预算。由于前几次对第0代进行GC时，第1代中可能已经有很多对象变得不可达。所以这次垃圾回收器决定检查第1代和第0代中的所有对象。两代都被垃圾回收后，堆的情况如下图：<br><img src=\"http://r.photo.store.qq.com/psb?/4d3e65a5-4593-42bc-88f9-7bbb2e647ebe/bxdZDsZi2Y6FSDWs7RXNPkkJK8dCzMD.cfnjwNY2Mjs!/o/dJIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=tgI2AbYCNgEDACU!&amp;su=197762641&amp;sce=0-12-12&amp;rf=2-9\" alt=\"\"></p>\n<p>托管堆只支持三代：第0代、第1代和第2代。</p>\n<p>CLR初始化时，会为每一代选择预算。</p>\n<p>然而，CLR的垃圾回收是自调节的。</p>\n<p>这意味着垃圾回收器会在执行垃圾回收的过程了解程序的行为。</p>\n<p>例如：假设应用程序构造了许多对象，但每个对象的时间都很短。<br>在这种情况下，对第0代的垃圾回收会回收到大量的内存。事实上，第0代的所有对象都可能被回收。</p>\n<p>如果垃圾回收器发现在回收第0代后存活下来的对象很少，就可能减少第0代的预算。已分配空间的减少意味着垃圾回收将更频繁地发生，但垃圾回收器每次做的事情也减少，这减少了进程的工作集。</p>\n<p>另一方面，如果垃圾回收器回收了第0代，发现还有很多对象存活，没多少内存可以被回收，就会增大第0代的预算。</p>\n<p>同样的启发性算法调整预算适用于了第1代和第2代的预算。</p>\n<p>引自：《CLR VIA C# -21章》</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/vstudio/f144e03t(v=vs.100\">自动内存管理</a>.aspx)</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/vstudio/ee787088(v=vs.100\">垃圾回收的基础</a>.aspx)</p>\n<p><a href=\"https://msdn.microsoft.com/zh-cn/library/vstudio/ee787088(v=vs.100\">代数</a>.aspx#generations )</p>\n"},{"layout":"post","title":"Jexus支持HTTPS协议","date":"2016-04-19T16:00:00.000Z","_content":"\n众所周知，在HTTPS页面请求HTTP资料的时候，现代浏览器会拦截，提示用户是否继续，或者直接拦截，提示都不出来。\n\n\n最近给自己做了个快速书签工具，点击书签就直接把书签发送到服务器地址，然后保存到我的网站中。\n\n一开始一切都挺正常的，不过遇到了https的网站的时候，就跪掉了。\n\n开始的时候看到HTTPS证书是收费的，想想还是算了，反正凑合能用就是。前几天偶尔看到有一个免费申请HTTPS的开源软件，喵了一下看起来还不错，这几天有空了立马开干。下面有一个教程，我申请证书差不多就是按照这个来处理的。\n\n[用Let’s Encrypt获取免费证书](https://www.paulyang.cn/blog/archives/39?spm=5176.blog2666.yqblogcon1.12.Nu0TgL)\n\n\n关于这个Let's Encrypt，维基百科是这样介绍的：\n\n> Let's Encrypt 是一个将于2015年末推出的数字证书认证机构，将通过旨在消除当前手动创建和安装证书的复杂过程的自动化流程，为安全网站提供免费的SSL/TLS证书。  Let's Encrypt 是由互联网安全研究小组（ISRG，一个公益组织）提供的服务。主要赞助商包括电子前哨基金会，Mozilla基金会，Akamai以及思科。2015年4月9日，ISRG与Linux基金会宣布合作。用以实现这一新的数字证书认证机构的协议被称为自动证书管理环境（ACME）。  GitHub上有这一规范的草案，且提案的一个版本已作为一个Internet草案发布。Let's Encrypt 宣称这一过程将十分简单、自动化并且免费。  2015年8月7日，该服务更新其推出计划，预计将在2015年9月7日当周某时发布首个证书，随后向列入白名单的域名发行少量证书并逐渐扩大发行。若一切按计划进行，该服务预计将在2015年11月16日当周某时全面开始提供.\n\n\n整个项目在Github有代码，主要是通过客户端来为我们的网站生成https证书。\n首先我们先下载客户端，如下：\n```shell\ngit clone https://github.com/letsencrypt/letsencrypt.git\n\n```\n接着进入这个仓库内，执行下面代码：\n```shell\n./letsencrypt-auto certonly -a \nwebroot\\ --webroot-path 网站所在路径(如：/var/www/web/) \\ \n-d 你的域名(如：test.online) -d www.你的域名(如ww.test.online)\n\n```\n这里需要注意的事，我这里为了排版，给上面的命令加了换行，运行这个命令的时候记得把换行符去掉。\n换行符在webroot、-d 前面各有一个。\n\n一切顺利的话，我们在`/etc/letsencrypt/live/域名/`这个目录下能看到四个文件，分别是：\n\n1. 域名证书文件\n2. 签发域名证书的证书链文件\n3. 域名证书+证书链文件\n4. 私钥文件\n\n如下图：\n![letsencrypt文件](http://7xread.com1.z0.glb.clouddn.com/60e4f29a-6da5-40e1-ae32-453a3bbf2455)\n\n接着就是为网站设置证书了。\n\n\nJexus设置HTTPS要更改jws.conf文档以及网站的配置文档。\n\n操作步骤如下：\n\n1. 修改jws.conf\n进入Jexus文件夹中，打开 “jws.conf”，添加下面两句：\n\n```shell\n\tCertificateFile    = /etc/letsencrypt/live/域名/fullchain.pem\n\tCertificateKeyFile = /etc/letsencrypt/live/域名/privkey.pem\n```\n\n修改之后效果图如下：\n![图片描述](http://7xread.com1.z0.glb.clouddn.com/d306d9c5-6391-421d-86fc-053b97d1b489)\n\n\n2. 开启网站的HTTPS功能\n\n进入siteconf/文件夹，找到对应的网站conf文件，\n\n把网站服务端口改为443：\nport=443\n\n启用https：\nUseHttps=true\n\n修改之后的效果图如下：\n![图片描述](http://7xread.com1.z0.glb.clouddn.com/0800dc87-2500-42d2-a3c5-a75a2c819330)\n\n然后重启jexus即可。\n\n完了之后，通过HTTPS即可访问。\n\n最后上一个HTTPS证书的图证明一下这个是可行的。\n![图片描述](http://7xread.com1.z0.glb.clouddn.com/24842774-311e-4e55-a6b5-b88a89edc754)\n\n\n撒花，下次再见。\n\n\n\n","source":"_posts/Jexus-support-HTTPS.md","raw":"---\nlayout: post\ntitle: Jexus支持HTTPS协议\ncategory: jexus\ndate: 2016-04-20 00:00:00\n---\n\n众所周知，在HTTPS页面请求HTTP资料的时候，现代浏览器会拦截，提示用户是否继续，或者直接拦截，提示都不出来。\n\n\n最近给自己做了个快速书签工具，点击书签就直接把书签发送到服务器地址，然后保存到我的网站中。\n\n一开始一切都挺正常的，不过遇到了https的网站的时候，就跪掉了。\n\n开始的时候看到HTTPS证书是收费的，想想还是算了，反正凑合能用就是。前几天偶尔看到有一个免费申请HTTPS的开源软件，喵了一下看起来还不错，这几天有空了立马开干。下面有一个教程，我申请证书差不多就是按照这个来处理的。\n\n[用Let’s Encrypt获取免费证书](https://www.paulyang.cn/blog/archives/39?spm=5176.blog2666.yqblogcon1.12.Nu0TgL)\n\n\n关于这个Let's Encrypt，维基百科是这样介绍的：\n\n> Let's Encrypt 是一个将于2015年末推出的数字证书认证机构，将通过旨在消除当前手动创建和安装证书的复杂过程的自动化流程，为安全网站提供免费的SSL/TLS证书。  Let's Encrypt 是由互联网安全研究小组（ISRG，一个公益组织）提供的服务。主要赞助商包括电子前哨基金会，Mozilla基金会，Akamai以及思科。2015年4月9日，ISRG与Linux基金会宣布合作。用以实现这一新的数字证书认证机构的协议被称为自动证书管理环境（ACME）。  GitHub上有这一规范的草案，且提案的一个版本已作为一个Internet草案发布。Let's Encrypt 宣称这一过程将十分简单、自动化并且免费。  2015年8月7日，该服务更新其推出计划，预计将在2015年9月7日当周某时发布首个证书，随后向列入白名单的域名发行少量证书并逐渐扩大发行。若一切按计划进行，该服务预计将在2015年11月16日当周某时全面开始提供.\n\n\n整个项目在Github有代码，主要是通过客户端来为我们的网站生成https证书。\n首先我们先下载客户端，如下：\n```shell\ngit clone https://github.com/letsencrypt/letsencrypt.git\n\n```\n接着进入这个仓库内，执行下面代码：\n```shell\n./letsencrypt-auto certonly -a \nwebroot\\ --webroot-path 网站所在路径(如：/var/www/web/) \\ \n-d 你的域名(如：test.online) -d www.你的域名(如ww.test.online)\n\n```\n这里需要注意的事，我这里为了排版，给上面的命令加了换行，运行这个命令的时候记得把换行符去掉。\n换行符在webroot、-d 前面各有一个。\n\n一切顺利的话，我们在`/etc/letsencrypt/live/域名/`这个目录下能看到四个文件，分别是：\n\n1. 域名证书文件\n2. 签发域名证书的证书链文件\n3. 域名证书+证书链文件\n4. 私钥文件\n\n如下图：\n![letsencrypt文件](http://7xread.com1.z0.glb.clouddn.com/60e4f29a-6da5-40e1-ae32-453a3bbf2455)\n\n接着就是为网站设置证书了。\n\n\nJexus设置HTTPS要更改jws.conf文档以及网站的配置文档。\n\n操作步骤如下：\n\n1. 修改jws.conf\n进入Jexus文件夹中，打开 “jws.conf”，添加下面两句：\n\n```shell\n\tCertificateFile    = /etc/letsencrypt/live/域名/fullchain.pem\n\tCertificateKeyFile = /etc/letsencrypt/live/域名/privkey.pem\n```\n\n修改之后效果图如下：\n![图片描述](http://7xread.com1.z0.glb.clouddn.com/d306d9c5-6391-421d-86fc-053b97d1b489)\n\n\n2. 开启网站的HTTPS功能\n\n进入siteconf/文件夹，找到对应的网站conf文件，\n\n把网站服务端口改为443：\nport=443\n\n启用https：\nUseHttps=true\n\n修改之后的效果图如下：\n![图片描述](http://7xread.com1.z0.glb.clouddn.com/0800dc87-2500-42d2-a3c5-a75a2c819330)\n\n然后重启jexus即可。\n\n完了之后，通过HTTPS即可访问。\n\n最后上一个HTTPS证书的图证明一下这个是可行的。\n![图片描述](http://7xread.com1.z0.glb.clouddn.com/24842774-311e-4e55-a6b5-b88a89edc754)\n\n\n撒花，下次再见。\n\n\n\n","slug":"Jexus-support-HTTPS","published":1,"updated":"2016-09-15T05:11:13.650Z","comments":1,"photos":[],"link":"","_id":"cit3xw9sw000ec0txfu5a1bm2","content":"<p>众所周知，在HTTPS页面请求HTTP资料的时候，现代浏览器会拦截，提示用户是否继续，或者直接拦截，提示都不出来。</p>\n<p>最近给自己做了个快速书签工具，点击书签就直接把书签发送到服务器地址，然后保存到我的网站中。</p>\n<p>一开始一切都挺正常的，不过遇到了https的网站的时候，就跪掉了。</p>\n<p>开始的时候看到HTTPS证书是收费的，想想还是算了，反正凑合能用就是。前几天偶尔看到有一个免费申请HTTPS的开源软件，喵了一下看起来还不错，这几天有空了立马开干。下面有一个教程，我申请证书差不多就是按照这个来处理的。</p>\n<p><a href=\"https://www.paulyang.cn/blog/archives/39?spm=5176.blog2666.yqblogcon1.12.Nu0TgL\" target=\"_blank\" rel=\"external\">用Let’s Encrypt获取免费证书</a></p>\n<p>关于这个Let’s Encrypt，维基百科是这样介绍的：</p>\n<blockquote>\n<p>Let’s Encrypt 是一个将于2015年末推出的数字证书认证机构，将通过旨在消除当前手动创建和安装证书的复杂过程的自动化流程，为安全网站提供免费的SSL/TLS证书。  Let’s Encrypt 是由互联网安全研究小组（ISRG，一个公益组织）提供的服务。主要赞助商包括电子前哨基金会，Mozilla基金会，Akamai以及思科。2015年4月9日，ISRG与Linux基金会宣布合作。用以实现这一新的数字证书认证机构的协议被称为自动证书管理环境（ACME）。  GitHub上有这一规范的草案，且提案的一个版本已作为一个Internet草案发布。Let’s Encrypt 宣称这一过程将十分简单、自动化并且免费。  2015年8月7日，该服务更新其推出计划，预计将在2015年9月7日当周某时发布首个证书，随后向列入白名单的域名发行少量证书并逐渐扩大发行。若一切按计划进行，该服务预计将在2015年11月16日当周某时全面开始提供.</p>\n</blockquote>\n<p>整个项目在Github有代码，主要是通过客户端来为我们的网站生成https证书。<br>首先我们先下载客户端，如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">git clone https://github.com/letsencrypt/letsencrypt.git</div></pre></td></tr></table></figure></p>\n<p>接着进入这个仓库内，执行下面代码：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">./letsencrypt-auto certonly -a </div><div class=\"line\">webroot\\ --webroot-path 网站所在路径(如：/var/www/web/) \\ </div><div class=\"line\">-d 你的域名(如：test.online) -d www.你的域名(如ww.test.online)</div></pre></td></tr></table></figure></p>\n<p>这里需要注意的事，我这里为了排版，给上面的命令加了换行，运行这个命令的时候记得把换行符去掉。<br>换行符在webroot、-d 前面各有一个。</p>\n<p>一切顺利的话，我们在<code>/etc/letsencrypt/live/域名/</code>这个目录下能看到四个文件，分别是：</p>\n<ol>\n<li>域名证书文件</li>\n<li>签发域名证书的证书链文件</li>\n<li>域名证书+证书链文件</li>\n<li>私钥文件</li>\n</ol>\n<p>如下图：<br><img src=\"http://7xread.com1.z0.glb.clouddn.com/60e4f29a-6da5-40e1-ae32-453a3bbf2455\" alt=\"letsencrypt文件\"></p>\n<p>接着就是为网站设置证书了。</p>\n<p>Jexus设置HTTPS要更改jws.conf文档以及网站的配置文档。</p>\n<p>操作步骤如下：</p>\n<ol>\n<li>修改jws.conf<br>进入Jexus文件夹中，打开 “jws.conf”，添加下面两句：</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">CertificateFile    = /etc/letsencrypt/live/域名/fullchain.pem</div><div class=\"line\">CertificateKeyFile = /etc/letsencrypt/live/域名/privkey.pem</div></pre></td></tr></table></figure>\n<p>修改之后效果图如下：<br><img src=\"http://7xread.com1.z0.glb.clouddn.com/d306d9c5-6391-421d-86fc-053b97d1b489\" alt=\"图片描述\"></p>\n<ol>\n<li>开启网站的HTTPS功能</li>\n</ol>\n<p>进入siteconf/文件夹，找到对应的网站conf文件，</p>\n<p>把网站服务端口改为443：<br>port=443</p>\n<p>启用https：<br>UseHttps=true</p>\n<p>修改之后的效果图如下：<br><img src=\"http://7xread.com1.z0.glb.clouddn.com/0800dc87-2500-42d2-a3c5-a75a2c819330\" alt=\"图片描述\"></p>\n<p>然后重启jexus即可。</p>\n<p>完了之后，通过HTTPS即可访问。</p>\n<p>最后上一个HTTPS证书的图证明一下这个是可行的。<br><img src=\"http://7xread.com1.z0.glb.clouddn.com/24842774-311e-4e55-a6b5-b88a89edc754\" alt=\"图片描述\"></p>\n<p>撒花，下次再见。</p>\n","excerpt":"","more":"<p>众所周知，在HTTPS页面请求HTTP资料的时候，现代浏览器会拦截，提示用户是否继续，或者直接拦截，提示都不出来。</p>\n<p>最近给自己做了个快速书签工具，点击书签就直接把书签发送到服务器地址，然后保存到我的网站中。</p>\n<p>一开始一切都挺正常的，不过遇到了https的网站的时候，就跪掉了。</p>\n<p>开始的时候看到HTTPS证书是收费的，想想还是算了，反正凑合能用就是。前几天偶尔看到有一个免费申请HTTPS的开源软件，喵了一下看起来还不错，这几天有空了立马开干。下面有一个教程，我申请证书差不多就是按照这个来处理的。</p>\n<p><a href=\"https://www.paulyang.cn/blog/archives/39?spm=5176.blog2666.yqblogcon1.12.Nu0TgL\">用Let’s Encrypt获取免费证书</a></p>\n<p>关于这个Let’s Encrypt，维基百科是这样介绍的：</p>\n<blockquote>\n<p>Let’s Encrypt 是一个将于2015年末推出的数字证书认证机构，将通过旨在消除当前手动创建和安装证书的复杂过程的自动化流程，为安全网站提供免费的SSL/TLS证书。  Let’s Encrypt 是由互联网安全研究小组（ISRG，一个公益组织）提供的服务。主要赞助商包括电子前哨基金会，Mozilla基金会，Akamai以及思科。2015年4月9日，ISRG与Linux基金会宣布合作。用以实现这一新的数字证书认证机构的协议被称为自动证书管理环境（ACME）。  GitHub上有这一规范的草案，且提案的一个版本已作为一个Internet草案发布。Let’s Encrypt 宣称这一过程将十分简单、自动化并且免费。  2015年8月7日，该服务更新其推出计划，预计将在2015年9月7日当周某时发布首个证书，随后向列入白名单的域名发行少量证书并逐渐扩大发行。若一切按计划进行，该服务预计将在2015年11月16日当周某时全面开始提供.</p>\n</blockquote>\n<p>整个项目在Github有代码，主要是通过客户端来为我们的网站生成https证书。<br>首先我们先下载客户端，如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">git clone https://github.com/letsencrypt/letsencrypt.git</div></pre></td></tr></table></figure></p>\n<p>接着进入这个仓库内，执行下面代码：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">./letsencrypt-auto certonly -a </div><div class=\"line\">webroot\\ --webroot-path 网站所在路径(如：/var/www/web/) \\ </div><div class=\"line\">-d 你的域名(如：test.online) -d www.你的域名(如ww.test.online)</div></pre></td></tr></table></figure></p>\n<p>这里需要注意的事，我这里为了排版，给上面的命令加了换行，运行这个命令的时候记得把换行符去掉。<br>换行符在webroot、-d 前面各有一个。</p>\n<p>一切顺利的话，我们在<code>/etc/letsencrypt/live/域名/</code>这个目录下能看到四个文件，分别是：</p>\n<ol>\n<li>域名证书文件</li>\n<li>签发域名证书的证书链文件</li>\n<li>域名证书+证书链文件</li>\n<li>私钥文件</li>\n</ol>\n<p>如下图：<br><img src=\"http://7xread.com1.z0.glb.clouddn.com/60e4f29a-6da5-40e1-ae32-453a3bbf2455\" alt=\"letsencrypt文件\"></p>\n<p>接着就是为网站设置证书了。</p>\n<p>Jexus设置HTTPS要更改jws.conf文档以及网站的配置文档。</p>\n<p>操作步骤如下：</p>\n<ol>\n<li>修改jws.conf<br>进入Jexus文件夹中，打开 “jws.conf”，添加下面两句：</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">CertificateFile    = /etc/letsencrypt/live/域名/fullchain.pem</div><div class=\"line\">CertificateKeyFile = /etc/letsencrypt/live/域名/privkey.pem</div></pre></td></tr></table></figure>\n<p>修改之后效果图如下：<br><img src=\"http://7xread.com1.z0.glb.clouddn.com/d306d9c5-6391-421d-86fc-053b97d1b489\" alt=\"图片描述\"></p>\n<ol>\n<li>开启网站的HTTPS功能</li>\n</ol>\n<p>进入siteconf/文件夹，找到对应的网站conf文件，</p>\n<p>把网站服务端口改为443：<br>port=443</p>\n<p>启用https：<br>UseHttps=true</p>\n<p>修改之后的效果图如下：<br><img src=\"http://7xread.com1.z0.glb.clouddn.com/0800dc87-2500-42d2-a3c5-a75a2c819330\" alt=\"图片描述\"></p>\n<p>然后重启jexus即可。</p>\n<p>完了之后，通过HTTPS即可访问。</p>\n<p>最后上一个HTTPS证书的图证明一下这个是可行的。<br><img src=\"http://7xread.com1.z0.glb.clouddn.com/24842774-311e-4e55-a6b5-b88a89edc754\" alt=\"图片描述\"></p>\n<p>撒花，下次再见。</p>\n"},{"layout":"post","title":".NET-join用法","date":"2016-03-02T16:00:00.000Z","_content":"\n\n#.NET   Join\n 连接：内连接、外连接、左连接、右连接。\nSQL的Join这里就不多说了，\n今天主要是看一下LINQ的Join用法，以及Enumerable.Join()的用法。\n\nJoin用于连接数据，首先就是数据之间有联系咯。\n \n先说Enumerable.Join()。\n参数类型如下：\n\t\t\tpublic static IEnumerable<TResult> Join<TOuter, TInner, TKey, TResult>\n\t\t\t(      \n\t\t\t         this IEnumerable<TOuter> outer,\n\t\t\t        IEnumerable<TInner> inner,\n\t\t\t        Func<TOuter, TKey> outerKeySelector,\n\t\t\t        Func<TInner, TKey> innerKeySelector,\n\t\t\t        Func<TOuter, TInner, TResult> resultSelector\n\t\t\t) \n类型参数\nTOuter\n第一个序列中的元素的类型。\nTInner\n第二个序列中的元素的类型。\nTKey\n键选择器函数返回的键的类型。\nTResult\n结果元素的类型。\n参数\nouter\n类型：System.Collections.Generic.IEnumerable<TOuter>\n要联接的第一个序列。\ninner\n类型：System.Collections.Generic.IEnumerable<TInner>\n要与第一个序列联接的序列。\nouterKeySelector\n类型：System.Func<TOuter, TKey>\n用于从第一个序列的每个元素提取联接键的函数。\ninnerKeySelector\n类型：System.Func<TInner, TKey>\n用于从第二个序列的每个元素提取联接键的函数。\nresultSelector\n类型：System.Func<TOuter, TInner, TResult>\n用于从两个匹配元素创建结果元素的函数。\n返回值\n类型：System.Collections.Generic.IEnumerable<TResult>\nIEnumerable&lt;T&gt; that has elements of type TResult that are obtained by performing an inner join on two sequences.\" xml:space=\"preserve\">一个具有 TResult 类型元素的 IEnumerable<T>，这些元素是通过对两个序列执行内部联接得来的。\n使用说明\n在 Visual Basic 和 C# 中，可以在 IEnumerable<TOuter> 类型的任何对象上将此方法作为实例方法来调用。当使用实例方法语法调用此方法时，请省略第一个参数。有关详细信息，请参阅 扩展方法 (Visual Basic) 或 扩展方法（C# 编程指南）。\n \n先上一个MSDN的例子。\n       \n         public static void JoinEx1()         \n         {\n\t       Person magnus = new Person { Name = \"Hedlund, Magnus\" };\n\t       Pet barley = new Pet { Name = \"Barley\", Owner = terry };\n\t       Person terry = new Person { Name = \"Adams, Terry\" };\n\t       Person charlotte = new Person { Name = \"Weiss, \n\t       Charlotte\" };\n\t       Pet boots = new Pet { Name = \"Boots\", Owner = terry };\n\t       Pet whiskers = new Pet { Name = \"Whiskers\", \n\t       Owner = charlotte};\n\t       Pet daisy = new Pet { Name = \"Daisy\", Owner = magnus };\n\n        List<Person> people = new List<Person> \n        { magnus, terry, charlotte };\n        List<Pet> pets = new List<Pet> \n        { barley, boots, whiskers, daisy };\n\n        // Create a list of Person-Pet pairs where \n        // each element is an anonymous type that contains a\n        // Pet's name and the name of the Person that owns the Pet.\n        var query =\n            people.Join(\n                        pets,//需要Join的另一个数据源\n              person => person,//自己用来比较的key， lambda 表达式\n         pet => pet.Owner,//另一个数据源用来比较的key， lambda 表达式\n    (person, pet) =>new { OwnerName = person.Name, Pet = pet.Name } \n                   //想要取出来的数据，支持匿名对象， lambda 表达式);\n        foreach (var obj in query)\n        {\n          Console.WriteLine( \"{0} - {1}\",obj.OwnerName,obj.Pet);\n        }\n    }\n\n LINQ的Join\n同样是上面的数据，如果换成LINQ的Join，写法如下：\n            var query = from person in people // 第一个数据源\n                      join pet in pets            //第二个数据源\n                      on person equals pet.Owner  //Join条件\n                      select  new { OwnerName = person.Name, Pet = pet.Name };  \n                      //要到得到的数据。\n\n\n上面两种写法得到的结果都是内链接结果，至于左连接、右连接、外连接....\n等我下次有心情再更新吧，再不走家里的键盘又要坏了。 \n\n一些资料链接：\nhttps://msdn.microsoft.com/zh-cn/library/bb311040.aspx\nhttps://msdn.microsoft.com/zh-cn/library/bb534675%28v=vs.110%29.aspx?f=255&MSPPError=-2147217396\nhttp://www.cnblogs.com/Ivony/archive/2008/08/18/1270555.html\nhttp://www.cnblogs.com/Ivony/archive/2008/08/28/1278643.html\nhttp://www.cnblogs.com/Ivony/archive/2008/10/14/1309807.html ; \n\n\nLINQ GroupJoin 实现左连接\nvar queryGroup = from person in people // 第一个数据源\n                                join pet in pets //第二个数据源\n                                on person equals pet.Owner into ps //加了into,华丽变身GroupJoin\n                                select new { OwnerName = person.Name, Pet = ps }; //要到得到的数据。 ","source":"_posts/Join.md","raw":"---\nlayout: post\ntitle: .NET-join用法\ncategory: .net\ndate: 2016-03-03 00:00:00\n---\n\n\n#.NET   Join\n 连接：内连接、外连接、左连接、右连接。\nSQL的Join这里就不多说了，\n今天主要是看一下LINQ的Join用法，以及Enumerable.Join()的用法。\n\nJoin用于连接数据，首先就是数据之间有联系咯。\n \n先说Enumerable.Join()。\n参数类型如下：\n\t\t\tpublic static IEnumerable<TResult> Join<TOuter, TInner, TKey, TResult>\n\t\t\t(      \n\t\t\t         this IEnumerable<TOuter> outer,\n\t\t\t        IEnumerable<TInner> inner,\n\t\t\t        Func<TOuter, TKey> outerKeySelector,\n\t\t\t        Func<TInner, TKey> innerKeySelector,\n\t\t\t        Func<TOuter, TInner, TResult> resultSelector\n\t\t\t) \n类型参数\nTOuter\n第一个序列中的元素的类型。\nTInner\n第二个序列中的元素的类型。\nTKey\n键选择器函数返回的键的类型。\nTResult\n结果元素的类型。\n参数\nouter\n类型：System.Collections.Generic.IEnumerable<TOuter>\n要联接的第一个序列。\ninner\n类型：System.Collections.Generic.IEnumerable<TInner>\n要与第一个序列联接的序列。\nouterKeySelector\n类型：System.Func<TOuter, TKey>\n用于从第一个序列的每个元素提取联接键的函数。\ninnerKeySelector\n类型：System.Func<TInner, TKey>\n用于从第二个序列的每个元素提取联接键的函数。\nresultSelector\n类型：System.Func<TOuter, TInner, TResult>\n用于从两个匹配元素创建结果元素的函数。\n返回值\n类型：System.Collections.Generic.IEnumerable<TResult>\nIEnumerable&lt;T&gt; that has elements of type TResult that are obtained by performing an inner join on two sequences.\" xml:space=\"preserve\">一个具有 TResult 类型元素的 IEnumerable<T>，这些元素是通过对两个序列执行内部联接得来的。\n使用说明\n在 Visual Basic 和 C# 中，可以在 IEnumerable<TOuter> 类型的任何对象上将此方法作为实例方法来调用。当使用实例方法语法调用此方法时，请省略第一个参数。有关详细信息，请参阅 扩展方法 (Visual Basic) 或 扩展方法（C# 编程指南）。\n \n先上一个MSDN的例子。\n       \n         public static void JoinEx1()         \n         {\n\t       Person magnus = new Person { Name = \"Hedlund, Magnus\" };\n\t       Pet barley = new Pet { Name = \"Barley\", Owner = terry };\n\t       Person terry = new Person { Name = \"Adams, Terry\" };\n\t       Person charlotte = new Person { Name = \"Weiss, \n\t       Charlotte\" };\n\t       Pet boots = new Pet { Name = \"Boots\", Owner = terry };\n\t       Pet whiskers = new Pet { Name = \"Whiskers\", \n\t       Owner = charlotte};\n\t       Pet daisy = new Pet { Name = \"Daisy\", Owner = magnus };\n\n        List<Person> people = new List<Person> \n        { magnus, terry, charlotte };\n        List<Pet> pets = new List<Pet> \n        { barley, boots, whiskers, daisy };\n\n        // Create a list of Person-Pet pairs where \n        // each element is an anonymous type that contains a\n        // Pet's name and the name of the Person that owns the Pet.\n        var query =\n            people.Join(\n                        pets,//需要Join的另一个数据源\n              person => person,//自己用来比较的key， lambda 表达式\n         pet => pet.Owner,//另一个数据源用来比较的key， lambda 表达式\n    (person, pet) =>new { OwnerName = person.Name, Pet = pet.Name } \n                   //想要取出来的数据，支持匿名对象， lambda 表达式);\n        foreach (var obj in query)\n        {\n          Console.WriteLine( \"{0} - {1}\",obj.OwnerName,obj.Pet);\n        }\n    }\n\n LINQ的Join\n同样是上面的数据，如果换成LINQ的Join，写法如下：\n            var query = from person in people // 第一个数据源\n                      join pet in pets            //第二个数据源\n                      on person equals pet.Owner  //Join条件\n                      select  new { OwnerName = person.Name, Pet = pet.Name };  \n                      //要到得到的数据。\n\n\n上面两种写法得到的结果都是内链接结果，至于左连接、右连接、外连接....\n等我下次有心情再更新吧，再不走家里的键盘又要坏了。 \n\n一些资料链接：\nhttps://msdn.microsoft.com/zh-cn/library/bb311040.aspx\nhttps://msdn.microsoft.com/zh-cn/library/bb534675%28v=vs.110%29.aspx?f=255&MSPPError=-2147217396\nhttp://www.cnblogs.com/Ivony/archive/2008/08/18/1270555.html\nhttp://www.cnblogs.com/Ivony/archive/2008/08/28/1278643.html\nhttp://www.cnblogs.com/Ivony/archive/2008/10/14/1309807.html ; \n\n\nLINQ GroupJoin 实现左连接\nvar queryGroup = from person in people // 第一个数据源\n                                join pet in pets //第二个数据源\n                                on person equals pet.Owner into ps //加了into,华丽变身GroupJoin\n                                select new { OwnerName = person.Name, Pet = ps }; //要到得到的数据。 ","slug":"Join","published":1,"updated":"2016-09-15T05:11:13.651Z","comments":1,"photos":[],"link":"","_id":"cit3xw9sy000ic0txmwy6q68a","content":"<p>#.NET   Join<br> 连接：内连接、外连接、左连接、右连接。<br>SQL的Join这里就不多说了，<br>今天主要是看一下LINQ的Join用法，以及Enumerable.Join()的用法。</p>\n<p>Join用于连接数据，首先就是数据之间有联系咯。</p>\n<p>先说Enumerable.Join()。<br>参数类型如下：<br>            public static IEnumerable<tresult> Join<touter, tinner,=\"\" tkey,=\"\" tresult=\"\"><br>            (<br>                     this IEnumerable<touter> outer,<br>                    IEnumerable<tinner> inner,<br>                    Func<touter, tkey=\"\"> outerKeySelector,<br>                    Func<tinner, tkey=\"\"> innerKeySelector,<br>                    Func<touter, tinner,=\"\" tresult=\"\"> resultSelector<br>            )<br>类型参数<br>TOuter<br>第一个序列中的元素的类型。<br>TInner<br>第二个序列中的元素的类型。<br>TKey<br>键选择器函数返回的键的类型。<br>TResult<br>结果元素的类型。<br>参数<br>outer<br>类型：System.Collections.Generic.IEnumerable<touter><br>要联接的第一个序列。<br>inner<br>类型：System.Collections.Generic.IEnumerable<tinner><br>要与第一个序列联接的序列。<br>outerKeySelector<br>类型：System.Func<touter, tkey=\"\"><br>用于从第一个序列的每个元素提取联接键的函数。<br>innerKeySelector<br>类型：System.Func<tinner, tkey=\"\"><br>用于从第二个序列的每个元素提取联接键的函数。<br>resultSelector<br>类型：System.Func<touter, tinner,=\"\" tresult=\"\"><br>用于从两个匹配元素创建结果元素的函数。<br>返回值<br>类型：System.Collections.Generic.IEnumerable<tresult><br>IEnumerable&lt;T&gt; that has elements of type TResult that are obtained by performing an inner join on two sequences.” xml:space=”preserve”&gt;一个具有 TResult 类型元素的 IEnumerable<t>，这些元素是通过对两个序列执行内部联接得来的。<br>使用说明<br>在 Visual Basic 和 C# 中，可以在 IEnumerable<touter> 类型的任何对象上将此方法作为实例方法来调用。当使用实例方法语法调用此方法时，请省略第一个参数。有关详细信息，请参阅 扩展方法 (Visual Basic) 或 扩展方法（C# 编程指南）。</touter></t></tresult></touter,></tinner,></touter,></tinner></touter></touter,></tinner,></touter,></tinner></touter></touter,></tresult></p>\n<p>先上一个MSDN的例子。</p>\n<pre><code>     public static void JoinEx1()         \n     {\n       Person magnus = new Person { Name = &quot;Hedlund, Magnus&quot; };\n       Pet barley = new Pet { Name = &quot;Barley&quot;, Owner = terry };\n       Person terry = new Person { Name = &quot;Adams, Terry&quot; };\n       Person charlotte = new Person { Name = &quot;Weiss, \n       Charlotte&quot; };\n       Pet boots = new Pet { Name = &quot;Boots&quot;, Owner = terry };\n       Pet whiskers = new Pet { Name = &quot;Whiskers&quot;, \n       Owner = charlotte};\n       Pet daisy = new Pet { Name = &quot;Daisy&quot;, Owner = magnus };\n\n    List&lt;Person&gt; people = new List&lt;Person&gt; \n    { magnus, terry, charlotte };\n    List&lt;Pet&gt; pets = new List&lt;Pet&gt; \n    { barley, boots, whiskers, daisy };\n\n    // Create a list of Person-Pet pairs where \n    // each element is an anonymous type that contains a\n    // Pet&apos;s name and the name of the Person that owns the Pet.\n    var query =\n        people.Join(\n                    pets,//需要Join的另一个数据源\n          person =&gt; person,//自己用来比较的key， lambda 表达式\n     pet =&gt; pet.Owner,//另一个数据源用来比较的key， lambda 表达式\n(person, pet) =&gt;new { OwnerName = person.Name, Pet = pet.Name } \n               //想要取出来的数据，支持匿名对象， lambda 表达式);\n    foreach (var obj in query)\n    {\n      Console.WriteLine( &quot;{0} - {1}&quot;,obj.OwnerName,obj.Pet);\n    }\n}\n</code></pre><p> LINQ的Join<br>同样是上面的数据，如果换成LINQ的Join，写法如下：<br>            var query = from person in people // 第一个数据源<br>                      join pet in pets            //第二个数据源<br>                      on person equals pet.Owner  //Join条件<br>                      select  new { OwnerName = person.Name, Pet = pet.Name };<br>                      //要到得到的数据。</p>\n<p>上面两种写法得到的结果都是内链接结果，至于左连接、右连接、外连接….<br>等我下次有心情再更新吧，再不走家里的键盘又要坏了。 </p>\n<p>一些资料链接：<br><a href=\"https://msdn.microsoft.com/zh-cn/library/bb311040.aspx\" target=\"_blank\" rel=\"external\">https://msdn.microsoft.com/zh-cn/library/bb311040.aspx</a><br><a href=\"https://msdn.microsoft.com/zh-cn/library/bb534675%28v=vs.110%29.aspx?f=255&amp;MSPPError=-2147217396\" target=\"_blank\" rel=\"external\">https://msdn.microsoft.com/zh-cn/library/bb534675%28v=vs.110%29.aspx?f=255&amp;MSPPError=-2147217396</a><br><a href=\"http://www.cnblogs.com/Ivony/archive/2008/08/18/1270555.html\" target=\"_blank\" rel=\"external\">http://www.cnblogs.com/Ivony/archive/2008/08/18/1270555.html</a><br><a href=\"http://www.cnblogs.com/Ivony/archive/2008/08/28/1278643.html\" target=\"_blank\" rel=\"external\">http://www.cnblogs.com/Ivony/archive/2008/08/28/1278643.html</a><br><a href=\"http://www.cnblogs.com/Ivony/archive/2008/10/14/1309807.html\" target=\"_blank\" rel=\"external\">http://www.cnblogs.com/Ivony/archive/2008/10/14/1309807.html</a> ; </p>\n<p>LINQ GroupJoin 实现左连接<br>var queryGroup = from person in people // 第一个数据源<br>                                join pet in pets //第二个数据源<br>                                on person equals pet.Owner into ps //加了into,华丽变身GroupJoin<br>                                select new { OwnerName = person.Name, Pet = ps }; //要到得到的数据。 </p>\n","excerpt":"","more":"<p>#.NET   Join<br> 连接：内连接、外连接、左连接、右连接。<br>SQL的Join这里就不多说了，<br>今天主要是看一下LINQ的Join用法，以及Enumerable.Join()的用法。</p>\n<p>Join用于连接数据，首先就是数据之间有联系咯。</p>\n<p>先说Enumerable.Join()。<br>参数类型如下：<br>            public static IEnumerable<TResult> Join<TOuter, TInner, TKey, TResult><br>            (<br>                     this IEnumerable<TOuter> outer,<br>                    IEnumerable<TInner> inner,<br>                    Func<TOuter, TKey> outerKeySelector,<br>                    Func<TInner, TKey> innerKeySelector,<br>                    Func<TOuter, TInner, TResult> resultSelector<br>            )<br>类型参数<br>TOuter<br>第一个序列中的元素的类型。<br>TInner<br>第二个序列中的元素的类型。<br>TKey<br>键选择器函数返回的键的类型。<br>TResult<br>结果元素的类型。<br>参数<br>outer<br>类型：System.Collections.Generic.IEnumerable<TOuter><br>要联接的第一个序列。<br>inner<br>类型：System.Collections.Generic.IEnumerable<TInner><br>要与第一个序列联接的序列。<br>outerKeySelector<br>类型：System.Func<TOuter, TKey><br>用于从第一个序列的每个元素提取联接键的函数。<br>innerKeySelector<br>类型：System.Func<TInner, TKey><br>用于从第二个序列的每个元素提取联接键的函数。<br>resultSelector<br>类型：System.Func<TOuter, TInner, TResult><br>用于从两个匹配元素创建结果元素的函数。<br>返回值<br>类型：System.Collections.Generic.IEnumerable<TResult><br>IEnumerable&lt;T&gt; that has elements of type TResult that are obtained by performing an inner join on two sequences.” xml:space=”preserve”&gt;一个具有 TResult 类型元素的 IEnumerable<T>，这些元素是通过对两个序列执行内部联接得来的。<br>使用说明<br>在 Visual Basic 和 C# 中，可以在 IEnumerable<TOuter> 类型的任何对象上将此方法作为实例方法来调用。当使用实例方法语法调用此方法时，请省略第一个参数。有关详细信息，请参阅 扩展方法 (Visual Basic) 或 扩展方法（C# 编程指南）。</p>\n<p>先上一个MSDN的例子。</p>\n<pre><code>     public static void JoinEx1()         \n     {\n       Person magnus = new Person { Name = &quot;Hedlund, Magnus&quot; };\n       Pet barley = new Pet { Name = &quot;Barley&quot;, Owner = terry };\n       Person terry = new Person { Name = &quot;Adams, Terry&quot; };\n       Person charlotte = new Person { Name = &quot;Weiss, \n       Charlotte&quot; };\n       Pet boots = new Pet { Name = &quot;Boots&quot;, Owner = terry };\n       Pet whiskers = new Pet { Name = &quot;Whiskers&quot;, \n       Owner = charlotte};\n       Pet daisy = new Pet { Name = &quot;Daisy&quot;, Owner = magnus };\n\n    List&lt;Person&gt; people = new List&lt;Person&gt; \n    { magnus, terry, charlotte };\n    List&lt;Pet&gt; pets = new List&lt;Pet&gt; \n    { barley, boots, whiskers, daisy };\n\n    // Create a list of Person-Pet pairs where \n    // each element is an anonymous type that contains a\n    // Pet&apos;s name and the name of the Person that owns the Pet.\n    var query =\n        people.Join(\n                    pets,//需要Join的另一个数据源\n          person =&gt; person,//自己用来比较的key， lambda 表达式\n     pet =&gt; pet.Owner,//另一个数据源用来比较的key， lambda 表达式\n(person, pet) =&gt;new { OwnerName = person.Name, Pet = pet.Name } \n               //想要取出来的数据，支持匿名对象， lambda 表达式);\n    foreach (var obj in query)\n    {\n      Console.WriteLine( &quot;{0} - {1}&quot;,obj.OwnerName,obj.Pet);\n    }\n}\n</code></pre><p> LINQ的Join<br>同样是上面的数据，如果换成LINQ的Join，写法如下：<br>            var query = from person in people // 第一个数据源<br>                      join pet in pets            //第二个数据源<br>                      on person equals pet.Owner  //Join条件<br>                      select  new { OwnerName = person.Name, Pet = pet.Name };<br>                      //要到得到的数据。</p>\n<p>上面两种写法得到的结果都是内链接结果，至于左连接、右连接、外连接….<br>等我下次有心情再更新吧，再不走家里的键盘又要坏了。 </p>\n<p>一些资料链接：<br><a href=\"https://msdn.microsoft.com/zh-cn/library/bb311040.aspx\">https://msdn.microsoft.com/zh-cn/library/bb311040.aspx</a><br><a href=\"https://msdn.microsoft.com/zh-cn/library/bb534675%28v=vs.110%29.aspx?f=255&amp;MSPPError=-2147217396\">https://msdn.microsoft.com/zh-cn/library/bb534675%28v=vs.110%29.aspx?f=255&amp;MSPPError=-2147217396</a><br><a href=\"http://www.cnblogs.com/Ivony/archive/2008/08/18/1270555.html\">http://www.cnblogs.com/Ivony/archive/2008/08/18/1270555.html</a><br><a href=\"http://www.cnblogs.com/Ivony/archive/2008/08/28/1278643.html\">http://www.cnblogs.com/Ivony/archive/2008/08/28/1278643.html</a><br><a href=\"http://www.cnblogs.com/Ivony/archive/2008/10/14/1309807.html\">http://www.cnblogs.com/Ivony/archive/2008/10/14/1309807.html</a> ; </p>\n<p>LINQ GroupJoin 实现左连接<br>var queryGroup = from person in people // 第一个数据源<br>                                join pet in pets //第二个数据源<br>                                on person equals pet.Owner into ps //加了into,华丽变身GroupJoin<br>                                select new { OwnerName = person.Name, Pet = ps }; //要到得到的数据。 </p>\n"},{"layout":"post","title":"C#LINQ 优点 总结(转载)","date":"2016-03-14T16:00:00.000Z","_content":"\n\n原文链接：http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html\n\n这几天在读一本LINQ方面的书《Essential LINQ》,在这里和大家分享下。\n\n由于对LINQ的深入总结需要大量的篇幅，因此在这里分成几个部分来讲。\n\n（*我看《Essential LINQ》是英文版的，有些名词不能翻译成正统的中文解释请给予谅解）\n\nLINQ的优点：\n\nLINQ基本有以下七个优点，让我来一一举例说明：\n\n#####1.Integrated：所谓的Integrated（集成化），LINQ是从以下方面体现集成的：\n\n(1):把查询语法融入了C#(VB)这些语言中，让他变成了一种语法。这样就能和C#中的其他语法一样支持：\n\n语句高亮显示，类型检查，允许使用debugger调试\n\n(2):把以前复杂的查询前的工作都集成封装起来，让开发人员侧重于查询。\n\n(3):集成后的语法更加的清晰易懂，可读性较高。\n\n  \n```\n比较： \n//原来的格式\nSqlConnection sqlConn = new SqlConnection(connectionString);>\nsqlConn.Open();\nSqlCommand command = new SqlCommand();\ncommand.Connection = sqlConn;\ncommand.CommandText = \"Select * From Customer\";\nSqlDataReader dataReader = command.ExecuteReader(CommandBehavior.CloseConnection);\n \n//LINQ的格式\nNORTHWNDDataContext dc = new NORTHWNDDataContext();\nvar query = from c in dc.Customers\n            select c;\n```\n\n\n\n#####2.Unitive：所谓Unitive(统一化)就指不管对任何类型外部和内部数据源(对象集合,xlm,数据库数据)都使用统一的查询语法。\n\n使用统一化查询语言的好处在于以下几点：\n\n你不用因为要使用不太熟悉的数据源而花很多精力去了解它，你可以快速简单的使用LINQ语法对起查询。\n由于使用了统一的语法，可以使代码维护变的更加简单。\n以下代码体现了LINQ的统一化：\n```\n//数据源:对象集合\nvar query = from c in GetCustomers()\n            select c;\n \n//数据源:SQL\nvar query1 = from c in dc.Customers\n             select c;\n//数据源:XML\nvar query2 = from c in customers.Descendants(\"Customer\")\n             select c;\n```\n\n         \n#####3.Extensible：所谓Extensible(可扩展)指以下2个方面:\n\n(1).可查询数据源的扩展。 LINQ提供了个LINQ provider model，你可以为LINQ创建或提供provider让LINQ支持更多的数据源。\n\n(2).可扩展查询方法。开发者可以根据自己的需求为LINQ重写和扩展查询方法。\n\n以下是些第三方的LINQ provider：\n\nLINQ Extender, LINQ to JavaScript, LINQ to JSON, LINQ to MySQL, LINQ to Flickr, LINQ to Google\n\n \n\n#####4.Declarative：所谓Declarative(声明式)，简单的来说指的是开发人员只要告诉程序做什么，程序自己判断怎么做。\n\nDeclarative programming(声明式编程)的优点体现在以下2点：\n\n(1).提高了开发速度。因为开发者不用书写大量的代码来具体化执行步骤，只许告诉程序做什么。\n\n(2).提高代码优化空间。因为开发者不用参与干涉对程序执行的具体步骤，这样就提供给编译器更多的空间去优化代码。\n\n举例SQL来说，LINQ生成的SQL语句往往比一对SQL水平一般的开发者能写出更好的SQL语句。\n\n比较Declarative programming 与 Imperative programming：\n```\n//声明式编程\nList<List<int>> lists = new List<List<int>> { new List<int> { 1, 2, 3 }, new List<int> { 4, 5 } };\nvar query = from list in lists\n            from num in list\n            where num % 3 == 0\n            orderby num descending\n            select num;\n \n//命令式编程\nList<int> list1 = new List<int>();\nlist1.Add(1);\nlist1.Add(2);\nlist1.Add(3);\nList<int> list2 = new List<int>();\nlist2.Add(4);\nlist2.Add(5);\nList<List<int>> lists1 = new List<List<int>>();\nlists1.Add(list1);\nlists1.Add(list2);\n \nList<int> newList = new List<int>();\nforeach (var item in lists1)\n      foreach (var num in item)\n        if (num % 3 == 0)\n            newList.Add(num);\nnewList.Reverse();\n\n```\n\n#####5.Hierarchical：所谓Hierarchical(层次化)指使用面向对象的方式抽象数据。\n\nSQL是关系型数据库，它以关系的方式描述数据以数据的联系，但我们的程序设计成面向对象的因此我们在程序里得到的数据库数据往往都是\n\nrectangular grid（平面的显示数据）。但是LINQ通过所谓的O-R Mapping方式，把关系型转换成对象与对象方式描述数据。\n\n这样带来的好处是：开发者能直接以对象的方式去操作数据，对习惯面向对象的开发者来说面向对象模型更易理解。\n\n \n\n#####6.Composable：所谓Composable(可组成)指LINQ可以把一个复杂的查询拆分成多个简单查询。\n\nLINQ返回的结果都是基于接口：IEnumerable<T>，因此能对查询结果继续查询，而且LINQ具有延迟执行的特性因此拆分执行不会影响效率。\n\n优点在于：\n\n(1).方便调试。把复杂的查询拆分成简单的查询，然后逐个调试。\n\n(2).便于代码维护。把代码拆分后能使代码变的更易理解。\n\n以下代码体现了可组成性：\n```\n//以下代码体现了Composable\nList<List<int>> lists = new List<List<int>> { new List<int>\n { 1, 2, 3 }, new List<int> { 4, 5 } };\n \nvar query1 = from list in lists\n             from num in list\n             select num;\n \nvar query2 = from num in query1\n             where num % 3 == 0\n             select num;\n \nvar query3 = from num in query2\n             orderby num descending\n             select num;\n```\n\n \n\n######7.Transformative：所谓Transformative(可转换)指的是LINQ能把一种数据源的内容转换到其他数据源。\n\n方便用户做数据移植。\n\n以下代码体现了转换的特性：\n```\n//把关系型数据转换成XML型\n\tvar query = new XElement(\"Orders\",\n            from c in dc.Customers\n            where c.City == \"Paris\"\n            select new XElement(\"Order\",\n                new XAttribute(\"Address\", c.Address)));\n```\n\n以上就是LINQ的几大优点，很高兴能在这里和大家分享。有任何不足之处请给予补充和纠正，谢谢光临小舍。\n\n//2011/1/28 补充(LINQ TO SQL)\n\n在LINQ TO SQL 方面，如果使用LINQ TO SQL可以有效的防止SQL注入，LINQ TO SQL 会把注入的代码当做无用的参数处理。\n\n\nhttp://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html ","source":"_posts/LINQ-advantage.md","raw":"---\nlayout: post\ntitle: C#LINQ 优点 总结(转载)\ncategory: .net\ndate: 2016-03-15 00:00:00\n---\n\n\n原文链接：http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html\n\n这几天在读一本LINQ方面的书《Essential LINQ》,在这里和大家分享下。\n\n由于对LINQ的深入总结需要大量的篇幅，因此在这里分成几个部分来讲。\n\n（*我看《Essential LINQ》是英文版的，有些名词不能翻译成正统的中文解释请给予谅解）\n\nLINQ的优点：\n\nLINQ基本有以下七个优点，让我来一一举例说明：\n\n#####1.Integrated：所谓的Integrated（集成化），LINQ是从以下方面体现集成的：\n\n(1):把查询语法融入了C#(VB)这些语言中，让他变成了一种语法。这样就能和C#中的其他语法一样支持：\n\n语句高亮显示，类型检查，允许使用debugger调试\n\n(2):把以前复杂的查询前的工作都集成封装起来，让开发人员侧重于查询。\n\n(3):集成后的语法更加的清晰易懂，可读性较高。\n\n  \n```\n比较： \n//原来的格式\nSqlConnection sqlConn = new SqlConnection(connectionString);>\nsqlConn.Open();\nSqlCommand command = new SqlCommand();\ncommand.Connection = sqlConn;\ncommand.CommandText = \"Select * From Customer\";\nSqlDataReader dataReader = command.ExecuteReader(CommandBehavior.CloseConnection);\n \n//LINQ的格式\nNORTHWNDDataContext dc = new NORTHWNDDataContext();\nvar query = from c in dc.Customers\n            select c;\n```\n\n\n\n#####2.Unitive：所谓Unitive(统一化)就指不管对任何类型外部和内部数据源(对象集合,xlm,数据库数据)都使用统一的查询语法。\n\n使用统一化查询语言的好处在于以下几点：\n\n你不用因为要使用不太熟悉的数据源而花很多精力去了解它，你可以快速简单的使用LINQ语法对起查询。\n由于使用了统一的语法，可以使代码维护变的更加简单。\n以下代码体现了LINQ的统一化：\n```\n//数据源:对象集合\nvar query = from c in GetCustomers()\n            select c;\n \n//数据源:SQL\nvar query1 = from c in dc.Customers\n             select c;\n//数据源:XML\nvar query2 = from c in customers.Descendants(\"Customer\")\n             select c;\n```\n\n         \n#####3.Extensible：所谓Extensible(可扩展)指以下2个方面:\n\n(1).可查询数据源的扩展。 LINQ提供了个LINQ provider model，你可以为LINQ创建或提供provider让LINQ支持更多的数据源。\n\n(2).可扩展查询方法。开发者可以根据自己的需求为LINQ重写和扩展查询方法。\n\n以下是些第三方的LINQ provider：\n\nLINQ Extender, LINQ to JavaScript, LINQ to JSON, LINQ to MySQL, LINQ to Flickr, LINQ to Google\n\n \n\n#####4.Declarative：所谓Declarative(声明式)，简单的来说指的是开发人员只要告诉程序做什么，程序自己判断怎么做。\n\nDeclarative programming(声明式编程)的优点体现在以下2点：\n\n(1).提高了开发速度。因为开发者不用书写大量的代码来具体化执行步骤，只许告诉程序做什么。\n\n(2).提高代码优化空间。因为开发者不用参与干涉对程序执行的具体步骤，这样就提供给编译器更多的空间去优化代码。\n\n举例SQL来说，LINQ生成的SQL语句往往比一对SQL水平一般的开发者能写出更好的SQL语句。\n\n比较Declarative programming 与 Imperative programming：\n```\n//声明式编程\nList<List<int>> lists = new List<List<int>> { new List<int> { 1, 2, 3 }, new List<int> { 4, 5 } };\nvar query = from list in lists\n            from num in list\n            where num % 3 == 0\n            orderby num descending\n            select num;\n \n//命令式编程\nList<int> list1 = new List<int>();\nlist1.Add(1);\nlist1.Add(2);\nlist1.Add(3);\nList<int> list2 = new List<int>();\nlist2.Add(4);\nlist2.Add(5);\nList<List<int>> lists1 = new List<List<int>>();\nlists1.Add(list1);\nlists1.Add(list2);\n \nList<int> newList = new List<int>();\nforeach (var item in lists1)\n      foreach (var num in item)\n        if (num % 3 == 0)\n            newList.Add(num);\nnewList.Reverse();\n\n```\n\n#####5.Hierarchical：所谓Hierarchical(层次化)指使用面向对象的方式抽象数据。\n\nSQL是关系型数据库，它以关系的方式描述数据以数据的联系，但我们的程序设计成面向对象的因此我们在程序里得到的数据库数据往往都是\n\nrectangular grid（平面的显示数据）。但是LINQ通过所谓的O-R Mapping方式，把关系型转换成对象与对象方式描述数据。\n\n这样带来的好处是：开发者能直接以对象的方式去操作数据，对习惯面向对象的开发者来说面向对象模型更易理解。\n\n \n\n#####6.Composable：所谓Composable(可组成)指LINQ可以把一个复杂的查询拆分成多个简单查询。\n\nLINQ返回的结果都是基于接口：IEnumerable<T>，因此能对查询结果继续查询，而且LINQ具有延迟执行的特性因此拆分执行不会影响效率。\n\n优点在于：\n\n(1).方便调试。把复杂的查询拆分成简单的查询，然后逐个调试。\n\n(2).便于代码维护。把代码拆分后能使代码变的更易理解。\n\n以下代码体现了可组成性：\n```\n//以下代码体现了Composable\nList<List<int>> lists = new List<List<int>> { new List<int>\n { 1, 2, 3 }, new List<int> { 4, 5 } };\n \nvar query1 = from list in lists\n             from num in list\n             select num;\n \nvar query2 = from num in query1\n             where num % 3 == 0\n             select num;\n \nvar query3 = from num in query2\n             orderby num descending\n             select num;\n```\n\n \n\n######7.Transformative：所谓Transformative(可转换)指的是LINQ能把一种数据源的内容转换到其他数据源。\n\n方便用户做数据移植。\n\n以下代码体现了转换的特性：\n```\n//把关系型数据转换成XML型\n\tvar query = new XElement(\"Orders\",\n            from c in dc.Customers\n            where c.City == \"Paris\"\n            select new XElement(\"Order\",\n                new XAttribute(\"Address\", c.Address)));\n```\n\n以上就是LINQ的几大优点，很高兴能在这里和大家分享。有任何不足之处请给予补充和纠正，谢谢光临小舍。\n\n//2011/1/28 补充(LINQ TO SQL)\n\n在LINQ TO SQL 方面，如果使用LINQ TO SQL可以有效的防止SQL注入，LINQ TO SQL 会把注入的代码当做无用的参数处理。\n\n\nhttp://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html ","slug":"LINQ-advantage","published":1,"updated":"2016-09-15T05:11:13.651Z","comments":1,"photos":[],"link":"","_id":"cit3xw9t0000kc0txogdwwl5k","content":"<p>原文链接：<a href=\"http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html\" target=\"_blank\" rel=\"external\">http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html</a></p>\n<p>这几天在读一本LINQ方面的书《Essential LINQ》,在这里和大家分享下。</p>\n<p>由于对LINQ的深入总结需要大量的篇幅，因此在这里分成几个部分来讲。</p>\n<p>（*我看《Essential LINQ》是英文版的，有些名词不能翻译成正统的中文解释请给予谅解）</p>\n<p>LINQ的优点：</p>\n<p>LINQ基本有以下七个优点，让我来一一举例说明：</p>\n<p>#####1.Integrated：所谓的Integrated（集成化），LINQ是从以下方面体现集成的：</p>\n<p>(1):把查询语法融入了C#(VB)这些语言中，让他变成了一种语法。这样就能和C#中的其他语法一样支持：</p>\n<p>语句高亮显示，类型检查，允许使用debugger调试</p>\n<p>(2):把以前复杂的查询前的工作都集成封装起来，让开发人员侧重于查询。</p>\n<p>(3):集成后的语法更加的清晰易懂，可读性较高。</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">比较： </div><div class=\"line\"><span class=\"comment\">//原来的格式</span></div><div class=\"line\">SqlConnection sqlConn = <span class=\"keyword\">new</span> SqlConnection(connectionString);&gt;</div><div class=\"line\">sqlConn.Open();</div><div class=\"line\">SqlCommand command = <span class=\"keyword\">new</span> SqlCommand();</div><div class=\"line\">command.Connection = sqlConn;</div><div class=\"line\">command.CommandText = <span class=\"string\">\"Select * From Customer\"</span>;</div><div class=\"line\">SqlDataReader dataReader = command.ExecuteReader(CommandBehavior.CloseConnection);</div><div class=\"line\"> </div><div class=\"line\"><span class=\"comment\">//LINQ的格式</span></div><div class=\"line\">NORTHWNDDataContext dc = <span class=\"keyword\">new</span> NORTHWNDDataContext();</div><div class=\"line\"><span class=\"keyword\">var</span> query = <span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> dc.Customers</div><div class=\"line\">            <span class=\"keyword\">select</span> c;</div></pre></td></tr></table></figure>\n<p>#####2.Unitive：所谓Unitive(统一化)就指不管对任何类型外部和内部数据源(对象集合,xlm,数据库数据)都使用统一的查询语法。</p>\n<p>使用统一化查询语言的好处在于以下几点：</p>\n<p>你不用因为要使用不太熟悉的数据源而花很多精力去了解它，你可以快速简单的使用LINQ语法对起查询。<br>由于使用了统一的语法，可以使代码维护变的更加简单。<br>以下代码体现了LINQ的统一化：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//数据源:对象集合</span></div><div class=\"line\"><span class=\"keyword\">var</span> query = <span class=\"function\"><span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> <span class=\"title\">GetCustomers</span>(<span class=\"params\"></span>)</span></div><div class=\"line\">            <span class=\"keyword\">select</span> c;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"comment\">//数据源:SQL</span></div><div class=\"line\"><span class=\"keyword\">var</span> query1 = <span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> dc.Customers</div><div class=\"line\">             <span class=\"keyword\">select</span> c;</div><div class=\"line\"><span class=\"comment\">//数据源:XML</span></div><div class=\"line\"><span class=\"keyword\">var</span> query2 = <span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> customers.Descendants(<span class=\"string\">\"Customer\"</span>)</div><div class=\"line\">             <span class=\"keyword\">select</span> c;</div></pre></td></tr></table></figure></p>\n<p>#####3.Extensible：所谓Extensible(可扩展)指以下2个方面:</p>\n<p>(1).可查询数据源的扩展。 LINQ提供了个LINQ provider model，你可以为LINQ创建或提供provider让LINQ支持更多的数据源。</p>\n<p>(2).可扩展查询方法。开发者可以根据自己的需求为LINQ重写和扩展查询方法。</p>\n<p>以下是些第三方的LINQ provider：</p>\n<p>LINQ Extender, LINQ to JavaScript, LINQ to JSON, LINQ to MySQL, LINQ to Flickr, LINQ to Google</p>\n<p>#####4.Declarative：所谓Declarative(声明式)，简单的来说指的是开发人员只要告诉程序做什么，程序自己判断怎么做。</p>\n<p>Declarative programming(声明式编程)的优点体现在以下2点：</p>\n<p>(1).提高了开发速度。因为开发者不用书写大量的代码来具体化执行步骤，只许告诉程序做什么。</p>\n<p>(2).提高代码优化空间。因为开发者不用参与干涉对程序执行的具体步骤，这样就提供给编译器更多的空间去优化代码。</p>\n<p>举例SQL来说，LINQ生成的SQL语句往往比一对SQL水平一般的开发者能写出更好的SQL语句。</p>\n<p>比较Declarative programming 与 Imperative programming：<br><figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//声明式编程</span></div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; lists = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; &#123; <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; &#123; <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span> &#125;, <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; &#123; <span class=\"number\">4</span>, <span class=\"number\">5</span> &#125; &#125;;</div><div class=\"line\"><span class=\"keyword\">var</span> query = from list <span class=\"keyword\">in</span> lists</div><div class=\"line\">            from <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> list</div><div class=\"line\">            where <span class=\"built_in\">num</span> % <span class=\"number\">3</span> == <span class=\"number\">0</span></div><div class=\"line\">            orderby <span class=\"built_in\">num</span> descending</div><div class=\"line\">            select <span class=\"built_in\">num</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"comment\">//命令式编程</span></div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; list1 = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;();</div><div class=\"line\">list1.Add(<span class=\"number\">1</span>);</div><div class=\"line\">list1.Add(<span class=\"number\">2</span>);</div><div class=\"line\">list1.Add(<span class=\"number\">3</span>);</div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; list2 = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;();</div><div class=\"line\">list2.Add(<span class=\"number\">4</span>);</div><div class=\"line\">list2.Add(<span class=\"number\">5</span>);</div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; lists1 = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt;();</div><div class=\"line\">lists1.Add(list1);</div><div class=\"line\">lists1.Add(list2);</div><div class=\"line\"> </div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; newList = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;();</div><div class=\"line\">foreach (<span class=\"keyword\">var</span> item <span class=\"keyword\">in</span> lists1)</div><div class=\"line\">      foreach (<span class=\"keyword\">var</span> <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> item)</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">num</span> % <span class=\"number\">3</span> == <span class=\"number\">0</span>)</div><div class=\"line\">            newList.Add(<span class=\"built_in\">num</span>);</div><div class=\"line\">newList.Reverse();</div></pre></td></tr></table></figure></p>\n<p>#####5.Hierarchical：所谓Hierarchical(层次化)指使用面向对象的方式抽象数据。</p>\n<p>SQL是关系型数据库，它以关系的方式描述数据以数据的联系，但我们的程序设计成面向对象的因此我们在程序里得到的数据库数据往往都是</p>\n<p>rectangular grid（平面的显示数据）。但是LINQ通过所谓的O-R Mapping方式，把关系型转换成对象与对象方式描述数据。</p>\n<p>这样带来的好处是：开发者能直接以对象的方式去操作数据，对习惯面向对象的开发者来说面向对象模型更易理解。</p>\n<p>#####6.Composable：所谓Composable(可组成)指LINQ可以把一个复杂的查询拆分成多个简单查询。</p>\n<p>LINQ返回的结果都是基于接口：IEnumerable<t>，因此能对查询结果继续查询，而且LINQ具有延迟执行的特性因此拆分执行不会影响效率。</t></p>\n<p>优点在于：</p>\n<p>(1).方便调试。把复杂的查询拆分成简单的查询，然后逐个调试。</p>\n<p>(2).便于代码维护。把代码拆分后能使代码变的更易理解。</p>\n<p>以下代码体现了可组成性：<br><figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//以下代码体现了Composable</span></div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; lists = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; &#123; <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;</div><div class=\"line\"> &#123; <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span> &#125;, <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; &#123; <span class=\"number\">4</span>, <span class=\"number\">5</span> &#125; &#125;;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">var</span> query1 = from list <span class=\"keyword\">in</span> lists</div><div class=\"line\">             from <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> list</div><div class=\"line\">             select <span class=\"built_in\">num</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">var</span> query2 = from <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> query1</div><div class=\"line\">             where <span class=\"built_in\">num</span> % <span class=\"number\">3</span> == <span class=\"number\">0</span></div><div class=\"line\">             select <span class=\"built_in\">num</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">var</span> query3 = from <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> query2</div><div class=\"line\">             orderby <span class=\"built_in\">num</span> descending</div><div class=\"line\">             select <span class=\"built_in\">num</span>;</div></pre></td></tr></table></figure></p>\n<p>######7.Transformative：所谓Transformative(可转换)指的是LINQ能把一种数据源的内容转换到其他数据源。</p>\n<p>方便用户做数据移植。</p>\n<p>以下代码体现了转换的特性：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//把关系型数据转换成XML型</span></div><div class=\"line\">\t<span class=\"keyword\">var</span> query = <span class=\"keyword\">new</span> XElement(<span class=\"string\">\"Orders\"</span>,</div><div class=\"line\">            <span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> dc.Customers</div><div class=\"line\">            <span class=\"keyword\">where</span> c.City == <span class=\"string\">\"Paris\"</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">select</span> new <span class=\"title\">XElement</span>(<span class=\"params\"><span class=\"string\">\"Order\"</span>,</span></span></div><div class=\"line\">                new XAttribute(<span class=\"string\">\"Address\"</span>, c.Address)));</div></pre></td></tr></table></figure></p>\n<p>以上就是LINQ的几大优点，很高兴能在这里和大家分享。有任何不足之处请给予补充和纠正，谢谢光临小舍。</p>\n<p>//2011/1/28 补充(LINQ TO SQL)</p>\n<p>在LINQ TO SQL 方面，如果使用LINQ TO SQL可以有效的防止SQL注入，LINQ TO SQL 会把注入的代码当做无用的参数处理。</p>\n<p><a href=\"http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html\" target=\"_blank\" rel=\"external\">http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html</a> </p>\n","excerpt":"","more":"<p>原文链接：<a href=\"http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html\">http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html</a></p>\n<p>这几天在读一本LINQ方面的书《Essential LINQ》,在这里和大家分享下。</p>\n<p>由于对LINQ的深入总结需要大量的篇幅，因此在这里分成几个部分来讲。</p>\n<p>（*我看《Essential LINQ》是英文版的，有些名词不能翻译成正统的中文解释请给予谅解）</p>\n<p>LINQ的优点：</p>\n<p>LINQ基本有以下七个优点，让我来一一举例说明：</p>\n<p>#####1.Integrated：所谓的Integrated（集成化），LINQ是从以下方面体现集成的：</p>\n<p>(1):把查询语法融入了C#(VB)这些语言中，让他变成了一种语法。这样就能和C#中的其他语法一样支持：</p>\n<p>语句高亮显示，类型检查，允许使用debugger调试</p>\n<p>(2):把以前复杂的查询前的工作都集成封装起来，让开发人员侧重于查询。</p>\n<p>(3):集成后的语法更加的清晰易懂，可读性较高。</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">比较： </div><div class=\"line\"><span class=\"comment\">//原来的格式</span></div><div class=\"line\">SqlConnection sqlConn = <span class=\"keyword\">new</span> SqlConnection(connectionString);&gt;</div><div class=\"line\">sqlConn.Open();</div><div class=\"line\">SqlCommand command = <span class=\"keyword\">new</span> SqlCommand();</div><div class=\"line\">command.Connection = sqlConn;</div><div class=\"line\">command.CommandText = <span class=\"string\">\"Select * From Customer\"</span>;</div><div class=\"line\">SqlDataReader dataReader = command.ExecuteReader(CommandBehavior.CloseConnection);</div><div class=\"line\"> </div><div class=\"line\"><span class=\"comment\">//LINQ的格式</span></div><div class=\"line\">NORTHWNDDataContext dc = <span class=\"keyword\">new</span> NORTHWNDDataContext();</div><div class=\"line\"><span class=\"keyword\">var</span> query = <span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> dc.Customers</div><div class=\"line\">            <span class=\"keyword\">select</span> c;</div></pre></td></tr></table></figure>\n<p>#####2.Unitive：所谓Unitive(统一化)就指不管对任何类型外部和内部数据源(对象集合,xlm,数据库数据)都使用统一的查询语法。</p>\n<p>使用统一化查询语言的好处在于以下几点：</p>\n<p>你不用因为要使用不太熟悉的数据源而花很多精力去了解它，你可以快速简单的使用LINQ语法对起查询。<br>由于使用了统一的语法，可以使代码维护变的更加简单。<br>以下代码体现了LINQ的统一化：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//数据源:对象集合</span></div><div class=\"line\"><span class=\"keyword\">var</span> query = <span class=\"function\"><span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> <span class=\"title\">GetCustomers</span>(<span class=\"params\"></span>)</div><div class=\"line\">            <span class=\"keyword\">select</span> c</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"comment\">//数据源:SQL</span></div><div class=\"line\"><span class=\"keyword\">var</span> query1 = <span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> dc.Customers</div><div class=\"line\">             <span class=\"keyword\">select</span> c;</div><div class=\"line\"><span class=\"comment\">//数据源:XML</span></div><div class=\"line\"><span class=\"keyword\">var</span> query2 = <span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> customers.Descendants(<span class=\"string\">\"Customer\"</span>)</div><div class=\"line\">             <span class=\"keyword\">select</span> c;</div></pre></td></tr></table></figure></p>\n<p>#####3.Extensible：所谓Extensible(可扩展)指以下2个方面:</p>\n<p>(1).可查询数据源的扩展。 LINQ提供了个LINQ provider model，你可以为LINQ创建或提供provider让LINQ支持更多的数据源。</p>\n<p>(2).可扩展查询方法。开发者可以根据自己的需求为LINQ重写和扩展查询方法。</p>\n<p>以下是些第三方的LINQ provider：</p>\n<p>LINQ Extender, LINQ to JavaScript, LINQ to JSON, LINQ to MySQL, LINQ to Flickr, LINQ to Google</p>\n<p>#####4.Declarative：所谓Declarative(声明式)，简单的来说指的是开发人员只要告诉程序做什么，程序自己判断怎么做。</p>\n<p>Declarative programming(声明式编程)的优点体现在以下2点：</p>\n<p>(1).提高了开发速度。因为开发者不用书写大量的代码来具体化执行步骤，只许告诉程序做什么。</p>\n<p>(2).提高代码优化空间。因为开发者不用参与干涉对程序执行的具体步骤，这样就提供给编译器更多的空间去优化代码。</p>\n<p>举例SQL来说，LINQ生成的SQL语句往往比一对SQL水平一般的开发者能写出更好的SQL语句。</p>\n<p>比较Declarative programming 与 Imperative programming：<br><figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//声明式编程</span></div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; lists = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; &#123; <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; &#123; <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span> &#125;, <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; &#123; <span class=\"number\">4</span>, <span class=\"number\">5</span> &#125; &#125;;</div><div class=\"line\"><span class=\"keyword\">var</span> query = from list <span class=\"keyword\">in</span> lists</div><div class=\"line\">            from <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> list</div><div class=\"line\">            where <span class=\"built_in\">num</span> % <span class=\"number\">3</span> == <span class=\"number\">0</span></div><div class=\"line\">            orderby <span class=\"built_in\">num</span> descending</div><div class=\"line\">            select <span class=\"built_in\">num</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"comment\">//命令式编程</span></div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; list1 = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;();</div><div class=\"line\">list1.Add(<span class=\"number\">1</span>);</div><div class=\"line\">list1.Add(<span class=\"number\">2</span>);</div><div class=\"line\">list1.Add(<span class=\"number\">3</span>);</div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; list2 = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;();</div><div class=\"line\">list2.Add(<span class=\"number\">4</span>);</div><div class=\"line\">list2.Add(<span class=\"number\">5</span>);</div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; lists1 = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt;();</div><div class=\"line\">lists1.Add(list1);</div><div class=\"line\">lists1.Add(list2);</div><div class=\"line\"> </div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; newList = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;();</div><div class=\"line\">foreach (<span class=\"keyword\">var</span> item <span class=\"keyword\">in</span> lists1)</div><div class=\"line\">      foreach (<span class=\"keyword\">var</span> <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> item)</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">num</span> % <span class=\"number\">3</span> == <span class=\"number\">0</span>)</div><div class=\"line\">            newList.Add(<span class=\"built_in\">num</span>);</div><div class=\"line\">newList.Reverse();</div></pre></td></tr></table></figure></p>\n<p>#####5.Hierarchical：所谓Hierarchical(层次化)指使用面向对象的方式抽象数据。</p>\n<p>SQL是关系型数据库，它以关系的方式描述数据以数据的联系，但我们的程序设计成面向对象的因此我们在程序里得到的数据库数据往往都是</p>\n<p>rectangular grid（平面的显示数据）。但是LINQ通过所谓的O-R Mapping方式，把关系型转换成对象与对象方式描述数据。</p>\n<p>这样带来的好处是：开发者能直接以对象的方式去操作数据，对习惯面向对象的开发者来说面向对象模型更易理解。</p>\n<p>#####6.Composable：所谓Composable(可组成)指LINQ可以把一个复杂的查询拆分成多个简单查询。</p>\n<p>LINQ返回的结果都是基于接口：IEnumerable<T>，因此能对查询结果继续查询，而且LINQ具有延迟执行的特性因此拆分执行不会影响效率。</p>\n<p>优点在于：</p>\n<p>(1).方便调试。把复杂的查询拆分成简单的查询，然后逐个调试。</p>\n<p>(2).便于代码维护。把代码拆分后能使代码变的更易理解。</p>\n<p>以下代码体现了可组成性：<br><figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//以下代码体现了Composable</span></div><div class=\"line\"><span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; lists = <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;&gt; &#123; <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt;</div><div class=\"line\"> &#123; <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span> &#125;, <span class=\"keyword\">new</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">int</span>&gt; &#123; <span class=\"number\">4</span>, <span class=\"number\">5</span> &#125; &#125;;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">var</span> query1 = from list <span class=\"keyword\">in</span> lists</div><div class=\"line\">             from <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> list</div><div class=\"line\">             select <span class=\"built_in\">num</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">var</span> query2 = from <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> query1</div><div class=\"line\">             where <span class=\"built_in\">num</span> % <span class=\"number\">3</span> == <span class=\"number\">0</span></div><div class=\"line\">             select <span class=\"built_in\">num</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">var</span> query3 = from <span class=\"built_in\">num</span> <span class=\"keyword\">in</span> query2</div><div class=\"line\">             orderby <span class=\"built_in\">num</span> descending</div><div class=\"line\">             select <span class=\"built_in\">num</span>;</div></pre></td></tr></table></figure></p>\n<p>######7.Transformative：所谓Transformative(可转换)指的是LINQ能把一种数据源的内容转换到其他数据源。</p>\n<p>方便用户做数据移植。</p>\n<p>以下代码体现了转换的特性：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//把关系型数据转换成XML型</span></div><div class=\"line\">\t<span class=\"keyword\">var</span> query = <span class=\"keyword\">new</span> XElement(<span class=\"string\">\"Orders\"</span>,</div><div class=\"line\">            <span class=\"keyword\">from</span> c <span class=\"keyword\">in</span> dc.Customers</div><div class=\"line\">            <span class=\"keyword\">where</span> c.City == <span class=\"string\">\"Paris\"</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">select</span> new <span class=\"title\">XElement</span>(<span class=\"params\"><span class=\"string\">\"Order\"</span>,</div><div class=\"line\">                new XAttribute(<span class=\"string\">\"Address\"</span>, c.Address</span>)))</span>;</div></pre></td></tr></table></figure></p>\n<p>以上就是LINQ的几大优点，很高兴能在这里和大家分享。有任何不足之处请给予补充和纠正，谢谢光临小舍。</p>\n<p>//2011/1/28 补充(LINQ TO SQL)</p>\n<p>在LINQ TO SQL 方面，如果使用LINQ TO SQL可以有效的防止SQL注入，LINQ TO SQL 会把注入的代码当做无用的参数处理。</p>\n<p><a href=\"http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html\">http://www.cnblogs.com/c-jquery-linq-sql-net-problem/archive/2011/01/15/LINQ_Merit.html</a> </p>\n"},{"layout":"post","title":".NET-lmabda避免修改绑定变量","date":"2016-02-14T16:00:00.000Z","_content":"\n先看一段代码\n\n\t\t#region test1 闭包\n\n        public static void test1()\n        {\n            int index = 0;\n            Func<IEnumerable<int>> sequence =()=>GetEnumrableInt(index);\n\n            index = 20;\n            foreach(int n in sequence())\n                Console.WriteLine(n);\n\n            Console.WriteLine(\"Done\");\n\n            index = 100;\n            foreach (int n in sequence())\n                Console.WriteLine(n);\n        }\n\n\n        public static IEnumerable<int> GetEnumrableInt(int index)\n        {\n            List<int> l = new List<int>();\n            for(int i=index;i<index+30;i++)\n            {\n                l.Add(i);\n            }\n            return l;\n        }\n\n        #endregion\n上面一坨代码演示了在闭包中使用了外部变量，随即又在外部修改了这些变量的情况，得到的结果是输出了20-50的数，然后又输出了100-130之间的数。这种行为有点诡异，但是确实有存在的意义...(书本这样说的，我到觉得很少会用到。)\n\n为了将查询表达式转换成可执行代码，C#编译器做了很多工作。一般而言，C#编译器将查询和lambda表达式转换成 \"静态委托\"、\"实例委托\" 或 \"闭包\"。编译器将根据lambda表达式中的代码选择一种实现方式。选择哪种方式依赖于lambda表达式的主体（body）。这看上去似乎是一些语言上的实现细节，但它却会显著地影响到我们的代码。编译器选择何种实现将可能导致diamante行为发生微妙的变化。\n\n并不是任何的lambda表达式都会生成同样结构的代码。\n\n对于编译器来说，最简单的一种行为是为以下形式的代码生成委托。  \n\n        //我们的lambda表达式\n        public static void test2()\n        {\n            int[] someNum = {0,1,2,3,4,5,6,7,8,9,10 };\n\n            IEnumerable<int> ans = from n in someNum\n                                   select n * n;\n\n            foreach (int i in ans)\n                Console.WriteLine(i);\n\n        }\n\n编译器将使用静态委托来实现n*n的lambda表达式，其为上面代码生成的代码如下：\n\n         //编译器为我们的lambda生成的代码\n        #region 等价于 test2()\n        private static int HiddenFunc(int n)\n        {\n            return n * n;\n        }\n        \n        //静态委托\n        private static Func<int, int> HiddenDelegate;\n\n        public void test2_1()\n        {\n\n            int[] someNum = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };\n\n            if(HiddenDelegate==null)\n            {\n                HiddenDelegate = new Func<int, int>(HiddenFunc);\n            }\n            IEnumerable<int> ans = someNum.Select<int, int>(HiddenDelegate);\n\n          foreach(int i in ans)\n              Console.WriteLine(i);\n\n        }\n        #endregion\n\n这个lambda表达式主体部分并没有访问任何的实例变量或者局部变量。lambda表达式仅仅访问了它的参数。对于这种情况，C#编译器将创建一个静态方法，作为委托的目标。这也是编译器执行的最简单的一种处理方式。若表达式可以通过私有的静态方法实现，那么编译器将生成该私有的静态方法以及相对应的委托定义。对于上面的代码例子中的情况以及仅访问了静态变量的表达式，编译器都会采用这样的方案。\n\n\n接下来介绍另一种较为简单的情况：\nlambda表达式需要访问类型的实例变量，但无需访问外层方法中的局部变量。\n\t\t\t\t\n    public class ModFilter\n    {\n        private readonly int modules;\n\n        public ModFilter(int mod)\n        {\n            modules = mod;\n        }\n\n\n        public IEnumerable<int> FindValues(IEnumerable<int> sequence)\n        {\n\n            return from n in sequence\n                   where n % modules == 0 //新添加的表达式\n                   select n * n;  //和前面的例子是一样的\n        }\n    }\n\n\n\n/* \n\n在这种情况下，编译器将为表达式创建一个实例方法来包装该委托。\n其基本概念和前一种情况一致，只是这里使用了实例方法，以便读取并修改当前对象的状态。\n与静态委托的例子一样，这里编译器将把lambda表达式转换成我们熟悉的代码。其中包含委托的定义以及方法调用。\n如下：\n\n*/\n\n\n\n    public class ModFilter_Other\n    {\n        private readonly int modules;\n\n\n        //实例方法\n        private bool WhereClause(int n)\n        {\n            return ((n%this.modules) ==0);\n        }\n\n\n        private static int SelectClause(int n)\n        {\n            return n * n;\n        }\n\n        private static Func<int, int> SelectDelegate;\n\n\n\n\n        public ModFilter_Other(int mod)\n        {\n            modules = mod;\n        }\n\n\n        public IEnumerable<int> FindValues(IEnumerable<int> sequence)\n        {\n            if(SelectDelegate==null)\n            {\n                SelectDelegate = new Func<int, int>(SelectClause);\n            }\n\n            return sequence.Where<int>(\n                new Func<int, bool>(this.WhereClause)).\n                Select<int, int>(SelectClause);\n        }\n    }\n\n概括来说便是：lambda表达式中的代码访问了对象实例中的成员变量，那么编译器将生成实例方法来表示lambda表达式中的代码。其实这并没有什么奇特之处——编译器省去了我们的一些代码输入工作，代码也变得整洁很多，本质来说这还是普通的方法调用。\n\n\n\n\n\n不过若是lambda表达式中访问到了外部方法中的局部变量或者方法参数，那么编译器将帮你完成很多工作。\n\n\n这里会用到闭包。编译器将生成一个私有的嵌套类型，以便为局部变量实现闭包。\n\n局部变量必须传入到实现了lambda表达式主体部分的委托里。\n\n此外，所有由该lambda表达式执行的对这些局部变量所作的修改都必须能够在外部访问到。\n\n当然，代码中内层和外层中共享的可能不止有一个变量，也可能不止一个的查询表达式。\n\n我们来修改一下该实例方法，让其访问一个局部变量。\n\n\n\t\t  public class ModFilter\n\t\t  {\n\t\t        private readonly int modules;\n\t\t\n\t\t        public ModFilter(int mod)\n\t\t        {\n\t\t            modules = mod;\n\t\t        }\n\t\t\n\t\t\n\t\t        public IEnumerable<int> FindValues(IEnumerable<int> sequence)\n\t\t        {\n\t\t            int numValues = 0;\n\t\t\n\t\t            return from n in sequence\n\t\t                   where n % modules == 0 //新添加的表达式\n\t\t                   select n * n / ++ numValues; //访问局部变量\n\t\t        }\n\t      }\n\n注意，select字句需要访问numValues这个局部变量。编译器为了创建这个闭包，需要使用嵌套类型来实现你所需要的行为。下面展示的是编译器为你生成的代码。\n\n\n\n\n \t public class ModFilter\n     {\n        private sealed class Closure\n        {\n            public ModFilter outer;\n\n            public int numValues;\n\n            public int SelectClause(int n)\n            {\n                return ((n * n) / ++this.numValues);\n            }\n        }\n\n\n\n        private readonly int modules;\n\n\n        //实例方法\n        private bool WhereClause(int n)\n        {\n            return ((n % this.modules) == 0);\n        }\n\n        public ModFilter(int mod)\n        {\n            modules = mod;\n        }\n\n\n        public IEnumerable<int> FindValues(IEnumerable<int> sequence)\n        {\n            Closure c = new Closure();\n            c.outer = this;\n            c.numValues = 0;\n\n            return sequence.Where<int>(\n                new Func<int, bool>(this.WhereClause)).\n                Select<int, int>(c.SelectClause);\n        }\n    }\n\n在上面这段代码中，编译器专门创建了一个嵌套类，用来容纳所有将在lambda表达式中访问或修改的变量。实际上，这些局部变量将完全被嵌套类的字段所代替。lambda表达式内部的代码以及表达式外部(但仍在当前方法内)的代码访问的均是同一个字段，lambda表达式中的逻辑也被编译成了内部类的一个方法。\n\n对于lambda表达式中将要用到的外部方法的参数，编译器也会以对待局部变量的方式实现：编译器将这些参数复制到表示该闭包的嵌套类中。\n\n回到最开始的那个示例，这是我们应该可以理解这种看似怪异的行为了。变量index在传入闭包后，但在查询开始执行前曾被外部代码修改。也就是说，你修改了闭包的内部状态，然后还期待其能够回到从前的状态开始执行，显然这是不可能实现的。\n\n考虑到延迟执行中的交互以及编译器实现闭包的方式，修改查询与外部代码之间绑定的变量将可能会引发错误的行为。\n因此，我们应该尽量避免在方法中修改哪些将要传入到闭包中，并将在闭包中使用的变量。\n\n\n\n\n","source":"_posts/can't-modify-linq-object.md","raw":"---\nlayout: post\ntitle: .NET-lmabda避免修改绑定变量\ncategory: .net\ndate: 2016-02-15 00:00:00\n---\n\n先看一段代码\n\n\t\t#region test1 闭包\n\n        public static void test1()\n        {\n            int index = 0;\n            Func<IEnumerable<int>> sequence =()=>GetEnumrableInt(index);\n\n            index = 20;\n            foreach(int n in sequence())\n                Console.WriteLine(n);\n\n            Console.WriteLine(\"Done\");\n\n            index = 100;\n            foreach (int n in sequence())\n                Console.WriteLine(n);\n        }\n\n\n        public static IEnumerable<int> GetEnumrableInt(int index)\n        {\n            List<int> l = new List<int>();\n            for(int i=index;i<index+30;i++)\n            {\n                l.Add(i);\n            }\n            return l;\n        }\n\n        #endregion\n上面一坨代码演示了在闭包中使用了外部变量，随即又在外部修改了这些变量的情况，得到的结果是输出了20-50的数，然后又输出了100-130之间的数。这种行为有点诡异，但是确实有存在的意义...(书本这样说的，我到觉得很少会用到。)\n\n为了将查询表达式转换成可执行代码，C#编译器做了很多工作。一般而言，C#编译器将查询和lambda表达式转换成 \"静态委托\"、\"实例委托\" 或 \"闭包\"。编译器将根据lambda表达式中的代码选择一种实现方式。选择哪种方式依赖于lambda表达式的主体（body）。这看上去似乎是一些语言上的实现细节，但它却会显著地影响到我们的代码。编译器选择何种实现将可能导致diamante行为发生微妙的变化。\n\n并不是任何的lambda表达式都会生成同样结构的代码。\n\n对于编译器来说，最简单的一种行为是为以下形式的代码生成委托。  \n\n        //我们的lambda表达式\n        public static void test2()\n        {\n            int[] someNum = {0,1,2,3,4,5,6,7,8,9,10 };\n\n            IEnumerable<int> ans = from n in someNum\n                                   select n * n;\n\n            foreach (int i in ans)\n                Console.WriteLine(i);\n\n        }\n\n编译器将使用静态委托来实现n*n的lambda表达式，其为上面代码生成的代码如下：\n\n         //编译器为我们的lambda生成的代码\n        #region 等价于 test2()\n        private static int HiddenFunc(int n)\n        {\n            return n * n;\n        }\n        \n        //静态委托\n        private static Func<int, int> HiddenDelegate;\n\n        public void test2_1()\n        {\n\n            int[] someNum = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };\n\n            if(HiddenDelegate==null)\n            {\n                HiddenDelegate = new Func<int, int>(HiddenFunc);\n            }\n            IEnumerable<int> ans = someNum.Select<int, int>(HiddenDelegate);\n\n          foreach(int i in ans)\n              Console.WriteLine(i);\n\n        }\n        #endregion\n\n这个lambda表达式主体部分并没有访问任何的实例变量或者局部变量。lambda表达式仅仅访问了它的参数。对于这种情况，C#编译器将创建一个静态方法，作为委托的目标。这也是编译器执行的最简单的一种处理方式。若表达式可以通过私有的静态方法实现，那么编译器将生成该私有的静态方法以及相对应的委托定义。对于上面的代码例子中的情况以及仅访问了静态变量的表达式，编译器都会采用这样的方案。\n\n\n接下来介绍另一种较为简单的情况：\nlambda表达式需要访问类型的实例变量，但无需访问外层方法中的局部变量。\n\t\t\t\t\n    public class ModFilter\n    {\n        private readonly int modules;\n\n        public ModFilter(int mod)\n        {\n            modules = mod;\n        }\n\n\n        public IEnumerable<int> FindValues(IEnumerable<int> sequence)\n        {\n\n            return from n in sequence\n                   where n % modules == 0 //新添加的表达式\n                   select n * n;  //和前面的例子是一样的\n        }\n    }\n\n\n\n/* \n\n在这种情况下，编译器将为表达式创建一个实例方法来包装该委托。\n其基本概念和前一种情况一致，只是这里使用了实例方法，以便读取并修改当前对象的状态。\n与静态委托的例子一样，这里编译器将把lambda表达式转换成我们熟悉的代码。其中包含委托的定义以及方法调用。\n如下：\n\n*/\n\n\n\n    public class ModFilter_Other\n    {\n        private readonly int modules;\n\n\n        //实例方法\n        private bool WhereClause(int n)\n        {\n            return ((n%this.modules) ==0);\n        }\n\n\n        private static int SelectClause(int n)\n        {\n            return n * n;\n        }\n\n        private static Func<int, int> SelectDelegate;\n\n\n\n\n        public ModFilter_Other(int mod)\n        {\n            modules = mod;\n        }\n\n\n        public IEnumerable<int> FindValues(IEnumerable<int> sequence)\n        {\n            if(SelectDelegate==null)\n            {\n                SelectDelegate = new Func<int, int>(SelectClause);\n            }\n\n            return sequence.Where<int>(\n                new Func<int, bool>(this.WhereClause)).\n                Select<int, int>(SelectClause);\n        }\n    }\n\n概括来说便是：lambda表达式中的代码访问了对象实例中的成员变量，那么编译器将生成实例方法来表示lambda表达式中的代码。其实这并没有什么奇特之处——编译器省去了我们的一些代码输入工作，代码也变得整洁很多，本质来说这还是普通的方法调用。\n\n\n\n\n\n不过若是lambda表达式中访问到了外部方法中的局部变量或者方法参数，那么编译器将帮你完成很多工作。\n\n\n这里会用到闭包。编译器将生成一个私有的嵌套类型，以便为局部变量实现闭包。\n\n局部变量必须传入到实现了lambda表达式主体部分的委托里。\n\n此外，所有由该lambda表达式执行的对这些局部变量所作的修改都必须能够在外部访问到。\n\n当然，代码中内层和外层中共享的可能不止有一个变量，也可能不止一个的查询表达式。\n\n我们来修改一下该实例方法，让其访问一个局部变量。\n\n\n\t\t  public class ModFilter\n\t\t  {\n\t\t        private readonly int modules;\n\t\t\n\t\t        public ModFilter(int mod)\n\t\t        {\n\t\t            modules = mod;\n\t\t        }\n\t\t\n\t\t\n\t\t        public IEnumerable<int> FindValues(IEnumerable<int> sequence)\n\t\t        {\n\t\t            int numValues = 0;\n\t\t\n\t\t            return from n in sequence\n\t\t                   where n % modules == 0 //新添加的表达式\n\t\t                   select n * n / ++ numValues; //访问局部变量\n\t\t        }\n\t      }\n\n注意，select字句需要访问numValues这个局部变量。编译器为了创建这个闭包，需要使用嵌套类型来实现你所需要的行为。下面展示的是编译器为你生成的代码。\n\n\n\n\n \t public class ModFilter\n     {\n        private sealed class Closure\n        {\n            public ModFilter outer;\n\n            public int numValues;\n\n            public int SelectClause(int n)\n            {\n                return ((n * n) / ++this.numValues);\n            }\n        }\n\n\n\n        private readonly int modules;\n\n\n        //实例方法\n        private bool WhereClause(int n)\n        {\n            return ((n % this.modules) == 0);\n        }\n\n        public ModFilter(int mod)\n        {\n            modules = mod;\n        }\n\n\n        public IEnumerable<int> FindValues(IEnumerable<int> sequence)\n        {\n            Closure c = new Closure();\n            c.outer = this;\n            c.numValues = 0;\n\n            return sequence.Where<int>(\n                new Func<int, bool>(this.WhereClause)).\n                Select<int, int>(c.SelectClause);\n        }\n    }\n\n在上面这段代码中，编译器专门创建了一个嵌套类，用来容纳所有将在lambda表达式中访问或修改的变量。实际上，这些局部变量将完全被嵌套类的字段所代替。lambda表达式内部的代码以及表达式外部(但仍在当前方法内)的代码访问的均是同一个字段，lambda表达式中的逻辑也被编译成了内部类的一个方法。\n\n对于lambda表达式中将要用到的外部方法的参数，编译器也会以对待局部变量的方式实现：编译器将这些参数复制到表示该闭包的嵌套类中。\n\n回到最开始的那个示例，这是我们应该可以理解这种看似怪异的行为了。变量index在传入闭包后，但在查询开始执行前曾被外部代码修改。也就是说，你修改了闭包的内部状态，然后还期待其能够回到从前的状态开始执行，显然这是不可能实现的。\n\n考虑到延迟执行中的交互以及编译器实现闭包的方式，修改查询与外部代码之间绑定的变量将可能会引发错误的行为。\n因此，我们应该尽量避免在方法中修改哪些将要传入到闭包中，并将在闭包中使用的变量。\n\n\n\n\n","slug":"can't-modify-linq-object","published":1,"updated":"2016-09-15T05:11:13.652Z","comments":1,"photos":[],"link":"","_id":"cit3xw9t3000nc0txkl53jl5p","content":"<p>先看一段代码</p>\n<pre><code>#region test1 闭包\n\npublic static void test1()\n{\n    int index = 0;\n    Func&lt;IEnumerable&lt;int&gt;&gt; sequence =()=&gt;GetEnumrableInt(index);\n\n    index = 20;\n    foreach(int n in sequence())\n        Console.WriteLine(n);\n\n    Console.WriteLine(&quot;Done&quot;);\n\n    index = 100;\n    foreach (int n in sequence())\n        Console.WriteLine(n);\n}\n\n\npublic static IEnumerable&lt;int&gt; GetEnumrableInt(int index)\n{\n    List&lt;int&gt; l = new List&lt;int&gt;();\n    for(int i=index;i&lt;index+30;i++)\n    {\n        l.Add(i);\n    }\n    return l;\n}\n\n#endregion\n</code></pre><p>上面一坨代码演示了在闭包中使用了外部变量，随即又在外部修改了这些变量的情况，得到的结果是输出了20-50的数，然后又输出了100-130之间的数。这种行为有点诡异，但是确实有存在的意义…(书本这样说的，我到觉得很少会用到。)</p>\n<p>为了将查询表达式转换成可执行代码，C#编译器做了很多工作。一般而言，C#编译器将查询和lambda表达式转换成 “静态委托”、”实例委托” 或 “闭包”。编译器将根据lambda表达式中的代码选择一种实现方式。选择哪种方式依赖于lambda表达式的主体（body）。这看上去似乎是一些语言上的实现细节，但它却会显著地影响到我们的代码。编译器选择何种实现将可能导致diamante行为发生微妙的变化。</p>\n<p>并不是任何的lambda表达式都会生成同样结构的代码。</p>\n<p>对于编译器来说，最简单的一种行为是为以下形式的代码生成委托。  </p>\n<pre><code>//我们的lambda表达式\npublic static void test2()\n{\n    int[] someNum = {0,1,2,3,4,5,6,7,8,9,10 };\n\n    IEnumerable&lt;int&gt; ans = from n in someNum\n                           select n * n;\n\n    foreach (int i in ans)\n        Console.WriteLine(i);\n\n}\n</code></pre><p>编译器将使用静态委托来实现n*n的lambda表达式，其为上面代码生成的代码如下：</p>\n<pre><code> //编译器为我们的lambda生成的代码\n#region 等价于 test2()\nprivate static int HiddenFunc(int n)\n{\n    return n * n;\n}\n\n//静态委托\nprivate static Func&lt;int, int&gt; HiddenDelegate;\n\npublic void test2_1()\n{\n\n    int[] someNum = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };\n\n    if(HiddenDelegate==null)\n    {\n        HiddenDelegate = new Func&lt;int, int&gt;(HiddenFunc);\n    }\n    IEnumerable&lt;int&gt; ans = someNum.Select&lt;int, int&gt;(HiddenDelegate);\n\n  foreach(int i in ans)\n      Console.WriteLine(i);\n\n}\n#endregion\n</code></pre><p>这个lambda表达式主体部分并没有访问任何的实例变量或者局部变量。lambda表达式仅仅访问了它的参数。对于这种情况，C#编译器将创建一个静态方法，作为委托的目标。这也是编译器执行的最简单的一种处理方式。若表达式可以通过私有的静态方法实现，那么编译器将生成该私有的静态方法以及相对应的委托定义。对于上面的代码例子中的情况以及仅访问了静态变量的表达式，编译器都会采用这样的方案。</p>\n<p>接下来介绍另一种较为简单的情况：<br>lambda表达式需要访问类型的实例变量，但无需访问外层方法中的局部变量。</p>\n<pre><code>public class ModFilter\n{\n    private readonly int modules;\n\n    public ModFilter(int mod)\n    {\n        modules = mod;\n    }\n\n\n    public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)\n    {\n\n        return from n in sequence\n               where n % modules == 0 //新添加的表达式\n               select n * n;  //和前面的例子是一样的\n    }\n}\n</code></pre><p>/* </p>\n<p>在这种情况下，编译器将为表达式创建一个实例方法来包装该委托。<br>其基本概念和前一种情况一致，只是这里使用了实例方法，以便读取并修改当前对象的状态。<br>与静态委托的例子一样，这里编译器将把lambda表达式转换成我们熟悉的代码。其中包含委托的定义以及方法调用。<br>如下：</p>\n<p>*/</p>\n<pre><code>public class ModFilter_Other\n{\n    private readonly int modules;\n\n\n    //实例方法\n    private bool WhereClause(int n)\n    {\n        return ((n%this.modules) ==0);\n    }\n\n\n    private static int SelectClause(int n)\n    {\n        return n * n;\n    }\n\n    private static Func&lt;int, int&gt; SelectDelegate;\n\n\n\n\n    public ModFilter_Other(int mod)\n    {\n        modules = mod;\n    }\n\n\n    public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)\n    {\n        if(SelectDelegate==null)\n        {\n            SelectDelegate = new Func&lt;int, int&gt;(SelectClause);\n        }\n\n        return sequence.Where&lt;int&gt;(\n            new Func&lt;int, bool&gt;(this.WhereClause)).\n            Select&lt;int, int&gt;(SelectClause);\n    }\n}\n</code></pre><p>概括来说便是：lambda表达式中的代码访问了对象实例中的成员变量，那么编译器将生成实例方法来表示lambda表达式中的代码。其实这并没有什么奇特之处——编译器省去了我们的一些代码输入工作，代码也变得整洁很多，本质来说这还是普通的方法调用。</p>\n<p>不过若是lambda表达式中访问到了外部方法中的局部变量或者方法参数，那么编译器将帮你完成很多工作。</p>\n<p>这里会用到闭包。编译器将生成一个私有的嵌套类型，以便为局部变量实现闭包。</p>\n<p>局部变量必须传入到实现了lambda表达式主体部分的委托里。</p>\n<p>此外，所有由该lambda表达式执行的对这些局部变量所作的修改都必须能够在外部访问到。</p>\n<p>当然，代码中内层和外层中共享的可能不止有一个变量，也可能不止一个的查询表达式。</p>\n<p>我们来修改一下该实例方法，让其访问一个局部变量。</p>\n<pre><code>public class ModFilter\n{\n      private readonly int modules;\n\n      public ModFilter(int mod)\n      {\n          modules = mod;\n      }\n\n\n      public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)\n      {\n          int numValues = 0;\n\n          return from n in sequence\n                 where n % modules == 0 //新添加的表达式\n                 select n * n / ++ numValues; //访问局部变量\n      }\n}\n</code></pre><p>注意，select字句需要访问numValues这个局部变量。编译器为了创建这个闭包，需要使用嵌套类型来实现你所需要的行为。下面展示的是编译器为你生成的代码。</p>\n<pre><code>  public class ModFilter\n {\n    private sealed class Closure\n    {\n        public ModFilter outer;\n\n        public int numValues;\n\n        public int SelectClause(int n)\n        {\n            return ((n * n) / ++this.numValues);\n        }\n    }\n\n\n\n    private readonly int modules;\n\n\n    //实例方法\n    private bool WhereClause(int n)\n    {\n        return ((n % this.modules) == 0);\n    }\n\n    public ModFilter(int mod)\n    {\n        modules = mod;\n    }\n\n\n    public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)\n    {\n        Closure c = new Closure();\n        c.outer = this;\n        c.numValues = 0;\n\n        return sequence.Where&lt;int&gt;(\n            new Func&lt;int, bool&gt;(this.WhereClause)).\n            Select&lt;int, int&gt;(c.SelectClause);\n    }\n}\n</code></pre><p>在上面这段代码中，编译器专门创建了一个嵌套类，用来容纳所有将在lambda表达式中访问或修改的变量。实际上，这些局部变量将完全被嵌套类的字段所代替。lambda表达式内部的代码以及表达式外部(但仍在当前方法内)的代码访问的均是同一个字段，lambda表达式中的逻辑也被编译成了内部类的一个方法。</p>\n<p>对于lambda表达式中将要用到的外部方法的参数，编译器也会以对待局部变量的方式实现：编译器将这些参数复制到表示该闭包的嵌套类中。</p>\n<p>回到最开始的那个示例，这是我们应该可以理解这种看似怪异的行为了。变量index在传入闭包后，但在查询开始执行前曾被外部代码修改。也就是说，你修改了闭包的内部状态，然后还期待其能够回到从前的状态开始执行，显然这是不可能实现的。</p>\n<p>考虑到延迟执行中的交互以及编译器实现闭包的方式，修改查询与外部代码之间绑定的变量将可能会引发错误的行为。<br>因此，我们应该尽量避免在方法中修改哪些将要传入到闭包中，并将在闭包中使用的变量。</p>\n","excerpt":"","more":"<p>先看一段代码</p>\n<pre><code>#region test1 闭包\n\npublic static void test1()\n{\n    int index = 0;\n    Func&lt;IEnumerable&lt;int&gt;&gt; sequence =()=&gt;GetEnumrableInt(index);\n\n    index = 20;\n    foreach(int n in sequence())\n        Console.WriteLine(n);\n\n    Console.WriteLine(&quot;Done&quot;);\n\n    index = 100;\n    foreach (int n in sequence())\n        Console.WriteLine(n);\n}\n\n\npublic static IEnumerable&lt;int&gt; GetEnumrableInt(int index)\n{\n    List&lt;int&gt; l = new List&lt;int&gt;();\n    for(int i=index;i&lt;index+30;i++)\n    {\n        l.Add(i);\n    }\n    return l;\n}\n\n#endregion\n</code></pre><p>上面一坨代码演示了在闭包中使用了外部变量，随即又在外部修改了这些变量的情况，得到的结果是输出了20-50的数，然后又输出了100-130之间的数。这种行为有点诡异，但是确实有存在的意义…(书本这样说的，我到觉得很少会用到。)</p>\n<p>为了将查询表达式转换成可执行代码，C#编译器做了很多工作。一般而言，C#编译器将查询和lambda表达式转换成 “静态委托”、”实例委托” 或 “闭包”。编译器将根据lambda表达式中的代码选择一种实现方式。选择哪种方式依赖于lambda表达式的主体（body）。这看上去似乎是一些语言上的实现细节，但它却会显著地影响到我们的代码。编译器选择何种实现将可能导致diamante行为发生微妙的变化。</p>\n<p>并不是任何的lambda表达式都会生成同样结构的代码。</p>\n<p>对于编译器来说，最简单的一种行为是为以下形式的代码生成委托。  </p>\n<pre><code>//我们的lambda表达式\npublic static void test2()\n{\n    int[] someNum = {0,1,2,3,4,5,6,7,8,9,10 };\n\n    IEnumerable&lt;int&gt; ans = from n in someNum\n                           select n * n;\n\n    foreach (int i in ans)\n        Console.WriteLine(i);\n\n}\n</code></pre><p>编译器将使用静态委托来实现n*n的lambda表达式，其为上面代码生成的代码如下：</p>\n<pre><code> //编译器为我们的lambda生成的代码\n#region 等价于 test2()\nprivate static int HiddenFunc(int n)\n{\n    return n * n;\n}\n\n//静态委托\nprivate static Func&lt;int, int&gt; HiddenDelegate;\n\npublic void test2_1()\n{\n\n    int[] someNum = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };\n\n    if(HiddenDelegate==null)\n    {\n        HiddenDelegate = new Func&lt;int, int&gt;(HiddenFunc);\n    }\n    IEnumerable&lt;int&gt; ans = someNum.Select&lt;int, int&gt;(HiddenDelegate);\n\n  foreach(int i in ans)\n      Console.WriteLine(i);\n\n}\n#endregion\n</code></pre><p>这个lambda表达式主体部分并没有访问任何的实例变量或者局部变量。lambda表达式仅仅访问了它的参数。对于这种情况，C#编译器将创建一个静态方法，作为委托的目标。这也是编译器执行的最简单的一种处理方式。若表达式可以通过私有的静态方法实现，那么编译器将生成该私有的静态方法以及相对应的委托定义。对于上面的代码例子中的情况以及仅访问了静态变量的表达式，编译器都会采用这样的方案。</p>\n<p>接下来介绍另一种较为简单的情况：<br>lambda表达式需要访问类型的实例变量，但无需访问外层方法中的局部变量。</p>\n<pre><code>public class ModFilter\n{\n    private readonly int modules;\n\n    public ModFilter(int mod)\n    {\n        modules = mod;\n    }\n\n\n    public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)\n    {\n\n        return from n in sequence\n               where n % modules == 0 //新添加的表达式\n               select n * n;  //和前面的例子是一样的\n    }\n}\n</code></pre><p>/* </p>\n<p>在这种情况下，编译器将为表达式创建一个实例方法来包装该委托。<br>其基本概念和前一种情况一致，只是这里使用了实例方法，以便读取并修改当前对象的状态。<br>与静态委托的例子一样，这里编译器将把lambda表达式转换成我们熟悉的代码。其中包含委托的定义以及方法调用。<br>如下：</p>\n<p>*/</p>\n<pre><code>public class ModFilter_Other\n{\n    private readonly int modules;\n\n\n    //实例方法\n    private bool WhereClause(int n)\n    {\n        return ((n%this.modules) ==0);\n    }\n\n\n    private static int SelectClause(int n)\n    {\n        return n * n;\n    }\n\n    private static Func&lt;int, int&gt; SelectDelegate;\n\n\n\n\n    public ModFilter_Other(int mod)\n    {\n        modules = mod;\n    }\n\n\n    public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)\n    {\n        if(SelectDelegate==null)\n        {\n            SelectDelegate = new Func&lt;int, int&gt;(SelectClause);\n        }\n\n        return sequence.Where&lt;int&gt;(\n            new Func&lt;int, bool&gt;(this.WhereClause)).\n            Select&lt;int, int&gt;(SelectClause);\n    }\n}\n</code></pre><p>概括来说便是：lambda表达式中的代码访问了对象实例中的成员变量，那么编译器将生成实例方法来表示lambda表达式中的代码。其实这并没有什么奇特之处——编译器省去了我们的一些代码输入工作，代码也变得整洁很多，本质来说这还是普通的方法调用。</p>\n<p>不过若是lambda表达式中访问到了外部方法中的局部变量或者方法参数，那么编译器将帮你完成很多工作。</p>\n<p>这里会用到闭包。编译器将生成一个私有的嵌套类型，以便为局部变量实现闭包。</p>\n<p>局部变量必须传入到实现了lambda表达式主体部分的委托里。</p>\n<p>此外，所有由该lambda表达式执行的对这些局部变量所作的修改都必须能够在外部访问到。</p>\n<p>当然，代码中内层和外层中共享的可能不止有一个变量，也可能不止一个的查询表达式。</p>\n<p>我们来修改一下该实例方法，让其访问一个局部变量。</p>\n<pre><code>public class ModFilter\n{\n      private readonly int modules;\n\n      public ModFilter(int mod)\n      {\n          modules = mod;\n      }\n\n\n      public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)\n      {\n          int numValues = 0;\n\n          return from n in sequence\n                 where n % modules == 0 //新添加的表达式\n                 select n * n / ++ numValues; //访问局部变量\n      }\n}\n</code></pre><p>注意，select字句需要访问numValues这个局部变量。编译器为了创建这个闭包，需要使用嵌套类型来实现你所需要的行为。下面展示的是编译器为你生成的代码。</p>\n<pre><code>  public class ModFilter\n {\n    private sealed class Closure\n    {\n        public ModFilter outer;\n\n        public int numValues;\n\n        public int SelectClause(int n)\n        {\n            return ((n * n) / ++this.numValues);\n        }\n    }\n\n\n\n    private readonly int modules;\n\n\n    //实例方法\n    private bool WhereClause(int n)\n    {\n        return ((n % this.modules) == 0);\n    }\n\n    public ModFilter(int mod)\n    {\n        modules = mod;\n    }\n\n\n    public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)\n    {\n        Closure c = new Closure();\n        c.outer = this;\n        c.numValues = 0;\n\n        return sequence.Where&lt;int&gt;(\n            new Func&lt;int, bool&gt;(this.WhereClause)).\n            Select&lt;int, int&gt;(c.SelectClause);\n    }\n}\n</code></pre><p>在上面这段代码中，编译器专门创建了一个嵌套类，用来容纳所有将在lambda表达式中访问或修改的变量。实际上，这些局部变量将完全被嵌套类的字段所代替。lambda表达式内部的代码以及表达式外部(但仍在当前方法内)的代码访问的均是同一个字段，lambda表达式中的逻辑也被编译成了内部类的一个方法。</p>\n<p>对于lambda表达式中将要用到的外部方法的参数，编译器也会以对待局部变量的方式实现：编译器将这些参数复制到表示该闭包的嵌套类中。</p>\n<p>回到最开始的那个示例，这是我们应该可以理解这种看似怪异的行为了。变量index在传入闭包后，但在查询开始执行前曾被外部代码修改。也就是说，你修改了闭包的内部状态，然后还期待其能够回到从前的状态开始执行，显然这是不可能实现的。</p>\n<p>考虑到延迟执行中的交互以及编译器实现闭包的方式，修改查询与外部代码之间绑定的变量将可能会引发错误的行为。<br>因此，我们应该尽量避免在方法中修改哪些将要传入到闭包中，并将在闭包中使用的变量。</p>\n"},{"layout":"post","title":"ASP.NET Core 启动方式（Hosting）","date":"2016-07-27T16:00:00.000Z","_content":"\n之前版本的ASP.NET程序必须依赖IIS来启动，而IIS上会为挂载在其中的ASP.NET 注册一个ISAPI filter。每当http请求过来时，IIS则会启动w3wp的worker process来开始整个ASP.NET runtime程序。相信大家都这样的流程都有相应的了解。在.net core之前，ASP.NET的主要场景都是运行在Windows平台的，IIS也就是web server的首选了。虽然也有类似于jexus的linux webserver可用，但是基于mono的.NET 总体还是不够Microsoft 原生的强。\n\n不过到了现在，一切都不同了。\n\n###### 新版ASP.NET Core有了.NET Core的支援后已经开始了它的跨平台之旅了，因此ASP.NET Core的启动方式也得开始重新设计以适应新需求了。\n\n\n### 1、Kestrel 和 IIS platform handler\n\n在 ASP.NET Core 中，整个runtime都是重写过的，所以它和IIS之间的关系也有所改变。而ASP.NET Core为了跨平台，它现在的执行方式就如一般的Console app一样。ASP.NET Core自带一个高性能的I/O组件 - Kestrel，使得它可以不依赖IIS的存在便启动了runtime。不过Kestrel 也只是一个I/O组件，并没有想IIS提供其它的功能来保护和管理ASP.NET 应用程序。ASP.NET Core同样可以通过IIS进行处理。但是如果通过IIS来进行处理的话，这个时候我们便需要一个“中间人”的角色来负责这个功能了。这个“中间人”的名字叫 Http Platform Handler，主要表现在web.config文档中的设置，其中包括启动ASP.NET Core 程序的的路径和名称，需要传入的参数以及一些其他的设置选项。Http Platform Handler的具体设置例子如下：\n```csharp\n<system.webServer>\n    <handlers>\n      <add name=\"httpPlatformHandler\" path=\"*\" verb=\"*\"\n      modules=\"httpPlatformHandler\" resourceType=\"Unspecified\"/>\n    </handlers>\n    <httpPlatform processPath=\"WebApp.exe\" arguments=\"\" \n    stdoutLogEnabled=\"false\" startupTimeLimit=\"3600\"/>\n  </system.webServer>\n\n```\n关于Http Platform Handler的相关资料可以看这个链接：\n[http://www.iis.net/downloads/microsoft/httpplatformhandler](http://www.iis.net/downloads/microsoft/httpplatformhandler)\n\n\n从上面的例子可以看出来，ASP.NET Core编译之后便是一个EXE程序，使得你可以直接运行。因此，当HTTP请求进来时，IIS先接受请求，然后根据你设置的web.config的内容将请求转发给WebApp.exe（你的ASP.NET Core程序），然后WebApp.exe开始执行时便会启动Kestrel，接着这个HTTP请求便进入了ASP.NET Core runtime的世界。这样看来，IIS这时候只是一个简单的proxy/forwarder角色。\n\nPS：在我翻译整理这个文章的时候，世界已经发生了变化：下个版本的asp.net core 将会有全新的IIS module来取代Http Platform Handler。\n\n具体详细资料见：[https://github.com/aspnet/IISIntegration/issues/105](https://github.com/aspnet/IISIntegration/issues/105)\n\n\n\n### 2、Main()\nASP.NET Core和其他的.NET 程序一样拥有一个static void Main(),这是整个runtime的进入点。下面看一个样例：\n```csharp\n public static void Main(string[] args)\n        {\n            var host = new WebHostBuilder()\n                .UseServer(\"Microsoft.AspNetCore.Server.Kestrel\")\n                .UseContentRoot(Directory.GetCurrentDirectory())\n                .UseDefaultConfiguration(args)\n                .UseIISPlatformHandlerUrl()\n                .UseStartup<Startup>()\n                .Build();\n\n            host.Run();\n        }\n```\n\nASP.NET Core host engine 的建立者是 WebHostBuilder．\n\n它实质上是一个了 IWebHostBuilder interface，其中 UseServer() 是用于指定使用什么样的 server。\n\n其中 UseServer() 有一个扩展方法UseServer(string assemblyName)。这样的话我们可以直接传入Kestrel的程序集名称:\"Microsoft.AspNetCore.Server.Kestrel\"。当然，这只是其中一种选项。你也可以自己实现一个自己的 server，只要你的 server 实现了 IServerFactory interface 即可。这样的设计提供了一个很大的弹性空间让我们自行选择hosting server（托管服务）。\n\n##### UseContentRoot() \n- 这个扩展方法是让我们指定应用程序的工作目录（working directory），如果我们没有指定的话，则会默认为我们的应用（webapp.exe）所在目录为工作目录。\n\n##### UseDefaultConfiguration() \n- 这个扩展方法使得我们在IWebHostBuilder 建立可以传入一些参数，比如 application key, environment name, server factory location, content root path 等等．因此，当我们在运行 WebApp.exe 的时候，同时可以带入我们需要用到的hosting参数（PS：这样的做法就像运行命令行程序时带入参数，多好玩）。这些参数也可以写在appsettings.json里面通过Configuration来读取。\n所以，UseDefaultConfiguration() 也不一定非要存在于 Main() 之中。（？？？个人不是很理解）\n\nPS：原作者原话，\"如果我沒记错的话，在写这个文章的时候，UseDefaultConfiguration() 已经被改为成了UseDefaultHostingConfiguration()．显然这个名称更能清楚明白．\"(？？？个人还没实践)\n\n\n##### UseIISPlatofmrHandleUrl() \n- 这个 IWebHostBuilder 的 扩展方法比较特殊。如果你要把 ASP.NET Core 放在 IIS 下，这个扩展方法会读取 IIS http platform handler 的 server port 和 application path，用于作为 ASP.NET Core 的启动位置，如 http://localhost:5000/start．如果你沒用 IIS，这个扩展方法对你来说基本是用不上的．\n\n##### UseStartup<>()\n\n- 这是 WebHostBuilder 里相当重要的一个扩展方法。它的方法签名如下：\n\n```csharp\n\npublic static IWebHostBuilder UseStartup<TStartup>\n(this IWebHostBuilder hostBuilder) where TStartup : class\n\n```\n这里你可以很清楚地看到 <> 里面要放的就是一个 class。\n\n在我们这里的范例中，它的名字是 Startup，里面最重要的就是需要定义要使用那些服务(service)以及要使用那些中间件(middleware)。\n\n\n### 3、Startup\n这是一个非常非常重要的class,在ASP.NET Core范例中一般都把它命名成Startup。其实我们把它命名成其他名字也是可以的，或者设定多个Startup。上面的内容可以看到，UseStartup()指定了谁是starup class。然后在Build()便会实例化starup class，之后便执行里面两个重要的方法：ConfigureServices() 和 Configure()。\n\n我们先來看 Startup 的构造函数.\n\n```csharp\n public Startup(IHostingEnvironment env)\n        {\n            // Set up configuration sources.\n            var builder = new ConfigurationBuilder()\n                .AddJsonFile(\"appsettings.json\")\n                .AddJsonFile($\"appsettings.{env.EnvironmentName}.json\", optional: true)\n                .AddEnvironmentVariables();\n            Configuration = builder.Build().ReloadOnChanged(\"appsettings.json\");\n        }\n```\n\nHost engine 在被执行 Build()时已经知道 startup type 是 Startup class，所以在 Build() 的时候会先创建期示例。在我们这里的是调用Startup类带参数的构造函数。\n\n在我们这个例子中选择的是传入IHostingEnvironment示例，它为我们带来了环境变量（EnvironmentName）。\n\n我们这里主要目的是把Configuration实例化。这是一个蛮重要的基础组件，以后会有文章来说明它。\n\n在这里我们特别说明一下，上面的示例代码中，我们执行了两次 AddJsonFile()，而且第二个json file的参数和第一个的还不太一样。这样的目的是为了让开发者可以把开发环境使用的环境参数和其他环境使用的参数有所区别。比如，你使用的开发环境用的是appsettings.json，这个文件只存在于你的电脑中。另一个文档是appsettings.production.json，这是正式环境使用的参数设定文档。第二個 AddJsonFile() 第二個参数是 true，也就是可能不存在的意思。所以若遇到重复名称参数时，appsettings.production.json 会覆盖 appsettings.json 的內容。这样使得开发环境和生产环境得以区分。\n\n接下来，在 IWebHostBuilder 的 Build()里面会执行 host engine 初始化的程序，其中就会去找Startup class里面的两个方法： ConfigureServices() 和 Configure()。\n\n ConfigureSerivces() 是定义了这个 web application 要使用那些服务，然后将这些服务放在 service container (IServiceCollection) 裡面。如下面的样例：\n \n ```csharp\n \n   public void ConfigureServices(IServiceCollection services)\n        {\n            // add entity framework\n            services.AddEntityFramework()\n                    .AddDbContext<BlogsContext>(o => o.UseSqlServer(Configuration[\"Data1:DefaultConnection:ConnectionString\"]))\n             \n            // Add framework services.\n            services.AddMvc();\n        }\n\n```\n\n它定义了entity framework和mvc两个服务。这里所谓的服务（services）的意思也就是通过它们带入更庞大的程序代码。这听起来好像有点搞笑，但也真的如此。像Entity framework 里面有这么多的代码，一定都需要带入许多定义好的物件或者参数，而不只是一个程序的进去点而已，所以services 的目的就是在这里。\n\n\nConfigure() 主要是定义了中间件（middleware）以及它们的顺序．\n\n```csharp\n        public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)\n        {\n            loggerFactory.AddConsole(Configuration.GetSection(\"Logging\"));\n            loggerFactory.AddDebug();\n\n            app.UseStaticFiles();\n\n            app.UseMvcWithDefaultRoute();\n        }\n\n```\n\n\n### 4、Build 和 Run\n最后，在IHostWebBuilder里最后的两个动作便是：Build and Run. \n\n\n##### Build() \n- 这个方法做的工作便是建立 hosting service，把 Startup 中定义的的 services 和 middleware 接收过来，然后确定content root path 和 application name，接着一句前面这些资料再加上Configuration过来的数据来初始化host engine (WebHost.cs)．\n\n##### Run() \n- 这个是启动 host engine 的 扩展方法，它在启动之前加入了一个 CancelKeyPress 的事件．因为在 Run() 方法 中传入入了 CancellationTokenSource() ，让我们有一个方法可以随时中断host engine的执行。\n\n目前的做法就用是 CancelKeyPress 事件，所以你可以按下 Ctrl+C  來中止 host engine 的执行．\n\n比较特別的是，这一段中止的文字说明居然是用 hard code，參考如下:\n\nhost.Run(cts.Token, \"Application started. Press Ctrl+C to shut down.\");\n\n不过这样的话，这里你也不能写中文...\n\n本文整理于[https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327](https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327)并已征得作者同意。\n感谢Bruce的分享。\n ","source":"_posts/asp.net-core-startup.md","raw":"---\nlayout: post\ntitle: ASP.NET Core 启动方式（Hosting）\ncategory: .net core\ndate: 2016-07-28 00:00:00\n---\n\n之前版本的ASP.NET程序必须依赖IIS来启动，而IIS上会为挂载在其中的ASP.NET 注册一个ISAPI filter。每当http请求过来时，IIS则会启动w3wp的worker process来开始整个ASP.NET runtime程序。相信大家都这样的流程都有相应的了解。在.net core之前，ASP.NET的主要场景都是运行在Windows平台的，IIS也就是web server的首选了。虽然也有类似于jexus的linux webserver可用，但是基于mono的.NET 总体还是不够Microsoft 原生的强。\n\n不过到了现在，一切都不同了。\n\n###### 新版ASP.NET Core有了.NET Core的支援后已经开始了它的跨平台之旅了，因此ASP.NET Core的启动方式也得开始重新设计以适应新需求了。\n\n\n### 1、Kestrel 和 IIS platform handler\n\n在 ASP.NET Core 中，整个runtime都是重写过的，所以它和IIS之间的关系也有所改变。而ASP.NET Core为了跨平台，它现在的执行方式就如一般的Console app一样。ASP.NET Core自带一个高性能的I/O组件 - Kestrel，使得它可以不依赖IIS的存在便启动了runtime。不过Kestrel 也只是一个I/O组件，并没有想IIS提供其它的功能来保护和管理ASP.NET 应用程序。ASP.NET Core同样可以通过IIS进行处理。但是如果通过IIS来进行处理的话，这个时候我们便需要一个“中间人”的角色来负责这个功能了。这个“中间人”的名字叫 Http Platform Handler，主要表现在web.config文档中的设置，其中包括启动ASP.NET Core 程序的的路径和名称，需要传入的参数以及一些其他的设置选项。Http Platform Handler的具体设置例子如下：\n```csharp\n<system.webServer>\n    <handlers>\n      <add name=\"httpPlatformHandler\" path=\"*\" verb=\"*\"\n      modules=\"httpPlatformHandler\" resourceType=\"Unspecified\"/>\n    </handlers>\n    <httpPlatform processPath=\"WebApp.exe\" arguments=\"\" \n    stdoutLogEnabled=\"false\" startupTimeLimit=\"3600\"/>\n  </system.webServer>\n\n```\n关于Http Platform Handler的相关资料可以看这个链接：\n[http://www.iis.net/downloads/microsoft/httpplatformhandler](http://www.iis.net/downloads/microsoft/httpplatformhandler)\n\n\n从上面的例子可以看出来，ASP.NET Core编译之后便是一个EXE程序，使得你可以直接运行。因此，当HTTP请求进来时，IIS先接受请求，然后根据你设置的web.config的内容将请求转发给WebApp.exe（你的ASP.NET Core程序），然后WebApp.exe开始执行时便会启动Kestrel，接着这个HTTP请求便进入了ASP.NET Core runtime的世界。这样看来，IIS这时候只是一个简单的proxy/forwarder角色。\n\nPS：在我翻译整理这个文章的时候，世界已经发生了变化：下个版本的asp.net core 将会有全新的IIS module来取代Http Platform Handler。\n\n具体详细资料见：[https://github.com/aspnet/IISIntegration/issues/105](https://github.com/aspnet/IISIntegration/issues/105)\n\n\n\n### 2、Main()\nASP.NET Core和其他的.NET 程序一样拥有一个static void Main(),这是整个runtime的进入点。下面看一个样例：\n```csharp\n public static void Main(string[] args)\n        {\n            var host = new WebHostBuilder()\n                .UseServer(\"Microsoft.AspNetCore.Server.Kestrel\")\n                .UseContentRoot(Directory.GetCurrentDirectory())\n                .UseDefaultConfiguration(args)\n                .UseIISPlatformHandlerUrl()\n                .UseStartup<Startup>()\n                .Build();\n\n            host.Run();\n        }\n```\n\nASP.NET Core host engine 的建立者是 WebHostBuilder．\n\n它实质上是一个了 IWebHostBuilder interface，其中 UseServer() 是用于指定使用什么样的 server。\n\n其中 UseServer() 有一个扩展方法UseServer(string assemblyName)。这样的话我们可以直接传入Kestrel的程序集名称:\"Microsoft.AspNetCore.Server.Kestrel\"。当然，这只是其中一种选项。你也可以自己实现一个自己的 server，只要你的 server 实现了 IServerFactory interface 即可。这样的设计提供了一个很大的弹性空间让我们自行选择hosting server（托管服务）。\n\n##### UseContentRoot() \n- 这个扩展方法是让我们指定应用程序的工作目录（working directory），如果我们没有指定的话，则会默认为我们的应用（webapp.exe）所在目录为工作目录。\n\n##### UseDefaultConfiguration() \n- 这个扩展方法使得我们在IWebHostBuilder 建立可以传入一些参数，比如 application key, environment name, server factory location, content root path 等等．因此，当我们在运行 WebApp.exe 的时候，同时可以带入我们需要用到的hosting参数（PS：这样的做法就像运行命令行程序时带入参数，多好玩）。这些参数也可以写在appsettings.json里面通过Configuration来读取。\n所以，UseDefaultConfiguration() 也不一定非要存在于 Main() 之中。（？？？个人不是很理解）\n\nPS：原作者原话，\"如果我沒记错的话，在写这个文章的时候，UseDefaultConfiguration() 已经被改为成了UseDefaultHostingConfiguration()．显然这个名称更能清楚明白．\"(？？？个人还没实践)\n\n\n##### UseIISPlatofmrHandleUrl() \n- 这个 IWebHostBuilder 的 扩展方法比较特殊。如果你要把 ASP.NET Core 放在 IIS 下，这个扩展方法会读取 IIS http platform handler 的 server port 和 application path，用于作为 ASP.NET Core 的启动位置，如 http://localhost:5000/start．如果你沒用 IIS，这个扩展方法对你来说基本是用不上的．\n\n##### UseStartup<>()\n\n- 这是 WebHostBuilder 里相当重要的一个扩展方法。它的方法签名如下：\n\n```csharp\n\npublic static IWebHostBuilder UseStartup<TStartup>\n(this IWebHostBuilder hostBuilder) where TStartup : class\n\n```\n这里你可以很清楚地看到 <> 里面要放的就是一个 class。\n\n在我们这里的范例中，它的名字是 Startup，里面最重要的就是需要定义要使用那些服务(service)以及要使用那些中间件(middleware)。\n\n\n### 3、Startup\n这是一个非常非常重要的class,在ASP.NET Core范例中一般都把它命名成Startup。其实我们把它命名成其他名字也是可以的，或者设定多个Startup。上面的内容可以看到，UseStartup()指定了谁是starup class。然后在Build()便会实例化starup class，之后便执行里面两个重要的方法：ConfigureServices() 和 Configure()。\n\n我们先來看 Startup 的构造函数.\n\n```csharp\n public Startup(IHostingEnvironment env)\n        {\n            // Set up configuration sources.\n            var builder = new ConfigurationBuilder()\n                .AddJsonFile(\"appsettings.json\")\n                .AddJsonFile($\"appsettings.{env.EnvironmentName}.json\", optional: true)\n                .AddEnvironmentVariables();\n            Configuration = builder.Build().ReloadOnChanged(\"appsettings.json\");\n        }\n```\n\nHost engine 在被执行 Build()时已经知道 startup type 是 Startup class，所以在 Build() 的时候会先创建期示例。在我们这里的是调用Startup类带参数的构造函数。\n\n在我们这个例子中选择的是传入IHostingEnvironment示例，它为我们带来了环境变量（EnvironmentName）。\n\n我们这里主要目的是把Configuration实例化。这是一个蛮重要的基础组件，以后会有文章来说明它。\n\n在这里我们特别说明一下，上面的示例代码中，我们执行了两次 AddJsonFile()，而且第二个json file的参数和第一个的还不太一样。这样的目的是为了让开发者可以把开发环境使用的环境参数和其他环境使用的参数有所区别。比如，你使用的开发环境用的是appsettings.json，这个文件只存在于你的电脑中。另一个文档是appsettings.production.json，这是正式环境使用的参数设定文档。第二個 AddJsonFile() 第二個参数是 true，也就是可能不存在的意思。所以若遇到重复名称参数时，appsettings.production.json 会覆盖 appsettings.json 的內容。这样使得开发环境和生产环境得以区分。\n\n接下来，在 IWebHostBuilder 的 Build()里面会执行 host engine 初始化的程序，其中就会去找Startup class里面的两个方法： ConfigureServices() 和 Configure()。\n\n ConfigureSerivces() 是定义了这个 web application 要使用那些服务，然后将这些服务放在 service container (IServiceCollection) 裡面。如下面的样例：\n \n ```csharp\n \n   public void ConfigureServices(IServiceCollection services)\n        {\n            // add entity framework\n            services.AddEntityFramework()\n                    .AddDbContext<BlogsContext>(o => o.UseSqlServer(Configuration[\"Data1:DefaultConnection:ConnectionString\"]))\n             \n            // Add framework services.\n            services.AddMvc();\n        }\n\n```\n\n它定义了entity framework和mvc两个服务。这里所谓的服务（services）的意思也就是通过它们带入更庞大的程序代码。这听起来好像有点搞笑，但也真的如此。像Entity framework 里面有这么多的代码，一定都需要带入许多定义好的物件或者参数，而不只是一个程序的进去点而已，所以services 的目的就是在这里。\n\n\nConfigure() 主要是定义了中间件（middleware）以及它们的顺序．\n\n```csharp\n        public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)\n        {\n            loggerFactory.AddConsole(Configuration.GetSection(\"Logging\"));\n            loggerFactory.AddDebug();\n\n            app.UseStaticFiles();\n\n            app.UseMvcWithDefaultRoute();\n        }\n\n```\n\n\n### 4、Build 和 Run\n最后，在IHostWebBuilder里最后的两个动作便是：Build and Run. \n\n\n##### Build() \n- 这个方法做的工作便是建立 hosting service，把 Startup 中定义的的 services 和 middleware 接收过来，然后确定content root path 和 application name，接着一句前面这些资料再加上Configuration过来的数据来初始化host engine (WebHost.cs)．\n\n##### Run() \n- 这个是启动 host engine 的 扩展方法，它在启动之前加入了一个 CancelKeyPress 的事件．因为在 Run() 方法 中传入入了 CancellationTokenSource() ，让我们有一个方法可以随时中断host engine的执行。\n\n目前的做法就用是 CancelKeyPress 事件，所以你可以按下 Ctrl+C  來中止 host engine 的执行．\n\n比较特別的是，这一段中止的文字说明居然是用 hard code，參考如下:\n\nhost.Run(cts.Token, \"Application started. Press Ctrl+C to shut down.\");\n\n不过这样的话，这里你也不能写中文...\n\n本文整理于[https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327](https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327)并已征得作者同意。\n感谢Bruce的分享。\n ","slug":"asp.net-core-startup","published":1,"updated":"2016-09-15T05:11:13.652Z","comments":1,"photos":[],"link":"","_id":"cit3xw9t6000pc0txk4ejz6h6","content":"<p>之前版本的ASP.NET程序必须依赖IIS来启动，而IIS上会为挂载在其中的ASP.NET 注册一个ISAPI filter。每当http请求过来时，IIS则会启动w3wp的worker process来开始整个ASP.NET runtime程序。相信大家都这样的流程都有相应的了解。在.net core之前，ASP.NET的主要场景都是运行在Windows平台的，IIS也就是web server的首选了。虽然也有类似于jexus的linux webserver可用，但是基于mono的.NET 总体还是不够Microsoft 原生的强。</p>\n<p>不过到了现在，一切都不同了。</p>\n<h6 id=\"新版ASP-NET-Core有了-NET-Core的支援后已经开始了它的跨平台之旅了，因此ASP-NET-Core的启动方式也得开始重新设计以适应新需求了。\"><a href=\"#新版ASP-NET-Core有了-NET-Core的支援后已经开始了它的跨平台之旅了，因此ASP-NET-Core的启动方式也得开始重新设计以适应新需求了。\" class=\"headerlink\" title=\"新版ASP.NET Core有了.NET Core的支援后已经开始了它的跨平台之旅了，因此ASP.NET Core的启动方式也得开始重新设计以适应新需求了。\"></a>新版ASP.NET Core有了.NET Core的支援后已经开始了它的跨平台之旅了，因此ASP.NET Core的启动方式也得开始重新设计以适应新需求了。</h6><h3 id=\"1、Kestrel-和-IIS-platform-handler\"><a href=\"#1、Kestrel-和-IIS-platform-handler\" class=\"headerlink\" title=\"1、Kestrel 和 IIS platform handler\"></a>1、Kestrel 和 IIS platform handler</h3><p>在 ASP.NET Core 中，整个runtime都是重写过的，所以它和IIS之间的关系也有所改变。而ASP.NET Core为了跨平台，它现在的执行方式就如一般的Console app一样。ASP.NET Core自带一个高性能的I/O组件 - Kestrel，使得它可以不依赖IIS的存在便启动了runtime。不过Kestrel 也只是一个I/O组件，并没有想IIS提供其它的功能来保护和管理ASP.NET 应用程序。ASP.NET Core同样可以通过IIS进行处理。但是如果通过IIS来进行处理的话，这个时候我们便需要一个“中间人”的角色来负责这个功能了。这个“中间人”的名字叫 Http Platform Handler，主要表现在web.config文档中的设置，其中包括启动ASP.NET Core 程序的的路径和名称，需要传入的参数以及一些其他的设置选项。Http Platform Handler的具体设置例子如下：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;system.webServer&gt;</div><div class=\"line\">    &lt;handlers&gt;</div><div class=\"line\">      &lt;add name=<span class=\"string\">\"httpPlatformHandler\"</span> path=<span class=\"string\">\"*\"</span> verb=<span class=\"string\">\"*\"</span></div><div class=\"line\">      modules=<span class=\"string\">\"httpPlatformHandler\"</span> resourceType=<span class=\"string\">\"Unspecified\"</span>/&gt;</div><div class=\"line\">    &lt;/handlers&gt;</div><div class=\"line\">    &lt;httpPlatform processPath=<span class=\"string\">\"WebApp.exe\"</span> arguments=<span class=\"string\">\"\"</span> </div><div class=\"line\">    stdoutLogEnabled=<span class=\"string\">\"false\"</span> startupTimeLimit=<span class=\"string\">\"3600\"</span>/&gt;</div><div class=\"line\">  &lt;/system.webServer&gt;</div></pre></td></tr></table></figure></p>\n<p>关于Http Platform Handler的相关资料可以看这个链接：<br><a href=\"http://www.iis.net/downloads/microsoft/httpplatformhandler\" target=\"_blank\" rel=\"external\">http://www.iis.net/downloads/microsoft/httpplatformhandler</a></p>\n<p>从上面的例子可以看出来，ASP.NET Core编译之后便是一个EXE程序，使得你可以直接运行。因此，当HTTP请求进来时，IIS先接受请求，然后根据你设置的web.config的内容将请求转发给WebApp.exe（你的ASP.NET Core程序），然后WebApp.exe开始执行时便会启动Kestrel，接着这个HTTP请求便进入了ASP.NET Core runtime的世界。这样看来，IIS这时候只是一个简单的proxy/forwarder角色。</p>\n<p>PS：在我翻译整理这个文章的时候，世界已经发生了变化：下个版本的asp.net core 将会有全新的IIS module来取代Http Platform Handler。</p>\n<p>具体详细资料见：<a href=\"https://github.com/aspnet/IISIntegration/issues/105\" target=\"_blank\" rel=\"external\">https://github.com/aspnet/IISIntegration/issues/105</a></p>\n<h3 id=\"2、Main\"><a href=\"#2、Main\" class=\"headerlink\" title=\"2、Main()\"></a>2、Main()</h3><p>ASP.NET Core和其他的.NET 程序一样拥有一个static void Main(),这是整个runtime的进入点。下面看一个样例：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"keyword\">string</span>[] args</span>)</span></div><div class=\"line\">       &#123;</div><div class=\"line\">           <span class=\"keyword\">var</span> host = <span class=\"keyword\">new</span> WebHostBuilder()</div><div class=\"line\">               .UseServer(<span class=\"string\">\"Microsoft.AspNetCore.Server.Kestrel\"</span>)</div><div class=\"line\">               .UseContentRoot(Directory.GetCurrentDirectory())</div><div class=\"line\">               .UseDefaultConfiguration(args)</div><div class=\"line\">               .UseIISPlatformHandlerUrl()</div><div class=\"line\">               .UseStartup&lt;Startup&gt;()</div><div class=\"line\">               .Build();</div><div class=\"line\"></div><div class=\"line\">           host.Run();</div><div class=\"line\">       &#125;</div></pre></td></tr></table></figure></p>\n<p>ASP.NET Core host engine 的建立者是 WebHostBuilder．</p>\n<p>它实质上是一个了 IWebHostBuilder interface，其中 UseServer() 是用于指定使用什么样的 server。</p>\n<p>其中 UseServer() 有一个扩展方法UseServer(string assemblyName)。这样的话我们可以直接传入Kestrel的程序集名称:”Microsoft.AspNetCore.Server.Kestrel”。当然，这只是其中一种选项。你也可以自己实现一个自己的 server，只要你的 server 实现了 IServerFactory interface 即可。这样的设计提供了一个很大的弹性空间让我们自行选择hosting server（托管服务）。</p>\n<h5 id=\"UseContentRoot\"><a href=\"#UseContentRoot\" class=\"headerlink\" title=\"UseContentRoot()\"></a>UseContentRoot()</h5><ul>\n<li>这个扩展方法是让我们指定应用程序的工作目录（working directory），如果我们没有指定的话，则会默认为我们的应用（webapp.exe）所在目录为工作目录。</li>\n</ul>\n<h5 id=\"UseDefaultConfiguration\"><a href=\"#UseDefaultConfiguration\" class=\"headerlink\" title=\"UseDefaultConfiguration()\"></a>UseDefaultConfiguration()</h5><ul>\n<li>这个扩展方法使得我们在IWebHostBuilder 建立可以传入一些参数，比如 application key, environment name, server factory location, content root path 等等．因此，当我们在运行 WebApp.exe 的时候，同时可以带入我们需要用到的hosting参数（PS：这样的做法就像运行命令行程序时带入参数，多好玩）。这些参数也可以写在appsettings.json里面通过Configuration来读取。<br>所以，UseDefaultConfiguration() 也不一定非要存在于 Main() 之中。（？？？个人不是很理解）</li>\n</ul>\n<p>PS：原作者原话，”如果我沒记错的话，在写这个文章的时候，UseDefaultConfiguration() 已经被改为成了UseDefaultHostingConfiguration()．显然这个名称更能清楚明白．”(？？？个人还没实践)</p>\n<h5 id=\"UseIISPlatofmrHandleUrl\"><a href=\"#UseIISPlatofmrHandleUrl\" class=\"headerlink\" title=\"UseIISPlatofmrHandleUrl()\"></a>UseIISPlatofmrHandleUrl()</h5><ul>\n<li>这个 IWebHostBuilder 的 扩展方法比较特殊。如果你要把 ASP.NET Core 放在 IIS 下，这个扩展方法会读取 IIS http platform handler 的 server port 和 application path，用于作为 ASP.NET Core 的启动位置，如 <a href=\"http://localhost:5000/start．如果你沒用\" target=\"_blank\" rel=\"external\">http://localhost:5000/start．如果你沒用</a> IIS，这个扩展方法对你来说基本是用不上的．</li>\n</ul>\n<h5 id=\"UseStartup-lt-gt\"><a href=\"#UseStartup-lt-gt\" class=\"headerlink\" title=\"UseStartup&lt;&gt;()\"></a>UseStartup&lt;&gt;()</h5><ul>\n<li>这是 WebHostBuilder 里相当重要的一个扩展方法。它的方法签名如下：</li>\n</ul>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IWebHostBuilder UseStartup&lt;TStartup&gt;</div><div class=\"line\">(<span class=\"keyword\">this</span> IWebHostBuilder hostBuilder) <span class=\"keyword\">where</span> TStartup : <span class=\"keyword\">class</span></div></pre></td></tr></table></figure>\n<p>这里你可以很清楚地看到 &lt;&gt; 里面要放的就是一个 class。</p>\n<p>在我们这里的范例中，它的名字是 Startup，里面最重要的就是需要定义要使用那些服务(service)以及要使用那些中间件(middleware)。</p>\n<h3 id=\"3、Startup\"><a href=\"#3、Startup\" class=\"headerlink\" title=\"3、Startup\"></a>3、Startup</h3><p>这是一个非常非常重要的class,在ASP.NET Core范例中一般都把它命名成Startup。其实我们把它命名成其他名字也是可以的，或者设定多个Startup。上面的内容可以看到，UseStartup()指定了谁是starup class。然后在Build()便会实例化starup class，之后便执行里面两个重要的方法：ConfigureServices() 和 Configure()。</p>\n<p>我们先來看 Startup 的构造函数.</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Startup</span>(<span class=\"params\">IHostingEnvironment env</span>)</span></div><div class=\"line\">       &#123;</div><div class=\"line\">           <span class=\"comment\">// Set up configuration sources.</span></div><div class=\"line\">           <span class=\"keyword\">var</span> builder = <span class=\"keyword\">new</span> ConfigurationBuilder()</div><div class=\"line\">               .AddJsonFile(<span class=\"string\">\"appsettings.json\"</span>)</div><div class=\"line\">               .AddJsonFile(<span class=\"string\">$\"appsettings.<span class=\"subst\">&#123;env.EnvironmentName&#125;</span>.json\"</span>, optional: <span class=\"literal\">true</span>)</div><div class=\"line\">               .AddEnvironmentVariables();</div><div class=\"line\">           Configuration = builder.Build().ReloadOnChanged(<span class=\"string\">\"appsettings.json\"</span>);</div><div class=\"line\">       &#125;</div></pre></td></tr></table></figure>\n<p>Host engine 在被执行 Build()时已经知道 startup type 是 Startup class，所以在 Build() 的时候会先创建期示例。在我们这里的是调用Startup类带参数的构造函数。</p>\n<p>在我们这个例子中选择的是传入IHostingEnvironment示例，它为我们带来了环境变量（EnvironmentName）。</p>\n<p>我们这里主要目的是把Configuration实例化。这是一个蛮重要的基础组件，以后会有文章来说明它。</p>\n<p>在这里我们特别说明一下，上面的示例代码中，我们执行了两次 AddJsonFile()，而且第二个json file的参数和第一个的还不太一样。这样的目的是为了让开发者可以把开发环境使用的环境参数和其他环境使用的参数有所区别。比如，你使用的开发环境用的是appsettings.json，这个文件只存在于你的电脑中。另一个文档是appsettings.production.json，这是正式环境使用的参数设定文档。第二個 AddJsonFile() 第二個参数是 true，也就是可能不存在的意思。所以若遇到重复名称参数时，appsettings.production.json 会覆盖 appsettings.json 的內容。这样使得开发环境和生产环境得以区分。</p>\n<p>接下来，在 IWebHostBuilder 的 Build()里面会执行 host engine 初始化的程序，其中就会去找Startup class里面的两个方法： ConfigureServices() 和 Configure()。</p>\n<p> ConfigureSerivces() 是定义了这个 web application 要使用那些服务，然后将这些服务放在 service container (IServiceCollection) 裡面。如下面的样例：</p>\n <figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"> </div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></div><div class=\"line\">     &#123;</div><div class=\"line\">         <span class=\"comment\">// add entity framework</span></div><div class=\"line\">         services.AddEntityFramework()</div><div class=\"line\">                 .AddDbContext&lt;BlogsContext&gt;(o =&gt; o.UseSqlServer(Configuration[<span class=\"string\">\"Data1:DefaultConnection:ConnectionString\"</span>]))</div><div class=\"line\">          </div><div class=\"line\">         <span class=\"comment\">// Add framework services.</span></div><div class=\"line\">         services.AddMvc();</div><div class=\"line\">     &#125;</div></pre></td></tr></table></figure>\n<p>它定义了entity framework和mvc两个服务。这里所谓的服务（services）的意思也就是通过它们带入更庞大的程序代码。这听起来好像有点搞笑，但也真的如此。像Entity framework 里面有这么多的代码，一定都需要带入许多定义好的物件或者参数，而不只是一个程序的进去点而已，所以services 的目的就是在这里。</p>\n<p>Configure() 主要是定义了中间件（middleware）以及它们的顺序．</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">    loggerFactory.AddConsole(Configuration.GetSection(<span class=\"string\">\"Logging\"</span>));</div><div class=\"line\">    loggerFactory.AddDebug();</div><div class=\"line\"></div><div class=\"line\">    app.UseStaticFiles();</div><div class=\"line\"></div><div class=\"line\">    app.UseMvcWithDefaultRoute();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"4、Build-和-Run\"><a href=\"#4、Build-和-Run\" class=\"headerlink\" title=\"4、Build 和 Run\"></a>4、Build 和 Run</h3><p>最后，在IHostWebBuilder里最后的两个动作便是：Build and Run. </p>\n<h5 id=\"Build\"><a href=\"#Build\" class=\"headerlink\" title=\"Build()\"></a>Build()</h5><ul>\n<li>这个方法做的工作便是建立 hosting service，把 Startup 中定义的的 services 和 middleware 接收过来，然后确定content root path 和 application name，接着一句前面这些资料再加上Configuration过来的数据来初始化host engine (WebHost.cs)．</li>\n</ul>\n<h5 id=\"Run\"><a href=\"#Run\" class=\"headerlink\" title=\"Run()\"></a>Run()</h5><ul>\n<li>这个是启动 host engine 的 扩展方法，它在启动之前加入了一个 CancelKeyPress 的事件．因为在 Run() 方法 中传入入了 CancellationTokenSource() ，让我们有一个方法可以随时中断host engine的执行。</li>\n</ul>\n<p>目前的做法就用是 CancelKeyPress 事件，所以你可以按下 Ctrl+C  來中止 host engine 的执行．</p>\n<p>比较特別的是，这一段中止的文字说明居然是用 hard code，參考如下:</p>\n<p>host.Run(cts.Token, “Application started. Press Ctrl+C to shut down.”);</p>\n<p>不过这样的话，这里你也不能写中文…</p>\n<p>本文整理于<a href=\"https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327\" target=\"_blank\" rel=\"external\">https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327</a>并已征得作者同意。<br>感谢Bruce的分享。</p>\n","excerpt":"","more":"<p>之前版本的ASP.NET程序必须依赖IIS来启动，而IIS上会为挂载在其中的ASP.NET 注册一个ISAPI filter。每当http请求过来时，IIS则会启动w3wp的worker process来开始整个ASP.NET runtime程序。相信大家都这样的流程都有相应的了解。在.net core之前，ASP.NET的主要场景都是运行在Windows平台的，IIS也就是web server的首选了。虽然也有类似于jexus的linux webserver可用，但是基于mono的.NET 总体还是不够Microsoft 原生的强。</p>\n<p>不过到了现在，一切都不同了。</p>\n<h6 id=\"新版ASP-NET-Core有了-NET-Core的支援后已经开始了它的跨平台之旅了，因此ASP-NET-Core的启动方式也得开始重新设计以适应新需求了。\"><a href=\"#新版ASP-NET-Core有了-NET-Core的支援后已经开始了它的跨平台之旅了，因此ASP-NET-Core的启动方式也得开始重新设计以适应新需求了。\" class=\"headerlink\" title=\"新版ASP.NET Core有了.NET Core的支援后已经开始了它的跨平台之旅了，因此ASP.NET Core的启动方式也得开始重新设计以适应新需求了。\"></a>新版ASP.NET Core有了.NET Core的支援后已经开始了它的跨平台之旅了，因此ASP.NET Core的启动方式也得开始重新设计以适应新需求了。</h6><h3 id=\"1、Kestrel-和-IIS-platform-handler\"><a href=\"#1、Kestrel-和-IIS-platform-handler\" class=\"headerlink\" title=\"1、Kestrel 和 IIS platform handler\"></a>1、Kestrel 和 IIS platform handler</h3><p>在 ASP.NET Core 中，整个runtime都是重写过的，所以它和IIS之间的关系也有所改变。而ASP.NET Core为了跨平台，它现在的执行方式就如一般的Console app一样。ASP.NET Core自带一个高性能的I/O组件 - Kestrel，使得它可以不依赖IIS的存在便启动了runtime。不过Kestrel 也只是一个I/O组件，并没有想IIS提供其它的功能来保护和管理ASP.NET 应用程序。ASP.NET Core同样可以通过IIS进行处理。但是如果通过IIS来进行处理的话，这个时候我们便需要一个“中间人”的角色来负责这个功能了。这个“中间人”的名字叫 Http Platform Handler，主要表现在web.config文档中的设置，其中包括启动ASP.NET Core 程序的的路径和名称，需要传入的参数以及一些其他的设置选项。Http Platform Handler的具体设置例子如下：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;system.webServer&gt;</div><div class=\"line\">    &lt;handlers&gt;</div><div class=\"line\">      &lt;add name=<span class=\"string\">\"httpPlatformHandler\"</span> path=<span class=\"string\">\"*\"</span> verb=<span class=\"string\">\"*\"</span></div><div class=\"line\">      modules=<span class=\"string\">\"httpPlatformHandler\"</span> resourceType=<span class=\"string\">\"Unspecified\"</span>/&gt;</div><div class=\"line\">    &lt;/handlers&gt;</div><div class=\"line\">    &lt;httpPlatform processPath=<span class=\"string\">\"WebApp.exe\"</span> arguments=<span class=\"string\">\"\"</span> </div><div class=\"line\">    stdoutLogEnabled=<span class=\"string\">\"false\"</span> startupTimeLimit=<span class=\"string\">\"3600\"</span>/&gt;</div><div class=\"line\">  &lt;/system.webServer&gt;</div></pre></td></tr></table></figure></p>\n<p>关于Http Platform Handler的相关资料可以看这个链接：<br><a href=\"http://www.iis.net/downloads/microsoft/httpplatformhandler\">http://www.iis.net/downloads/microsoft/httpplatformhandler</a></p>\n<p>从上面的例子可以看出来，ASP.NET Core编译之后便是一个EXE程序，使得你可以直接运行。因此，当HTTP请求进来时，IIS先接受请求，然后根据你设置的web.config的内容将请求转发给WebApp.exe（你的ASP.NET Core程序），然后WebApp.exe开始执行时便会启动Kestrel，接着这个HTTP请求便进入了ASP.NET Core runtime的世界。这样看来，IIS这时候只是一个简单的proxy/forwarder角色。</p>\n<p>PS：在我翻译整理这个文章的时候，世界已经发生了变化：下个版本的asp.net core 将会有全新的IIS module来取代Http Platform Handler。</p>\n<p>具体详细资料见：<a href=\"https://github.com/aspnet/IISIntegration/issues/105\">https://github.com/aspnet/IISIntegration/issues/105</a></p>\n<h3 id=\"2、Main\"><a href=\"#2、Main\" class=\"headerlink\" title=\"2、Main()\"></a>2、Main()</h3><p>ASP.NET Core和其他的.NET 程序一样拥有一个static void Main(),这是整个runtime的进入点。下面看一个样例：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"keyword\">string</span>[] args</span>)</div><div class=\"line\">       </span>&#123;</div><div class=\"line\">           <span class=\"keyword\">var</span> host = <span class=\"keyword\">new</span> WebHostBuilder()</div><div class=\"line\">               .UseServer(<span class=\"string\">\"Microsoft.AspNetCore.Server.Kestrel\"</span>)</div><div class=\"line\">               .UseContentRoot(Directory.GetCurrentDirectory())</div><div class=\"line\">               .UseDefaultConfiguration(args)</div><div class=\"line\">               .UseIISPlatformHandlerUrl()</div><div class=\"line\">               .UseStartup&lt;Startup&gt;()</div><div class=\"line\">               .Build();</div><div class=\"line\"></div><div class=\"line\">           host.Run();</div><div class=\"line\">       &#125;</div></pre></td></tr></table></figure></p>\n<p>ASP.NET Core host engine 的建立者是 WebHostBuilder．</p>\n<p>它实质上是一个了 IWebHostBuilder interface，其中 UseServer() 是用于指定使用什么样的 server。</p>\n<p>其中 UseServer() 有一个扩展方法UseServer(string assemblyName)。这样的话我们可以直接传入Kestrel的程序集名称:”Microsoft.AspNetCore.Server.Kestrel”。当然，这只是其中一种选项。你也可以自己实现一个自己的 server，只要你的 server 实现了 IServerFactory interface 即可。这样的设计提供了一个很大的弹性空间让我们自行选择hosting server（托管服务）。</p>\n<h5 id=\"UseContentRoot\"><a href=\"#UseContentRoot\" class=\"headerlink\" title=\"UseContentRoot()\"></a>UseContentRoot()</h5><ul>\n<li>这个扩展方法是让我们指定应用程序的工作目录（working directory），如果我们没有指定的话，则会默认为我们的应用（webapp.exe）所在目录为工作目录。</li>\n</ul>\n<h5 id=\"UseDefaultConfiguration\"><a href=\"#UseDefaultConfiguration\" class=\"headerlink\" title=\"UseDefaultConfiguration()\"></a>UseDefaultConfiguration()</h5><ul>\n<li>这个扩展方法使得我们在IWebHostBuilder 建立可以传入一些参数，比如 application key, environment name, server factory location, content root path 等等．因此，当我们在运行 WebApp.exe 的时候，同时可以带入我们需要用到的hosting参数（PS：这样的做法就像运行命令行程序时带入参数，多好玩）。这些参数也可以写在appsettings.json里面通过Configuration来读取。<br>所以，UseDefaultConfiguration() 也不一定非要存在于 Main() 之中。（？？？个人不是很理解）</li>\n</ul>\n<p>PS：原作者原话，”如果我沒记错的话，在写这个文章的时候，UseDefaultConfiguration() 已经被改为成了UseDefaultHostingConfiguration()．显然这个名称更能清楚明白．”(？？？个人还没实践)</p>\n<h5 id=\"UseIISPlatofmrHandleUrl\"><a href=\"#UseIISPlatofmrHandleUrl\" class=\"headerlink\" title=\"UseIISPlatofmrHandleUrl()\"></a>UseIISPlatofmrHandleUrl()</h5><ul>\n<li>这个 IWebHostBuilder 的 扩展方法比较特殊。如果你要把 ASP.NET Core 放在 IIS 下，这个扩展方法会读取 IIS http platform handler 的 server port 和 application path，用于作为 ASP.NET Core 的启动位置，如 <a href=\"http://localhost:5000/start．如果你沒用\">http://localhost:5000/start．如果你沒用</a> IIS，这个扩展方法对你来说基本是用不上的．</li>\n</ul>\n<h5 id=\"UseStartup-lt-gt\"><a href=\"#UseStartup-lt-gt\" class=\"headerlink\" title=\"UseStartup&lt;&gt;()\"></a>UseStartup&lt;&gt;()</h5><ul>\n<li>这是 WebHostBuilder 里相当重要的一个扩展方法。它的方法签名如下：</li>\n</ul>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IWebHostBuilder UseStartup&lt;TStartup&gt;</div><div class=\"line\">(<span class=\"keyword\">this</span> IWebHostBuilder hostBuilder) <span class=\"keyword\">where</span> TStartup : <span class=\"keyword\">class</span></div></pre></td></tr></table></figure>\n<p>这里你可以很清楚地看到 &lt;&gt; 里面要放的就是一个 class。</p>\n<p>在我们这里的范例中，它的名字是 Startup，里面最重要的就是需要定义要使用那些服务(service)以及要使用那些中间件(middleware)。</p>\n<h3 id=\"3、Startup\"><a href=\"#3、Startup\" class=\"headerlink\" title=\"3、Startup\"></a>3、Startup</h3><p>这是一个非常非常重要的class,在ASP.NET Core范例中一般都把它命名成Startup。其实我们把它命名成其他名字也是可以的，或者设定多个Startup。上面的内容可以看到，UseStartup()指定了谁是starup class。然后在Build()便会实例化starup class，之后便执行里面两个重要的方法：ConfigureServices() 和 Configure()。</p>\n<p>我们先來看 Startup 的构造函数.</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Startup</span>(<span class=\"params\">IHostingEnvironment env</span>)</div><div class=\"line\">       </span>&#123;</div><div class=\"line\">           <span class=\"comment\">// Set up configuration sources.</span></div><div class=\"line\">           <span class=\"keyword\">var</span> builder = <span class=\"keyword\">new</span> ConfigurationBuilder()</div><div class=\"line\">               .AddJsonFile(<span class=\"string\">\"appsettings.json\"</span>)</div><div class=\"line\">               .AddJsonFile(<span class=\"string\">$\"appsettings.<span class=\"subst\">&#123;env.EnvironmentName&#125;</span>.json\"</span>, optional: <span class=\"literal\">true</span>)</div><div class=\"line\">               .AddEnvironmentVariables();</div><div class=\"line\">           Configuration = builder.Build().ReloadOnChanged(<span class=\"string\">\"appsettings.json\"</span>);</div><div class=\"line\">       &#125;</div></pre></td></tr></table></figure>\n<p>Host engine 在被执行 Build()时已经知道 startup type 是 Startup class，所以在 Build() 的时候会先创建期示例。在我们这里的是调用Startup类带参数的构造函数。</p>\n<p>在我们这个例子中选择的是传入IHostingEnvironment示例，它为我们带来了环境变量（EnvironmentName）。</p>\n<p>我们这里主要目的是把Configuration实例化。这是一个蛮重要的基础组件，以后会有文章来说明它。</p>\n<p>在这里我们特别说明一下，上面的示例代码中，我们执行了两次 AddJsonFile()，而且第二个json file的参数和第一个的还不太一样。这样的目的是为了让开发者可以把开发环境使用的环境参数和其他环境使用的参数有所区别。比如，你使用的开发环境用的是appsettings.json，这个文件只存在于你的电脑中。另一个文档是appsettings.production.json，这是正式环境使用的参数设定文档。第二個 AddJsonFile() 第二個参数是 true，也就是可能不存在的意思。所以若遇到重复名称参数时，appsettings.production.json 会覆盖 appsettings.json 的內容。这样使得开发环境和生产环境得以区分。</p>\n<p>接下来，在 IWebHostBuilder 的 Build()里面会执行 host engine 初始化的程序，其中就会去找Startup class里面的两个方法： ConfigureServices() 和 Configure()。</p>\n<p> ConfigureSerivces() 是定义了这个 web application 要使用那些服务，然后将这些服务放在 service container (IServiceCollection) 裡面。如下面的样例：</p>\n <figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"> </div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</div><div class=\"line\">     </span>&#123;</div><div class=\"line\">         <span class=\"comment\">// add entity framework</span></div><div class=\"line\">         services.AddEntityFramework()</div><div class=\"line\">                 .AddDbContext&lt;BlogsContext&gt;(o =&gt; o.UseSqlServer(Configuration[<span class=\"string\">\"Data1:DefaultConnection:ConnectionString\"</span>]))</div><div class=\"line\">          </div><div class=\"line\">         <span class=\"comment\">// Add framework services.</span></div><div class=\"line\">         services.AddMvc();</div><div class=\"line\">     &#125;</div></pre></td></tr></table></figure>\n<p>它定义了entity framework和mvc两个服务。这里所谓的服务（services）的意思也就是通过它们带入更庞大的程序代码。这听起来好像有点搞笑，但也真的如此。像Entity framework 里面有这么多的代码，一定都需要带入许多定义好的物件或者参数，而不只是一个程序的进去点而已，所以services 的目的就是在这里。</p>\n<p>Configure() 主要是定义了中间件（middleware）以及它们的顺序．</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    loggerFactory.AddConsole(Configuration.GetSection(<span class=\"string\">\"Logging\"</span>));</div><div class=\"line\">    loggerFactory.AddDebug();</div><div class=\"line\"></div><div class=\"line\">    app.UseStaticFiles();</div><div class=\"line\"></div><div class=\"line\">    app.UseMvcWithDefaultRoute();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"4、Build-和-Run\"><a href=\"#4、Build-和-Run\" class=\"headerlink\" title=\"4、Build 和 Run\"></a>4、Build 和 Run</h3><p>最后，在IHostWebBuilder里最后的两个动作便是：Build and Run. </p>\n<h5 id=\"Build\"><a href=\"#Build\" class=\"headerlink\" title=\"Build()\"></a>Build()</h5><ul>\n<li>这个方法做的工作便是建立 hosting service，把 Startup 中定义的的 services 和 middleware 接收过来，然后确定content root path 和 application name，接着一句前面这些资料再加上Configuration过来的数据来初始化host engine (WebHost.cs)．</li>\n</ul>\n<h5 id=\"Run\"><a href=\"#Run\" class=\"headerlink\" title=\"Run()\"></a>Run()</h5><ul>\n<li>这个是启动 host engine 的 扩展方法，它在启动之前加入了一个 CancelKeyPress 的事件．因为在 Run() 方法 中传入入了 CancellationTokenSource() ，让我们有一个方法可以随时中断host engine的执行。</li>\n</ul>\n<p>目前的做法就用是 CancelKeyPress 事件，所以你可以按下 Ctrl+C  來中止 host engine 的执行．</p>\n<p>比较特別的是，这一段中止的文字说明居然是用 hard code，參考如下:</p>\n<p>host.Run(cts.Token, “Application started. Press Ctrl+C to shut down.”);</p>\n<p>不过这样的话，这里你也不能写中文…</p>\n<p>本文整理于<a href=\"https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327\">https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327</a>并已征得作者同意。<br>感谢Bruce的分享。</p>\n"},{"layout":"post","title":".NET 类字段与类属性","date":"2016-02-09T16:00:00.000Z","_content":"#.NET 类字段与类属性\n@(.NET)[基础|字段|属性]\n\n##字段\n字段表示只读或可读/可写的数据值。\n字段可以是静态的，这种字段被认为是类型状态的一部分。\n字段也可以是实例（非静态），这种字段被认为是对象状态的一部分。 \n强烈建议把字段声明为私有，防止类型或对象的状态被类型外部代码破坏。\n\n##属性\n属性允许用简单的、字段风格的语法设置或查询类型或对象的逻辑状态，同时保证状态不被破坏。\n作用于类型称为静态属性，作用于对象称为实例属性。\n属性可以无参，也可以有多个参数（相当少见，但集合类用的多）。 \n\n\tusing System;\n\t\n\tpublic sealed class SomeType\n\t{                            //  1  \n\t// Nested class  \n\t   private class SomeNestedType { }                //  2  \n\t\n\t   // Constant, read­only, and static read/write field   \n\t   private const Int32 c_SomeConstant = 1;            //  3     \n\t\n\t   private readonly String m_SomeReadOnlyField = \"2\";     //  4    \n\t\n\t   private static Int32 s_SomeReadWriteField = 3;      //  5  \n\t\n\t   // Type constructor  \n\t   static SomeType() { }                                  //  6  \n\t\n\t   // Instance constructors  \n\t   public SomeType(Int32 x) { }                           //  7  \n\t\n\t   public SomeType() { }                                  //  8 \n\t\n\t   // Instance and static methods  \n\t   private String InstanceMethod() { return null; }       // 9   \n\t\n\t   public static void Main() { }                        // 10 \n\t\n\t   // Instance property  \n\t   public Int32 SomeProp\n\t   {                                // 11      \n\t       get { return 0; }                                // 12      \n\t       set { }                                          // 13  \n\t   }\n\t\n\t   // Instance parameterful property (indexer) \n\t   public Int32 this[String s]\n\t   {                          // 14       \n\t       get { return 0; }                                // 15        \n\t       set { }                                          // 16  \n\t   }\n\t\n\t   // Instance event  \n\t   public event EventHandler SomeEvent;                  // 17  \n\t}\n\n![enter image description here](https://kekaeq-ch3301.files.1drv.com/y3meEWWaK-o9SNfr_fT71Xr3YrPqO1LIswWqMvlHyUxWeH8P0PtXsQlfRkDnGshlMJIy2gPsxNet14efOPOuX-dHmZhCTg8PXyELJR9tnayye4LeEQ6F997b8pSI84wBR6nmmOF8IAr92oKWk36-f8alkEj9TrDQbiMoKGQwO5MTFY/20150105.jpg?psid=1)\n\n\n![enter image description here](https://kekaeq-ch3301.files.1drv.com/y3mN8FseIEbAaQfT8ynEIc4nYsOUK0p0IN7Hp39imVSZXNQXlSfAYmvaC-9bDM3Hq6rPCV1XgrgvoST8wXejwARXaDmXptZpb_nyWwUzWK1rzaJ6fSsYfnP0icRKUclaVxnlltOJSQiuTFO7_fCfabmv0AsrgL5sLo6GdVJmpd-L10/QQ%E5%9B%BE%E7%89%8720151003165909.jpg?psid=1)","source":"_posts/classfield-property.md","raw":"---\nlayout: post\ntitle: .NET 类字段与类属性\ncategory: .net\ndate: 2016-02-10 00:00:00\n---\n#.NET 类字段与类属性\n@(.NET)[基础|字段|属性]\n\n##字段\n字段表示只读或可读/可写的数据值。\n字段可以是静态的，这种字段被认为是类型状态的一部分。\n字段也可以是实例（非静态），这种字段被认为是对象状态的一部分。 \n强烈建议把字段声明为私有，防止类型或对象的状态被类型外部代码破坏。\n\n##属性\n属性允许用简单的、字段风格的语法设置或查询类型或对象的逻辑状态，同时保证状态不被破坏。\n作用于类型称为静态属性，作用于对象称为实例属性。\n属性可以无参，也可以有多个参数（相当少见，但集合类用的多）。 \n\n\tusing System;\n\t\n\tpublic sealed class SomeType\n\t{                            //  1  \n\t// Nested class  \n\t   private class SomeNestedType { }                //  2  \n\t\n\t   // Constant, read­only, and static read/write field   \n\t   private const Int32 c_SomeConstant = 1;            //  3     \n\t\n\t   private readonly String m_SomeReadOnlyField = \"2\";     //  4    \n\t\n\t   private static Int32 s_SomeReadWriteField = 3;      //  5  \n\t\n\t   // Type constructor  \n\t   static SomeType() { }                                  //  6  \n\t\n\t   // Instance constructors  \n\t   public SomeType(Int32 x) { }                           //  7  \n\t\n\t   public SomeType() { }                                  //  8 \n\t\n\t   // Instance and static methods  \n\t   private String InstanceMethod() { return null; }       // 9   \n\t\n\t   public static void Main() { }                        // 10 \n\t\n\t   // Instance property  \n\t   public Int32 SomeProp\n\t   {                                // 11      \n\t       get { return 0; }                                // 12      \n\t       set { }                                          // 13  \n\t   }\n\t\n\t   // Instance parameterful property (indexer) \n\t   public Int32 this[String s]\n\t   {                          // 14       \n\t       get { return 0; }                                // 15        \n\t       set { }                                          // 16  \n\t   }\n\t\n\t   // Instance event  \n\t   public event EventHandler SomeEvent;                  // 17  \n\t}\n\n![enter image description here](https://kekaeq-ch3301.files.1drv.com/y3meEWWaK-o9SNfr_fT71Xr3YrPqO1LIswWqMvlHyUxWeH8P0PtXsQlfRkDnGshlMJIy2gPsxNet14efOPOuX-dHmZhCTg8PXyELJR9tnayye4LeEQ6F997b8pSI84wBR6nmmOF8IAr92oKWk36-f8alkEj9TrDQbiMoKGQwO5MTFY/20150105.jpg?psid=1)\n\n\n![enter image description here](https://kekaeq-ch3301.files.1drv.com/y3mN8FseIEbAaQfT8ynEIc4nYsOUK0p0IN7Hp39imVSZXNQXlSfAYmvaC-9bDM3Hq6rPCV1XgrgvoST8wXejwARXaDmXptZpb_nyWwUzWK1rzaJ6fSsYfnP0icRKUclaVxnlltOJSQiuTFO7_fCfabmv0AsrgL5sLo6GdVJmpd-L10/QQ%E5%9B%BE%E7%89%8720151003165909.jpg?psid=1)","slug":"classfield-property","published":1,"updated":"2016-09-15T05:11:13.653Z","comments":1,"photos":[],"link":"","_id":"cit3xw9t7000sc0txnw2b3qsj","content":"<p>#.NET 类字段与类属性<br>@(.NET)[基础|字段|属性]</p>\n<p>##字段<br>字段表示只读或可读/可写的数据值。<br>字段可以是静态的，这种字段被认为是类型状态的一部分。<br>字段也可以是实例（非静态），这种字段被认为是对象状态的一部分。<br>强烈建议把字段声明为私有，防止类型或对象的状态被类型外部代码破坏。</p>\n<p>##属性<br>属性允许用简单的、字段风格的语法设置或查询类型或对象的逻辑状态，同时保证状态不被破坏。<br>作用于类型称为静态属性，作用于对象称为实例属性。<br>属性可以无参，也可以有多个参数（相当少见，但集合类用的多）。 </p>\n<pre><code>using System;\n\npublic sealed class SomeType\n{                            //  1  \n// Nested class  \n   private class SomeNestedType { }                //  2  \n\n   // Constant, read­only, and static read/write field   \n   private const Int32 c_SomeConstant = 1;            //  3     \n\n   private readonly String m_SomeReadOnlyField = &quot;2&quot;;     //  4    \n\n   private static Int32 s_SomeReadWriteField = 3;      //  5  \n\n   // Type constructor  \n   static SomeType() { }                                  //  6  \n\n   // Instance constructors  \n   public SomeType(Int32 x) { }                           //  7  \n\n   public SomeType() { }                                  //  8 \n\n   // Instance and static methods  \n   private String InstanceMethod() { return null; }       // 9   \n\n   public static void Main() { }                        // 10 \n\n   // Instance property  \n   public Int32 SomeProp\n   {                                // 11      \n       get { return 0; }                                // 12      \n       set { }                                          // 13  \n   }\n\n   // Instance parameterful property (indexer) \n   public Int32 this[String s]\n   {                          // 14       \n       get { return 0; }                                // 15        \n       set { }                                          // 16  \n   }\n\n   // Instance event  \n   public event EventHandler SomeEvent;                  // 17  \n}\n</code></pre><p><img src=\"https://kekaeq-ch3301.files.1drv.com/y3meEWWaK-o9SNfr_fT71Xr3YrPqO1LIswWqMvlHyUxWeH8P0PtXsQlfRkDnGshlMJIy2gPsxNet14efOPOuX-dHmZhCTg8PXyELJR9tnayye4LeEQ6F997b8pSI84wBR6nmmOF8IAr92oKWk36-f8alkEj9TrDQbiMoKGQwO5MTFY/20150105.jpg?psid=1\" alt=\"enter image description here\"></p>\n<p><img src=\"https://kekaeq-ch3301.files.1drv.com/y3mN8FseIEbAaQfT8ynEIc4nYsOUK0p0IN7Hp39imVSZXNQXlSfAYmvaC-9bDM3Hq6rPCV1XgrgvoST8wXejwARXaDmXptZpb_nyWwUzWK1rzaJ6fSsYfnP0icRKUclaVxnlltOJSQiuTFO7_fCfabmv0AsrgL5sLo6GdVJmpd-L10/QQ%E5%9B%BE%E7%89%8720151003165909.jpg?psid=1\" alt=\"enter image description here\"></p>\n","excerpt":"","more":"<p>#.NET 类字段与类属性<br>@(.NET)[基础|字段|属性]</p>\n<p>##字段<br>字段表示只读或可读/可写的数据值。<br>字段可以是静态的，这种字段被认为是类型状态的一部分。<br>字段也可以是实例（非静态），这种字段被认为是对象状态的一部分。<br>强烈建议把字段声明为私有，防止类型或对象的状态被类型外部代码破坏。</p>\n<p>##属性<br>属性允许用简单的、字段风格的语法设置或查询类型或对象的逻辑状态，同时保证状态不被破坏。<br>作用于类型称为静态属性，作用于对象称为实例属性。<br>属性可以无参，也可以有多个参数（相当少见，但集合类用的多）。 </p>\n<pre><code>using System;\n\npublic sealed class SomeType\n{                            //  1  \n// Nested class  \n   private class SomeNestedType { }                //  2  \n\n   // Constant, read­only, and static read/write field   \n   private const Int32 c_SomeConstant = 1;            //  3     \n\n   private readonly String m_SomeReadOnlyField = &quot;2&quot;;     //  4    \n\n   private static Int32 s_SomeReadWriteField = 3;      //  5  \n\n   // Type constructor  \n   static SomeType() { }                                  //  6  \n\n   // Instance constructors  \n   public SomeType(Int32 x) { }                           //  7  \n\n   public SomeType() { }                                  //  8 \n\n   // Instance and static methods  \n   private String InstanceMethod() { return null; }       // 9   \n\n   public static void Main() { }                        // 10 \n\n   // Instance property  \n   public Int32 SomeProp\n   {                                // 11      \n       get { return 0; }                                // 12      \n       set { }                                          // 13  \n   }\n\n   // Instance parameterful property (indexer) \n   public Int32 this[String s]\n   {                          // 14       \n       get { return 0; }                                // 15        \n       set { }                                          // 16  \n   }\n\n   // Instance event  \n   public event EventHandler SomeEvent;                  // 17  \n}\n</code></pre><p><img src=\"https://kekaeq-ch3301.files.1drv.com/y3meEWWaK-o9SNfr_fT71Xr3YrPqO1LIswWqMvlHyUxWeH8P0PtXsQlfRkDnGshlMJIy2gPsxNet14efOPOuX-dHmZhCTg8PXyELJR9tnayye4LeEQ6F997b8pSI84wBR6nmmOF8IAr92oKWk36-f8alkEj9TrDQbiMoKGQwO5MTFY/20150105.jpg?psid=1\" alt=\"enter image description here\"></p>\n<p><img src=\"https://kekaeq-ch3301.files.1drv.com/y3mN8FseIEbAaQfT8ynEIc4nYsOUK0p0IN7Hp39imVSZXNQXlSfAYmvaC-9bDM3Hq6rPCV1XgrgvoST8wXejwARXaDmXptZpb_nyWwUzWK1rzaJ6fSsYfnP0icRKUclaVxnlltOJSQiuTFO7_fCfabmv0AsrgL5sLo6GdVJmpd-L10/QQ%E5%9B%BE%E7%89%8720151003165909.jpg?psid=1\" alt=\"enter image description here\"></p>\n"},{"layout":"post","title":"避免在函数或者操作中抛出异常","date":"2016-06-19T16:00:00.000Z","_content":"\n## 1、引言\n如某个场景下，你的函数或操作需要操作一个序列的对象，且在处理的过程中抛出了异常。这时如果没有一些状态记录之类的数据，我们不了解已经处理了多少的数据，也不知道应该采用怎么样的策略回滚，因此根本无法返回到之前的状态。\n我们看一下下面的一个代码：\n```csharp\nvar allEmp = FindAllEmployees();\nallEmp.ForEach(e => e.MonthlySalary *=1.05M);\n```\n这样的代码看起来没什么问题。可是某一天，这个程序运行时抛出了异常。抛出异常的位置可能未知，导致部分员工得到了加薪，另外的一些员工却没有。结果是除了人工检查数据，我们已经没有办法重新找回丢失的状态。\n\n这样的代码修改元素的方式导致发生了上面的问题。这段代码并没有遵循“强异常安全保证”规则。换而言之，在运行时遇到错误，我们无法得知具体发生了什么，没有发生什么。\n\n### 原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。\n我们有几种方法都可以实现这样的需求，但是每种方法都有各自的优势和风险。\n\n## 2、在函数/操作中抛出异常\n显而易见的，不是所有的方法都会遇到这样的问题（异常导致状态丢失）。很多时候我们只是检查了一下序列中的元素，访问之后并不会修改其中的元素。这类的行为我们其实并不需要太过于小心。现在我们回到最开始的地方，对于上面的场景（为每位员工加薪百分之五），如果我们想遵循“强异常安全保证”原则，那应该如何修改这个方法呢？\n\n#### 第一种异常：获取数据的时候异常\n在上面的例子中，即使FindAllEmployees()函数抛出异常，导致我们无法正确让员工加薪。虽然这样的情况并不是导致我们的数据产生问题，但是该加薪的大家没有得到加薪，这是一个多么沮丧的事情呢。\n\n#### 解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees()方法），让其永远不会抛出异常。\n\n很多时候，我们在开始修改数据之前，先校验数据的合法性以及剔除错误数据（如果允许剔除的话）并不是非常困难。我们是可以采取这样的方法来实现我们的目的。不过在这里的话，我们就必须严格处理操作方法，使得它能满足所有情况下的需求。\n\n#### 第二种异常：lambda表达式中操作数据异常\n同样是上面的例子，如果我们在执行加薪操作的时候，提升了那些已经离职的员工薪资导致了异常，使得程序中断，状态丢失。这样的情况，我们在执行加薪操作前先过滤掉已离职的员工便是一种正确的做法。\n\n#### 解决方法：操作数据前通过校验过滤后再执行操作\n如：\n```csharp\nallEmp.Where(emp=>emp.Active).ForEach(e => e.MonthlySalary *=1.05M);\n```\n\n\n#### 第三种异常：执行操作的时候抛出异常\n有时候，我们根本无法保证处理方法的时候会不会抛出异常。这个时候就必须采取一些代价更加昂贵的处理方法了。\n\n#### 解决方法：创建副本尝试执行操作，副本无误后执行真正操作\n我们在编写这类代码的时候，应该考虑抛出异常之后的处理方案。这就意味着，我们的操作应该先在原数据副本上执行，随后仅在操作成功之后再将其替换原有的数据。\n如:\n\n```csharp\nvar updatas = (from e in allEmp \n              select new Emp\n              {\n                  EmpID=e.EmpID,\n                  .....\n                  MonthlySalary =e.MonthlySalary *=1.05M\n              }).ToList();\n\nallEmp = updatas;\n```\n\n但是这样的修改也引发了其他的问题：代码量增加了，同时生成副本也消耗了大量的资源。这样的做法也有一个好处，我们在操作副本数据时遇到异常之后，有充分的\"空间\"来处理这些数据。\n\n实际中，这意味着我们让查询表达式返回了新序列，而不是去修改原先序列中的元素。这样的话，我们在尝试完成所有的操作的同时，即使失败了，也不会影响到我们程序的原有状态。\n\n\n\n\n","source":"_posts/don’t-throw-exception-in-foreach.md","raw":"---\nlayout: post\ntitle: 避免在函数或者操作中抛出异常\ncategory: .net\ndate: 2016-06-20 00:00:00\n---\n\n## 1、引言\n如某个场景下，你的函数或操作需要操作一个序列的对象，且在处理的过程中抛出了异常。这时如果没有一些状态记录之类的数据，我们不了解已经处理了多少的数据，也不知道应该采用怎么样的策略回滚，因此根本无法返回到之前的状态。\n我们看一下下面的一个代码：\n```csharp\nvar allEmp = FindAllEmployees();\nallEmp.ForEach(e => e.MonthlySalary *=1.05M);\n```\n这样的代码看起来没什么问题。可是某一天，这个程序运行时抛出了异常。抛出异常的位置可能未知，导致部分员工得到了加薪，另外的一些员工却没有。结果是除了人工检查数据，我们已经没有办法重新找回丢失的状态。\n\n这样的代码修改元素的方式导致发生了上面的问题。这段代码并没有遵循“强异常安全保证”规则。换而言之，在运行时遇到错误，我们无法得知具体发生了什么，没有发生什么。\n\n### 原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。\n我们有几种方法都可以实现这样的需求，但是每种方法都有各自的优势和风险。\n\n## 2、在函数/操作中抛出异常\n显而易见的，不是所有的方法都会遇到这样的问题（异常导致状态丢失）。很多时候我们只是检查了一下序列中的元素，访问之后并不会修改其中的元素。这类的行为我们其实并不需要太过于小心。现在我们回到最开始的地方，对于上面的场景（为每位员工加薪百分之五），如果我们想遵循“强异常安全保证”原则，那应该如何修改这个方法呢？\n\n#### 第一种异常：获取数据的时候异常\n在上面的例子中，即使FindAllEmployees()函数抛出异常，导致我们无法正确让员工加薪。虽然这样的情况并不是导致我们的数据产生问题，但是该加薪的大家没有得到加薪，这是一个多么沮丧的事情呢。\n\n#### 解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees()方法），让其永远不会抛出异常。\n\n很多时候，我们在开始修改数据之前，先校验数据的合法性以及剔除错误数据（如果允许剔除的话）并不是非常困难。我们是可以采取这样的方法来实现我们的目的。不过在这里的话，我们就必须严格处理操作方法，使得它能满足所有情况下的需求。\n\n#### 第二种异常：lambda表达式中操作数据异常\n同样是上面的例子，如果我们在执行加薪操作的时候，提升了那些已经离职的员工薪资导致了异常，使得程序中断，状态丢失。这样的情况，我们在执行加薪操作前先过滤掉已离职的员工便是一种正确的做法。\n\n#### 解决方法：操作数据前通过校验过滤后再执行操作\n如：\n```csharp\nallEmp.Where(emp=>emp.Active).ForEach(e => e.MonthlySalary *=1.05M);\n```\n\n\n#### 第三种异常：执行操作的时候抛出异常\n有时候，我们根本无法保证处理方法的时候会不会抛出异常。这个时候就必须采取一些代价更加昂贵的处理方法了。\n\n#### 解决方法：创建副本尝试执行操作，副本无误后执行真正操作\n我们在编写这类代码的时候，应该考虑抛出异常之后的处理方案。这就意味着，我们的操作应该先在原数据副本上执行，随后仅在操作成功之后再将其替换原有的数据。\n如:\n\n```csharp\nvar updatas = (from e in allEmp \n              select new Emp\n              {\n                  EmpID=e.EmpID,\n                  .....\n                  MonthlySalary =e.MonthlySalary *=1.05M\n              }).ToList();\n\nallEmp = updatas;\n```\n\n但是这样的修改也引发了其他的问题：代码量增加了，同时生成副本也消耗了大量的资源。这样的做法也有一个好处，我们在操作副本数据时遇到异常之后，有充分的\"空间\"来处理这些数据。\n\n实际中，这意味着我们让查询表达式返回了新序列，而不是去修改原先序列中的元素。这样的话，我们在尝试完成所有的操作的同时，即使失败了，也不会影响到我们程序的原有状态。\n\n\n\n\n","slug":"don’t-throw-exception-in-foreach","published":1,"updated":"2016-09-15T05:11:13.653Z","comments":1,"photos":[],"link":"","_id":"cit3xw9tl0016c0txo6k16vpg","content":"<h2 id=\"1、引言\"><a href=\"#1、引言\" class=\"headerlink\" title=\"1、引言\"></a>1、引言</h2><p>如某个场景下，你的函数或操作需要操作一个序列的对象，且在处理的过程中抛出了异常。这时如果没有一些状态记录之类的数据，我们不了解已经处理了多少的数据，也不知道应该采用怎么样的策略回滚，因此根本无法返回到之前的状态。<br>我们看一下下面的一个代码：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> allEmp = FindAllEmployees();</div><div class=\"line\">allEmp.ForEach(e =&gt; e.MonthlySalary *=<span class=\"number\">1.05</span>M);</div></pre></td></tr></table></figure></p>\n<p>这样的代码看起来没什么问题。可是某一天，这个程序运行时抛出了异常。抛出异常的位置可能未知，导致部分员工得到了加薪，另外的一些员工却没有。结果是除了人工检查数据，我们已经没有办法重新找回丢失的状态。</p>\n<p>这样的代码修改元素的方式导致发生了上面的问题。这段代码并没有遵循“强异常安全保证”规则。换而言之，在运行时遇到错误，我们无法得知具体发生了什么，没有发生什么。</p>\n<h3 id=\"原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。\"><a href=\"#原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。\" class=\"headerlink\" title=\"原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。\"></a>原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。</h3><p>我们有几种方法都可以实现这样的需求，但是每种方法都有各自的优势和风险。</p>\n<h2 id=\"2、在函数-操作中抛出异常\"><a href=\"#2、在函数-操作中抛出异常\" class=\"headerlink\" title=\"2、在函数/操作中抛出异常\"></a>2、在函数/操作中抛出异常</h2><p>显而易见的，不是所有的方法都会遇到这样的问题（异常导致状态丢失）。很多时候我们只是检查了一下序列中的元素，访问之后并不会修改其中的元素。这类的行为我们其实并不需要太过于小心。现在我们回到最开始的地方，对于上面的场景（为每位员工加薪百分之五），如果我们想遵循“强异常安全保证”原则，那应该如何修改这个方法呢？</p>\n<h4 id=\"第一种异常：获取数据的时候异常\"><a href=\"#第一种异常：获取数据的时候异常\" class=\"headerlink\" title=\"第一种异常：获取数据的时候异常\"></a>第一种异常：获取数据的时候异常</h4><p>在上面的例子中，即使FindAllEmployees()函数抛出异常，导致我们无法正确让员工加薪。虽然这样的情况并不是导致我们的数据产生问题，但是该加薪的大家没有得到加薪，这是一个多么沮丧的事情呢。</p>\n<h4 id=\"解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees-方法），让其永远不会抛出异常。\"><a href=\"#解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees-方法），让其永远不会抛出异常。\" class=\"headerlink\" title=\"解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees()方法），让其永远不会抛出异常。\"></a>解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees()方法），让其永远不会抛出异常。</h4><p>很多时候，我们在开始修改数据之前，先校验数据的合法性以及剔除错误数据（如果允许剔除的话）并不是非常困难。我们是可以采取这样的方法来实现我们的目的。不过在这里的话，我们就必须严格处理操作方法，使得它能满足所有情况下的需求。</p>\n<h4 id=\"第二种异常：lambda表达式中操作数据异常\"><a href=\"#第二种异常：lambda表达式中操作数据异常\" class=\"headerlink\" title=\"第二种异常：lambda表达式中操作数据异常\"></a>第二种异常：lambda表达式中操作数据异常</h4><p>同样是上面的例子，如果我们在执行加薪操作的时候，提升了那些已经离职的员工薪资导致了异常，使得程序中断，状态丢失。这样的情况，我们在执行加薪操作前先过滤掉已离职的员工便是一种正确的做法。</p>\n<h4 id=\"解决方法：操作数据前通过校验过滤后再执行操作\"><a href=\"#解决方法：操作数据前通过校验过滤后再执行操作\" class=\"headerlink\" title=\"解决方法：操作数据前通过校验过滤后再执行操作\"></a>解决方法：操作数据前通过校验过滤后再执行操作</h4><p>如：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">allEmp.Where(emp=&gt;emp.Active).ForEach(e =&gt; e.MonthlySalary *=<span class=\"number\">1.05</span>M);</div></pre></td></tr></table></figure></p>\n<h4 id=\"第三种异常：执行操作的时候抛出异常\"><a href=\"#第三种异常：执行操作的时候抛出异常\" class=\"headerlink\" title=\"第三种异常：执行操作的时候抛出异常\"></a>第三种异常：执行操作的时候抛出异常</h4><p>有时候，我们根本无法保证处理方法的时候会不会抛出异常。这个时候就必须采取一些代价更加昂贵的处理方法了。</p>\n<h4 id=\"解决方法：创建副本尝试执行操作，副本无误后执行真正操作\"><a href=\"#解决方法：创建副本尝试执行操作，副本无误后执行真正操作\" class=\"headerlink\" title=\"解决方法：创建副本尝试执行操作，副本无误后执行真正操作\"></a>解决方法：创建副本尝试执行操作，副本无误后执行真正操作</h4><p>我们在编写这类代码的时候，应该考虑抛出异常之后的处理方案。这就意味着，我们的操作应该先在原数据副本上执行，随后仅在操作成功之后再将其替换原有的数据。<br>如:</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> updatas = (<span class=\"keyword\">from</span> e <span class=\"keyword\">in</span> allEmp </div><div class=\"line\">              <span class=\"keyword\">select</span> <span class=\"keyword\">new</span> Emp</div><div class=\"line\">              &#123;</div><div class=\"line\">                  EmpID=e.EmpID,</div><div class=\"line\">                  .....</div><div class=\"line\">                  MonthlySalary =e.MonthlySalary *=<span class=\"number\">1.05</span>M</div><div class=\"line\">              &#125;).ToList();</div><div class=\"line\"></div><div class=\"line\">allEmp = updatas;</div></pre></td></tr></table></figure>\n<p>但是这样的修改也引发了其他的问题：代码量增加了，同时生成副本也消耗了大量的资源。这样的做法也有一个好处，我们在操作副本数据时遇到异常之后，有充分的”空间”来处理这些数据。</p>\n<p>实际中，这意味着我们让查询表达式返回了新序列，而不是去修改原先序列中的元素。这样的话，我们在尝试完成所有的操作的同时，即使失败了，也不会影响到我们程序的原有状态。</p>\n","excerpt":"","more":"<h2 id=\"1、引言\"><a href=\"#1、引言\" class=\"headerlink\" title=\"1、引言\"></a>1、引言</h2><p>如某个场景下，你的函数或操作需要操作一个序列的对象，且在处理的过程中抛出了异常。这时如果没有一些状态记录之类的数据，我们不了解已经处理了多少的数据，也不知道应该采用怎么样的策略回滚，因此根本无法返回到之前的状态。<br>我们看一下下面的一个代码：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> allEmp = FindAllEmployees();</div><div class=\"line\">allEmp.ForEach(e =&gt; e.MonthlySalary *=<span class=\"number\">1.05</span>M);</div></pre></td></tr></table></figure></p>\n<p>这样的代码看起来没什么问题。可是某一天，这个程序运行时抛出了异常。抛出异常的位置可能未知，导致部分员工得到了加薪，另外的一些员工却没有。结果是除了人工检查数据，我们已经没有办法重新找回丢失的状态。</p>\n<p>这样的代码修改元素的方式导致发生了上面的问题。这段代码并没有遵循“强异常安全保证”规则。换而言之，在运行时遇到错误，我们无法得知具体发生了什么，没有发生什么。</p>\n<h3 id=\"原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。\"><a href=\"#原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。\" class=\"headerlink\" title=\"原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。\"></a>原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。</h3><p>我们有几种方法都可以实现这样的需求，但是每种方法都有各自的优势和风险。</p>\n<h2 id=\"2、在函数-操作中抛出异常\"><a href=\"#2、在函数-操作中抛出异常\" class=\"headerlink\" title=\"2、在函数/操作中抛出异常\"></a>2、在函数/操作中抛出异常</h2><p>显而易见的，不是所有的方法都会遇到这样的问题（异常导致状态丢失）。很多时候我们只是检查了一下序列中的元素，访问之后并不会修改其中的元素。这类的行为我们其实并不需要太过于小心。现在我们回到最开始的地方，对于上面的场景（为每位员工加薪百分之五），如果我们想遵循“强异常安全保证”原则，那应该如何修改这个方法呢？</p>\n<h4 id=\"第一种异常：获取数据的时候异常\"><a href=\"#第一种异常：获取数据的时候异常\" class=\"headerlink\" title=\"第一种异常：获取数据的时候异常\"></a>第一种异常：获取数据的时候异常</h4><p>在上面的例子中，即使FindAllEmployees()函数抛出异常，导致我们无法正确让员工加薪。虽然这样的情况并不是导致我们的数据产生问题，但是该加薪的大家没有得到加薪，这是一个多么沮丧的事情呢。</p>\n<h4 id=\"解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees-方法），让其永远不会抛出异常。\"><a href=\"#解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees-方法），让其永远不会抛出异常。\" class=\"headerlink\" title=\"解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees()方法），让其永远不会抛出异常。\"></a>解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees()方法），让其永远不会抛出异常。</h4><p>很多时候，我们在开始修改数据之前，先校验数据的合法性以及剔除错误数据（如果允许剔除的话）并不是非常困难。我们是可以采取这样的方法来实现我们的目的。不过在这里的话，我们就必须严格处理操作方法，使得它能满足所有情况下的需求。</p>\n<h4 id=\"第二种异常：lambda表达式中操作数据异常\"><a href=\"#第二种异常：lambda表达式中操作数据异常\" class=\"headerlink\" title=\"第二种异常：lambda表达式中操作数据异常\"></a>第二种异常：lambda表达式中操作数据异常</h4><p>同样是上面的例子，如果我们在执行加薪操作的时候，提升了那些已经离职的员工薪资导致了异常，使得程序中断，状态丢失。这样的情况，我们在执行加薪操作前先过滤掉已离职的员工便是一种正确的做法。</p>\n<h4 id=\"解决方法：操作数据前通过校验过滤后再执行操作\"><a href=\"#解决方法：操作数据前通过校验过滤后再执行操作\" class=\"headerlink\" title=\"解决方法：操作数据前通过校验过滤后再执行操作\"></a>解决方法：操作数据前通过校验过滤后再执行操作</h4><p>如：<br><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">allEmp.Where(emp=&gt;emp.Active).ForEach(e =&gt; e.MonthlySalary *=<span class=\"number\">1.05</span>M);</div></pre></td></tr></table></figure></p>\n<h4 id=\"第三种异常：执行操作的时候抛出异常\"><a href=\"#第三种异常：执行操作的时候抛出异常\" class=\"headerlink\" title=\"第三种异常：执行操作的时候抛出异常\"></a>第三种异常：执行操作的时候抛出异常</h4><p>有时候，我们根本无法保证处理方法的时候会不会抛出异常。这个时候就必须采取一些代价更加昂贵的处理方法了。</p>\n<h4 id=\"解决方法：创建副本尝试执行操作，副本无误后执行真正操作\"><a href=\"#解决方法：创建副本尝试执行操作，副本无误后执行真正操作\" class=\"headerlink\" title=\"解决方法：创建副本尝试执行操作，副本无误后执行真正操作\"></a>解决方法：创建副本尝试执行操作，副本无误后执行真正操作</h4><p>我们在编写这类代码的时候，应该考虑抛出异常之后的处理方案。这就意味着，我们的操作应该先在原数据副本上执行，随后仅在操作成功之后再将其替换原有的数据。<br>如:</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> updatas = (<span class=\"keyword\">from</span> e <span class=\"keyword\">in</span> allEmp </div><div class=\"line\">              <span class=\"keyword\">select</span> <span class=\"keyword\">new</span> Emp</div><div class=\"line\">              &#123;</div><div class=\"line\">                  EmpID=e.EmpID,</div><div class=\"line\">                  .....</div><div class=\"line\">                  MonthlySalary =e.MonthlySalary *=<span class=\"number\">1.05</span>M</div><div class=\"line\">              &#125;).ToList();</div><div class=\"line\"></div><div class=\"line\">allEmp = updatas;</div></pre></td></tr></table></figure>\n<p>但是这样的修改也引发了其他的问题：代码量增加了，同时生成副本也消耗了大量的资源。这样的做法也有一个好处，我们在操作副本数据时遇到异常之后，有充分的”空间”来处理这些数据。</p>\n<p>实际中，这意味着我们让查询表达式返回了新序列，而不是去修改原先序列中的元素。这样的话，我们在尝试完成所有的操作的同时，即使失败了，也不会影响到我们程序的原有状态。</p>\n"},{"layout":"post","title":"一些有用的网站","date":"2016-03-09T16:00:00.000Z","_content":"\n\n[Markdown 语法说明 (简体中文版)](http://wowubuntu.com/markdown/)\n\n[Markdown: Basics （快速入门）](http://wowubuntu.com/markdown/basic.html)\n\n[使用GitHub和Hexo搭建免费静态Blog(本博客案例)](http://wsgzao.github.io/post/hexo-guide/)\n\n[win下面的git客户端提示FIlename too long解决方法](https://www.mxgw.info/t/filename-too-long-in-git.html)\n\n[Hexo Next 模板](http://theme-next.iissnan.com/)\n\n\n","source":"_posts/something.md","raw":"---\nlayout: post\ntitle: 一些有用的网站\ncategory: nothing\ndate: 2016-03-10 00:00:00\n---\n\n\n[Markdown 语法说明 (简体中文版)](http://wowubuntu.com/markdown/)\n\n[Markdown: Basics （快速入门）](http://wowubuntu.com/markdown/basic.html)\n\n[使用GitHub和Hexo搭建免费静态Blog(本博客案例)](http://wsgzao.github.io/post/hexo-guide/)\n\n[win下面的git客户端提示FIlename too long解决方法](https://www.mxgw.info/t/filename-too-long-in-git.html)\n\n[Hexo Next 模板](http://theme-next.iissnan.com/)\n\n\n","slug":"something","published":1,"updated":"2016-09-15T05:11:13.654Z","comments":1,"photos":[],"link":"","_id":"cit3xw9to0018c0txmn0nlahv","content":"<p><a href=\"http://wowubuntu.com/markdown/\" target=\"_blank\" rel=\"external\">Markdown 语法说明 (简体中文版)</a></p>\n<p><a href=\"http://wowubuntu.com/markdown/basic.html\" target=\"_blank\" rel=\"external\">Markdown: Basics （快速入门）</a></p>\n<p><a href=\"http://wsgzao.github.io/post/hexo-guide/\" target=\"_blank\" rel=\"external\">使用GitHub和Hexo搭建免费静态Blog(本博客案例)</a></p>\n<p><a href=\"https://www.mxgw.info/t/filename-too-long-in-git.html\" target=\"_blank\" rel=\"external\">win下面的git客户端提示FIlename too long解决方法</a></p>\n<p><a href=\"http://theme-next.iissnan.com/\" target=\"_blank\" rel=\"external\">Hexo Next 模板</a></p>\n","excerpt":"","more":"<p><a href=\"http://wowubuntu.com/markdown/\">Markdown 语法说明 (简体中文版)</a></p>\n<p><a href=\"http://wowubuntu.com/markdown/basic.html\">Markdown: Basics （快速入门）</a></p>\n<p><a href=\"http://wsgzao.github.io/post/hexo-guide/\">使用GitHub和Hexo搭建免费静态Blog(本博客案例)</a></p>\n<p><a href=\"https://www.mxgw.info/t/filename-too-long-in-git.html\">win下面的git客户端提示FIlename too long解决方法</a></p>\n<p><a href=\"http://theme-next.iissnan.com/\">Hexo Next 模板</a></p>\n"},{"layout":"post","title":"ubuntu使用Jexus搭建MyWebSQL","date":"2016-04-06T16:00:00.000Z","_content":"\n\n之前在阿里云上装了一个ubuntu，后来也没怎么用力，就挂这一个mysql数据库。最近在家里用MySQL Workbench 连接阿里云上面的MySQL的时候，连着过了一会就中断了。后来看了一圈回来才发现，目测是家里电信宽带的锅，不断给我动态分配IP地址....后来群里面的小伙伴说，搭个websql了事啦。听起来不错的想法，于是昨天就试了一下。\n\n之前在ubuntu上装过apache，后来为了跑asp.net，把apache停了，换成了jexus。\nJexus是国内.NET 跨平台大牛们写的一个web服务器，使用方便，很稳定，也在不断加入新特性。相关资料直接访问[www.jexus.org](http://www.jexus.org/)。\n\njexus是以mono为基础的，其实首先应该先配置mono的运行环境。\n\n###第一步 安装mono\n相关资料链接：\n\n\n[在Ubuntu操作系统上安装mono的具体方法](http://www.linuxdot.net/bbsfile-3090)\n\n[Ubuntu 14.04 安装 Mono](http://www.isvee.com/archives/763)\n\n\n\n我的ubuntu老早之前就安装好了mono，这个就此瞥过咯。\n\n\n###第二步 安装jexus\n\n[Jexus web server V5.1 安装配置要点](http://www.linuxdot.net/bbsfile-3084)\n\n[jexus首页](http://www.jexus.org/)\n\n\n```\nA、安装：\ncd /tmp\nwget linuxdot.net/down/jexus-5.8.1.tar.gz \ntar -zxvf jexus-5.8.1.tar.gz \ncd jexus-5.8.1 \nsudo ./install \n\nB、更新\ncd /tmp\nsudo /usr/jexus/jws stop\nwget linuxdot.net/down/jexus-5.8.1.tar.gz\ntar -zxvf jexus-5.8.1.tar.gz\ncd jexus-5.8.1\nsudo ./upgrade\n\n```\n\n5.8.1差不多是现在最新版本了。\n\n###第三步 jexus 支持PHP\n\n先在ubuntu上安装一下PHP5-CGI.\n\n[用 Jexus ASP.NET WEB服务器搭建 PHP 网站的具体方法](http://www.linuxidc.com/Linux/2012-05/60172.htm)\n\n\n总结来说就是下面两句：\n```\nsudo apt-get update\n\nsudo apt-get install php5-cgi\n\n```\n\n接着：\n\n```\n1)修改“/etc/php.ini”文件:\n\n找到cgi.force_redirect=1一行，把前边的\"#\"号去掉，把值从1改为0，如：\n\ncgi.force_redirect=0\n\n2)修改jws.conf。打开jexus文件夹中的jws.conf，作如下配置：\n\n填写PHP-CGI程序路径和工作进程数。如：“php-fcgi.set=/usr/bin/php-cgi,6”。\n\n3)修改网站配置。在需要使用PHP的网站的配置文件中添加:\n\nfastcgi.add=php|socket:/var/run/jexus/phpsvr\n```\n\n[Jexus 支持PHP的三种方式-张善友](http://www.cnblogs.com/shanyou/p/3369322.html)\n\n\n搞完上面这些，理论上你的jexus已经能跑PHP网站了。\n\n\n\n###第四步 安装mywebsql\n\n[mywebsql首页](http://mywebsql.net/)\n\nmywebsql跑起来应该是下图的：\n\n![mywebsql效果图](http://7xread.com1.z0.glb.clouddn.com/7d902b94-f132-4041-84fa-78f044f91358)\n\n[下载地址](https://sourceforge.net/projects/mywebsql/files/stable/mywebsql-3.6.zip/download)\n\n```\ncd /tmp\n\nwget https://sourceforge.net/projects/mywebsql/files/stable/mywebsql-3.6.zip\n\ncp mywebsql-3.6.zip /var/www \n\ncd /var/www\n\ntar -zxvf mywebsql-3.6.zip \n\n```\n\n\n把mywebsql网站文件弄好之后，就可以去看jexus配置php网站了。\n\njexus的网站配置文件夹一般路径就是/usr/jexus/siteconf/\n\n```\ncd /usr/jexus/siteconf/\n\nvi mywebSQL #创建网站配置文件\n\ncd .. \n\n./jexus restart\n\n```\n\n上面的mywebSQL里面就写网站配置了，主要是端口号/运行环境之类的配置。\n\n贴一下我的配置：\n\n```\n#仅供参考\n######################\n# Web Site: Default\n########################################\n\nport=2016\nroot=/ /var/www/mywebsql\nhosts=*    #OR your.com,*.your.com\nusephp =true\nfastcgi.add=php|socket:/var/run/jexus/phpsvr\n\n# addr=0.0.0.0\n# CheckQuery=false\n# NoLog=true\n# NoFile=/index.aspx\n# Keep_Alive=false\n# UseGZIP=true\n# UseHttps=true\n# DenyFrom=192.168.0.233, 192.168.1.*, 192.168.2.0/24\n# AllowFrom=192.168.*.*\n# DenyDirs=~/cgi, ~/upfiles\n# indexes=myindex.aspx\n# rewrite=^/.+?\\.(asp|php|cgi|pl|sh)$ /index.aspx\n\n# reproxy=/bbs/ http://192.168.1.112/bbs/\n\n# Jexus php fastcgi address is '/var/run/jexus/phpsvr'\n#######################################################\n# fastcgi.add=php|socket:/var/run/jexus/phpsvr\n\n# php-fpm listen address is '127.0.0.1:9000'\n############################################\n# fastcgi.add=php|tcp:127.0.0.1:9000\n\n```\n\n\n到这里，访问http://你的主机IP:上面配置的端口号 就能看到下面的页面了。\n\n![MywWebSQL登陆页](http://7xread.com1.z0.glb.clouddn.com/df3951c0-9d3d-4085-b577-743df68c1d98)\n\n\n输入账号密码就能登陆。\n\n\n###然而....\n我登陆的时候显示，系统提示：没有安装客户端库。\n\n###第五步 配置PHP MySQL库\n\n\n于是又跑去看了一下MyWebSQL的说明，文档上说可以在/install.php上面看配置。\n\n\n\n![这是配置好的效果图](http://7xread.com1.z0.glb.clouddn.com/cf8d88d8-fb5d-42f0-81cc-e0fbb566ebe5)\n\n显示：\n\nMySQL Client Library\tclient library is not installed\nMySQL improved functionality\tclient library is not installed\n\n\n好吧，PHP MySQL客户端库没有安装....\n\n那就安装咯。\n于是找到了下面一个文章：\n[ZH奶酪：Ubuntu 14.04安装LAMP(Linux，Apache，MySQL，PHP)](http://www.cnblogs.com/CheeseZH/p/4694135.html)\n\n安装一下基础库\n```\nsudo apt-get install php5 libapache2-mod-php5 php5-mcrypt php5-curl php5-imagick php5-cli\n\n```\n\n搜索一下还有什么库可以安装。\n\napt-cache search php5-\n\n\n![](http://7xread.com1.z0.glb.clouddn.com/7bac43bc-01ea-4ce0-ba4b-37a06a51fe3a)\n\n\n```\nsudo apt-get install php5 php5-mysqlnd \n\nsudo apt-get install php5 php5-mysqlnd-ms\n\n```\n\n接着重启一下jexus的网站，万事大吉。\n\n","source":"_posts/ubuntu-jexus-mywebsql.md","raw":"---\nlayout: post\ntitle: ubuntu使用Jexus搭建MyWebSQL\ncategory: ubuntu\ndate: 2016-04-07 00:00:00\n\n---\n\n\n之前在阿里云上装了一个ubuntu，后来也没怎么用力，就挂这一个mysql数据库。最近在家里用MySQL Workbench 连接阿里云上面的MySQL的时候，连着过了一会就中断了。后来看了一圈回来才发现，目测是家里电信宽带的锅，不断给我动态分配IP地址....后来群里面的小伙伴说，搭个websql了事啦。听起来不错的想法，于是昨天就试了一下。\n\n之前在ubuntu上装过apache，后来为了跑asp.net，把apache停了，换成了jexus。\nJexus是国内.NET 跨平台大牛们写的一个web服务器，使用方便，很稳定，也在不断加入新特性。相关资料直接访问[www.jexus.org](http://www.jexus.org/)。\n\njexus是以mono为基础的，其实首先应该先配置mono的运行环境。\n\n###第一步 安装mono\n相关资料链接：\n\n\n[在Ubuntu操作系统上安装mono的具体方法](http://www.linuxdot.net/bbsfile-3090)\n\n[Ubuntu 14.04 安装 Mono](http://www.isvee.com/archives/763)\n\n\n\n我的ubuntu老早之前就安装好了mono，这个就此瞥过咯。\n\n\n###第二步 安装jexus\n\n[Jexus web server V5.1 安装配置要点](http://www.linuxdot.net/bbsfile-3084)\n\n[jexus首页](http://www.jexus.org/)\n\n\n```\nA、安装：\ncd /tmp\nwget linuxdot.net/down/jexus-5.8.1.tar.gz \ntar -zxvf jexus-5.8.1.tar.gz \ncd jexus-5.8.1 \nsudo ./install \n\nB、更新\ncd /tmp\nsudo /usr/jexus/jws stop\nwget linuxdot.net/down/jexus-5.8.1.tar.gz\ntar -zxvf jexus-5.8.1.tar.gz\ncd jexus-5.8.1\nsudo ./upgrade\n\n```\n\n5.8.1差不多是现在最新版本了。\n\n###第三步 jexus 支持PHP\n\n先在ubuntu上安装一下PHP5-CGI.\n\n[用 Jexus ASP.NET WEB服务器搭建 PHP 网站的具体方法](http://www.linuxidc.com/Linux/2012-05/60172.htm)\n\n\n总结来说就是下面两句：\n```\nsudo apt-get update\n\nsudo apt-get install php5-cgi\n\n```\n\n接着：\n\n```\n1)修改“/etc/php.ini”文件:\n\n找到cgi.force_redirect=1一行，把前边的\"#\"号去掉，把值从1改为0，如：\n\ncgi.force_redirect=0\n\n2)修改jws.conf。打开jexus文件夹中的jws.conf，作如下配置：\n\n填写PHP-CGI程序路径和工作进程数。如：“php-fcgi.set=/usr/bin/php-cgi,6”。\n\n3)修改网站配置。在需要使用PHP的网站的配置文件中添加:\n\nfastcgi.add=php|socket:/var/run/jexus/phpsvr\n```\n\n[Jexus 支持PHP的三种方式-张善友](http://www.cnblogs.com/shanyou/p/3369322.html)\n\n\n搞完上面这些，理论上你的jexus已经能跑PHP网站了。\n\n\n\n###第四步 安装mywebsql\n\n[mywebsql首页](http://mywebsql.net/)\n\nmywebsql跑起来应该是下图的：\n\n![mywebsql效果图](http://7xread.com1.z0.glb.clouddn.com/7d902b94-f132-4041-84fa-78f044f91358)\n\n[下载地址](https://sourceforge.net/projects/mywebsql/files/stable/mywebsql-3.6.zip/download)\n\n```\ncd /tmp\n\nwget https://sourceforge.net/projects/mywebsql/files/stable/mywebsql-3.6.zip\n\ncp mywebsql-3.6.zip /var/www \n\ncd /var/www\n\ntar -zxvf mywebsql-3.6.zip \n\n```\n\n\n把mywebsql网站文件弄好之后，就可以去看jexus配置php网站了。\n\njexus的网站配置文件夹一般路径就是/usr/jexus/siteconf/\n\n```\ncd /usr/jexus/siteconf/\n\nvi mywebSQL #创建网站配置文件\n\ncd .. \n\n./jexus restart\n\n```\n\n上面的mywebSQL里面就写网站配置了，主要是端口号/运行环境之类的配置。\n\n贴一下我的配置：\n\n```\n#仅供参考\n######################\n# Web Site: Default\n########################################\n\nport=2016\nroot=/ /var/www/mywebsql\nhosts=*    #OR your.com,*.your.com\nusephp =true\nfastcgi.add=php|socket:/var/run/jexus/phpsvr\n\n# addr=0.0.0.0\n# CheckQuery=false\n# NoLog=true\n# NoFile=/index.aspx\n# Keep_Alive=false\n# UseGZIP=true\n# UseHttps=true\n# DenyFrom=192.168.0.233, 192.168.1.*, 192.168.2.0/24\n# AllowFrom=192.168.*.*\n# DenyDirs=~/cgi, ~/upfiles\n# indexes=myindex.aspx\n# rewrite=^/.+?\\.(asp|php|cgi|pl|sh)$ /index.aspx\n\n# reproxy=/bbs/ http://192.168.1.112/bbs/\n\n# Jexus php fastcgi address is '/var/run/jexus/phpsvr'\n#######################################################\n# fastcgi.add=php|socket:/var/run/jexus/phpsvr\n\n# php-fpm listen address is '127.0.0.1:9000'\n############################################\n# fastcgi.add=php|tcp:127.0.0.1:9000\n\n```\n\n\n到这里，访问http://你的主机IP:上面配置的端口号 就能看到下面的页面了。\n\n![MywWebSQL登陆页](http://7xread.com1.z0.glb.clouddn.com/df3951c0-9d3d-4085-b577-743df68c1d98)\n\n\n输入账号密码就能登陆。\n\n\n###然而....\n我登陆的时候显示，系统提示：没有安装客户端库。\n\n###第五步 配置PHP MySQL库\n\n\n于是又跑去看了一下MyWebSQL的说明，文档上说可以在/install.php上面看配置。\n\n\n\n![这是配置好的效果图](http://7xread.com1.z0.glb.clouddn.com/cf8d88d8-fb5d-42f0-81cc-e0fbb566ebe5)\n\n显示：\n\nMySQL Client Library\tclient library is not installed\nMySQL improved functionality\tclient library is not installed\n\n\n好吧，PHP MySQL客户端库没有安装....\n\n那就安装咯。\n于是找到了下面一个文章：\n[ZH奶酪：Ubuntu 14.04安装LAMP(Linux，Apache，MySQL，PHP)](http://www.cnblogs.com/CheeseZH/p/4694135.html)\n\n安装一下基础库\n```\nsudo apt-get install php5 libapache2-mod-php5 php5-mcrypt php5-curl php5-imagick php5-cli\n\n```\n\n搜索一下还有什么库可以安装。\n\napt-cache search php5-\n\n\n![](http://7xread.com1.z0.glb.clouddn.com/7bac43bc-01ea-4ce0-ba4b-37a06a51fe3a)\n\n\n```\nsudo apt-get install php5 php5-mysqlnd \n\nsudo apt-get install php5 php5-mysqlnd-ms\n\n```\n\n接着重启一下jexus的网站，万事大吉。\n\n","slug":"ubuntu-jexus-mywebsql","published":1,"updated":"2016-09-15T05:11:13.654Z","comments":1,"photos":[],"link":"","_id":"cit3xw9tq001ac0tx4dyamfom","content":"<p>之前在阿里云上装了一个ubuntu，后来也没怎么用力，就挂这一个mysql数据库。最近在家里用MySQL Workbench 连接阿里云上面的MySQL的时候，连着过了一会就中断了。后来看了一圈回来才发现，目测是家里电信宽带的锅，不断给我动态分配IP地址….后来群里面的小伙伴说，搭个websql了事啦。听起来不错的想法，于是昨天就试了一下。</p>\n<p>之前在ubuntu上装过apache，后来为了跑asp.net，把apache停了，换成了jexus。<br>Jexus是国内.NET 跨平台大牛们写的一个web服务器，使用方便，很稳定，也在不断加入新特性。相关资料直接访问<a href=\"http://www.jexus.org/\" target=\"_blank\" rel=\"external\">www.jexus.org</a>。</p>\n<p>jexus是以mono为基础的，其实首先应该先配置mono的运行环境。</p>\n<p>###第一步 安装mono<br>相关资料链接：</p>\n<p><a href=\"http://www.linuxdot.net/bbsfile-3090\" target=\"_blank\" rel=\"external\">在Ubuntu操作系统上安装mono的具体方法</a></p>\n<p><a href=\"http://www.isvee.com/archives/763\" target=\"_blank\" rel=\"external\">Ubuntu 14.04 安装 Mono</a></p>\n<p>我的ubuntu老早之前就安装好了mono，这个就此瞥过咯。</p>\n<p>###第二步 安装jexus</p>\n<p><a href=\"http://www.linuxdot.net/bbsfile-3084\" target=\"_blank\" rel=\"external\">Jexus web server V5.1 安装配置要点</a></p>\n<p><a href=\"http://www.jexus.org/\" target=\"_blank\" rel=\"external\">jexus首页</a></p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">A、安装：</div><div class=\"line\">cd /tmp</div><div class=\"line\">wget linuxdot.net/down/jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span>.tar.gz </div><div class=\"line\">tar -zxvf jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span>.tar.gz </div><div class=\"line\">cd jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span> </div><div class=\"line\">sudo ./install </div><div class=\"line\"></div><div class=\"line\">B、更新</div><div class=\"line\">cd /tmp</div><div class=\"line\">sudo /usr/jexus/jws stop</div><div class=\"line\">wget linuxdot.net/down/jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span>.tar.gz</div><div class=\"line\">tar -zxvf jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span>.tar.gz</div><div class=\"line\">cd jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span></div><div class=\"line\">sudo ./upgrade</div></pre></td></tr></table></figure>\n<p>5.8.1差不多是现在最新版本了。</p>\n<p>###第三步 jexus 支持PHP</p>\n<p>先在ubuntu上安装一下PHP5-CGI.</p>\n<p><a href=\"http://www.linuxidc.com/Linux/2012-05/60172.htm\" target=\"_blank\" rel=\"external\">用 Jexus ASP.NET WEB服务器搭建 PHP 网站的具体方法</a></p>\n<p>总结来说就是下面两句：<br><figure class=\"highlight q\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo apt-<span class=\"built_in\">get</span> <span class=\"keyword\">update</span></div><div class=\"line\"></div><div class=\"line\">sudo apt-<span class=\"built_in\">get</span> install php5-cgi</div></pre></td></tr></table></figure></p>\n<p>接着：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>)修改“<span class=\"regexp\">/etc/</span>php.ini”文件:</div><div class=\"line\"></div><div class=\"line\">找到cgi.force_redirect=<span class=\"number\">1</span>一行，把前边的<span class=\"string\">\"#\"</span>号去掉，把值从<span class=\"number\">1</span>改为<span class=\"number\">0</span>，如：</div><div class=\"line\"></div><div class=\"line\">cgi.force_redirect=<span class=\"number\">0</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"number\">2</span>)修改jws.conf。打开jexus文件夹中的jws.conf，作如下配置：</div><div class=\"line\"></div><div class=\"line\">填写PHP-CGI程序路径和工作进程数。如：“php-fcgi.set=<span class=\"regexp\">/usr/</span>bin/php-cgi,<span class=\"number\">6</span>”。</div><div class=\"line\"></div><div class=\"line\"><span class=\"number\">3</span>)修改网站配置。在需要使用PHP的网站的配置文件中添加:</div><div class=\"line\"></div><div class=\"line\">fastcgi.add=php|<span class=\"string\">socket:</span><span class=\"regexp\">/var/</span>run<span class=\"regexp\">/jexus/</span>phpsvr</div></pre></td></tr></table></figure>\n<p><a href=\"http://www.cnblogs.com/shanyou/p/3369322.html\" target=\"_blank\" rel=\"external\">Jexus 支持PHP的三种方式-张善友</a></p>\n<p>搞完上面这些，理论上你的jexus已经能跑PHP网站了。</p>\n<p>###第四步 安装mywebsql</p>\n<p><a href=\"http://mywebsql.net/\" target=\"_blank\" rel=\"external\">mywebsql首页</a></p>\n<p>mywebsql跑起来应该是下图的：</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/7d902b94-f132-4041-84fa-78f044f91358\" alt=\"mywebsql效果图\"></p>\n<p><a href=\"https://sourceforge.net/projects/mywebsql/files/stable/mywebsql-3.6.zip/download\" target=\"_blank\" rel=\"external\">下载地址</a></p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">cd</span> /tmp</div><div class=\"line\"></div><div class=\"line\">wget https:<span class=\"comment\">//sourceforge.net/projects/mywebsql/files/stable/mywebsql-3.6.zip</span></div><div class=\"line\"></div><div class=\"line\">cp mywebsql-3.6.<span class=\"keyword\">zip</span> /<span class=\"keyword\">var</span>/www </div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">cd</span> /<span class=\"keyword\">var</span>/www</div><div class=\"line\"></div><div class=\"line\">tar -zxvf mywebsql-3.6.<span class=\"keyword\">zip</span></div></pre></td></tr></table></figure>\n<p>把mywebsql网站文件弄好之后，就可以去看jexus配置php网站了。</p>\n<p>jexus的网站配置文件夹一般路径就是/usr/jexus/siteconf/</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd <span class=\"regexp\">/usr/</span>jexus<span class=\"regexp\">/siteconf/</span></div><div class=\"line\"></div><div class=\"line\">vi mywebSQL <span class=\"comment\">#创建网站配置文件</span></div><div class=\"line\"></div><div class=\"line\">cd .. </div><div class=\"line\"></div><div class=\"line\">.<span class=\"regexp\">/jexus restart</span></div></pre></td></tr></table></figure>\n<p>上面的mywebSQL里面就写网站配置了，主要是端口号/运行环境之类的配置。</p>\n<p>贴一下我的配置：</p>\n<figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">#仅供参考</span></div><div class=\"line\"><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">####</span></div><div class=\"line\"># Web Site: Default</div><div class=\"line\">###<span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">#</span></div><div class=\"line\"></div><div class=\"line\">port=<span class=\"number\">2016</span></div><div class=\"line\">root=/ /var/www/mywebsql</div><div class=\"line\">hosts=*    <span class=\"comment\">#OR your.com,*.your.com</span></div><div class=\"line\">usephp =<span class=\"literal\">true</span></div><div class=\"line\">fastcgi.add=php|socket:/var/run/jexus/phpsvr</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># addr=0.0.0.0</span></div><div class=\"line\"><span class=\"comment\"># CheckQuery=false</span></div><div class=\"line\"><span class=\"comment\"># NoLog=true</span></div><div class=\"line\"><span class=\"comment\"># NoFile=/index.aspx</span></div><div class=\"line\"><span class=\"comment\"># Keep_Alive=false</span></div><div class=\"line\"><span class=\"comment\"># UseGZIP=true</span></div><div class=\"line\"><span class=\"comment\"># UseHttps=true</span></div><div class=\"line\"><span class=\"comment\"># DenyFrom=192.168.0.233, 192.168.1.*, 192.168.2.0/24</span></div><div class=\"line\"><span class=\"comment\"># AllowFrom=192.168.*.*</span></div><div class=\"line\"><span class=\"comment\"># DenyDirs=~/cgi, ~/upfiles</span></div><div class=\"line\"><span class=\"comment\"># indexes=myindex.aspx</span></div><div class=\"line\"><span class=\"comment\"># rewrite=^/.+?\\.(asp|php|cgi|pl|sh)$ /index.aspx</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># reproxy=/bbs/ http://192.168.1.112/bbs/</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Jexus php fastcgi address is '/var/run/jexus/phpsvr'</span></div><div class=\"line\"><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">#</span></div><div class=\"line\"><span class=\"comment\"># fastcgi.add=php|socket:/var/run/jexus/phpsvr</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># php-fpm listen address is '127.0.0.1:9000'</span></div><div class=\"line\"><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">##</span></div><div class=\"line\"><span class=\"comment\"># fastcgi.add=php|tcp:127.0.0.1:9000</span></div></pre></td></tr></table></figure>\n<p>到这里，访问<a href=\"http://你的主机IP:上面配置的端口号\" target=\"_blank\" rel=\"external\">http://你的主机IP:上面配置的端口号</a> 就能看到下面的页面了。</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/df3951c0-9d3d-4085-b577-743df68c1d98\" alt=\"MywWebSQL登陆页\"></p>\n<p>输入账号密码就能登陆。</p>\n<p>###然而….<br>我登陆的时候显示，系统提示：没有安装客户端库。</p>\n<p>###第五步 配置PHP MySQL库</p>\n<p>于是又跑去看了一下MyWebSQL的说明，文档上说可以在/install.php上面看配置。</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/cf8d88d8-fb5d-42f0-81cc-e0fbb566ebe5\" alt=\"这是配置好的效果图\"></p>\n<p>显示：</p>\n<p>MySQL Client Library    client library is not installed<br>MySQL improved functionality    client library is not installed</p>\n<p>好吧，PHP MySQL客户端库没有安装….</p>\n<p>那就安装咯。<br>于是找到了下面一个文章：<br><a href=\"http://www.cnblogs.com/CheeseZH/p/4694135.html\" target=\"_blank\" rel=\"external\">ZH奶酪：Ubuntu 14.04安装LAMP(Linux，Apache，MySQL，PHP)</a></p>\n<p>安装一下基础库<br><figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo apt-get install php5 libapache2-mod-php5 php5-mcrypt php5-curl php5-imagick php5-cli</div></pre></td></tr></table></figure></p>\n<p>搜索一下还有什么库可以安装。</p>\n<p>apt-cache search php5-</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/7bac43bc-01ea-4ce0-ba4b-37a06a51fe3a\" alt=\"\"></p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo apt-get install php5 php5-mysqlnd </div><div class=\"line\"></div><div class=\"line\">sudo apt-get install php5 php5-mysqlnd-ms</div></pre></td></tr></table></figure>\n<p>接着重启一下jexus的网站，万事大吉。</p>\n","excerpt":"","more":"<p>之前在阿里云上装了一个ubuntu，后来也没怎么用力，就挂这一个mysql数据库。最近在家里用MySQL Workbench 连接阿里云上面的MySQL的时候，连着过了一会就中断了。后来看了一圈回来才发现，目测是家里电信宽带的锅，不断给我动态分配IP地址….后来群里面的小伙伴说，搭个websql了事啦。听起来不错的想法，于是昨天就试了一下。</p>\n<p>之前在ubuntu上装过apache，后来为了跑asp.net，把apache停了，换成了jexus。<br>Jexus是国内.NET 跨平台大牛们写的一个web服务器，使用方便，很稳定，也在不断加入新特性。相关资料直接访问<a href=\"http://www.jexus.org/\">www.jexus.org</a>。</p>\n<p>jexus是以mono为基础的，其实首先应该先配置mono的运行环境。</p>\n<p>###第一步 安装mono<br>相关资料链接：</p>\n<p><a href=\"http://www.linuxdot.net/bbsfile-3090\">在Ubuntu操作系统上安装mono的具体方法</a></p>\n<p><a href=\"http://www.isvee.com/archives/763\">Ubuntu 14.04 安装 Mono</a></p>\n<p>我的ubuntu老早之前就安装好了mono，这个就此瞥过咯。</p>\n<p>###第二步 安装jexus</p>\n<p><a href=\"http://www.linuxdot.net/bbsfile-3084\">Jexus web server V5.1 安装配置要点</a></p>\n<p><a href=\"http://www.jexus.org/\">jexus首页</a></p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">A、安装：</div><div class=\"line\">cd /tmp</div><div class=\"line\">wget linuxdot.net/down/jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span>.tar.gz </div><div class=\"line\">tar -zxvf jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span>.tar.gz </div><div class=\"line\">cd jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span> </div><div class=\"line\">sudo ./install </div><div class=\"line\"></div><div class=\"line\">B、更新</div><div class=\"line\">cd /tmp</div><div class=\"line\">sudo /usr/jexus/jws stop</div><div class=\"line\">wget linuxdot.net/down/jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span>.tar.gz</div><div class=\"line\">tar -zxvf jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span>.tar.gz</div><div class=\"line\">cd jexus<span class=\"number\">-5.8</span><span class=\"number\">.1</span></div><div class=\"line\">sudo ./upgrade</div></pre></td></tr></table></figure>\n<p>5.8.1差不多是现在最新版本了。</p>\n<p>###第三步 jexus 支持PHP</p>\n<p>先在ubuntu上安装一下PHP5-CGI.</p>\n<p><a href=\"http://www.linuxidc.com/Linux/2012-05/60172.htm\">用 Jexus ASP.NET WEB服务器搭建 PHP 网站的具体方法</a></p>\n<p>总结来说就是下面两句：<br><figure class=\"highlight q\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo apt-<span class=\"built_in\">get</span> <span class=\"keyword\">update</span></div><div class=\"line\"></div><div class=\"line\">sudo apt-<span class=\"built_in\">get</span> install php5-cgi</div></pre></td></tr></table></figure></p>\n<p>接着：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>)修改“<span class=\"regexp\">/etc/</span>php.ini”文件:</div><div class=\"line\"></div><div class=\"line\">找到cgi.force_redirect=<span class=\"number\">1</span>一行，把前边的<span class=\"string\">\"#\"</span>号去掉，把值从<span class=\"number\">1</span>改为<span class=\"number\">0</span>，如：</div><div class=\"line\"></div><div class=\"line\">cgi.force_redirect=<span class=\"number\">0</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"number\">2</span>)修改jws.conf。打开jexus文件夹中的jws.conf，作如下配置：</div><div class=\"line\"></div><div class=\"line\">填写PHP-CGI程序路径和工作进程数。如：“php-fcgi.set=<span class=\"regexp\">/usr/</span>bin/php-cgi,<span class=\"number\">6</span>”。</div><div class=\"line\"></div><div class=\"line\"><span class=\"number\">3</span>)修改网站配置。在需要使用PHP的网站的配置文件中添加:</div><div class=\"line\"></div><div class=\"line\">fastcgi.add=php|<span class=\"string\">socket:</span><span class=\"regexp\">/var/</span>run<span class=\"regexp\">/jexus/</span>phpsvr</div></pre></td></tr></table></figure>\n<p><a href=\"http://www.cnblogs.com/shanyou/p/3369322.html\">Jexus 支持PHP的三种方式-张善友</a></p>\n<p>搞完上面这些，理论上你的jexus已经能跑PHP网站了。</p>\n<p>###第四步 安装mywebsql</p>\n<p><a href=\"http://mywebsql.net/\">mywebsql首页</a></p>\n<p>mywebsql跑起来应该是下图的：</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/7d902b94-f132-4041-84fa-78f044f91358\" alt=\"mywebsql效果图\"></p>\n<p><a href=\"https://sourceforge.net/projects/mywebsql/files/stable/mywebsql-3.6.zip/download\">下载地址</a></p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">cd</span> /tmp</div><div class=\"line\"></div><div class=\"line\">wget https:<span class=\"comment\">//sourceforge.net/projects/mywebsql/files/stable/mywebsql-3.6.zip</span></div><div class=\"line\"></div><div class=\"line\">cp mywebsql-3.6.<span class=\"keyword\">zip</span> /<span class=\"keyword\">var</span>/www </div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">cd</span> /<span class=\"keyword\">var</span>/www</div><div class=\"line\"></div><div class=\"line\">tar -zxvf mywebsql-3.6.<span class=\"keyword\">zip</span></div></pre></td></tr></table></figure>\n<p>把mywebsql网站文件弄好之后，就可以去看jexus配置php网站了。</p>\n<p>jexus的网站配置文件夹一般路径就是/usr/jexus/siteconf/</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd <span class=\"regexp\">/usr/</span>jexus<span class=\"regexp\">/siteconf/</span></div><div class=\"line\"></div><div class=\"line\">vi mywebSQL <span class=\"comment\">#创建网站配置文件</span></div><div class=\"line\"></div><div class=\"line\">cd .. </div><div class=\"line\"></div><div class=\"line\">.<span class=\"regexp\">/jexus restart</span></div></pre></td></tr></table></figure>\n<p>上面的mywebSQL里面就写网站配置了，主要是端口号/运行环境之类的配置。</p>\n<p>贴一下我的配置：</p>\n<figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">#仅供参考</span></div><div class=\"line\"><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">####</div><div class=\"line\"># Web Site: Default</div><div class=\"line\">###</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">#</span></div><div class=\"line\"></div><div class=\"line\">port=<span class=\"number\">2016</span></div><div class=\"line\">root=/ /var/www/mywebsql</div><div class=\"line\">hosts=*    <span class=\"comment\">#OR your.com,*.your.com</span></div><div class=\"line\">usephp =<span class=\"literal\">true</span></div><div class=\"line\">fastcgi.add=php|socket:/var/run/jexus/phpsvr</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># addr=0.0.0.0</span></div><div class=\"line\"><span class=\"comment\"># CheckQuery=false</span></div><div class=\"line\"><span class=\"comment\"># NoLog=true</span></div><div class=\"line\"><span class=\"comment\"># NoFile=/index.aspx</span></div><div class=\"line\"><span class=\"comment\"># Keep_Alive=false</span></div><div class=\"line\"><span class=\"comment\"># UseGZIP=true</span></div><div class=\"line\"><span class=\"comment\"># UseHttps=true</span></div><div class=\"line\"><span class=\"comment\"># DenyFrom=192.168.0.233, 192.168.1.*, 192.168.2.0/24</span></div><div class=\"line\"><span class=\"comment\"># AllowFrom=192.168.*.*</span></div><div class=\"line\"><span class=\"comment\"># DenyDirs=~/cgi, ~/upfiles</span></div><div class=\"line\"><span class=\"comment\"># indexes=myindex.aspx</span></div><div class=\"line\"><span class=\"comment\"># rewrite=^/.+?\\.(asp|php|cgi|pl|sh)$ /index.aspx</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># reproxy=/bbs/ http://192.168.1.112/bbs/</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Jexus php fastcgi address is '/var/run/jexus/phpsvr'</span></div><div class=\"line\"><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">#</span></div><div class=\"line\"><span class=\"comment\"># fastcgi.add=php|socket:/var/run/jexus/phpsvr</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># php-fpm listen address is '127.0.0.1:9000'</span></div><div class=\"line\"><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">######</span><span class=\"comment\">##</span></div><div class=\"line\"><span class=\"comment\"># fastcgi.add=php|tcp:127.0.0.1:9000</span></div></pre></td></tr></table></figure>\n<p>到这里，访问<a href=\"http://你的主机IP:上面配置的端口号\">http://你的主机IP:上面配置的端口号</a> 就能看到下面的页面了。</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/df3951c0-9d3d-4085-b577-743df68c1d98\" alt=\"MywWebSQL登陆页\"></p>\n<p>输入账号密码就能登陆。</p>\n<p>###然而….<br>我登陆的时候显示，系统提示：没有安装客户端库。</p>\n<p>###第五步 配置PHP MySQL库</p>\n<p>于是又跑去看了一下MyWebSQL的说明，文档上说可以在/install.php上面看配置。</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/cf8d88d8-fb5d-42f0-81cc-e0fbb566ebe5\" alt=\"这是配置好的效果图\"></p>\n<p>显示：</p>\n<p>MySQL Client Library    client library is not installed<br>MySQL improved functionality    client library is not installed</p>\n<p>好吧，PHP MySQL客户端库没有安装….</p>\n<p>那就安装咯。<br>于是找到了下面一个文章：<br><a href=\"http://www.cnblogs.com/CheeseZH/p/4694135.html\">ZH奶酪：Ubuntu 14.04安装LAMP(Linux，Apache，MySQL，PHP)</a></p>\n<p>安装一下基础库<br><figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo apt-get install php5 libapache2-mod-php5 php5-mcrypt php5-curl php5-imagick php5-cli</div></pre></td></tr></table></figure></p>\n<p>搜索一下还有什么库可以安装。</p>\n<p>apt-cache search php5-</p>\n<p><img src=\"http://7xread.com1.z0.glb.clouddn.com/7bac43bc-01ea-4ce0-ba4b-37a06a51fe3a\" alt=\"\"></p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo apt-get install php5 php5-mysqlnd </div><div class=\"line\"></div><div class=\"line\">sudo apt-get install php5 php5-mysqlnd-ms</div></pre></td></tr></table></figure>\n<p>接着重启一下jexus的网站，万事大吉。</p>\n"},{"layout":"post","title":"mono webreques https exception","date":"2016-04-10T04:39:04.000Z","_content":"\n前几天在做一个使用URL通过WebRequest请求HTML页面的功能的时候遇到了点坑，程序在开发环境没有任何的问题，部署到linux mono上之后就跪了。代码如下：\n\n```csharp\npublic static string GetHTML(string url)\n{\n    string htmlCode;\n    try\n    {\n        HttpWebRequest webRequest = (System.Net.HttpWebRequest)System.Net.WebRequest.Create(url);\n        webRequest.Timeout = 30000;\n        webRequest.Method = \"GET\";\n        webRequest.UserAgent = \"Mozilla/4.0\";\n        webRequest.Headers.Add(\"Accept-Encoding\", \"gzip, deflate\");\n\n        HttpWebResponse webResponse = (System.Net.HttpWebResponse)webRequest.GetResponse();\n        //获取目标网站的编码格式\n        string contentype = webResponse.Headers[\"Content-Type\"];\n        Regex regex = new Regex(\"charset\\\\s*=\\\\s*[\\\\W]?\\\\s*([\\\\w-]+)\", RegexOptions.IgnoreCase);\n        if (webResponse.ContentEncoding.ToLower() == \"gzip\")//如果使用了GZip则先解压\n        {\n            using (System.IO.Stream streamReceive = webResponse.GetResponseStream())\n            {\n                using (var zipStream = new System.IO.Compression.GZipStream(streamReceive, \n                System.IO.Compression.CompressionMode.Decompress))\n                {\n                    //匹配编码格式\n                    if (regex.IsMatch(contentype))\n                    {\n                        Encoding ending = Encoding.GetEncoding(regex.Match(contentype).Groups[1].Value.Trim());\n                        using (StreamReader sr = new System.IO.StreamReader(zipStream, ending))\n                        {\n                            htmlCode = sr.ReadToEnd();\n                        }\n                    }\n                    else\n                    {\n                        using (StreamReader sr = \n                        new System.IO.StreamReader(zipStream, Encoding.UTF8))\n                        {\n                            htmlCode = sr.ReadToEnd();\n                        }\n                    }\n                }\n            }\n        }\n        else\n        {\n            using (System.IO.Stream streamReceive = webResponse.GetResponseStream())\n            {\n                using (System.IO.StreamReader sr = new System.IO.StreamReader(streamReceive, Encoding.Default))\n                {\n                    htmlCode = sr.ReadToEnd();\n                }\n            }\n        }\n        return htmlCode;\n\n    }catch(Exception ex)\n    {\n        LogHelper.WriteException(\"GetHTML\", ex, new { Url = url });\n        return \"\";\n    }\n\n}\n```\n\n开发环境在Windows10 + VS2013,整个代码跑起来没什么问题。\n\n无论是HTTP还是HTTPS协议，网页HTML一样能获取得到。\n\n网站部署到linux Jexus之后HTTP协议的网站同样可以获取到HTML，遇到HTTPS协议的网站的时候就跪了。\n\n抓到的异常信息如下：\n\n```csharp\n   System.Net.WebException: Error: TrustFailure (The authentication or decryption has failed.) \n   ---> System.IO.IOException: The authentication or decryption has failed.\n   ---> System.IO.IOException: The authentication or decryption has failed. \n   ---> Mono.Security.Protocol.Tls.TlsException:\n   Invalid certificate received from server. Error code: 0xffffffff800b0109\n   at Mono.Security.Protocol.Tls.RecordProtocol.EndReceiveRecord \n   (IAsyncResult asyncResult) <0x41b58d80 + 0x0013e> in <filename unknown>:0 \n   at Mono.Security.Protocol.Tls.SslClientStream.SafeEndReceiveRecord\n   (IAsyncResult ar, Boolean ignoreEmpty) <0x41b58cb0 + 0x00031> in <filename unknown>:0 \n   at Mono.Security.Protocol.Tls.SslClientStream.NegotiateAsyncWorker\n   (IAsyncResult result) <0x41b72a40 + 0x0023f> in <filename unknown>:0 \n   --- End of inner exception stack trace ---\n   at Mono.Security.Protocol.Tls.SslClientStream.EndNegotiateHandshake \n   (IAsyncResult result) <0x41ba07e0 + 0x000f3> in <filename unknown>:0 \n   at Mono.Security.Protocol.Tls.SslStreamBase.AsyncHandshakeCallback \n   (IAsyncResult asyncResult) <0x41ba0540 + 0x00086> in <filename unknown>:0 \n   --- End of inner exception stack trace ---\n   at Mono.Security.Protocol.Tls.SslStreamBase.EndRead \n   (IAsyncResult asyncResult) <0x41b73fd0 + 0x00199> in <filename unknown>:0 \n   at Mono.Net.Security.Private.LegacySslStream.EndAuthenticateAsClient \n   (IAsyncResult asyncResult) <0x41b73f30 + 0x00042> in <filename unknown>:0 \n   at Mono.Net.Security.Private.LegacySslStream.AuthenticateAsClient (System.String targetHost, \n   System.Security.Cryptography.X509Certificates.X509CertificateCollection\n   clientCertificates, SslProtocols enabledSslProtocols,\n   Boolean checkCertificateRevocation) <0x41b6a660 + 0x00055> in <filename unknown>:0 \n   at Mono.Net.Security.MonoTlsStream.CreateStream (System.Byte[] buffer) \n   <0x41b69c30 + 0x00159> in <filename unknown>:0 \n   --- End of inner exception stack trace ---\n   at System.Net.HttpWebRequest.EndGetResponse (IAsyncResult asyncResult) \n   <0x41b67660 + 0x001f9> in <filename unknown>:0 \n   at System.Net.HttpWebRequest.GetResponse () <0x41b60920 + 0x0005a> in <filename unknown>:0 \n   at WebBookmarkUI.Commom.HTTPHelper.GetHTML (System.String url) <0x41b59b70 + 0x00235> \n   in <filename unknown>:0 \n\n```\n\n有用的信息基本就是：\n\n1. Invalid certificate received from server\n2. The authentication or decryption has failed\n\n一开始百思不得其解，为嘛好好的程序在开发环境跑得都好的，到了mono上就挂了，多疑的我还以为是mono的bug。\n今天静下心来去找了一下资料，发现Mono的文档有这个问题的描述，认真读了一遍，又去请教了一番宇内流云大大，终于弄懂了是什么回事。\n\n先贴一下相关资料：\n\n1. [stackoverflow mono-webrequest-fails-with-https](http://stackoverflow.com/questions/4926676/mono-webrequest-fails-with-https)\n\n2. [mono doc security](http://www.mono-project.com/docs/faq/security/)\n\n\n这个问题是出现的原因是Windows自带了HTPPS的根证书，linux默认则是没有带有根证书的。我们的mono在调用WebRequest去请求HTTPS协议的网站的时候，找不到任何有效的根证书，所以抛出上面的异常了。\n\n解决方案也很简单，为linux导入一下HTTPS根证书就好。\n\n在linux服务器上面执行下面这条命令。\n```\nmozroots --import --ask-remove --machine\n\n```\n\n\n然后在网站的Application_Start()里面添加下面代码：\n\n```csharp\n System.Net.ServicePointManager.ServerCertificateValidationCallback +=\n delegate(object sender, System.Security.Cryptography.X509Certificates.X509Certificate certificate,\n System.Security.Cryptography.X509Certificates.X509Chain chain,\n System.Net.Security.SslPolicyErrors sslPolicyErrors)\n{\n    return true; // **** Always accept\n};\n\n```\n\n完事。\n\n这个故事告诉我们，linux干活都是要亲力亲为呀。\n\n\n\n","source":"_posts/mono-webreques-https-exception.md","raw":"---\nlayout: post\ntitle: mono webreques https exception\ncategory: .net\ndate: 2016-04-10 12:39:04\ntags:\n  - mono\n  - webreques exception\n---\n\n前几天在做一个使用URL通过WebRequest请求HTML页面的功能的时候遇到了点坑，程序在开发环境没有任何的问题，部署到linux mono上之后就跪了。代码如下：\n\n```csharp\npublic static string GetHTML(string url)\n{\n    string htmlCode;\n    try\n    {\n        HttpWebRequest webRequest = (System.Net.HttpWebRequest)System.Net.WebRequest.Create(url);\n        webRequest.Timeout = 30000;\n        webRequest.Method = \"GET\";\n        webRequest.UserAgent = \"Mozilla/4.0\";\n        webRequest.Headers.Add(\"Accept-Encoding\", \"gzip, deflate\");\n\n        HttpWebResponse webResponse = (System.Net.HttpWebResponse)webRequest.GetResponse();\n        //获取目标网站的编码格式\n        string contentype = webResponse.Headers[\"Content-Type\"];\n        Regex regex = new Regex(\"charset\\\\s*=\\\\s*[\\\\W]?\\\\s*([\\\\w-]+)\", RegexOptions.IgnoreCase);\n        if (webResponse.ContentEncoding.ToLower() == \"gzip\")//如果使用了GZip则先解压\n        {\n            using (System.IO.Stream streamReceive = webResponse.GetResponseStream())\n            {\n                using (var zipStream = new System.IO.Compression.GZipStream(streamReceive, \n                System.IO.Compression.CompressionMode.Decompress))\n                {\n                    //匹配编码格式\n                    if (regex.IsMatch(contentype))\n                    {\n                        Encoding ending = Encoding.GetEncoding(regex.Match(contentype).Groups[1].Value.Trim());\n                        using (StreamReader sr = new System.IO.StreamReader(zipStream, ending))\n                        {\n                            htmlCode = sr.ReadToEnd();\n                        }\n                    }\n                    else\n                    {\n                        using (StreamReader sr = \n                        new System.IO.StreamReader(zipStream, Encoding.UTF8))\n                        {\n                            htmlCode = sr.ReadToEnd();\n                        }\n                    }\n                }\n            }\n        }\n        else\n        {\n            using (System.IO.Stream streamReceive = webResponse.GetResponseStream())\n            {\n                using (System.IO.StreamReader sr = new System.IO.StreamReader(streamReceive, Encoding.Default))\n                {\n                    htmlCode = sr.ReadToEnd();\n                }\n            }\n        }\n        return htmlCode;\n\n    }catch(Exception ex)\n    {\n        LogHelper.WriteException(\"GetHTML\", ex, new { Url = url });\n        return \"\";\n    }\n\n}\n```\n\n开发环境在Windows10 + VS2013,整个代码跑起来没什么问题。\n\n无论是HTTP还是HTTPS协议，网页HTML一样能获取得到。\n\n网站部署到linux Jexus之后HTTP协议的网站同样可以获取到HTML，遇到HTTPS协议的网站的时候就跪了。\n\n抓到的异常信息如下：\n\n```csharp\n   System.Net.WebException: Error: TrustFailure (The authentication or decryption has failed.) \n   ---> System.IO.IOException: The authentication or decryption has failed.\n   ---> System.IO.IOException: The authentication or decryption has failed. \n   ---> Mono.Security.Protocol.Tls.TlsException:\n   Invalid certificate received from server. Error code: 0xffffffff800b0109\n   at Mono.Security.Protocol.Tls.RecordProtocol.EndReceiveRecord \n   (IAsyncResult asyncResult) <0x41b58d80 + 0x0013e> in <filename unknown>:0 \n   at Mono.Security.Protocol.Tls.SslClientStream.SafeEndReceiveRecord\n   (IAsyncResult ar, Boolean ignoreEmpty) <0x41b58cb0 + 0x00031> in <filename unknown>:0 \n   at Mono.Security.Protocol.Tls.SslClientStream.NegotiateAsyncWorker\n   (IAsyncResult result) <0x41b72a40 + 0x0023f> in <filename unknown>:0 \n   --- End of inner exception stack trace ---\n   at Mono.Security.Protocol.Tls.SslClientStream.EndNegotiateHandshake \n   (IAsyncResult result) <0x41ba07e0 + 0x000f3> in <filename unknown>:0 \n   at Mono.Security.Protocol.Tls.SslStreamBase.AsyncHandshakeCallback \n   (IAsyncResult asyncResult) <0x41ba0540 + 0x00086> in <filename unknown>:0 \n   --- End of inner exception stack trace ---\n   at Mono.Security.Protocol.Tls.SslStreamBase.EndRead \n   (IAsyncResult asyncResult) <0x41b73fd0 + 0x00199> in <filename unknown>:0 \n   at Mono.Net.Security.Private.LegacySslStream.EndAuthenticateAsClient \n   (IAsyncResult asyncResult) <0x41b73f30 + 0x00042> in <filename unknown>:0 \n   at Mono.Net.Security.Private.LegacySslStream.AuthenticateAsClient (System.String targetHost, \n   System.Security.Cryptography.X509Certificates.X509CertificateCollection\n   clientCertificates, SslProtocols enabledSslProtocols,\n   Boolean checkCertificateRevocation) <0x41b6a660 + 0x00055> in <filename unknown>:0 \n   at Mono.Net.Security.MonoTlsStream.CreateStream (System.Byte[] buffer) \n   <0x41b69c30 + 0x00159> in <filename unknown>:0 \n   --- End of inner exception stack trace ---\n   at System.Net.HttpWebRequest.EndGetResponse (IAsyncResult asyncResult) \n   <0x41b67660 + 0x001f9> in <filename unknown>:0 \n   at System.Net.HttpWebRequest.GetResponse () <0x41b60920 + 0x0005a> in <filename unknown>:0 \n   at WebBookmarkUI.Commom.HTTPHelper.GetHTML (System.String url) <0x41b59b70 + 0x00235> \n   in <filename unknown>:0 \n\n```\n\n有用的信息基本就是：\n\n1. Invalid certificate received from server\n2. The authentication or decryption has failed\n\n一开始百思不得其解，为嘛好好的程序在开发环境跑得都好的，到了mono上就挂了，多疑的我还以为是mono的bug。\n今天静下心来去找了一下资料，发现Mono的文档有这个问题的描述，认真读了一遍，又去请教了一番宇内流云大大，终于弄懂了是什么回事。\n\n先贴一下相关资料：\n\n1. [stackoverflow mono-webrequest-fails-with-https](http://stackoverflow.com/questions/4926676/mono-webrequest-fails-with-https)\n\n2. [mono doc security](http://www.mono-project.com/docs/faq/security/)\n\n\n这个问题是出现的原因是Windows自带了HTPPS的根证书，linux默认则是没有带有根证书的。我们的mono在调用WebRequest去请求HTTPS协议的网站的时候，找不到任何有效的根证书，所以抛出上面的异常了。\n\n解决方案也很简单，为linux导入一下HTTPS根证书就好。\n\n在linux服务器上面执行下面这条命令。\n```\nmozroots --import --ask-remove --machine\n\n```\n\n\n然后在网站的Application_Start()里面添加下面代码：\n\n```csharp\n System.Net.ServicePointManager.ServerCertificateValidationCallback +=\n delegate(object sender, System.Security.Cryptography.X509Certificates.X509Certificate certificate,\n System.Security.Cryptography.X509Certificates.X509Chain chain,\n System.Net.Security.SslPolicyErrors sslPolicyErrors)\n{\n    return true; // **** Always accept\n};\n\n```\n\n完事。\n\n这个故事告诉我们，linux干活都是要亲力亲为呀。\n\n\n\n","slug":"mono-webreques-https-exception","published":1,"updated":"2016-09-15T05:11:13.654Z","comments":1,"photos":[],"link":"","_id":"cit3xw9tw001gc0tx9gpy1eyg","content":"<p>前几天在做一个使用URL通过WebRequest请求HTML页面的功能的时候遇到了点坑，程序在开发环境没有任何的问题，部署到linux mono上之后就跪了。代码如下：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">string</span> <span class=\"title\">GetHTML</span>(<span class=\"params\"><span class=\"keyword\">string</span> url</span>)</span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">string</span> htmlCode;</div><div class=\"line\">    <span class=\"keyword\">try</span></div><div class=\"line\">    &#123;</div><div class=\"line\">        HttpWebRequest webRequest = (System.Net.HttpWebRequest)System.Net.WebRequest.Create(url);</div><div class=\"line\">        webRequest.Timeout = <span class=\"number\">30000</span>;</div><div class=\"line\">        webRequest.Method = <span class=\"string\">\"GET\"</span>;</div><div class=\"line\">        webRequest.UserAgent = <span class=\"string\">\"Mozilla/4.0\"</span>;</div><div class=\"line\">        webRequest.Headers.Add(<span class=\"string\">\"Accept-Encoding\"</span>, <span class=\"string\">\"gzip, deflate\"</span>);</div><div class=\"line\"></div><div class=\"line\">        HttpWebResponse webResponse = (System.Net.HttpWebResponse)webRequest.GetResponse();</div><div class=\"line\">        <span class=\"comment\">//获取目标网站的编码格式</span></div><div class=\"line\">        <span class=\"keyword\">string</span> contentype = webResponse.Headers[<span class=\"string\">\"Content-Type\"</span>];</div><div class=\"line\">        Regex regex = <span class=\"keyword\">new</span> Regex(<span class=\"string\">\"charset\\\\s*=\\\\s*[\\\\W]?\\\\s*([\\\\w-]+)\"</span>, RegexOptions.IgnoreCase);</div><div class=\"line\">        <span class=\"keyword\">if</span> (webResponse.ContentEncoding.ToLower() == <span class=\"string\">\"gzip\"</span>)<span class=\"comment\">//如果使用了GZip则先解压</span></div><div class=\"line\">        &#123;</div><div class=\"line\">            <span class=\"keyword\">using</span> (System.IO.Stream streamReceive = webResponse.GetResponseStream())</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"keyword\">using</span> (<span class=\"keyword\">var</span> zipStream = <span class=\"keyword\">new</span> System.IO.Compression.GZipStream(streamReceive, </div><div class=\"line\">                System.IO.Compression.CompressionMode.Decompress))</div><div class=\"line\">                &#123;</div><div class=\"line\">                    <span class=\"comment\">//匹配编码格式</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (regex.IsMatch(contentype))</div><div class=\"line\">                    &#123;</div><div class=\"line\">                        Encoding ending = Encoding.GetEncoding(regex.Match(contentype).Groups[<span class=\"number\">1</span>].Value.Trim());</div><div class=\"line\">                        <span class=\"keyword\">using</span> (StreamReader sr = <span class=\"keyword\">new</span> System.IO.StreamReader(zipStream, ending))</div><div class=\"line\">                        &#123;</div><div class=\"line\">                            htmlCode = sr.ReadToEnd();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">else</span></div><div class=\"line\">                    &#123;</div><div class=\"line\">                        <span class=\"keyword\">using</span> (StreamReader sr = </div><div class=\"line\">                        <span class=\"keyword\">new</span> System.IO.StreamReader(zipStream, Encoding.UTF8))</div><div class=\"line\">                        &#123;</div><div class=\"line\">                            htmlCode = sr.ReadToEnd();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span></div><div class=\"line\">        &#123;</div><div class=\"line\">            <span class=\"keyword\">using</span> (System.IO.Stream streamReceive = webResponse.GetResponseStream())</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"keyword\">using</span> (System.IO.StreamReader sr = <span class=\"keyword\">new</span> System.IO.StreamReader(streamReceive, Encoding.Default))</div><div class=\"line\">                &#123;</div><div class=\"line\">                    htmlCode = sr.ReadToEnd();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> htmlCode;</div><div class=\"line\"></div><div class=\"line\">    &#125;<span class=\"keyword\">catch</span>(Exception ex)</div><div class=\"line\">    &#123;</div><div class=\"line\">        LogHelper.WriteException(<span class=\"string\">\"GetHTML\"</span>, ex, <span class=\"keyword\">new</span> &#123; Url = url &#125;);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>开发环境在Windows10 + VS2013,整个代码跑起来没什么问题。</p>\n<p>无论是HTTP还是HTTPS协议，网页HTML一样能获取得到。</p>\n<p>网站部署到linux Jexus之后HTTP协议的网站同样可以获取到HTML，遇到HTTPS协议的网站的时候就跪了。</p>\n<p>抓到的异常信息如下：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div></pre></td><td class=\"code\"><pre><div class=\"line\">System.Net.WebException: Error: TrustFailure (The authentication or decryption has failed.) </div><div class=\"line\">---&gt; System.IO.IOException: The authentication or decryption has failed.</div><div class=\"line\">---&gt; System.IO.IOException: The authentication or decryption has failed. </div><div class=\"line\">---&gt; Mono.Security.Protocol.Tls.TlsException:</div><div class=\"line\">Invalid certificate received <span class=\"keyword\">from</span> server. Error code: <span class=\"number\">0xffffffff800b0109</span></div><div class=\"line\">at Mono.Security.Protocol.Tls.RecordProtocol.EndReceiveRecord </div><div class=\"line\">(IAsyncResult asyncResult) &lt;<span class=\"number\">0x41b58d80</span> + <span class=\"number\">0x0013e</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Security.Protocol.Tls.SslClientStream.SafeEndReceiveRecord</div><div class=\"line\">(IAsyncResult ar, Boolean ignoreEmpty) &lt;<span class=\"number\">0x41b58cb0</span> + <span class=\"number\">0x00031</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Security.Protocol.Tls.SslClientStream.NegotiateAsyncWorker</div><div class=\"line\">(IAsyncResult result) &lt;<span class=\"number\">0x41b72a40</span> + <span class=\"number\">0x0023f</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">--- End of inner exception stack trace ---</div><div class=\"line\">at Mono.Security.Protocol.Tls.SslClientStream.EndNegotiateHandshake </div><div class=\"line\">(IAsyncResult result) &lt;<span class=\"number\">0x41ba07e0</span> + <span class=\"number\">0x000f3</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Security.Protocol.Tls.SslStreamBase.AsyncHandshakeCallback </div><div class=\"line\">(IAsyncResult asyncResult) &lt;<span class=\"number\">0x41ba0540</span> + <span class=\"number\">0x00086</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">--- End of inner exception stack trace ---</div><div class=\"line\">at Mono.Security.Protocol.Tls.SslStreamBase.EndRead </div><div class=\"line\">(IAsyncResult asyncResult) &lt;<span class=\"number\">0x41b73fd0</span> + <span class=\"number\">0x00199</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Net.Security.Private.LegacySslStream.EndAuthenticateAsClient </div><div class=\"line\">(IAsyncResult asyncResult) &lt;<span class=\"number\">0x41b73f30</span> + <span class=\"number\">0x00042</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Net.Security.Private.LegacySslStream.AuthenticateAsClient (System.String targetHost, </div><div class=\"line\">System.Security.Cryptography.X509Certificates.X509CertificateCollection</div><div class=\"line\">clientCertificates, SslProtocols enabledSslProtocols,</div><div class=\"line\">Boolean checkCertificateRevocation) &lt;<span class=\"number\">0x41b6a660</span> + <span class=\"number\">0x00055</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Net.Security.MonoTlsStream.CreateStream (System.Byte[] buffer) </div><div class=\"line\">&lt;<span class=\"number\">0x41b69c30</span> + <span class=\"number\">0x00159</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">--- End of inner exception stack trace ---</div><div class=\"line\">at System.Net.HttpWebRequest.EndGetResponse (IAsyncResult asyncResult) </div><div class=\"line\">&lt;<span class=\"number\">0x41b67660</span> + <span class=\"number\">0x001f9</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at System.Net.HttpWebRequest.GetResponse () &lt;<span class=\"number\">0x41b60920</span> + <span class=\"number\">0x0005a</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at WebBookmarkUI.Commom.HTTPHelper.GetHTML (System.String url) &lt;<span class=\"number\">0x41b59b70</span> + <span class=\"number\">0x00235</span>&gt; </div><div class=\"line\"><span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span></div></pre></td></tr></table></figure>\n<p>有用的信息基本就是：</p>\n<ol>\n<li>Invalid certificate received from server</li>\n<li>The authentication or decryption has failed</li>\n</ol>\n<p>一开始百思不得其解，为嘛好好的程序在开发环境跑得都好的，到了mono上就挂了，多疑的我还以为是mono的bug。<br>今天静下心来去找了一下资料，发现Mono的文档有这个问题的描述，认真读了一遍，又去请教了一番宇内流云大大，终于弄懂了是什么回事。</p>\n<p>先贴一下相关资料：</p>\n<ol>\n<li><p><a href=\"http://stackoverflow.com/questions/4926676/mono-webrequest-fails-with-https\" target=\"_blank\" rel=\"external\">stackoverflow mono-webrequest-fails-with-https</a></p>\n</li>\n<li><p><a href=\"http://www.mono-project.com/docs/faq/security/\" target=\"_blank\" rel=\"external\">mono doc security</a></p>\n</li>\n</ol>\n<p>这个问题是出现的原因是Windows自带了HTPPS的根证书，linux默认则是没有带有根证书的。我们的mono在调用WebRequest去请求HTTPS协议的网站的时候，找不到任何有效的根证书，所以抛出上面的异常了。</p>\n<p>解决方案也很简单，为linux导入一下HTTPS根证书就好。</p>\n<p>在linux服务器上面执行下面这条命令。<br><figure class=\"highlight brainfuck\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">mozroots</span> <span class=\"literal\">-</span><span class=\"literal\">-</span><span class=\"comment\">import</span> <span class=\"literal\">-</span><span class=\"literal\">-</span><span class=\"comment\">ask</span><span class=\"literal\">-</span><span class=\"comment\">remove</span> <span class=\"literal\">-</span><span class=\"literal\">-</span><span class=\"comment\">machine</span></div></pre></td></tr></table></figure></p>\n<p>然后在网站的Application_Start()里面添加下面代码：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"> System.Net.ServicePointManager.ServerCertificateValidationCallback +=</div><div class=\"line\"> <span class=\"keyword\">delegate</span>(<span class=\"keyword\">object</span> sender, System.Security.Cryptography.X509Certificates.X509Certificate certificate,</div><div class=\"line\"> System.Security.Cryptography.X509Certificates.X509Chain chain,</div><div class=\"line\"> System.Net.Security.SslPolicyErrors sslPolicyErrors)</div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>; <span class=\"comment\">// **** Always accept</span></div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>完事。</p>\n<p>这个故事告诉我们，linux干活都是要亲力亲为呀。</p>\n","excerpt":"","more":"<p>前几天在做一个使用URL通过WebRequest请求HTML页面的功能的时候遇到了点坑，程序在开发环境没有任何的问题，部署到linux mono上之后就跪了。代码如下：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">string</span> <span class=\"title\">GetHTML</span>(<span class=\"params\"><span class=\"keyword\">string</span> url</span>)</div><div class=\"line\"></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">string</span> htmlCode;</div><div class=\"line\">    <span class=\"keyword\">try</span></div><div class=\"line\">    &#123;</div><div class=\"line\">        HttpWebRequest webRequest = (System.Net.HttpWebRequest)System.Net.WebRequest.Create(url);</div><div class=\"line\">        webRequest.Timeout = <span class=\"number\">30000</span>;</div><div class=\"line\">        webRequest.Method = <span class=\"string\">\"GET\"</span>;</div><div class=\"line\">        webRequest.UserAgent = <span class=\"string\">\"Mozilla/4.0\"</span>;</div><div class=\"line\">        webRequest.Headers.Add(<span class=\"string\">\"Accept-Encoding\"</span>, <span class=\"string\">\"gzip, deflate\"</span>);</div><div class=\"line\"></div><div class=\"line\">        HttpWebResponse webResponse = (System.Net.HttpWebResponse)webRequest.GetResponse();</div><div class=\"line\">        <span class=\"comment\">//获取目标网站的编码格式</span></div><div class=\"line\">        <span class=\"keyword\">string</span> contentype = webResponse.Headers[<span class=\"string\">\"Content-Type\"</span>];</div><div class=\"line\">        Regex regex = <span class=\"keyword\">new</span> Regex(<span class=\"string\">\"charset\\\\s*=\\\\s*[\\\\W]?\\\\s*([\\\\w-]+)\"</span>, RegexOptions.IgnoreCase);</div><div class=\"line\">        <span class=\"keyword\">if</span> (webResponse.ContentEncoding.ToLower() == <span class=\"string\">\"gzip\"</span>)<span class=\"comment\">//如果使用了GZip则先解压</span></div><div class=\"line\">        &#123;</div><div class=\"line\">            <span class=\"keyword\">using</span> (System.IO.Stream streamReceive = webResponse.GetResponseStream())</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"keyword\">using</span> (<span class=\"keyword\">var</span> zipStream = <span class=\"keyword\">new</span> System.IO.Compression.GZipStream(streamReceive, </div><div class=\"line\">                System.IO.Compression.CompressionMode.Decompress))</div><div class=\"line\">                &#123;</div><div class=\"line\">                    <span class=\"comment\">//匹配编码格式</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (regex.IsMatch(contentype))</div><div class=\"line\">                    &#123;</div><div class=\"line\">                        Encoding ending = Encoding.GetEncoding(regex.Match(contentype).Groups[<span class=\"number\">1</span>].Value.Trim());</div><div class=\"line\">                        <span class=\"keyword\">using</span> (StreamReader sr = <span class=\"keyword\">new</span> System.IO.StreamReader(zipStream, ending))</div><div class=\"line\">                        &#123;</div><div class=\"line\">                            htmlCode = sr.ReadToEnd();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">else</span></div><div class=\"line\">                    &#123;</div><div class=\"line\">                        <span class=\"keyword\">using</span> (StreamReader sr = </div><div class=\"line\">                        <span class=\"keyword\">new</span> System.IO.StreamReader(zipStream, Encoding.UTF8))</div><div class=\"line\">                        &#123;</div><div class=\"line\">                            htmlCode = sr.ReadToEnd();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span></div><div class=\"line\">        &#123;</div><div class=\"line\">            <span class=\"keyword\">using</span> (System.IO.Stream streamReceive = webResponse.GetResponseStream())</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"keyword\">using</span> (System.IO.StreamReader sr = <span class=\"keyword\">new</span> System.IO.StreamReader(streamReceive, Encoding.Default))</div><div class=\"line\">                &#123;</div><div class=\"line\">                    htmlCode = sr.ReadToEnd();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> htmlCode;</div><div class=\"line\"></div><div class=\"line\">    &#125;<span class=\"keyword\">catch</span>(Exception ex)</div><div class=\"line\">    &#123;</div><div class=\"line\">        LogHelper.WriteException(<span class=\"string\">\"GetHTML\"</span>, ex, <span class=\"keyword\">new</span> &#123; Url = url &#125;);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>开发环境在Windows10 + VS2013,整个代码跑起来没什么问题。</p>\n<p>无论是HTTP还是HTTPS协议，网页HTML一样能获取得到。</p>\n<p>网站部署到linux Jexus之后HTTP协议的网站同样可以获取到HTML，遇到HTTPS协议的网站的时候就跪了。</p>\n<p>抓到的异常信息如下：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div></pre></td><td class=\"code\"><pre><div class=\"line\">System.Net.WebException: Error: TrustFailure (The authentication or decryption has failed.) </div><div class=\"line\">---&gt; System.IO.IOException: The authentication or decryption has failed.</div><div class=\"line\">---&gt; System.IO.IOException: The authentication or decryption has failed. </div><div class=\"line\">---&gt; Mono.Security.Protocol.Tls.TlsException:</div><div class=\"line\">Invalid certificate received <span class=\"keyword\">from</span> server. Error code: <span class=\"number\">0xffffffff800b0109</span></div><div class=\"line\">at Mono.Security.Protocol.Tls.RecordProtocol.EndReceiveRecord </div><div class=\"line\">(IAsyncResult asyncResult) &lt;<span class=\"number\">0x41b58d80</span> + <span class=\"number\">0x0013e</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Security.Protocol.Tls.SslClientStream.SafeEndReceiveRecord</div><div class=\"line\">(IAsyncResult ar, Boolean ignoreEmpty) &lt;<span class=\"number\">0x41b58cb0</span> + <span class=\"number\">0x00031</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Security.Protocol.Tls.SslClientStream.NegotiateAsyncWorker</div><div class=\"line\">(IAsyncResult result) &lt;<span class=\"number\">0x41b72a40</span> + <span class=\"number\">0x0023f</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">--- End of inner exception stack trace ---</div><div class=\"line\">at Mono.Security.Protocol.Tls.SslClientStream.EndNegotiateHandshake </div><div class=\"line\">(IAsyncResult result) &lt;<span class=\"number\">0x41ba07e0</span> + <span class=\"number\">0x000f3</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Security.Protocol.Tls.SslStreamBase.AsyncHandshakeCallback </div><div class=\"line\">(IAsyncResult asyncResult) &lt;<span class=\"number\">0x41ba0540</span> + <span class=\"number\">0x00086</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">--- End of inner exception stack trace ---</div><div class=\"line\">at Mono.Security.Protocol.Tls.SslStreamBase.EndRead </div><div class=\"line\">(IAsyncResult asyncResult) &lt;<span class=\"number\">0x41b73fd0</span> + <span class=\"number\">0x00199</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Net.Security.Private.LegacySslStream.EndAuthenticateAsClient </div><div class=\"line\">(IAsyncResult asyncResult) &lt;<span class=\"number\">0x41b73f30</span> + <span class=\"number\">0x00042</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Net.Security.Private.LegacySslStream.AuthenticateAsClient (System.String targetHost, </div><div class=\"line\">System.Security.Cryptography.X509Certificates.X509CertificateCollection</div><div class=\"line\">clientCertificates, SslProtocols enabledSslProtocols,</div><div class=\"line\">Boolean checkCertificateRevocation) &lt;<span class=\"number\">0x41b6a660</span> + <span class=\"number\">0x00055</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at Mono.Net.Security.MonoTlsStream.CreateStream (System.Byte[] buffer) </div><div class=\"line\">&lt;<span class=\"number\">0x41b69c30</span> + <span class=\"number\">0x00159</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">--- End of inner exception stack trace ---</div><div class=\"line\">at System.Net.HttpWebRequest.EndGetResponse (IAsyncResult asyncResult) </div><div class=\"line\">&lt;<span class=\"number\">0x41b67660</span> + <span class=\"number\">0x001f9</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at System.Net.HttpWebRequest.GetResponse () &lt;<span class=\"number\">0x41b60920</span> + <span class=\"number\">0x0005a</span>&gt; <span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span> </div><div class=\"line\">at WebBookmarkUI.Commom.HTTPHelper.GetHTML (System.String url) &lt;<span class=\"number\">0x41b59b70</span> + <span class=\"number\">0x00235</span>&gt; </div><div class=\"line\"><span class=\"keyword\">in</span> &lt;filename unknown&gt;:<span class=\"number\">0</span></div></pre></td></tr></table></figure>\n<p>有用的信息基本就是：</p>\n<ol>\n<li>Invalid certificate received from server</li>\n<li>The authentication or decryption has failed</li>\n</ol>\n<p>一开始百思不得其解，为嘛好好的程序在开发环境跑得都好的，到了mono上就挂了，多疑的我还以为是mono的bug。<br>今天静下心来去找了一下资料，发现Mono的文档有这个问题的描述，认真读了一遍，又去请教了一番宇内流云大大，终于弄懂了是什么回事。</p>\n<p>先贴一下相关资料：</p>\n<ol>\n<li><p><a href=\"http://stackoverflow.com/questions/4926676/mono-webrequest-fails-with-https\">stackoverflow mono-webrequest-fails-with-https</a></p>\n</li>\n<li><p><a href=\"http://www.mono-project.com/docs/faq/security/\">mono doc security</a></p>\n</li>\n</ol>\n<p>这个问题是出现的原因是Windows自带了HTPPS的根证书，linux默认则是没有带有根证书的。我们的mono在调用WebRequest去请求HTTPS协议的网站的时候，找不到任何有效的根证书，所以抛出上面的异常了。</p>\n<p>解决方案也很简单，为linux导入一下HTTPS根证书就好。</p>\n<p>在linux服务器上面执行下面这条命令。<br><figure class=\"highlight brainfuck\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">mozroots</span> <span class=\"literal\">-</span><span class=\"literal\">-</span><span class=\"comment\">import</span> <span class=\"literal\">-</span><span class=\"literal\">-</span><span class=\"comment\">ask</span><span class=\"literal\">-</span><span class=\"comment\">remove</span> <span class=\"literal\">-</span><span class=\"literal\">-</span><span class=\"comment\">machine</span></div></pre></td></tr></table></figure></p>\n<p>然后在网站的Application_Start()里面添加下面代码：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"> System.Net.ServicePointManager.ServerCertificateValidationCallback +=</div><div class=\"line\"> <span class=\"keyword\">delegate</span>(<span class=\"keyword\">object</span> sender, System.Security.Cryptography.X509Certificates.X509Certificate certificate,</div><div class=\"line\"> System.Security.Cryptography.X509Certificates.X509Chain chain,</div><div class=\"line\"> System.Net.Security.SslPolicyErrors sslPolicyErrors)</div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>; <span class=\"comment\">// **** Always accept</span></div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>完事。</p>\n<p>这个故事告诉我们，linux干活都是要亲力亲为呀。</p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cit3xw9rz0000c0txbwbzwlnz","category_id":"cit3xw9s70002c0txwevsl9xq","_id":"cit3xw9sl000ac0txh18eaja8"},{"post_id":"cit3xw9s40001c0txy560cuwd","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9sx000gc0txebgudgpb"},{"post_id":"cit3xw9s90003c0txrif9sn16","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9t2000lc0txw38jp57r"},{"post_id":"cit3xw9sy000ic0txmwy6q68a","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9t5000oc0tx8q8nqq5m"},{"post_id":"cit3xw9sf0005c0txn429l3ms","category_id":"cit3xw9sy000hc0tx79i2ylvf","_id":"cit3xw9t7000rc0tx115r4n8u"},{"post_id":"cit3xw9t0000kc0txogdwwl5k","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9t9000tc0txdffa8l04"},{"post_id":"cit3xw9t3000nc0txkl53jl5p","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9tc000vc0tx93ke5may"},{"post_id":"cit3xw9sh0006c0tx7fbhwjb3","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9tc000wc0txi7m5ynip"},{"post_id":"cit3xw9t7000sc0txnw2b3qsj","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9td000xc0txjz1lhbva"},{"post_id":"cit3xw9sj0008c0txilmauj66","category_id":"cit3xw9sy000hc0tx79i2ylvf","_id":"cit3xw9te000zc0txw1emdx75"},{"post_id":"cit3xw9sl000bc0txkusfuw7s","category_id":"cit3xw9tb000uc0txsfbwhp0i","_id":"cit3xw9te0010c0txs7yjwwn5"},{"post_id":"cit3xw9ss000dc0tx5cbem0t6","category_id":"cit3xw9tb000uc0txsfbwhp0i","_id":"cit3xw9th0012c0txzfx4nik8"},{"post_id":"cit3xw9sw000ec0txfu5a1bm2","category_id":"cit3xw9te0011c0txrg8lmdpe","_id":"cit3xw9ti0014c0txexh9mug6"},{"post_id":"cit3xw9t6000pc0txk4ejz6h6","category_id":"cit3xw9th0013c0txfnyixq5n","_id":"cit3xw9ti0015c0txwu0g4ptj"},{"post_id":"cit3xw9tl0016c0txo6k16vpg","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9ts001cc0txi6drttyu"},{"post_id":"cit3xw9to0018c0txmn0nlahv","category_id":"cit3xw9ts001bc0txbiijvkwa","_id":"cit3xw9tt001ec0tx87y05vwl"},{"post_id":"cit3xw9tq001ac0tx4dyamfom","category_id":"cit3xw9ts001dc0tx4xc46xy0","_id":"cit3xw9tv001fc0txxhtm8oee"},{"post_id":"cit3xw9tw001gc0tx9gpy1eyg","category_id":"cit3xw9si0007c0tx6be0j5in","_id":"cit3xw9tz001jc0txuyq92kqj"}],"PostTag":[{"post_id":"cit3xw9s40001c0txy560cuwd","tag_id":"cit3xw9sd0004c0txxj3bapjg","_id":"cit3xw9sx000fc0txbpf7qbuj"},{"post_id":"cit3xw9s40001c0txy560cuwd","tag_id":"cit3xw9sk0009c0txmylzt039","_id":"cit3xw9sz000jc0txcm7r2ach"},{"post_id":"cit3xw9tw001gc0tx9gpy1eyg","tag_id":"cit3xw9ty001ic0txes0g7sw7","_id":"cit3xw9tz001lc0txn3udq88k"},{"post_id":"cit3xw9tw001gc0tx9gpy1eyg","tag_id":"cit3xw9tz001kc0tx970kwsbg","_id":"cit3xw9tz001mc0txew8c8tiw"}],"Tag":[{"name":"58City","_id":"cit3xw9sd0004c0txxj3bapjg"},{"name":"Crawler","_id":"cit3xw9sk0009c0txmylzt039"},{"name":"mono","_id":"cit3xw9ty001ic0txes0g7sw7"},{"name":"webreques exception","_id":"cit3xw9tz001kc0tx970kwsbg"}]}}